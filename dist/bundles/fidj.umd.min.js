!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common")):"function"==typeof define&&define.amd?define("fidj",["exports","@angular/core","@angular/common"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).fidj={},e.ng.core,e.ng.common)}(this,(function(e,t,n){"use strict";function o(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var o=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,o.get?o:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var i,r=o(t),s=function(){function e(){}return e.encode=function(e){return e?("undefined"!=typeof window?window.btoa:require("btoa"))(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode(parseInt("0x"+t,16))}))):null},e.decode=function(e){if(!e)return null;var t="undefined"!=typeof window?window.atob:require("atob");return decodeURIComponent(t(e).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""))},e}(),c=function(){function e(e,t){if(this.storageKey=t,this.version="0.1",this.storage=e||window.localStorage,!this.storage)throw new Error("fidj.LocalStorageFactory needs a storageService!")}return e.prototype.set=function(e,t){e=this.storageKey+e,this.checkKey(e);var n=typeof t;if("undefined"===n)t="null";else if(null===t)t="null";else if("string"===n)t=JSON.stringify({string:t});else if("number"===n)t=JSON.stringify({number:t});else if("boolean"===n)t=JSON.stringify({bool:t});else{if("object"!==n)throw new TypeError("Value type "+n+" is invalid. It must be null, undefined, xml, string, number, boolean or object");t=JSON.stringify({json:t})}return this.storage.setItem(e,t),t},e.prototype.get=function(e,t){e=this.storageKey+e,this.checkKey(e);var n=this.storage.getItem(e);if(null!==n){if("null"===n)return null;var o=JSON.parse(n);return"string"in o?o.string:"number"in o?o.number.valueOf():"bool"in o?o.bool.valueOf():o.json}return t||null},e.prototype.remove=function(e){e=this.storageKey+e,this.checkKey(e);var t=null!==this.storage.getItem(e);return this.storage.removeItem(e),t},e.prototype.clear=function(){var e=this.storage.length>0;return this.storage.clear(),e},e.prototype.size=function(){return this.storage.length},e.prototype.foreach=function(e,t){for(var n=this.storage.length,o=0;o<n;o++){var i=this.storage.key(o),r=this.get(i);t?e.call(t,r):e(r)}return n},e.prototype.checkKey=function(e){if(!e||"string"!=typeof e)throw new TypeError("Key type must be string");return!0},e}(),a=function(){function e(){}return e.encrypt=function(t,n){var o="";t=e.header+t;for(var i=0;i<t.length;i++)o+=String.fromCharCode(t[i].charCodeAt(0).toString(10)^e.keyCharAt(n,i));return o=s.encode(o)},e.decrypt=function(t,n,o){var i="";t=s.decode(t);for(var r=0;r<t.length;r++)i+=String.fromCharCode(t[r].charCodeAt(0).toString(10)^e.keyCharAt(n,r));return o||e.header===i.substring(0,e.header.length)?(o||(i=i.substring(e.header.length)),i):null},e.keyCharAt=function(e,t){return e[Math.floor(t%e.length)].charCodeAt(0).toString(10)},e}();a.header="artemis-lotsum",e.LoggerLevelEnum=void 0,(i=e.LoggerLevelEnum||(e.LoggerLevelEnum={}))[i.INFO=1]="INFO",i[i.WARN=2]="WARN",i[i.ERROR=3]="ERROR",i[i.NONE=4]="NONE";var d=function(){function e(e,t){this.code=e,this.reason=t}return e.prototype.equals=function(e){return this.code===e.code&&this.reason===e.reason},e.prototype.toString=function(){var e="string"==typeof this.reason?this.reason:JSON.stringify(this.reason);return this.code+" - "+e},e}(),u=function(){};u.decorators=[{type:t.NgModule,args:[{imports:[n.CommonModule],declarations:[],exports:[]}]}],u.ctorParameters=function(){return[]};var l;!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.TIMEOUT=1]="TIMEOUT",e[e.STATUS=2]="STATUS"}(l||(l={}));var f=function(){function e(){this.xhr=require("axios")}return e.formatResponseData=function(e){for(var t=e;t&&t.data;)t=t.data;try{t=JSON.parse(t+"")}catch(e){}return t},e.formatError=function(e){var t={reason:l.UNKNOWN,status:-1,code:-1,message:""};return e.status&&(t.reason=l.STATUS,t.status=parseInt(e.status,10),t.code=parseInt(e.status,10)),e.response?(t.message=e.response,e.response.status?(t.reason=l.STATUS,t.status=parseInt(e.response.status,10),t.code=parseInt(e.response.status,10)):null===e.response.status&&(t.reason=l.TIMEOUT,t.status=408,t.code=408)):e.request?t.message=e.request:e.message&&(t.message=e.message),t},e.prototype.post=function(t){var n={method:"POST",url:t.url,data:JSON.stringify(t.data)};return t.headers&&(n.headers=t.headers),this.xhr.post(n.url,n.data,{headers:n.headers,timeout:1e4}).then((function(t){return t.status&&(parseInt(t.status,10)<200||parseInt(t.status,10)>=300)?Promise.reject(e.formatError(t)):Promise.resolve(e.formatResponseData(t))})).catch((function(t){return Promise.reject(e.formatError(t))}))},e.prototype.put=function(t){var n={method:"PUT",url:t.url,data:JSON.stringify(t.data)};return t.headers&&(n.headers=t.headers),this.xhr.put(n.url,n.data,{headers:n.headers,timeout:1e4}).then((function(t){return t.status&&(parseInt(t.status,10)<200||parseInt(t.status,10)>=300)?Promise.reject(e.formatError(t)):Promise.resolve(e.formatResponseData(t))})).catch((function(t){return Promise.reject(e.formatError(t))}))},e.prototype.delete=function(t){var n={method:"DELETE",url:t.url,data:JSON.stringify(t.data)};return t.headers&&(n.headers=t.headers),this.xhr.delete(n.url,{headers:n.headers,timeout:1e4}).then((function(t){return t.status&&(parseInt(t.status,10)<200||parseInt(t.status,10)>=300)?Promise.reject(e.formatError(t)):Promise.resolve(e.formatResponseData(t))})).catch((function(t){return Promise.reject(e.formatError(t))}))},e.prototype.get=function(t){var n={method:"GET",url:t.url};return t.data&&(n.data=t.data),t.headers&&(n.headers=t.headers),this.xhr.get(n.url,{headers:n.headers,timeout:1e4}).then((function(t){return t.status&&(parseInt(t.status,10)<200||parseInt(t.status,10)>=300)?Promise.reject(e.formatError(t)):Promise.resolve(e.formatResponseData(t))})).catch((function(t){return Promise.reject(e.formatError(t))}))},e}(),h=function(){function e(t,n,o,i){this.appId=t,this.URI=n,this.storage=o,this.sdk=i;var r=this.storage.get(e._clientUuid)||"uuid-"+Math.random(),s="_clientInfo";"undefined"!=typeof window&&window.navigator&&(s=window.navigator.appName+"@"+window.navigator.appVersion+"-"+window.navigator.userAgent),"undefined"!=typeof window&&window.device&&window.device.uuid&&(r=window.device.uuid),this.setClientUuid(r),this.setClientInfo(s),this.clientId=this.storage.get(e._clientId),e.refreshCount=this.storage.get(e._refreshCount)||e.refreshCountInitial}return e.prototype.setClientId=function(t){this.clientId=""+t,this.storage.set(e._clientId,this.clientId)},e.prototype.setClientUuid=function(t){this.clientUuid=""+t,this.storage.set(e._clientUuid,this.clientUuid)},e.prototype.setClientInfo=function(e){this.clientInfo=""+e},e.prototype.login=function(e,t,n){var o=this;if(!this.URI)return console.error("no api uri"),Promise.reject({code:408,reason:"no-api-uri"});var i=this.URI+"/users",r={name:e,username:e,email:e,password:t};return(new f).post({url:i,data:r,headers:{"Content-Type":"application/json",Accept:"application/json"}}).then((function(n){o.setClientId(n._id);var i=o.URI+"/me/tokens",r={grant_type:"client_credentials",client_id:o.clientId,client_secret:t,client_udid:o.clientUuid,client_info:o.clientInfo,audience:o.appId,scope:JSON.stringify(o.sdk)};return(new f).post({url:i,data:r,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Basic "+s.encode(e+":"+t)}})}))},e.prototype.reAuthenticate=function(t){var n=this;if(!this.URI)return console.error("no api uri"),Promise.reject({code:408,reason:"no-api-uri"});var o=this.URI+"/me/tokens",i={grant_type:"refresh_token",client_id:this.clientId,client_udid:this.clientUuid,client_info:this.clientInfo,audience:this.appId,scope:JSON.stringify(this.sdk),refresh_token:t,refresh_extra:e.refreshCount};return(new f).post({url:o,data:i,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+t}}).then((function(t){return e.refreshCount++,n.storage.set(e._refreshCount,e.refreshCount),Promise.resolve(t)}))},e.prototype.logout=function(t){if(!this.URI)return console.error("no api uri"),Promise.reject({code:408,reason:"no-api-uri"});if(this.storage.remove(e._clientId),this.storage.remove(e._refreshCount),e.refreshCount=e.refreshCountInitial,!t||!this.clientId)return Promise.resolve();var n=this.URI+"/me/tokens/"+this.clientId,o={token:t,client_id:this.clientId,client_udid:this.clientUuid,client_info:this.clientInfo,audience:this.appId,scope:JSON.stringify(this.sdk)};return(new f).delete({url:n,data:o,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+t}})},e.prototype.isReady=function(){return!!this.URI},e}();h.refreshCountInitial=1,h.refreshCount=h.refreshCountInitial,h._clientUuid="v2.clientUuid",h._clientId="v2.clientId",h._refreshCount="v2.refreshCount";function p(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))}function g(e,t){var n,o,i,r,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function c(r){return function(c){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,o&&(i=2&r[0]?o.return:r[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,r[1])).done)return i;switch(o=0,i&&(r=[2&r[0],i.value]),r[0]){case 0:case 1:i=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,o=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==r[0]&&2!==r[0])){s=0;continue}if(3===r[0]&&(!i||r[1]>i[0]&&r[1]<i[3])){s.label=r[1];break}if(6===r[0]&&s.label<i[1]){s.label=i[1],i=r;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(r);break}i[2]&&s.ops.pop(),s.trys.pop();continue}r=t.call(e,s)}catch(e){r=[6,e],o=0}finally{n=i=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,c])}}}Object.create;Object.create;var y,v=function(){function e(t,n,o){this._sdk=t,this._storage=n,this._logger=o,this.client=null,this.user=null,this.cryptoSalt=this._storage.get(e._cryptoSalt)||null,this.cryptoSaltNext=this._storage.get(e._cryptoSaltNext)||null,this.accessToken=this._storage.get(e._accessToken)||null,this.accessTokenPrevious=this._storage.get("v2.accessTokenPrevious")||null,this.idToken=this._storage.get(e._idToken)||null,this.refreshToken=this._storage.get(e._refreshToken)||null,this.states=this._storage.get(e._states)||{},this.apis=[]}return e.prototype.isReady=function(){return!!this.client&&this.client.isReady()},e.prototype.destroy=function(t){this._storage.remove(e._accessToken),this._storage.remove(e._idToken),this._storage.remove(e._refreshToken),this._storage.remove(e._states),this.accessToken&&(this.accessTokenPrevious=this.accessToken,this._storage.set(e._accessTokenPrevious,this.accessTokenPrevious)),t&&(this._storage.remove(e._cryptoSalt),this._storage.remove(e._cryptoSaltNext),this._storage.remove(e._accessTokenPrevious)),this.user=null,this.client&&this.client.logout(),this.accessToken=null,this.idToken=null,this.refreshToken=null,this.states={}},e.prototype.setClient=function(e){this.client=e,this.user||(this.user={}),this.user._name=JSON.parse(this.getIdPayload({name:""})).name},e.prototype.setUser=function(e){this.user=e,this.client&&this.user._id&&(this.client.setClientId(this.user._id),delete this.user._id)},e.prototype.getUser=function(){return this.user},e.prototype.getClient=function(){return this.client},e.prototype.setCryptoSalt=function(t){this.cryptoSalt!==t&&this.cryptoSaltNext!==t&&(this.cryptoSaltNext=t,this._storage.set(e._cryptoSaltNext,this.cryptoSaltNext)),this.cryptoSalt||this.setCryptoSaltAsVerified()},e.prototype.setCryptoSaltAsVerified=function(){this.cryptoSaltNext&&(this.cryptoSalt=this.cryptoSaltNext,this._storage.set(e._cryptoSalt,this.cryptoSalt)),this.cryptoSaltNext=null,this._storage.remove(e._cryptoSaltNext)},e.prototype.encrypt=function(e){if("string"!=typeof e)e=JSON.stringify(e);else{var t={string:e};e=JSON.stringify(t)}if(this.fidjCrypto&&this.cryptoSalt){var n=this.cryptoSalt;return a.encrypt(e,n)}return e},e.prototype.decrypt=function(e){var t=null;try{if(!t&&this.fidjCrypto&&this.cryptoSaltNext){var n=this.cryptoSaltNext;t=a.decrypt(e,n),t=JSON.parse(t)}}catch(e){t=null}try{if(!t&&this.fidjCrypto&&this.cryptoSalt){n=this.cryptoSalt;t=a.decrypt(e,n),t=JSON.parse(t)}}catch(e){t=null}try{if(!t&&this.fidjCrypto&&this.cryptoSalt){n=this.cryptoSalt;t=a.decrypt(e,n,!0),t=JSON.parse(t)}}catch(e){t=null}try{t||(t=JSON.parse(e)),t&&t.string&&(t=t.string)}catch(e){t=null}return t},e.prototype.isLogin=function(){var e=!0;try{var t=this.refreshToken.split(".")[1],n=JSON.parse(s.decode(t));e=(new Date).getTime()/1e3>=n.exp}catch(e){}return!e},e.prototype.logout=function(){return this.getClient().logout(this.refreshToken)},e.prototype.getClientId=function(){return this.client?this.client.clientId:null},e.prototype.getIdToken=function(){return this.idToken},e.prototype.getIdPayload=function(e){var t=this.getIdToken();try{var n=void 0;if(t&&(n=t.split(".")[1]),n)return s.decode(n)}catch(t){this._logger.log("fidj.connection.getIdPayload pb: ",e,t)}return e?("string"!=typeof e&&(e=JSON.stringify(e)),e):null},e.prototype.getAccessPayload=function(e){e&&"string"!=typeof e&&(e=JSON.stringify(e));try{var t=this.accessToken.split(".")[1];if(t)return s.decode(t)}catch(e){}return e||null},e.prototype.getPreviousAccessPayload=function(e){e&&"string"!=typeof e&&(e=JSON.stringify(e));try{var t=this.accessTokenPrevious.split(".")[1];if(t)return s.decode(t)}catch(e){}return e||null},e.prototype.refreshConnection=function(){var t=this;if(this._storage.set(e._states,this.states),this.accessToken){var n=this.accessToken.split(".")[1],o=s.decode(n),i=(new Date).getTime()/1e3<JSON.parse(o).exp;if(this._logger.log("fidj.connection.connection.refreshConnection : token not expired ? ",i),i)return Promise.resolve(this.getUser())}if(this.refreshToken){n=this.refreshToken.split(".")[1],o=s.decode(n);var r=(new Date).getTime()/1e3>=JSON.parse(o).exp;this._logger.log("fidj.connection.connection.refreshConnection : refreshToken not expired ? ",r),r&&this._storage.remove(e._refreshToken)}return this.accessTokenPrevious=this.accessToken,this._storage.set("v2.accessTokenPrevious",this.accessTokenPrevious),this._storage.remove(e._accessToken),this._storage.remove(e._idToken),this.accessToken=null,this.idToken=null,this._logger.log("fidj.connection.connection.refreshConnection : refresh authentication."),new Promise((function(e,n){if(!t.getClient())return n(new d(400,"Need an initialized client."));t.getClient().reAuthenticate(t.refreshToken).then((function(n){t.setConnection(n),e(t.getUser())})).catch((function(e){n(e)}))}))},e.prototype.setConnection=function(t){if(t.access_token){this.accessToken=t.access_token,this._storage.set(e._accessToken,this.accessToken),delete t.access_token;var n=JSON.parse(this.getAccessPayload({salt:""})).salt;n&&this.setCryptoSalt(n)}t.id_token&&(this.idToken=t.id_token,this._storage.set(e._idToken,this.idToken),delete t.id_token),t.refresh_token&&(this.refreshToken=t.refresh_token,this._storage.set(e._refreshToken,this.refreshToken),delete t.refresh_token),this._storage.set(e._states,this.states),t.roles=JSON.parse(this.getIdPayload({roles:[]})).roles,t.message=JSON.parse(this.getIdPayload({message:""})).message,this.setUser(t)},e.prototype.setConnectionOffline=function(t){t.accessToken&&(this.accessToken=t.accessToken,this._storage.set(e._accessToken,this.accessToken)),t.idToken&&(this.idToken=t.idToken,this._storage.set(e._idToken,this.idToken)),t.refreshToken&&(this.refreshToken=t.refreshToken,this._storage.set(e._refreshToken,this.refreshToken)),this.setUser({roles:JSON.parse(this.getIdPayload({roles:[]})).roles,message:JSON.parse(this.getIdPayload({message:""})).message,_id:"demo"})},e.prototype.getApiEndpoints=function(e){var t=[{key:"fidj.default",url:"https://api.fidj.ovh/v3",blocked:!1}],n=[];if(this._sdk.prod||(t=[{key:"fidj.default",url:"http://localhost:3201/v3",blocked:!1},{key:"fidj.default",url:"https://fidj-sandbox.herokuapp.com/v3",blocked:!1}]),this.accessToken){var o,i=this.getAccessPayload({apis:[]});(o=JSON.parse(i).apis)&&o.length&&(t=[],o.forEach((function(e){e.url&&t.push(e)})))}this.accessTokenPrevious&&((o=JSON.parse(this.getPreviousAccessPayload({apis:[]})).apis)&&o.length&&o.forEach((function(e){e.url&&0===t.filter((function(t){return t.url===e.url})).length&&t.push(e)})));this._logger.log("fidj.sdk.connection.getApiEndpoints : ",t);var r=!0;if(this.states&&Object.keys(this.states).length)for(var s=0;s<t.length&&r;s++)this.states[t[s].url]||(r=!1);else r=!1;if(e&&e.filter)if(r&&"theBestOne"===e.filter)for(s=0;s<t.length&&0===n.length;s++){var c=t[s];this.states[c.url]&&this.states[c.url].state&&n.push(c)}else if(r&&"theBestOldOne"===e.filter){var a=void 0;for(s=0;s<t.length;s++){c=t[s];this.states[c.url]&&this.states[c.url].lastTimeWasOk&&(!a||this.states[c.url].lastTimeWasOk>this.states[a.url].lastTimeWasOk)&&(a=c)}a&&n.push(a)}else t.length&&n.push(t[0]);else n=t;return n},e.prototype.getDBs=function(e){if(!this.accessToken)return[];var t=Math.random()%2,n=JSON.parse(this.getAccessPayload({dbs:[]})).dbs||[];0===t?n=n.sort():1===t&&(n=n.reverse());var o=[],i=!0;if(this.states&&Object.keys(this.states).length)for(var r=0;r<n.length&&i;r++)this.states[n[r].url]||(i=!1);else i=!1;if(i&&e&&"theBestOne"===e.filter)for(r=0;r<n.length&&0===o.length;r++){var s=n[r];this.states[s.url]&&this.states[s.url].state&&o.push(s)}else if(i&&e&&"theBestOnes"===e.filter)for(r=0;r<n.length;r++){s=n[r];this.states[s.url]&&this.states[s.url].state&&o.push(s)}else e&&"theBestOne"===e.filter&&n.length?o.push(n[0]):o=n;return o},e.prototype.verifyApiState=function(e,t){return p(this,void 0,void 0,(function(){var n,o,i,r;return g(this,(function(s){switch(s.label){case 0:return s.trys.push([0,2,,3]),this._logger.log("fidj.sdk.connection.verifyApiState : ",e,t),[4,(new f).get({url:t+"/status?isOk="+this._sdk.version,headers:{"Content-Type":"application/json",Accept:"application/json"}})];case 1:return n=s.sent(),o=!1,n&&n.isOk&&(o=!0),this.states[t]={state:o,time:e,lastTimeWasOk:e},this._logger.log("fidj.sdk.connection.verifyApiState > states : ",this.states),[3,3];case 2:return i=s.sent(),r=0,this.states[t]&&(r=this.states[t].lastTimeWasOk),this.states[t]={state:!1,time:e,lastTimeWasOk:r},this._logger.log("fidj.sdk.connection.verifyApiState > catch pb  - states : ",i,this.states),[3,3];case 3:return[2]}}))}))},e.prototype.verifyDbState=function(e,t){return p(this,void 0,void 0,(function(){var n;return g(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,(new f).get({url:t,headers:{"Content-Type":"application/json",Accept:"application/json"}})];case 1:return o.sent(),this.states[t]={state:!0,time:e,lastTimeWasOk:e},[3,3];case 2:return o.sent(),n=0,this.states[t]&&(n=this.states[t].lastTimeWasOk),this.states[t]={state:!1,time:e,lastTimeWasOk:n},[3,3];case 3:return[2]}}))}))},e.prototype.verifyConnectionStates=function(){var e=this,t=(new Date).getTime(),n=[];return this.apis=this.getApiEndpoints(),this.apis.forEach((function(o){var i=o.url;i||(i=o.toString()),n.push(e.verifyApiState(t,i))})),this.getDBs().forEach((function(o){var i=o.url;i||(i=o.toString()),n.push(e.verifyDbState(t,i))})),Promise.all(n)},e}();if(v._accessToken="v2.accessToken",v._accessTokenPrevious="v2.accessTokenPrevious",v._idToken="v2.idToken",v._refreshToken="v2.refreshToken",v._states="v2.states",v._cryptoSalt="v2.cryptoSalt",v._cryptoSaltNext="v2.cryptoSalt.next","undefined"!=typeof window){y=window.PouchDB?window.PouchDB:require("pouchdb").default;var j=require("pouchdb-adapter-cordova-sqlite");y.plugin(j)}var m=function(){function e(){this.db=null,this.dbRecordCount=0,this.dbLastSync=null,this.remoteDb=null,this.dbs=[]}return e.prototype.isReady=function(){return!!this.db},e.prototype.create=function(e,t){var n=this;return!t&&this.db?Promise.resolve(this.db):(this.dbRecordCount=0,this.dbLastSync=null,this.db=null,e=e||"default","undefined"==typeof window?Promise.resolve(this.db):new Promise((function(t,o){var i={location:"default"};try{window.cordova&&(i={location:"default",adapter:"cordova-sqlite"}),n.db=new y("fidj_db_"+e,i),n.db.info().then((function(e){return t(n.db)})).catch((function(e){o(new d(400,e))}))}catch(e){o(new d(500,e))}})))},e.prototype.destroy=function(){var e=this;return this.db?this.db&&!this.db.destroy?Promise.reject(new d(408,"Need a valid db")):new Promise((function(t,n){e.db.destroy((function(o,i){o?n(new d(500,o)):(e.dbRecordCount=0,e.dbLastSync=null,e.db=null,t())}))})):(this.dbRecordCount=0,this.dbLastSync=null,Promise.resolve())},e.prototype.setRemote=function(e){this.dbs=e},e.prototype.sync=function(e){var t=this;return this.db?this.dbs&&this.dbs.length?new Promise((function(n,o){try{t.remoteDb&&t.remoteUri===t.dbs[0].url||(t.remoteUri=t.dbs[0].url,t.remoteDb=new y(t.remoteUri)),t.db.replicate.to(t.remoteDb).on("complete",(function(i){return t.remoteDb.replicate.to(t.db,{filter:function(t){return!!e&&!!t&&t.fidjUserId===e}}).on("complete",(function(){n()})).on("denied",(function(e){return o({code:403,reason:{second:e}})})).on("error",(function(e){return o({code:401,reason:{second:e}})}))})).on("denied",(function(e){return o({code:403,reason:{first:e}})})).on("error",(function(e){return o({code:401,reason:{first:e}})}))}catch(e){o(new d(500,e))}})):Promise.reject(new d(408,"need a remote db")):Promise.reject(new d(408,"need db"))},e.prototype.put=function(t,n,o,i,r,s){var c=this;if(!this.db)return Promise.reject(new d(408,"need db"));if(!(t&&n&&o&&i&&r))return Promise.reject(new d(400,"need formated data"));var a=JSON.parse(JSON.stringify(t)),u={_id:n,fidjUserId:o,fidjOrgId:i,fidjAppVersion:r};a._rev&&(u._rev=""+a._rev),delete a._id,delete a._rev,delete a.fidjUserId,delete a.fidjOrgId,delete a.fidjAppVersion,delete a.fidjData;var l=e.write(e.value(a));return s?(l=s.obj[s.method](l),u.fidjDacr=l):u.fidjData=l,new Promise((function(e,n){c.db.put(u,(function(o,i){i&&i.ok&&i.id&&i.rev?(c.dbRecordCount++,"object"==typeof t?(t._rev=i.rev,t._id=i.id,e(t)):e(i.id)):n(new d(500,o))}))}))},e.prototype.remove=function(e){var t=this;return this.db?new Promise((function(n,o){t.db.get(e).then((function(e){return e._deleted=!0,t.db.put(e)})).then((function(e){n()})).catch((function(e){o(e)}))})):Promise.reject(new d(408,"need db"))},e.prototype.get=function(t,n){var o=this;return this.db?new Promise((function(i,r){o.db.get(t).then((function(t){if(t&&(t.fidjDacr||t.fidjData)){var s=t.fidjDacr;n&&s?s=n.obj[n.method](s):t.fidjData&&(s=JSON.parse(t.fidjData));var c=e.extractJson(s);c?(c._id=t._id,c._rev=t._rev,i(JSON.parse(JSON.stringify(c)))):(o.remove(t._id),r(new d(400,"Bad encoding")))}else r(new d(400,"No data found"))})).catch((function(e){return r(new d(500,e))}))})):Promise.reject(new d(408,"Need db"))},e.prototype.getAll=function(t){var n=this;return this.db&&this.db.allDocs?new Promise((function(o,i){n.db.allDocs({include_docs:!0,descending:!0}).then((function(i){var r=[];i.rows.forEach((function(o){if(o&&o.doc._id&&(o.doc.fidjDacr||o.doc.fidjData)){var i=o.doc.fidjDacr;t&&i?i=t.obj[t.method](i):o.doc.fidjData&&(i=JSON.parse(o.doc.fidjData));var s=e.extractJson(i);s?(s._id=o.doc._id,s._rev=o.doc._rev,r.push(JSON.parse(JSON.stringify(s)))):(console.error("Bad encoding : delete row"),n.remove(o.doc._id))}else console.error("Bad encoding")})),o(r)})).catch((function(e){return i(new d(400,e))}))})):Promise.reject(new d(408,"Need a valid db"))},e.prototype.isEmpty=function(){var e=this;return this.db&&this.db.allDocs?new Promise((function(t,n){e.db.allDocs({}).then((function(o){o?(e.dbRecordCount=o.total_rows,o.total_rows&&o.total_rows>0?t(!1):t(!0)):n(new d(400,"No response"))})).catch((function(e){return n(new d(400,e))}))})):Promise.reject(new d(408,"No db"))},e.prototype.info=function(){return this.db?this.db.info():Promise.reject(new d(408,"No db"))},e.write=function(e){var t="null",n=typeof e;return"undefined"===n||null===t?t="null":"string"===n?t=JSON.stringify({string:e}):"number"===n?t=JSON.stringify({number:e}):"boolean"===n?t=JSON.stringify({bool:e}):"object"===n&&(t=JSON.stringify({json:e})),t},e.value=function(e){var t=e;return"object"!=typeof e||("string"in e?t=e.string:"number"in e?t=e.number.valueOf():"bool"in e?t=e.bool.valueOf():"json"in e&&"object"!=typeof(t=e.json)&&(t=JSON.parse(t))),t},e.extractJson=function(e){var t=e;return e?("object"==typeof e&&"json"in e&&(t=e.json),"string"==typeof t&&(t=JSON.parse(t)),"object"==typeof t&&"json"in t&&(t=t.json),"object"!=typeof t&&(t=null),t):null},e}(),k=function(){function t(t){this.level=t,t||(this.level=e.LoggerLevelEnum.ERROR),"undefined"==typeof console&&(this.level=e.LoggerLevelEnum.NONE)}return t.prototype.log=function(t,n){this.level===e.LoggerLevelEnum.INFO&&console.log(t,n)},t.prototype.warn=function(t,n){this.level!==e.LoggerLevelEnum.INFO&&this.level!==e.LoggerLevelEnum.WARN||console.warn(t,n)},t.prototype.error=function(t,n){this.level!==e.LoggerLevelEnum.INFO&&this.level!==e.LoggerLevelEnum.WARN&&this.level!==e.LoggerLevelEnum.ERROR||console.error(t,n)},t.prototype.setLevel=function(e){this.level=e},t}(),b=require("url-join"),S=function(){function t(e,t,n){var o;this.sdk={org:"fidj",version:"3.3.0",prod:!1,useDB:!0},t&&(this.promise=t),this.logger=e||new k,n&&n.logLevel&&this.logger.setLevel(n.logLevel),this.logger.log("fidj.sdk.service : constructor"),"undefined"!=typeof window?o=window.localStorage:"undefined"!=typeof global&&(require("localstorage-polyfill"),o=global.localStorage),this.storage=new c(o,"fidj."),this.session=new m,this.connection=new v(this.sdk,this.storage,this.logger)}return t.prototype.fidjInit=function(t,n){var o=this;return n&&n.logLevel?o.logger.setLevel(n.logLevel):o.logger.setLevel(e.LoggerLevelEnum.NONE),o.logger.log("fidj.sdk.service.fidjInit : ",n),t?(o.sdk.prod=!n||n.prod,o.sdk.useDB=!!n&&n.useDB,o.connection.fidjId=t,o.connection.fidjVersion=o.sdk.version,o.connection.fidjCrypto=!(!n||!n.hasOwnProperty("crypto"))&&n.crypto,new o.promise((function(e,t){o.connection.verifyConnectionStates().then((function(){var n=o.connection.getApiEndpoints({filter:"theBestOne"})[0],i=o.connection.getApiEndpoints({filter:"theBestOldOne"})[0],r=o.fidjIsLogin();o.logger.log("fidj.sdk.service.fidjInit > verifyConnectionStates : ",n,i,r),n&&n.url&&(n=n.url),i&&i.url&&(i=i.url),n?(o.connection.setClient(new h(o.connection.fidjId,n,o.storage,o.sdk)),e()):r&&i?(o.connection.setClient(new h(o.connection.fidjId,i,o.storage,o.sdk)),e()):t(new d(404,"Need one connection - or too old SDK version (check update)"))})).catch((function(e){o.logger.error("fidj.sdk.service.fidjInit: ",e),t(new d(500,e.toString()))}))}))):(o.logger.error("fidj.sdk.service.fidjInit : bad init"),o.promise.reject(new d(400,"Need a fidjId")))},t.prototype.fidjLogin=function(e,t){var n=this;return n.logger.log("fidj.sdk.service.fidjLogin"),n.connection.isReady()?new n.promise((function(o,i){n._removeAll().then((function(){return n.connection.verifyConnectionStates()})).then((function(){return n._createSession(n.connection.fidjId)})).then((function(){return n._loginInternal(e,t)})).then((function(e){n.connection.setConnection(e),n.sdk.useDB?n.session.sync(n.connection.getClientId()).then((function(){return o(n.connection.getUser())})).catch((function(e){return o(n.connection.getUser())})):o(n.connection.getUser())})).catch((function(e){n.logger.error("fidj.sdk.service.fidjLogin: ",e.toString()),i(e)}))})):n.promise.reject(new d(404,"Need an intialized FidjService"))},t.prototype.fidjLoginInDemoMode=function(e){var t=this;if(!e||!e.accessToken){var n=new Date;n.setDate(n.getDate()+1);var o=n.getTime(),i=s.encode(JSON.stringify({roles:[],message:"demo",apis:[],endpoints:[],dbs:[],exp:o})),r=s.encode(JSON.stringify({})),c=r+"."+i+"."+r;e={accessToken:c,idToken:c,refreshToken:c}}return new t.promise((function(n,o){t._removeAll().then((function(){return t._createSession(t.connection.fidjId)})).then((function(){t.connection.setConnectionOffline(e),n(t.connection.getUser())})).catch((function(e){t.logger.error("fidj.sdk.service.fidjLoginInDemoMode error: ",e),o(e)}))}))},t.prototype.fidjGetEndpoints=function(e){e||(e={showBlocked:!1});var t=this.connection.getAccessPayload({endpoints:[]}),n=JSON.parse(t).endpoints;return n&&Array.isArray(n)?n=n.filter((function(t){var n=!0;return n&&e.key&&(n=t.key===e.key),n&&!e.showBlocked&&(n=!t.blocked),n})):[]},t.prototype.fidjRoles=function(){return JSON.parse(this.connection.getIdPayload({roles:[]})).roles},t.prototype.fidjMessage=function(){return JSON.parse(this.connection.getIdPayload({message:""})).message},t.prototype.fidjIsLogin=function(){return this.connection.isLogin()},t.prototype.fidjLogout=function(e){var t=this,n=this;return n.connection.getClient()||e?n.connection.logout().then((function(){return n._removeAll()})).catch((function(){return n._removeAll()})).then((function(){return t.session.create(n.connection.fidjId,!0)})):n._removeAll().then((function(){return t.session.create(n.connection.fidjId,!0)}))},t.prototype.fidjSync=function(e,t){var n=this,o=this;if(o.logger.log("fidj.sdk.service.fidjSync"),!o.sdk.useDB)return o.logger.log("fidj.sdk.service.fidjSync: you ar not using DB - no sync available."),Promise.resolve();var i=null===o.session.dbLastSync;return new o.promise((function(r,s){o._createSession(o.connection.fidjId).then((function(){return o.session.sync(o.connection.getClientId())})).then((function(){return o.logger.log("fidj.sdk.service.fidjSync resolved"),o.session.isEmpty()})).catch((function(e){return o.logger.warn("fidj.sdk.service.fidjSync warn: ",e),o.session.isEmpty()})).then((function(n){return o.logger.log("fidj.sdk.service.fidjSync isEmpty : ",n,i),new o.promise((function(r,c){if(n&&i&&e){var a=e(t);a&&a.catch instanceof Function&&a.then(r).catch(s),"string"==typeof a&&o.logger.log(a)}r()}))})).then((function(e){return o.logger.log("fidj.sdk.service.fidjSync fnInitFirstData resolved: ",e),o.session.dbLastSync=(new Date).getTime(),o.session.info()})).then((function(e){return o.session.dbRecordCount=0,e&&e.doc_count&&(o.session.dbRecordCount=e.doc_count),o.logger.log("fidj.sdk.service.fidjSync _dbRecordCount : "+o.session.dbRecordCount),o.connection.refreshConnection()})).then((function(e){o.logger.log("fidj.sdk.service.fidjSync refreshConnection done : ",e),r()})).catch((function(e){if(o.logger.warn("fidj.sdk.service.fidjSync refreshConnection failed : ",e),!e||403!==e.code&&410!==e.code)if(e&&e.code)r();else{var t="Error during synchronisation: "+e.toString();o.logger.error(t),s({code:500,reason:t})}else n.fidjLogout().then((function(){s({code:403,reason:"Synchronization unauthorized : need to login again."})})).catch((function(){s({code:403,reason:"Synchronization unauthorized : need to login again.."})}))}))}))},t.prototype.fidjPutInDb=function(e){var t,n,o=this;return o.logger.log("fidj.sdk.service.fidjPutInDb: ",e),o.sdk.useDB?o.connection.getClientId()?o.session.isReady()?(e&&"object"==typeof e&&Object.keys(e).indexOf("_id")&&(t=e._id),t||(t=o._generateObjectUniqueId(o.connection.fidjId)),o.connection.fidjCrypto&&(n={obj:o.connection,method:"encrypt"}),o.session.put(e,t,o.connection.getClientId(),o.sdk.org,o.connection.fidjVersion,n)):o.promise.reject(new d(400,"Need to be synchronised.")):o.promise.reject(new d(401,"DB put impossible. Need a user logged in.")):(o.logger.log("fidj.sdk.service.fidjPutInDb: you are not using DB - no put available."),Promise.resolve("NA"))},t.prototype.fidjRemoveInDb=function(e){var t=this;return t.logger.log("fidj.sdk.service.fidjRemoveInDb ",e),t.sdk.useDB?t.session.isReady()?e&&"string"==typeof e?t.session.remove(e):t.promise.reject(new d(400,"DB remove impossible. Need the data._id.")):t.promise.reject(new d(400,"Need to be synchronised.")):(t.logger.log("fidj.sdk.service.fidjRemoveInDb: you are not using DB - no remove available."),Promise.resolve())},t.prototype.fidjFindInDb=function(e){var t,n=this;return n.sdk.useDB?n.connection.getClientId()?n.session.isReady()?(n.connection.fidjCrypto&&(t={obj:n.connection,method:"decrypt"}),n.session.get(e,t)):n.promise.reject(new d(400," Need to be synchronised.")):n.promise.reject(new d(401,"Find pb : need a user logged in.")):(n.logger.log("fidj.sdk.service.fidjFindInDb: you are not using DB - no find available."),Promise.resolve())},t.prototype.fidjFindAllInDb=function(){var e,t=this;return t.sdk.useDB?t.connection.getClientId()?t.session.isReady()?(t.connection.fidjCrypto&&(e={obj:t.connection,method:"decrypt"}),t.session.getAll(e).then((function(e){return t.connection.setCryptoSaltAsVerified(),t.promise.resolve(e)}))):t.promise.reject(new d(400,"Need to be synchronised.")):t.promise.reject(new d(401,"Need a user logged in.")):(t.logger.log("fidj.sdk.service.fidjFindAllInDb: you are not using DB - no find available."),Promise.resolve([]))},t.prototype.fidjSendOnEndpoint=function(e,t,n,o){var i={key:e},r=this.fidjGetEndpoints(i);if(!r||1!==r.length)return this.promise.reject(new d(400,"fidj.sdk.service.fidjSendOnEndpoint : endpoint does not exist."));var s=r[0].url;n&&(s=b(s,n));var c,a=this.connection.getIdToken(),u=new f;switch(t){case"POST":c=u.post({url:s,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+a},data:o});break;case"PUT":c=u.put({url:s,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+a},data:o});break;case"DELETE":c=u.delete({url:s,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+a}});break;default:c=u.get({url:s,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+a}})}return c},t.prototype.fidjGetIdToken=function(){return this.connection.getIdToken()},t.prototype._loginInternal=function(e,t,n){var o=this;return o.logger.log("fidj.sdk.service._loginInternal"),o.connection.isReady()?new o.promise((function(i,r){o.connection.logout().then((function(){return o.connection.getClient().login(e,t,n)})).catch((function(i){return o.connection.getClient().login(e,t,n)})).then((function(t){t.email=e,i(t)})).catch((function(e){o.logger.error("fidj.sdk.service._loginInternal error : "+e),r(e)}))})):o.promise.reject(new d(403,"Need an intialized FidjService"))},t.prototype._removeAll=function(){return this.connection.destroy(),this.session.destroy()},t.prototype._createSession=function(e){var t=this.connection.getDBs({filter:"theBestOnes"});return t&&0!==t.length||this.logger.warn("Seems that you are in Demo mode or using Node (no remote DB)."),this.session.setRemote(t),this.session.create(e)},t.prototype._testPromise=function(e){return e?this.promise.resolve("test promise ok "+e):new this.promise((function(e,t){e("test promise ok")}))},t.prototype._generateObjectUniqueId=function(e,n,o){var i=new Date,r=""+i.getFullYear()+i.getMonth()+i.getDate()+i.getHours()+i.getMinutes(),s=++t._srvDataUniqId,c="";return e&&e.charAt(0)&&(c+=e.charAt(0)+""),n&&n.length>3&&(c+=n.substring(0,4)),o&&o.length>3&&(c+=o.substring(0,4)),c+=r+""+s},t}();S._srvDataUniqId=0;var _=function(){function t(){this.logger=new k(e.LoggerLevelEnum.ERROR),this.promise=Promise,this.fidjService=null}return t.prototype.init=function(e,t){return this.fidjService||(this.fidjService=new S(this.logger,this.promise)),this.fidjService.fidjInit(e,t)},t.prototype.login=function(e,t){return this.fidjService?this.fidjService.fidjLogin(e,t):this.promise.reject(new d(303,"fidj.sdk.angular.login : not initialized."))},t.prototype.loginAsDemo=function(e){return this.fidjService?this.fidjService.fidjLoginInDemoMode(e):this.promise.reject(new d(303,"fidj.sdk.angular.loginAsDemo : not initialized."))},t.prototype.isLoggedIn=function(){return!!this.fidjService&&this.fidjService.fidjIsLogin()},t.prototype.getRoles=function(){return this.fidjService?this.fidjService.fidjRoles():[]},t.prototype.getEndpoints=function(){return this.fidjService?this.fidjService.fidjGetEndpoints():[]},t.prototype.sendOnEndpoint=function(e,t,n,o){return this.fidjService?this.fidjService.fidjSendOnEndpoint(e,t,n,o):this.promise.reject(new d(303,"fidj.sdk.angular.loginAsDemo : not initialized."))},t.prototype.getIdToken=function(){if(this.fidjService)return this.fidjService.fidjGetIdToken()},t.prototype.getMessage=function(){return this.fidjService?this.fidjService.fidjMessage():""},t.prototype.logout=function(e){return e||!this.fidjService?this.promise.reject(new d(303,"fidj.sdk.angular.logout : not initialized.")):this.fidjService.fidjLogout(e)},t.prototype.sync=function(e){return this.fidjService?this.fidjService.fidjSync(e,this):this.promise.reject(new d(401,"fidj.sdk.angular.sync : not initialized."))},t.prototype.put=function(e){return this.fidjService?this.fidjService.fidjPutInDb(e):this.promise.reject(new d(401,"fidj.sdk.angular.put : not initialized."))},t.prototype.remove=function(e){return this.fidjService?this.fidjService.fidjRemoveInDb(e):this.promise.reject(new d(401,"fidj.sdk.angular.remove : not initialized."))},t.prototype.find=function(e){return this.fidjService?this.fidjService.fidjFindInDb(e):this.promise.reject(new d(401,"fidj.sdk.angular.find : not initialized."))},t.prototype.findAll=function(){return this.fidjService?this.fidjService.fidjFindAllInDb():this.promise.reject(new d(401,"fidj.sdk.angular.findAll : not initialized."))},t}();_.ɵprov=r.ɵɵdefineInjectable({factory:function(){return new _},token:_,providedIn:"root"}),_.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],_.ctorParameters=function(){return[]},e.Base64=s,e.Error=d,e.FidjModule=u,e.FidjService=_,e.LocalStorage=c,e.Xor=a,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=fidj.umd.min.js.map