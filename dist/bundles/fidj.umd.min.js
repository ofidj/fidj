!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common")):"function"==typeof define&&define.amd?define("fidj",["exports","@angular/core","@angular/common"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).fidj={},e.ng.core,e.ng.common)}(this,(function(e,t,n){"use strict";function o(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var o=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,o.get?o:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var r,i=o(t),s=function(){function e(){}return e.encode=function(e){return e?("undefined"!=typeof window?window.btoa:require("btoa"))(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode(parseInt("0x"+t,16))}))):null},e.decode=function(e){if(!e)return null;var t="undefined"!=typeof window?window.atob:require("atob");return decodeURIComponent(t(e).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""))},e}(),a=function(){function e(e,t){if(this.storageKey=t,this.version="0.1",this.storage=e||window.localStorage,!this.storage)throw new Error("fidj.LocalStorageFactory needs a storageService!")}return e.prototype.set=function(e,t){e=this.storageKey+e,this.checkKey(e);var n=typeof t;if("undefined"===n)t="null";else if(null===t)t="null";else if("string"===n)t=JSON.stringify({string:t});else if("number"===n)t=JSON.stringify({number:t});else if("boolean"===n)t=JSON.stringify({bool:t});else{if("object"!==n)throw new TypeError("Value type "+n+" is invalid. It must be null, undefined, xml, string, number, boolean or object");t=JSON.stringify({json:t})}return this.storage.setItem(e,t),t},e.prototype.get=function(e,t){e=this.storageKey+e,this.checkKey(e);var n=this.storage.getItem(e);if(null!==n){if("null"===n)return null;var o=JSON.parse(n);return"string"in o?o.string:"number"in o?o.number.valueOf():"bool"in o?o.bool.valueOf():o.json}return t||null},e.prototype.remove=function(e){e=this.storageKey+e,this.checkKey(e);var t=null!==this.storage.getItem(e);return this.storage.removeItem(e),t},e.prototype.clear=function(){var e=this.storage.length>0;return this.storage.clear(),e},e.prototype.size=function(){return this.storage.length},e.prototype.foreach=function(e,t){for(var n=this.storage.length,o=0;o<n;o++){var r=this.storage.key(o),i=this.get(r);t?e.call(t,i):e(i)}return n},e.prototype.checkKey=function(e){if(!e||"string"!=typeof e)throw new TypeError("Key type must be string");return!0},e}(),c=function(){function e(){}return e.encrypt=function(t,n){var o="";t=e.header+t;for(var r=0;r<t.length;r++)o+=String.fromCharCode(t[r].charCodeAt(0).toString(10)^e.keyCharAt(n,r));return o=s.encode(o)},e.decrypt=function(t,n,o){var r="";t=s.decode(t);for(var i=0;i<t.length;i++)r+=String.fromCharCode(t[i].charCodeAt(0).toString(10)^e.keyCharAt(n,i));return o||e.header===r.substring(0,e.header.length)?(o||(r=r.substring(e.header.length)),r):null},e.keyCharAt=function(e,t){return e[Math.floor(t%e.length)].charCodeAt(0).toString(10)},e}();c.header="artemis-lotsum",e.LoggerLevelEnum=void 0,(r=e.LoggerLevelEnum||(e.LoggerLevelEnum={}))[r.INFO=1]="INFO",r[r.WARN=2]="WARN",r[r.ERROR=3]="ERROR",r[r.NONE=4]="NONE";var d=function(){function e(e,t){this.code=e,this.reason=t}return e.prototype.equals=function(e){return this.code===e.code&&this.reason===e.reason},e.prototype.toString=function(){var e="string"==typeof this.reason?this.reason:JSON.stringify(this.reason);return this.code+" - "+e},e}(),u=function(){};u.decorators=[{type:t.NgModule,args:[{imports:[n.CommonModule],declarations:[],exports:[]}]}],u.ctorParameters=function(){return[]};function l(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))}function f(e,t){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){s.label=i[1];break}if(6===i[0]&&s.label<r[1]){s.label=r[1],r=i;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(i);break}r[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}Object.create;Object.create;var h,p=function(e,t,n,o){this.username=e,this.accessToken=t,this.idToken=n,this.refreshToken=o},g=function(e,t,n,o){this.id=e,this.username=t,this.roles=n};!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.TIMEOUT=1]="TIMEOUT",e[e.STATUS=2]="STATUS"}(h||(h={}));var y=function(){function e(){this.xhr=require("axios")}return e.formatResponseData=function(e){for(var t=e;t&&t.data;)t=t.data;try{t=JSON.parse(t+"")}catch(e){}return t},e.formatError=function(e){var t={reason:h.UNKNOWN,status:-1,code:-1,message:""};return e.status&&(t.reason=h.STATUS,t.status=parseInt(e.status,10),t.code=parseInt(e.status,10)),e.response?(t.message=e.response,e.response.status?(t.reason=h.STATUS,t.status=parseInt(e.response.status,10),t.code=parseInt(e.response.status,10)):null===e.response.status&&(t.reason=h.TIMEOUT,t.status=408,t.code=408)):e.request?t.message=e.request:e.message&&(t.message=e.message),t},e.prototype.post=function(t){var n={method:"POST",url:t.url,data:JSON.stringify(t.data)};return t.headers&&(n.headers=t.headers),this.xhr.post(n.url,n.data,{headers:n.headers}).then((function(t){return t.status&&(parseInt(t.status,10)<200||parseInt(t.status,10)>=300)?Promise.reject(e.formatError(t)):Promise.resolve(e.formatResponseData(t))})).catch((function(t){return Promise.reject(e.formatError(t))}))},e.prototype.put=function(t){var n={method:"PUT",url:t.url,data:JSON.stringify(t.data)};return t.headers&&(n.headers=t.headers),this.xhr.put(n.url,n.data,{headers:n.headers,timeout:1e4}).then((function(t){return t.status&&(parseInt(t.status,10)<200||parseInt(t.status,10)>=300)?Promise.reject(e.formatError(t)):Promise.resolve(e.formatResponseData(t))})).catch((function(t){return Promise.reject(e.formatError(t))}))},e.prototype.delete=function(t){var n={method:"DELETE",url:t.url,data:JSON.stringify(t.data)};return t.headers&&(n.headers=t.headers),this.xhr.delete(n.url,{headers:n.headers,timeout:1e4}).then((function(t){return t.status&&(parseInt(t.status,10)<200||parseInt(t.status,10)>=300)?Promise.reject(e.formatError(t)):Promise.resolve(e.formatResponseData(t))})).catch((function(t){return Promise.reject(e.formatError(t))}))},e.prototype.get=function(t){var n={method:"GET",url:t.url};return t.data&&(n.data=t.data),t.headers&&(n.headers=t.headers),this.xhr.get(n.url,{headers:n.headers,timeout:1e4}).then((function(t){return t.status&&(parseInt(t.status,10)<200||parseInt(t.status,10)>=300)?Promise.reject(e.formatError(t)):Promise.resolve(e.formatResponseData(t))})).catch((function(t){return Promise.reject(e.formatError(t))}))},e}(),v=function(){function e(t,n,o,r){this.appId=t,this.URI=n,this.storage=o,this.sdk=r;var i=this.storage.get(e._clientUuid)||"uuid-"+Math.random(),s="_clientInfo";"undefined"!=typeof window&&window.navigator&&(s=window.navigator.appName+"@"+window.navigator.appVersion+"-"+window.navigator.userAgent),"undefined"!=typeof window&&window.device&&window.device.uuid&&(i=window.device.uuid),this.setClientUuid(i),this.setClientInfo(s),this.clientId=this.storage.get(e._clientId),e.refreshCount=this.storage.get(e._refreshCount)||e.refreshCountInitial}return e.prototype.setClientId=function(t){this.clientId=""+t,this.storage.set(e._clientId,this.clientId)},e.prototype.setClientUuid=function(t){this.clientUuid=""+t,this.storage.set(e._clientUuid,this.clientUuid)},e.prototype.setClientInfo=function(e){this.clientInfo=""+e},e.prototype.login=function(e,t,n){return l(this,void 0,void 0,(function(){var n,o,r,i,a,c,d;return f(this,(function(u){switch(u.label){case 0:return this.URI?(n=this.URI+"/users",o={name:e,username:e,email:e,password:t},[4,(new y).post({url:n,data:o,headers:{"Content-Type":"application/json",Accept:"application/json"}})]):(console.error("no api uri"),[2,Promise.reject({code:408,reason:"no-api-uri"})]);case 1:return u.sent().user,this.setClientId(e),r=this.URI+"/apps/"+this.appId+"/tokens",i={grant_type:"access_token",client_udid:this.clientUuid,client_info:this.clientInfo,scope:JSON.stringify(this.sdk)},[4,(new y).post({url:r,data:i,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Basic "+s.encode(e+":"+t)}})];case 2:return a=u.sent().token,i.grant_type="id_token",[4,(new y).post({url:r,data:i,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+a.data}})];case 3:return c=u.sent().token,i.grant_type="refresh_token",[4,(new y).post({url:r,data:i,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+a.data}})];case 4:return d=u.sent().token,[2,new p(e,a,c,d)]}}))}))},e.prototype.reAuthenticate=function(t){var n=this;if(!this.URI)return console.error("no api uri"),Promise.reject({code:408,reason:"no-api-uri"});var o=this.URI+"/me/tokens",r={grant_type:"refresh_token",client_udid:this.clientUuid,client_info:this.clientInfo,scope:JSON.stringify(this.sdk),refreshCount:e.refreshCount};return(new y).post({url:o,data:r,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+t}}).then((function(t){return e.refreshCount++,n.storage.set(e._refreshCount,e.refreshCount),Promise.resolve(t)}))},e.prototype.logout=function(t){if(!this.URI)return console.error("no api uri"),Promise.reject({code:408,reason:"no-api-uri"});if(this.storage.remove(e._clientId),this.storage.remove(e._refreshCount),e.refreshCount=e.refreshCountInitial,!t||!this.clientId)return Promise.resolve();var n=this.URI+"/me/tokens",o={token:t,client_udid:this.clientUuid,client_info:this.clientInfo,scope:JSON.stringify(this.sdk)};return(new y).delete({url:n,data:o,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+t}})},e.prototype.isReady=function(){return!!this.URI},e}();v.refreshCountInitial=1,v.refreshCount=v.refreshCountInitial,v._clientUuid="v2.clientUuid",v._clientId="v2.clientId",v._refreshCount="v2.refreshCount";var j,m=function(){function e(t,n,o){this._sdk=t,this._storage=n,this._logger=o,this.client=null,this.user=null,this.cryptoSalt=this._storage.get(e._cryptoSalt)||null,this.cryptoSaltNext=this._storage.get(e._cryptoSaltNext)||null,this.accessToken=this._storage.get(e._accessToken)||null,this.accessTokenPrevious=this._storage.get("v2.accessTokenPrevious")||null,this.idToken=this._storage.get(e._idToken)||null,this.refreshToken=this._storage.get(e._refreshToken)||null,this.states=this._storage.get(e._states)||{},this.apis=[]}return e.prototype.isReady=function(){return!!this.client&&this.client.isReady()},e.prototype.destroy=function(t){this._storage.remove(e._accessToken),this._storage.remove(e._idToken),this._storage.remove(e._refreshToken),this._storage.remove(e._states),this.accessToken&&(this.accessTokenPrevious=this.accessToken,this._storage.set(e._accessTokenPrevious,this.accessTokenPrevious)),t&&(this._storage.remove(e._cryptoSalt),this._storage.remove(e._cryptoSaltNext),this._storage.remove(e._accessTokenPrevious)),this.user=null,this.client&&this.client.logout(),this.accessToken=null,this.idToken=null,this.refreshToken=null,this.states={}},e.prototype.setClient=function(e){this.client=e},e.prototype.setUser=function(e){this.user=e,this.client&&this.user.id&&this.client.setClientId(this.user.id)},e.prototype.getUser=function(){return this.user},e.prototype.getClient=function(){return this.client},e.prototype.setCryptoSalt=function(t){this.cryptoSalt!==t&&this.cryptoSaltNext!==t&&(this.cryptoSaltNext=t,this._storage.set(e._cryptoSaltNext,this.cryptoSaltNext)),this.cryptoSalt||this.setCryptoSaltAsVerified()},e.prototype.setCryptoSaltAsVerified=function(){this.cryptoSaltNext&&(this.cryptoSalt=this.cryptoSaltNext,this._storage.set(e._cryptoSalt,this.cryptoSalt)),this.cryptoSaltNext=null,this._storage.remove(e._cryptoSaltNext)},e.prototype.encrypt=function(e){if("string"!=typeof e)e=JSON.stringify(e);else{var t={string:e};e=JSON.stringify(t)}if(this.fidjCrypto&&this.cryptoSalt){var n=this.cryptoSalt;return c.encrypt(e,n)}return e},e.prototype.decrypt=function(e){var t=null;try{if(!t&&this.fidjCrypto&&this.cryptoSaltNext){var n=this.cryptoSaltNext;t=c.decrypt(e,n),t=JSON.parse(t)}}catch(e){t=null}try{if(!t&&this.fidjCrypto&&this.cryptoSalt){n=this.cryptoSalt;t=c.decrypt(e,n),t=JSON.parse(t)}}catch(e){t=null}try{if(!t&&this.fidjCrypto&&this.cryptoSalt){n=this.cryptoSalt;t=c.decrypt(e,n,!0),t=JSON.parse(t)}}catch(e){t=null}try{t||(t=JSON.parse(e)),t&&t.string&&(t=t.string)}catch(e){t=null}return t},e.prototype.isLogin=function(){var e=!0;try{var t=this.refreshToken.split(".")[1],n=JSON.parse(s.decode(t));e=(new Date).getTime()/1e3>=n.exp}catch(e){}return!e},e.prototype.logout=function(){return this.getClient().logout(this.refreshToken)},e.prototype.getClientId=function(){return this.client?this.client.clientId:null},e.prototype.getIdToken=function(){return this.idToken},e.prototype.getIdPayload=function(e){var t=this.getIdToken();try{var n=void 0;if(t&&(n=t.split(".")[1]),n)return s.decode(n)}catch(t){this._logger.log("fidj.connection.getIdPayload pb: ",e,t)}return e?("string"!=typeof e&&(e=JSON.stringify(e)),e):null},e.prototype.getAccessPayload=function(e){e&&"string"!=typeof e&&(e=JSON.stringify(e));try{var t=this.accessToken.split(".")[1];if(t)return s.decode(t)}catch(e){}return e||null},e.prototype.getPreviousAccessPayload=function(e){e&&"string"!=typeof e&&(e=JSON.stringify(e));try{var t=this.accessTokenPrevious.split(".")[1];if(t)return s.decode(t)}catch(e){}return e||null},e.prototype.refreshConnection=function(){var t=this;if(this._storage.set(e._states,this.states),this.accessToken){var n=this.accessToken.split(".")[1],o=s.decode(n),r=(new Date).getTime()/1e3<JSON.parse(o).exp;if(this._logger.log("fidj.connection.connection.refreshConnection : token not expired ? ",r),r)return Promise.resolve(this.getUser())}if(this.refreshToken){n=this.refreshToken.split(".")[1],o=s.decode(n);var i=(new Date).getTime()/1e3>=JSON.parse(o).exp;this._logger.log("fidj.connection.connection.refreshConnection : refreshToken not expired ? ",i),i&&this._storage.remove(e._refreshToken)}return this.accessTokenPrevious=this.accessToken,this._storage.set("v2.accessTokenPrevious",this.accessTokenPrevious),this._storage.remove(e._accessToken),this._storage.remove(e._idToken),this.accessToken=null,this.idToken=null,this._logger.log("fidj.connection.connection.refreshConnection : refresh authentication."),new Promise((function(e,n){if(!t.getClient())return n(new d(400,"Need an initialized client."));t.getClient().reAuthenticate(t.refreshToken).then((function(n){t.setConnection(n),e(t.getUser())})).catch((function(e){n(e)}))}))},e.prototype.setConnection=function(t){if(t.accessToken){this.accessToken=t.accessToken.data,this._storage.set(e._accessToken,this.accessToken);var n=JSON.parse(this.getAccessPayload({salt:""})).salt;n&&this.setCryptoSalt(n)}t.idToken&&(this.idToken=t.idToken.data,this._storage.set(e._idToken,this.idToken)),t.refreshToken&&(this.refreshToken=t.refreshToken.data,this._storage.set(e._refreshToken,this.refreshToken)),this._storage.set(e._states,this.states);var o=new g(t.username,t.username,JSON.parse(this.getIdPayload({roles:[]})).roles,JSON.parse(this.getIdPayload({message:""})).message);this.setUser(o)},e.prototype.setConnectionOffline=function(t){t.accessToken&&(this.accessToken=t.accessToken,this._storage.set(e._accessToken,this.accessToken)),t.idToken&&(this.idToken=t.idToken,this._storage.set(e._idToken,this.idToken)),t.refreshToken&&(this.refreshToken=t.refreshToken,this._storage.set(e._refreshToken,this.refreshToken)),this.setUser(new g("demo","demo",JSON.parse(this.getIdPayload({roles:[]})).roles,JSON.parse(this.getIdPayload({message:""})).message))},e.prototype.getApiEndpoints=function(e){var t=[{key:"fidj.default",url:"https://api.fidj.ovh/v3",blocked:!1}],n=[];if(this._sdk.prod||(t=[{key:"fidj.default",url:"http://localhost:3201/v3",blocked:!1},{key:"fidj.default",url:"https://fidj-sandbox.herokuapp.com/v3",blocked:!1}]),this.accessToken){var o,r=this.getAccessPayload({apis:[]});(o=JSON.parse(r).apis)&&o.length&&(t=[],o.forEach((function(e){e.url&&t.push(e)})))}this.accessTokenPrevious&&((o=JSON.parse(this.getPreviousAccessPayload({apis:[]})).apis)&&o.length&&o.forEach((function(e){e.url&&0===t.filter((function(t){return t.url===e.url})).length&&t.push(e)})));this._logger.log("fidj.sdk.connection.getApiEndpoints : ",t);var i=!0;if(this.states&&Object.keys(this.states).length)for(var s=0;s<t.length&&i;s++)this.states[t[s].url]||(i=!1);else i=!1;if(e&&e.filter)if(i&&"theBestOne"===e.filter)for(s=0;s<t.length&&0===n.length;s++){var a=t[s];this.states[a.url]&&this.states[a.url].state&&n.push(a)}else if(i&&"theBestOldOne"===e.filter){var c=void 0;for(s=0;s<t.length;s++){a=t[s];this.states[a.url]&&this.states[a.url].lastTimeWasOk&&(!c||this.states[a.url].lastTimeWasOk>this.states[c.url].lastTimeWasOk)&&(c=a)}c&&n.push(c)}else t.length&&n.push(t[0]);else n=t;return n},e.prototype.getDBs=function(e){if(!this.accessToken)return[];var t=Math.random()%2,n=JSON.parse(this.getAccessPayload({dbs:[]})).dbs||[];0===t?n=n.sort():1===t&&(n=n.reverse());var o=[],r=!0;if(this.states&&Object.keys(this.states).length)for(var i=0;i<n.length&&r;i++)this.states[n[i].url]||(r=!1);else r=!1;if(r&&e&&"theBestOne"===e.filter)for(i=0;i<n.length&&0===o.length;i++){var s=n[i];this.states[s.url]&&this.states[s.url].state&&o.push(s)}else if(r&&e&&"theBestOnes"===e.filter)for(i=0;i<n.length;i++){s=n[i];this.states[s.url]&&this.states[s.url].state&&o.push(s)}else e&&"theBestOne"===e.filter&&n.length?o.push(n[0]):o=n;return o},e.prototype.verifyApiState=function(e,t){return l(this,void 0,void 0,(function(){var n,o,r,i;return f(this,(function(s){switch(s.label){case 0:return s.trys.push([0,2,,3]),this._logger.log("fidj.sdk.connection.verifyApiState : ",e,t),[4,(new y).get({url:t+"/status?isOk="+this._sdk.version,headers:{"Content-Type":"application/json",Accept:"application/json"}})];case 1:return n=s.sent(),o=!1,n&&n.isOk&&(o=!0),this.states[t]={state:o,time:e,lastTimeWasOk:e},this._logger.log("fidj.sdk.connection.verifyApiState > states : ",this.states),[3,3];case 2:return r=s.sent(),i=0,this.states[t]&&(i=this.states[t].lastTimeWasOk),this.states[t]={state:!1,time:e,lastTimeWasOk:i},this._logger.log("fidj.sdk.connection.verifyApiState > catch pb  - states : ",r,this.states),[3,3];case 3:return[2]}}))}))},e.prototype.verifyDbState=function(e,t){return l(this,void 0,void 0,(function(){var n;return f(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,(new y).get({url:t,headers:{"Content-Type":"application/json",Accept:"application/json"}})];case 1:return o.sent(),this.states[t]={state:!0,time:e,lastTimeWasOk:e},[3,3];case 2:return o.sent(),n=0,this.states[t]&&(n=this.states[t].lastTimeWasOk),this.states[t]={state:!1,time:e,lastTimeWasOk:n},[3,3];case 3:return[2]}}))}))},e.prototype.verifyConnectionStates=function(){var e=this,t=(new Date).getTime(),n=[];return this.apis=this.getApiEndpoints(),this.apis.forEach((function(o){var r=o.url;r||(r=o.toString()),n.push(e.verifyApiState(t,r))})),this.getDBs().forEach((function(o){var r=o.url;r||(r=o.toString()),n.push(e.verifyDbState(t,r))})),Promise.all(n)},e}();if(m._accessToken="v2.accessToken",m._accessTokenPrevious="v2.accessTokenPrevious",m._idToken="v2.idToken",m._refreshToken="v2.refreshToken",m._states="v2.states",m._cryptoSalt="v2.cryptoSalt",m._cryptoSaltNext="v2.cryptoSalt.next","undefined"!=typeof window){j=window.PouchDB?window.PouchDB:require("pouchdb").default;var k=require("pouchdb-adapter-cordova-sqlite");j.plugin(k)}var b=function(){function e(){this.db=null,this.dbRecordCount=0,this.dbLastSync=null,this.remoteDb=null,this.dbs=[]}return e.prototype.isReady=function(){return!!this.db},e.prototype.create=function(e,t){var n=this;return!t&&this.db?Promise.resolve(this.db):(this.dbRecordCount=0,this.dbLastSync=null,this.db=null,e=e||"default","undefined"==typeof window?Promise.resolve(this.db):new Promise((function(t,o){var r={location:"default"};try{window.cordova&&(r={location:"default",adapter:"cordova-sqlite"}),n.db=new j("fidj_db_"+e,r),n.db.info().then((function(e){return t(n.db)})).catch((function(e){o(new d(400,e))}))}catch(e){o(new d(500,e))}})))},e.prototype.destroy=function(){var e=this;return this.db?this.db&&!this.db.destroy?Promise.reject(new d(408,"Need a valid db")):new Promise((function(t,n){e.db.destroy((function(o,r){o?n(new d(500,o)):(e.dbRecordCount=0,e.dbLastSync=null,e.db=null,t())}))})):(this.dbRecordCount=0,this.dbLastSync=null,Promise.resolve())},e.prototype.setRemote=function(e){this.dbs=e},e.prototype.sync=function(e){var t=this;return this.db?this.dbs&&this.dbs.length?new Promise((function(n,o){try{t.remoteDb&&t.remoteUri===t.dbs[0].url||(t.remoteUri=t.dbs[0].url,t.remoteDb=new j(t.remoteUri)),t.db.replicate.to(t.remoteDb).on("complete",(function(r){return t.remoteDb.replicate.to(t.db,{filter:function(t){return!!e&&!!t&&t.fidjUserId===e}}).on("complete",(function(){n()})).on("denied",(function(e){return o({code:403,reason:{second:e}})})).on("error",(function(e){return o({code:401,reason:{second:e}})}))})).on("denied",(function(e){return o({code:403,reason:{first:e}})})).on("error",(function(e){return o({code:401,reason:{first:e}})}))}catch(e){o(new d(500,e))}})):Promise.reject(new d(408,"need a remote db")):Promise.reject(new d(408,"need db"))},e.prototype.put=function(t,n,o,r,i,s){var a=this;if(!this.db)return Promise.reject(new d(408,"need db"));if(!(t&&n&&o&&r&&i))return Promise.reject(new d(400,"need formated data"));var c=JSON.parse(JSON.stringify(t)),u={_id:n,fidjUserId:o,fidjOrgId:r,fidjAppVersion:i};c._rev&&(u._rev=""+c._rev),delete c._id,delete c._rev,delete c.fidjUserId,delete c.fidjOrgId,delete c.fidjAppVersion,delete c.fidjData;var l=e.write(e.value(c));return s?(l=s.obj[s.method](l),u.fidjDacr=l):u.fidjData=l,new Promise((function(e,n){a.db.put(u,(function(o,r){r&&r.ok&&r.id&&r.rev?(a.dbRecordCount++,"object"==typeof t?(t._rev=r.rev,t._id=r.id,e(t)):e(r.id)):n(new d(500,o))}))}))},e.prototype.remove=function(e){var t=this;return this.db?new Promise((function(n,o){t.db.get(e).then((function(e){return e._deleted=!0,t.db.put(e)})).then((function(e){n()})).catch((function(e){o(e)}))})):Promise.reject(new d(408,"need db"))},e.prototype.get=function(t,n){var o=this;return this.db?new Promise((function(r,i){o.db.get(t).then((function(t){if(t&&(t.fidjDacr||t.fidjData)){var s=t.fidjDacr;n&&s?s=n.obj[n.method](s):t.fidjData&&(s=JSON.parse(t.fidjData));var a=e.extractJson(s);a?(a._id=t._id,a._rev=t._rev,r(JSON.parse(JSON.stringify(a)))):(o.remove(t._id),i(new d(400,"Bad encoding")))}else i(new d(400,"No data found"))})).catch((function(e){return i(new d(500,e))}))})):Promise.reject(new d(408,"Need db"))},e.prototype.getAll=function(t){var n=this;return this.db&&this.db.allDocs?new Promise((function(o,r){n.db.allDocs({include_docs:!0,descending:!0}).then((function(r){var i=[];r.rows.forEach((function(o){if(o&&o.doc._id&&(o.doc.fidjDacr||o.doc.fidjData)){var r=o.doc.fidjDacr;t&&r?r=t.obj[t.method](r):o.doc.fidjData&&(r=JSON.parse(o.doc.fidjData));var s=e.extractJson(r);s?(s._id=o.doc._id,s._rev=o.doc._rev,i.push(JSON.parse(JSON.stringify(s)))):(console.error("Bad encoding : delete row"),n.remove(o.doc._id))}else console.error("Bad encoding")})),o(i)})).catch((function(e){return r(new d(400,e))}))})):Promise.reject(new d(408,"Need a valid db"))},e.prototype.isEmpty=function(){var e=this;return this.db&&this.db.allDocs?new Promise((function(t,n){e.db.allDocs({}).then((function(o){o?(e.dbRecordCount=o.total_rows,o.total_rows&&o.total_rows>0?t(!1):t(!0)):n(new d(400,"No response"))})).catch((function(e){return n(new d(400,e))}))})):Promise.reject(new d(408,"No db"))},e.prototype.info=function(){return this.db?this.db.info():Promise.reject(new d(408,"No db"))},e.write=function(e){var t="null",n=typeof e;return"undefined"===n||null===t?t="null":"string"===n?t=JSON.stringify({string:e}):"number"===n?t=JSON.stringify({number:e}):"boolean"===n?t=JSON.stringify({bool:e}):"object"===n&&(t=JSON.stringify({json:e})),t},e.value=function(e){var t=e;return"object"!=typeof e||("string"in e?t=e.string:"number"in e?t=e.number.valueOf():"bool"in e?t=e.bool.valueOf():"json"in e&&"object"!=typeof(t=e.json)&&(t=JSON.parse(t))),t},e.extractJson=function(e){var t=e;return e?("object"==typeof e&&"json"in e&&(t=e.json),"string"==typeof t&&(t=JSON.parse(t)),"object"==typeof t&&"json"in t&&(t=t.json),"object"!=typeof t&&(t=null),t):null},e}(),S=function(){function t(t){this.level=t,t||(this.level=e.LoggerLevelEnum.ERROR),"undefined"==typeof console&&(this.level=e.LoggerLevelEnum.NONE)}return t.prototype.log=function(t,n){this.level===e.LoggerLevelEnum.INFO&&console.log(t,n)},t.prototype.warn=function(t,n){this.level!==e.LoggerLevelEnum.INFO&&this.level!==e.LoggerLevelEnum.WARN||console.warn(t,n)},t.prototype.error=function(t,n){this.level!==e.LoggerLevelEnum.INFO&&this.level!==e.LoggerLevelEnum.WARN&&this.level!==e.LoggerLevelEnum.ERROR||console.error(t,n)},t.prototype.setLevel=function(e){this.level=e},t}(),w=require("url-join"),_=function(){function t(e,t,n){var o;this.sdk={org:"fidj",version:"3.3.0",prod:!1,useDB:!0},t&&(this.promise=t),this.logger=e||new S,n&&n.logLevel&&this.logger.setLevel(n.logLevel),this.logger.log("fidj.sdk.service : constructor"),"undefined"!=typeof window?o=window.localStorage:"undefined"!=typeof global&&(require("localstorage-polyfill"),o=global.localStorage),this.storage=new a(o,"fidj."),this.session=new b,this.connection=new m(this.sdk,this.storage,this.logger)}return t.prototype.fidjInit=function(t,n){var o=this;return n&&n.logLevel?o.logger.setLevel(n.logLevel):o.logger.setLevel(e.LoggerLevelEnum.NONE),o.logger.log("fidj.sdk.service.fidjInit : ",n),t?(o.sdk.prod=!n||n.prod,o.sdk.useDB=!!n&&n.useDB,o.connection.fidjId=t,o.connection.fidjVersion=o.sdk.version,o.connection.fidjCrypto=!(!n||!n.hasOwnProperty("crypto"))&&n.crypto,new o.promise((function(e,t){o.connection.verifyConnectionStates().then((function(){var n=o.connection.getApiEndpoints({filter:"theBestOne"})[0],r=o.connection.getApiEndpoints({filter:"theBestOldOne"})[0],i=o.fidjIsLogin();o.logger.log("fidj.sdk.service.fidjInit > verifyConnectionStates : ",n,r,i),n&&n.url&&(n=n.url),r&&r.url&&(r=r.url),n?(o.connection.setClient(new v(o.connection.fidjId,n,o.storage,o.sdk)),e()):i&&r?(o.connection.setClient(new v(o.connection.fidjId,r,o.storage,o.sdk)),e()):t(new d(404,"Need one connection - or too old SDK version (check update)"))})).catch((function(e){o.logger.error("fidj.sdk.service.fidjInit: ",e),t(new d(500,e.toString()))}))}))):(o.logger.error("fidj.sdk.service.fidjInit : bad init"),o.promise.reject(new d(400,"Need a fidjId")))},t.prototype.fidjLogin=function(e,t){return l(this,void 0,void 0,(function(){var n,o;return f(this,(function(r){switch(r.label){case 0:if(this.logger.log("fidj.sdk.service.fidjLogin"),!this.connection.isReady())throw new d(404,"Need an intialized FidjService");r.label=1;case 1:return r.trys.push([1,6,,7]),[4,this._removeAll()];case 2:return r.sent(),[4,this.connection.verifyConnectionStates()];case 3:return r.sent(),[4,this._createSession(this.connection.fidjId)];case 4:return r.sent(),[4,this._loginInternal(e,t)];case 5:return r.sent(),[3,7];case 6:throw n=r.sent(),new d(500,n.toString());case 7:if(!this.sdk.useDB)return[2,this.connection.getUser()];r.label=8;case 8:return r.trys.push([8,10,,11]),[4,this.session.sync(this.connection.getClientId())];case 9:return r.sent(),[3,11];case 10:return o=r.sent(),this.logger.warn("fidj.sdk.service.fidjLogin: sync -not blocking- issue  ",o.toString()),[3,11];case 11:return[2,this.connection.getUser()]}}))}))},t.prototype.fidjLoginInDemoMode=function(e){var t=this;if(!e||!e.accessToken){var n=new Date;n.setDate(n.getDate()+1);var o=n.getTime(),r=s.encode(JSON.stringify({roles:[],message:"demo",apis:[],endpoints:[],dbs:[],exp:o})),i=s.encode(JSON.stringify({})),a=i+"."+r+"."+i;e={accessToken:a,idToken:a,refreshToken:a}}return new t.promise((function(n,o){t._removeAll().then((function(){return t._createSession(t.connection.fidjId)})).then((function(){t.connection.setConnectionOffline(e),n(t.connection.getUser())})).catch((function(e){t.logger.error("fidj.sdk.service.fidjLoginInDemoMode error: ",e),o(e)}))}))},t.prototype.fidjGetEndpoints=function(e){e||(e={showBlocked:!1});var t=this.connection.getAccessPayload({endpoints:[]}),n=JSON.parse(t).endpoints;return n&&Array.isArray(n)?n=n.filter((function(t){var n=!0;return n&&e.key&&(n=t.key===e.key),n&&!e.showBlocked&&(n=!t.blocked),n})):[]},t.prototype.fidjRoles=function(){return JSON.parse(this.connection.getIdPayload({roles:[]})).roles},t.prototype.fidjMessage=function(){return JSON.parse(this.connection.getIdPayload({message:""})).message},t.prototype.fidjIsLogin=function(){return this.connection.isLogin()},t.prototype.fidjLogout=function(e){var t=this,n=this;return n.connection.getClient()||e?n.connection.logout().then((function(){return n._removeAll()})).catch((function(){return n._removeAll()})).then((function(){return t.session.create(n.connection.fidjId,!0)})):n._removeAll().then((function(){return t.session.create(n.connection.fidjId,!0)}))},t.prototype.fidjSync=function(e,t){var n=this,o=this;if(o.logger.log("fidj.sdk.service.fidjSync"),!o.sdk.useDB)return o.logger.log("fidj.sdk.service.fidjSync: you ar not using DB - no sync available."),Promise.resolve();var r=null===o.session.dbLastSync;return new o.promise((function(i,s){o._createSession(o.connection.fidjId).then((function(){return o.session.sync(o.connection.getClientId())})).then((function(){return o.logger.log("fidj.sdk.service.fidjSync resolved"),o.session.isEmpty()})).catch((function(e){return o.logger.warn("fidj.sdk.service.fidjSync warn: ",e),o.session.isEmpty()})).then((function(n){return o.logger.log("fidj.sdk.service.fidjSync isEmpty : ",n,r),new o.promise((function(i,a){if(n&&r&&e){var c=e(t);c&&c.catch instanceof Function&&c.then(i).catch(s),"string"==typeof c&&o.logger.log(c)}i()}))})).then((function(e){return o.logger.log("fidj.sdk.service.fidjSync fnInitFirstData resolved: ",e),o.session.dbLastSync=(new Date).getTime(),o.session.info()})).then((function(e){return o.session.dbRecordCount=0,e&&e.doc_count&&(o.session.dbRecordCount=e.doc_count),o.logger.log("fidj.sdk.service.fidjSync _dbRecordCount : "+o.session.dbRecordCount),o.connection.refreshConnection()})).then((function(e){o.logger.log("fidj.sdk.service.fidjSync refreshConnection done : ",e),i()})).catch((function(e){if(o.logger.warn("fidj.sdk.service.fidjSync refreshConnection failed : ",e),!e||403!==e.code&&410!==e.code)if(e&&e.code)i();else{var t="Error during synchronisation: "+e.toString();o.logger.error(t),s({code:500,reason:t})}else n.fidjLogout().then((function(){s({code:403,reason:"Synchronization unauthorized : need to login again."})})).catch((function(){s({code:403,reason:"Synchronization unauthorized : need to login again.."})}))}))}))},t.prototype.fidjPutInDb=function(e){var t,n,o=this;return o.logger.log("fidj.sdk.service.fidjPutInDb: ",e),o.sdk.useDB?o.connection.getClientId()?o.session.isReady()?(e&&"object"==typeof e&&Object.keys(e).indexOf("_id")&&(t=e._id),t||(t=o._generateObjectUniqueId(o.connection.fidjId)),o.connection.fidjCrypto&&(n={obj:o.connection,method:"encrypt"}),o.session.put(e,t,o.connection.getClientId(),o.sdk.org,o.connection.fidjVersion,n)):o.promise.reject(new d(400,"Need to be synchronised.")):o.promise.reject(new d(401,"DB put impossible. Need a user logged in.")):(o.logger.log("fidj.sdk.service.fidjPutInDb: you are not using DB - no put available."),Promise.resolve("NA"))},t.prototype.fidjRemoveInDb=function(e){var t=this;return t.logger.log("fidj.sdk.service.fidjRemoveInDb ",e),t.sdk.useDB?t.session.isReady()?e&&"string"==typeof e?t.session.remove(e):t.promise.reject(new d(400,"DB remove impossible. Need the data._id.")):t.promise.reject(new d(400,"Need to be synchronised.")):(t.logger.log("fidj.sdk.service.fidjRemoveInDb: you are not using DB - no remove available."),Promise.resolve())},t.prototype.fidjFindInDb=function(e){var t,n=this;return n.sdk.useDB?n.connection.getClientId()?n.session.isReady()?(n.connection.fidjCrypto&&(t={obj:n.connection,method:"decrypt"}),n.session.get(e,t)):n.promise.reject(new d(400," Need to be synchronised.")):n.promise.reject(new d(401,"Find pb : need a user logged in.")):(n.logger.log("fidj.sdk.service.fidjFindInDb: you are not using DB - no find available."),Promise.resolve())},t.prototype.fidjFindAllInDb=function(){var e,t=this;return t.sdk.useDB?t.connection.getClientId()?t.session.isReady()?(t.connection.fidjCrypto&&(e={obj:t.connection,method:"decrypt"}),t.session.getAll(e).then((function(e){return t.connection.setCryptoSaltAsVerified(),t.promise.resolve(e)}))):t.promise.reject(new d(400,"Need to be synchronised.")):t.promise.reject(new d(401,"Need a user logged in.")):(t.logger.log("fidj.sdk.service.fidjFindAllInDb: you are not using DB - no find available."),Promise.resolve([]))},t.prototype.fidjSendOnEndpoint=function(e,t,n,o){var r={key:e},i=this.fidjGetEndpoints(r);if(!i||1!==i.length)return this.promise.reject(new d(400,"fidj.sdk.service.fidjSendOnEndpoint : endpoint does not exist."));var s=i[0].url;n&&(s=w(s,n));var a,c=this.connection.getIdToken(),u=new y;switch(t){case"POST":a=u.post({url:s,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+c},data:o});break;case"PUT":a=u.put({url:s,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+c},data:o});break;case"DELETE":a=u.delete({url:s,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+c}});break;default:a=u.get({url:s,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+c}})}return a},t.prototype.fidjGetIdToken=function(){return this.connection.getIdToken()},t.prototype._loginInternal=function(e,t,n){var o=this;return o.logger.log("fidj.sdk.service._loginInternal"),o.connection.isReady()?new o.promise((function(r,i){o.connection.logout().then((function(){return o.connection.getClient().login(e,t,n)})).catch((function(r){return o.connection.getClient().login(e,t,n)})).then((function(e){r(e)})).catch((function(e){o.logger.error("fidj.sdk.service._loginInternal error : "+e),i(e)}))})):o.promise.reject(new d(403,"Need an intialized FidjService"))},t.prototype._removeAll=function(){return this.connection.destroy(),this.session.destroy()},t.prototype._createSession=function(e){var t=this.connection.getDBs({filter:"theBestOnes"});return t&&0!==t.length||this.logger.warn("Seems that you are in Demo mode or using Node (no remote DB)."),this.session.setRemote(t),this.session.create(e)},t.prototype._testPromise=function(e){return e?this.promise.resolve("test promise ok "+e):new this.promise((function(e,t){e("test promise ok")}))},t.prototype._generateObjectUniqueId=function(e,n,o){var r=new Date,i=""+r.getFullYear()+r.getMonth()+r.getDate()+r.getHours()+r.getMinutes(),s=++t._srvDataUniqId,a="";return e&&e.charAt(0)&&(a+=e.charAt(0)+""),n&&n.length>3&&(a+=n.substring(0,4)),o&&o.length>3&&(a+=o.substring(0,4)),a+=i+""+s},t}();_._srvDataUniqId=0;var T=function(){function t(){this.logger=new S(e.LoggerLevelEnum.ERROR),this.promise=Promise,this.fidjService=null}return t.prototype.init=function(e,t){return this.fidjService||(this.fidjService=new _(this.logger,this.promise)),this.fidjService.fidjInit(e,t)},t.prototype.login=function(e,t){return this.fidjService?this.fidjService.fidjLogin(e,t):this.promise.reject(new d(303,"fidj.sdk.angular.login : not initialized."))},t.prototype.loginAsDemo=function(e){return this.fidjService?this.fidjService.fidjLoginInDemoMode(e):this.promise.reject(new d(303,"fidj.sdk.angular.loginAsDemo : not initialized."))},t.prototype.isLoggedIn=function(){return!!this.fidjService&&this.fidjService.fidjIsLogin()},t.prototype.getRoles=function(){return this.fidjService?this.fidjService.fidjRoles():[]},t.prototype.getEndpoints=function(){return this.fidjService?this.fidjService.fidjGetEndpoints():[]},t.prototype.sendOnEndpoint=function(e,t,n,o){return this.fidjService?this.fidjService.fidjSendOnEndpoint(e,t,n,o):this.promise.reject(new d(303,"fidj.sdk.angular.loginAsDemo : not initialized."))},t.prototype.getIdToken=function(){if(this.fidjService)return this.fidjService.fidjGetIdToken()},t.prototype.getMessage=function(){return this.fidjService?this.fidjService.fidjMessage():""},t.prototype.logout=function(e){return e||!this.fidjService?this.promise.reject(new d(303,"fidj.sdk.angular.logout : not initialized.")):this.fidjService.fidjLogout(e)},t.prototype.sync=function(e){return this.fidjService?this.fidjService.fidjSync(e,this):this.promise.reject(new d(401,"fidj.sdk.angular.sync : not initialized."))},t.prototype.put=function(e){return this.fidjService?this.fidjService.fidjPutInDb(e):this.promise.reject(new d(401,"fidj.sdk.angular.put : not initialized."))},t.prototype.remove=function(e){return this.fidjService?this.fidjService.fidjRemoveInDb(e):this.promise.reject(new d(401,"fidj.sdk.angular.remove : not initialized."))},t.prototype.find=function(e){return this.fidjService?this.fidjService.fidjFindInDb(e):this.promise.reject(new d(401,"fidj.sdk.angular.find : not initialized."))},t.prototype.findAll=function(){return this.fidjService?this.fidjService.fidjFindAllInDb():this.promise.reject(new d(401,"fidj.sdk.angular.findAll : not initialized."))},t}();T.ɵprov=i.ɵɵdefineInjectable({factory:function(){return new T},token:T,providedIn:"root"}),T.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],T.ctorParameters=function(){return[]},e.Base64=s,e.Error=d,e.FidjModule=u,e.FidjService=T,e.LocalStorage=a,e.Xor=c,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=fidj.umd.min.js.map