!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common")):"function"==typeof define&&define.amd?define("fidj",["exports","@angular/core","@angular/common"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).fidj={},e.ng.core,e.ng.common)}(this,(function(e,t,n){"use strict";var o=function(){function e(){}return e.encode=function(e){return e?("undefined"!=typeof window?window.btoa:require("btoa"))(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode(parseInt("0x"+t,16))}))):null},e.decode=function(e){if(!e)return null;var t="undefined"!=typeof window?window.atob:require("atob");return decodeURIComponent(t(e).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""))},e}(),i=function(){function e(e,t){if(this.storageKey=t,this.version="0.1",this.storage=e||window.localStorage,!this.storage)throw new Error("fidj.LocalStorageFactory needs a storageService!")}return e.prototype.set=function(e,t){e=this.storageKey+e,this.checkKey(e);var n=typeof t;if("undefined"===n)t="null";else if(null===t)t="null";else if("string"===n)t=JSON.stringify({string:t});else if("number"===n)t=JSON.stringify({number:t});else if("boolean"===n)t=JSON.stringify({bool:t});else{if("object"!==n)throw new TypeError("Value type "+n+" is invalid. It must be null, undefined, xml, string, number, boolean or object");t=JSON.stringify({json:t})}return this.storage.setItem(e,t),t},e.prototype.get=function(e,t){e=this.storageKey+e,this.checkKey(e);var n=this.storage.getItem(e);if(null!==n){if("null"===n)return null;var o=JSON.parse(n);return"string"in o?o.string:"number"in o?o.number.valueOf():"bool"in o?o.bool.valueOf():o.json}return t||null},e.prototype.remove=function(e){e=this.storageKey+e,this.checkKey(e);var t=null!==this.storage.getItem(e);return this.storage.removeItem(e),t},e.prototype.clear=function(){var e=this.storage.length>0;return this.storage.clear(),e},e.prototype.size=function(){return this.storage.length},e.prototype.foreach=function(e,t){for(var n=this.storage.length,o=0;o<n;o++){var i=this.storage.key(o),r=this.get(i);t?e.call(t,r):e(r)}return n},e.prototype.checkKey=function(e){if(!e||"string"!=typeof e)throw new TypeError("Key type must be string");return!0},e}(),r=function(){function e(){}return e.encrypt=function(t,n){var i="";t=e.header+t;for(var r=0;r<t.length;r++)i+=String.fromCharCode(t[r].charCodeAt(0).toString(10)^e.keyCharAt(n,r));return i=o.encode(i)},e.decrypt=function(t,n,i){var r="";t=o.decode(t);for(var s=0;s<t.length;s++)r+=String.fromCharCode(t[s].charCodeAt(0).toString(10)^e.keyCharAt(n,s));return i||e.header===r.substring(0,e.header.length)?(i||(r=r.substring(e.header.length)),r):null},e.keyCharAt=function(e,t){return e[Math.floor(t%e.length)].charCodeAt(0).toString(10)},e}();r.header="artemis-lotsum";var s;function c(e,t,n,o){var i,r=arguments.length,s=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,o);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(s=(r<3?i(s):r>3?i(t,n,s):i(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s}function a(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){e.done?i(e.value):new n((function(t){t(e.value)})).then(s,c)}a((o=o.apply(e,t||[])).next())}))}function d(e,t){var n,o,i,r,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function c(r){return function(c){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,o&&(i=2&r[0]?o.return:r[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,r[1])).done)return i;switch(o=0,i&&(r=[2&r[0],i.value]),r[0]){case 0:case 1:i=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,o=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==r[0]&&2!==r[0])){s=0;continue}if(3===r[0]&&(!i||r[1]>i[0]&&r[1]<i[3])){s.label=r[1];break}if(6===r[0]&&s.label<i[1]){s.label=i[1],i=r;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(r);break}i[2]&&s.ops.pop(),s.trys.pop();continue}r=t.call(e,s)}catch(e){r=[6,e],o=0}finally{n=i=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,c])}}}!function(e){e[e.LOG=1]="LOG",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e[e.NONE=4]="NONE"}(s||(s={}));var u;!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.TIMEOUT=1]="TIMEOUT",e[e.STATUS=2]="STATUS"}(u||(u={}));var l=function(){function e(){this.xhr=require("axios")}return e.formatResponseData=function(e){for(var t=e;t&&t.data;)t=t.data;try{t=JSON.parse(t+"")}catch(e){}return t},e.formatError=function(e){var t={reason:u.UNKNOWN,status:-1,code:-1,message:""};return e.status&&(t.reason=u.STATUS,t.status=parseInt(e.status,10),t.code=parseInt(e.status,10)),e.response?(t.message=e.response,e.response.status?(t.reason=u.STATUS,t.status=parseInt(e.response.status,10),t.code=parseInt(e.response.status,10)):null===e.response.status&&(t.reason=u.TIMEOUT,t.status=408,t.code=408)):e.request?t.message=e.request:e.message&&(t.message=e.message),t},e.prototype.post=function(t){var n={method:"POST",url:t.url,data:JSON.stringify(t.data)};return t.headers&&(n.headers=t.headers),this.xhr.post(n.url,{data:n.data,headers:n.headers,timeout:1e4}).then((function(t){return t.status&&(parseInt(t.status,10)<200||parseInt(t.status,10)>=300)?Promise.reject(e.formatError(t)):Promise.resolve(e.formatResponseData(t))})).catch((function(t){return Promise.reject(e.formatError(t))}))},e.prototype.put=function(t){var n={method:"PUT",url:t.url,data:JSON.stringify(t.data)};return t.headers&&(n.headers=t.headers),this.xhr.put(n.url,{data:n.data,headers:n.headers,timeout:1e4}).then((function(t){return t.status&&(parseInt(t.status,10)<200||parseInt(t.status,10)>=300)?Promise.reject(e.formatError(t)):Promise.resolve(e.formatResponseData(t))})).catch((function(t){return Promise.reject(e.formatError(t))}))},e.prototype.delete=function(t){var n={method:"DELETE",url:t.url,data:JSON.stringify(t.data)};return t.headers&&(n.headers=t.headers),this.xhr.delete(n.url,{data:n.data,headers:n.headers,timeout:1e4}).then((function(t){return t.status&&(parseInt(t.status,10)<200||parseInt(t.status,10)>=300)?Promise.reject(e.formatError(t)):Promise.resolve(e.formatResponseData(t))})).catch((function(t){return Promise.reject(e.formatError(t))}))},e.prototype.get=function(t){var n={method:"GET",url:t.url};return t.data&&(n.data=t.data),t.headers&&(n.headers=t.headers),this.xhr.get(n.url,{data:n.data,headers:n.headers,timeout:1e4}).then((function(t){return t.status&&(parseInt(t.status,10)<200||parseInt(t.status,10)>=300)?Promise.reject(e.formatError(t)):Promise.resolve(e.formatResponseData(t))})).catch((function(t){return Promise.reject(e.formatError(t))}))},e}(),f=function(){function e(t,n,o,i){this.appId=t,this.URI=n,this.storage=o,this.sdk=i;var r=this.storage.get(e._clientUuid)||"uuid-"+Math.random(),s="_clientInfo";"undefined"!=typeof window&&window.navigator&&(s=window.navigator.appName+"@"+window.navigator.appVersion+"-"+window.navigator.userAgent),"undefined"!=typeof window&&window.device&&window.device.uuid&&(r=window.device.uuid),this.setClientUuid(r),this.setClientInfo(s),this.clientId=this.storage.get(e._clientId),e.refreshCount=this.storage.get(e._refreshCount)||e.refreshCountInitial}return e.prototype.setClientId=function(t){this.clientId=""+t,this.storage.set(e._clientId,this.clientId)},e.prototype.setClientUuid=function(t){this.clientUuid=""+t,this.storage.set(e._clientUuid,this.clientUuid)},e.prototype.setClientInfo=function(e){this.clientInfo=""+e},e.prototype.login=function(e,t,n){var o=this;if(!this.URI)return console.error("no api uri"),Promise.reject({code:408,reason:"no-api-uri"});var i=this.URI+"/users",r={name:e,username:e,email:e,password:t};return(new l).post({url:i,data:r,headers:{"Content-Type":"application/json",Accept:"application/json"}}).then((function(e){o.setClientId(e._id);var n=o.URI+"/oauth/token",i={grant_type:"client_credentials",client_id:o.clientId,client_secret:t,client_udid:o.clientUuid,client_info:o.clientInfo,audience:o.appId,scope:JSON.stringify(o.sdk)};return(new l).post({url:n,data:i,headers:{"Content-Type":"application/json",Accept:"application/json"}})}))},e.prototype.reAuthenticate=function(t){var n=this;if(!this.URI)return console.error("no api uri"),Promise.reject({code:408,reason:"no-api-uri"});var o=this.URI+"/oauth/token",i={grant_type:"refresh_token",client_id:this.clientId,client_udid:this.clientUuid,client_info:this.clientInfo,audience:this.appId,scope:JSON.stringify(this.sdk),refresh_token:t,refresh_extra:e.refreshCount};return(new l).post({url:o,data:i,headers:{"Content-Type":"application/json",Accept:"application/json"}}).then((function(t){return e.refreshCount++,n.storage.set(e._refreshCount,e.refreshCount),Promise.resolve(t)}))},e.prototype.logout=function(t){if(!this.URI)return console.error("no api uri"),Promise.reject({code:408,reason:"no-api-uri"});if(this.storage.remove(e._clientId),this.storage.remove(e._refreshCount),e.refreshCount=e.refreshCountInitial,!t||!this.clientId)return Promise.resolve();var n=this.URI+"/oauth/revoke",o={token:t,client_id:this.clientId,client_udid:this.clientUuid,client_info:this.clientInfo,audience:this.appId,scope:JSON.stringify(this.sdk)};return(new l).post({url:n,data:o,headers:{"Content-Type":"application/json",Accept:"application/json"}})},e.prototype.isReady=function(){return!!this.URI},e}();f.refreshCountInitial=1,f.refreshCount=f.refreshCountInitial,f._clientUuid="v2.clientUuid",f._clientId="v2.clientId",f._refreshCount="v2.refreshCount";var h,p=function(){function e(e,t){this.code=e,this.reason=t}return e.prototype.equals=function(e){return this.code===e.code&&this.reason===e.reason},e.prototype.toString=function(){var e="string"==typeof this.reason?this.reason:JSON.stringify(this.reason);return this.code+" - "+e},e}(),g=function(){function e(t,n,o){this._sdk=t,this._storage=n,this._logger=o,this.client=null,this.user=null,this.cryptoSalt=this._storage.get(e._cryptoSalt)||null,this.cryptoSaltNext=this._storage.get(e._cryptoSaltNext)||null,this.accessToken=this._storage.get(e._accessToken)||null,this.accessTokenPrevious=this._storage.get("v2.accessTokenPrevious")||null,this.idToken=this._storage.get(e._idToken)||null,this.refreshToken=this._storage.get(e._refreshToken)||null,this.states=this._storage.get(e._states)||{},this.apis=[]}return e.prototype.isReady=function(){return!!this.client&&this.client.isReady()},e.prototype.destroy=function(t){this._storage.remove(e._accessToken),this._storage.remove(e._idToken),this._storage.remove(e._refreshToken),this._storage.remove(e._states),this.accessToken&&(this.accessTokenPrevious=this.accessToken,this._storage.set(e._accessTokenPrevious,this.accessTokenPrevious)),t&&(this._storage.remove(e._cryptoSalt),this._storage.remove(e._cryptoSaltNext),this._storage.remove(e._accessTokenPrevious)),this.user=null,this.client&&this.client.logout(),this.accessToken=null,this.idToken=null,this.refreshToken=null,this.states={}},e.prototype.setClient=function(e){this.client=e,this.user||(this.user={}),this.user._name=JSON.parse(this.getIdPayload({name:""})).name},e.prototype.setUser=function(e){this.user=e,this.client&&this.user._id&&(this.client.setClientId(this.user._id),delete this.user._id)},e.prototype.getUser=function(){return this.user},e.prototype.getClient=function(){return this.client},e.prototype.setCryptoSalt=function(t){this.cryptoSalt!==t&&this.cryptoSaltNext!==t&&(this.cryptoSaltNext=t,this._storage.set(e._cryptoSaltNext,this.cryptoSaltNext)),this.cryptoSalt||this.setCryptoSaltAsVerified()},e.prototype.setCryptoSaltAsVerified=function(){this.cryptoSaltNext&&(this.cryptoSalt=this.cryptoSaltNext,this._storage.set(e._cryptoSalt,this.cryptoSalt)),this.cryptoSaltNext=null,this._storage.remove(e._cryptoSaltNext)},e.prototype.encrypt=function(e){if("string"!=typeof e)e=JSON.stringify(e);else{var t={string:e};e=JSON.stringify(t)}if(this.fidjCrypto&&this.cryptoSalt){var n=this.cryptoSalt;return r.encrypt(e,n)}return e},e.prototype.decrypt=function(e){var t=null;try{if(!t&&this.fidjCrypto&&this.cryptoSaltNext){var n=this.cryptoSaltNext;t=r.decrypt(e,n),t=JSON.parse(t)}}catch(e){t=null}try{if(!t&&this.fidjCrypto&&this.cryptoSalt){n=this.cryptoSalt;t=r.decrypt(e,n),t=JSON.parse(t)}}catch(e){t=null}try{if(!t&&this.fidjCrypto&&this.cryptoSalt){n=this.cryptoSalt;t=r.decrypt(e,n,!0),t=JSON.parse(t)}}catch(e){t=null}try{t||(t=JSON.parse(e)),t&&t.string&&(t=t.string)}catch(e){t=null}return t},e.prototype.isLogin=function(){var e=!0;try{var t=this.refreshToken.split(".")[1],n=JSON.parse(o.decode(t));e=(new Date).getTime()/1e3>=n.exp}catch(e){}return!e},e.prototype.logout=function(){return this.getClient().logout(this.refreshToken)},e.prototype.getClientId=function(){return this.client?this.client.clientId:null},e.prototype.getIdToken=function(){return this.idToken},e.prototype.getIdPayload=function(e){e&&"string"!=typeof e&&(e=JSON.stringify(e));try{var t=this.getIdToken().split(".")[1];if(t)return o.decode(t)}catch(t){this._logger.log("fidj.connection.getIdPayload pb: ",e,t)}return e||null},e.prototype.getAccessPayload=function(e){e&&"string"!=typeof e&&(e=JSON.stringify(e));try{var t=this.accessToken.split(".")[1];if(t)return o.decode(t)}catch(e){}return e||null},e.prototype.getPreviousAccessPayload=function(e){e&&"string"!=typeof e&&(e=JSON.stringify(e));try{var t=this.accessTokenPrevious.split(".")[1];if(t)return o.decode(t)}catch(e){}return e||null},e.prototype.refreshConnection=function(){var t=this;if(this._storage.set(e._states,this.states),this.accessToken){var n=this.accessToken.split(".")[1],i=o.decode(n),r=(new Date).getTime()/1e3<JSON.parse(i).exp;if(this._logger.log("fidj.connection.connection.refreshConnection : token not expired ? ",r),r)return Promise.resolve(this.getUser())}if(this.refreshToken){n=this.refreshToken.split(".")[1],i=o.decode(n);var s=(new Date).getTime()/1e3>=JSON.parse(i).exp;this._logger.log("fidj.connection.connection.refreshConnection : refreshToken not expired ? ",s),s&&this._storage.remove(e._refreshToken)}return this.accessTokenPrevious=this.accessToken,this._storage.set("v2.accessTokenPrevious",this.accessTokenPrevious),this._storage.remove(e._accessToken),this._storage.remove(e._idToken),this.accessToken=null,this.idToken=null,this._logger.log("fidj.connection.connection.refreshConnection : refresh authentication."),new Promise((function(e,n){if(!t.getClient())return n(new p(400,"Need an initialized client."));t.getClient().reAuthenticate(t.refreshToken).then((function(n){t.setConnection(n),e(t.getUser())})).catch((function(e){n(e)}))}))},e.prototype.setConnection=function(t){if(t.access_token){this.accessToken=t.access_token,this._storage.set(e._accessToken,this.accessToken),delete t.access_token;var n=JSON.parse(this.getAccessPayload({salt:""})).salt;n&&this.setCryptoSalt(n)}t.id_token&&(this.idToken=t.id_token,this._storage.set(e._idToken,this.idToken),delete t.id_token),t.refresh_token&&(this.refreshToken=t.refresh_token,this._storage.set(e._refreshToken,this.refreshToken),delete t.refresh_token),this._storage.set(e._states,this.states),t.roles=JSON.parse(this.getIdPayload({roles:[]})).roles,t.message=JSON.parse(this.getIdPayload({message:""})).message,this.setUser(t)},e.prototype.setConnectionOffline=function(t){t.accessToken&&(this.accessToken=t.accessToken,this._storage.set(e._accessToken,this.accessToken)),t.idToken&&(this.idToken=t.idToken,this._storage.set(e._idToken,this.idToken)),t.refreshToken&&(this.refreshToken=t.refreshToken,this._storage.set(e._refreshToken,this.refreshToken)),this.setUser({roles:JSON.parse(this.getIdPayload({roles:[]})).roles,message:JSON.parse(this.getIdPayload({message:""})).message,_id:"demo"})},e.prototype.getApiEndpoints=function(e){var t=[{key:"fidj.default",url:"https://fidj.ovh/api",blocked:!1}],n=[];if(this._sdk.prod||(t=[{key:"fidj.default",url:"http://localhost:3201/api",blocked:!1},{key:"fidj.default",url:"https://fidj-sandbox.herokuapp.com/api",blocked:!1}]),this.accessToken){var o,i=this.getAccessPayload({apis:[]});(o=JSON.parse(i).apis)&&o.length&&(t=[],o.forEach((function(e){e.url&&t.push(e)})))}this.accessTokenPrevious&&((o=JSON.parse(this.getPreviousAccessPayload({apis:[]})).apis)&&o.length&&o.forEach((function(e){e.url&&0===t.filter((function(t){return t.url===e.url})).length&&t.push(e)})));this._logger.log("fidj.sdk.connection.getApiEndpoints : ",t);var r=!0;if(this.states&&Object.keys(this.states).length)for(var s=0;s<t.length&&r;s++)this.states[t[s].url]||(r=!1);else r=!1;if(e&&e.filter)if(r&&"theBestOne"===e.filter)for(s=0;s<t.length&&0===n.length;s++){var c=t[s];this.states[c.url]&&this.states[c.url].state&&n.push(c)}else if(r&&"theBestOldOne"===e.filter){var a=void 0;for(s=0;s<t.length;s++){c=t[s];this.states[c.url]&&this.states[c.url].lastTimeWasOk&&(!a||this.states[c.url].lastTimeWasOk>this.states[a.url].lastTimeWasOk)&&(a=c)}a&&n.push(a)}else t.length&&n.push(t[0]);else n=t;return n},e.prototype.getDBs=function(e){if(!this.accessToken)return[];var t=Math.random()%2,n=JSON.parse(this.getAccessPayload({dbs:[]})).dbs||[];0===t?n=n.sort():1===t&&(n=n.reverse());var o=[],i=!0;if(this.states&&Object.keys(this.states).length)for(var r=0;r<n.length&&i;r++)this.states[n[r].url]||(i=!1);else i=!1;if(i&&e&&"theBestOne"===e.filter)for(r=0;r<n.length&&0===o.length;r++){var s=n[r];this.states[s.url]&&this.states[s.url].state&&o.push(s)}else if(i&&e&&"theBestOnes"===e.filter)for(r=0;r<n.length;r++){s=n[r];this.states[s.url]&&this.states[s.url].state&&o.push(s)}else e&&"theBestOne"===e.filter&&n.length?o.push(n[0]):o=n;return o},e.prototype.verifyApiState=function(e,t){return a(this,void 0,void 0,(function(){var n,o,i,r;return d(this,(function(s){switch(s.label){case 0:return s.trys.push([0,2,,3]),this._logger.log("fidj.sdk.connection.verifyApiState : ",e,t),[4,(new l).get({url:t+"/status?isok="+this._sdk.version,headers:{"Content-Type":"application/json",Accept:"application/json"}})];case 1:return n=s.sent(),o=!1,n&&n.isok&&(o=!0),this.states[t]={state:o,time:e,lastTimeWasOk:e},this._logger.log("fidj.sdk.connection.verifyApiState > states : ",this.states),[3,3];case 2:return i=s.sent(),r=0,this.states[t]&&(r=this.states[t].lastTimeWasOk),this.states[t]={state:!1,time:e,lastTimeWasOk:r},this._logger.log("fidj.sdk.connection.verifyApiState > catch pb  - states : ",i,this.states),[3,3];case 3:return[2]}}))}))},e.prototype.verifyDbState=function(e,t){return a(this,void 0,void 0,(function(){var n;return d(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,(new l).get({url:t,headers:{"Content-Type":"application/json",Accept:"application/json"}})];case 1:return o.sent(),this.states[t]={state:!0,time:e,lastTimeWasOk:e},[3,3];case 2:return o.sent(),n=0,this.states[t]&&(n=this.states[t].lastTimeWasOk),this.states[t]={state:!1,time:e,lastTimeWasOk:n},[3,3];case 3:return[2]}}))}))},e.prototype.verifyConnectionStates=function(){var e=this,t=(new Date).getTime(),n=[];return this.apis=this.getApiEndpoints(),this.apis.forEach((function(o){var i=o.url;i||(i=o.toString()),n.push(e.verifyApiState(t,i))})),this.getDBs().forEach((function(o){var i=o.url;i||(i=o.toString()),n.push(e.verifyDbState(t,i))})),Promise.all(n)},e}();if(g._accessToken="v2.accessToken",g._accessTokenPrevious="v2.accessTokenPrevious",g._idToken="v2.idToken",g._refreshToken="v2.refreshToken",g._states="v2.states",g._cryptoSalt="v2.cryptoSalt",g._cryptoSaltNext="v2.cryptoSalt.next","undefined"!=typeof window){h=window.PouchDB?window.PouchDB:require("pouchdb").default;var y=require("pouchdb-adapter-cordova-sqlite");h.plugin(y)}var v=function(){function e(){this.db=null,this.dbRecordCount=0,this.dbLastSync=null,this.remoteDb=null,this.dbs=[]}return e.prototype.isReady=function(){return!!this.db},e.prototype.create=function(e,t){var n=this;return!t&&this.db?Promise.resolve(this.db):(this.dbRecordCount=0,this.dbLastSync=null,this.db=null,e=e||"default","undefined"==typeof window?Promise.resolve(this.db):new Promise((function(t,o){var i={location:"default"};try{window.cordova&&(i={location:"default",adapter:"cordova-sqlite"}),n.db=new h("fidj_db_"+e,i),n.db.info().then((function(e){return t(n.db)})).catch((function(e){o(new p(400,e))}))}catch(e){o(new p(500,e))}})))},e.prototype.destroy=function(){var e=this;return this.db?this.db&&!this.db.destroy?Promise.reject(new p(408,"Need a valid db")):new Promise((function(t,n){e.db.destroy((function(o,i){o?n(new p(500,o)):(e.dbRecordCount=0,e.dbLastSync=null,e.db=null,t())}))})):(this.dbRecordCount=0,this.dbLastSync=null,Promise.resolve())},e.prototype.setRemote=function(e){this.dbs=e},e.prototype.sync=function(e){var t=this;return this.db?this.dbs&&this.dbs.length?new Promise((function(n,o){try{t.remoteDb&&t.remoteUri===t.dbs[0].url||(t.remoteUri=t.dbs[0].url,t.remoteDb=new h(t.remoteUri)),t.db.replicate.to(t.remoteDb).on("complete",(function(i){return t.remoteDb.replicate.to(t.db,{filter:function(t){return!!e&&!!t&&t.fidjUserId===e}}).on("complete",(function(){n()})).on("denied",(function(e){return o({code:403,reason:{second:e}})})).on("error",(function(e){return o({code:401,reason:{second:e}})}))})).on("denied",(function(e){return o({code:403,reason:{first:e}})})).on("error",(function(e){return o({code:401,reason:{first:e}})}))}catch(e){o(new p(500,e))}})):Promise.reject(new p(408,"need a remote db")):Promise.reject(new p(408,"need db"))},e.prototype.put=function(t,n,o,i,r,s){var c=this;if(!this.db)return Promise.reject(new p(408,"need db"));if(!(t&&n&&o&&i&&r))return Promise.reject(new p(400,"need formated data"));var a=JSON.parse(JSON.stringify(t)),d={_id:n,fidjUserId:o,fidjOrgId:i,fidjAppVersion:r};a._rev&&(d._rev=""+a._rev),delete a._id,delete a._rev,delete a.fidjUserId,delete a.fidjOrgId,delete a.fidjAppVersion,delete a.fidjData;var u=e.write(e.value(a));return s?(u=s.obj[s.method](u),d.fidjDacr=u):d.fidjData=u,new Promise((function(e,n){c.db.put(d,(function(o,i){i&&i.ok&&i.id&&i.rev?(c.dbRecordCount++,"object"==typeof t?(t._rev=i.rev,t._id=i.id,e(t)):e(i.id)):n(new p(500,o))}))}))},e.prototype.remove=function(e){var t=this;return this.db?new Promise((function(n,o){t.db.get(e).then((function(e){return e._deleted=!0,t.db.put(e)})).then((function(e){n()})).catch((function(e){o(e)}))})):Promise.reject(new p(408,"need db"))},e.prototype.get=function(t,n){var o=this;return this.db?new Promise((function(i,r){o.db.get(t).then((function(t){if(t&&(t.fidjDacr||t.fidjData)){var s=t.fidjDacr;n&&s?s=n.obj[n.method](s):t.fidjData&&(s=JSON.parse(t.fidjData));var c=e.extractJson(s);c?(c._id=t._id,c._rev=t._rev,i(JSON.parse(JSON.stringify(c)))):(o.remove(t._id),r(new p(400,"Bad encoding")))}else r(new p(400,"No data found"))})).catch((function(e){return r(new p(500,e))}))})):Promise.reject(new p(408,"Need db"))},e.prototype.getAll=function(t){var n=this;return this.db&&this.db.allDocs?new Promise((function(o,i){n.db.allDocs({include_docs:!0,descending:!0}).then((function(i){var r=[];i.rows.forEach((function(o){if(o&&o.doc._id&&(o.doc.fidjDacr||o.doc.fidjData)){var i=o.doc.fidjDacr;t&&i?i=t.obj[t.method](i):o.doc.fidjData&&(i=JSON.parse(o.doc.fidjData));var s=e.extractJson(i);s?(s._id=o.doc._id,s._rev=o.doc._rev,r.push(JSON.parse(JSON.stringify(s)))):(console.error("Bad encoding : delete row"),n.remove(o.doc._id))}else console.error("Bad encoding")})),o(r)})).catch((function(e){return i(new p(400,e))}))})):Promise.reject(new p(408,"Need a valid db"))},e.prototype.isEmpty=function(){var e=this;return this.db&&this.db.allDocs?new Promise((function(t,n){e.db.allDocs({}).then((function(o){o?(e.dbRecordCount=o.total_rows,o.total_rows&&o.total_rows>0?t(!1):t(!0)):n(new p(400,"No response"))})).catch((function(e){return n(new p(400,e))}))})):Promise.reject(new p(408,"No db"))},e.prototype.info=function(){return this.db?this.db.info():Promise.reject(new p(408,"No db"))},e.write=function(e){var t="null",n=typeof e;return"undefined"===n||null===t?t="null":"string"===n?t=JSON.stringify({string:e}):"number"===n?t=JSON.stringify({number:e}):"boolean"===n?t=JSON.stringify({bool:e}):"object"===n&&(t=JSON.stringify({json:e})),t},e.value=function(e){var t=e;return"object"!=typeof e||("string"in e?t=e.string:"number"in e?t=e.number.valueOf():"bool"in e?t=e.bool.valueOf():"json"in e&&"object"!=typeof(t=e.json)&&(t=JSON.parse(t))),t},e.extractJson=function(e){var t=e;return e?("object"==typeof e&&"json"in e&&(t=e.json),"string"==typeof t&&(t=JSON.parse(t)),"object"==typeof t&&"json"in t&&(t=t.json),"object"!=typeof t&&(t=null),t):null},e}(),j=function(){function e(e){this.level=e,e||(this.level=s.ERROR),"undefined"==typeof console&&(this.level=s.NONE)}return e.prototype.log=function(e,t){this.level===s.LOG&&console.log(e,t)},e.prototype.warn=function(e,t){this.level!==s.LOG&&this.level!==s.WARN||console.warn(e,t)},e.prototype.error=function(e,t){this.level!==s.LOG&&this.level!==s.WARN&&this.level!==s.ERROR||console.error(e,t)},e.prototype.setLevel=function(e){this.level=e},e}(),m=require("url-join"),k=function(){function e(e,t,n){var o;this.sdk={org:"fidj",version:"2.1.50",prod:!1,useDB:!0},t&&(this.promise=t),this.logger=e||new j,n&&n.logLevel&&this.logger.setLevel(n.logLevel),this.logger.log("fidj.sdk.service : constructor"),"undefined"!=typeof window?o=window.localStorage:"undefined"!=typeof global&&(require("localstorage-polyfill"),o=global.localStorage),this.storage=new i(o,"fidj."),this.session=new v,this.connection=new g(this.sdk,this.storage,this.logger)}return e.prototype.fidjInit=function(e,t){var n=this;return t&&t.logLevel&&n.logger.setLevel(t.logLevel),n.logger.log("fidj.sdk.service.fidjInit : ",t),e?(n.sdk.prod=!t||t.prod,n.sdk.useDB=!t||t.useDB,n.connection.fidjId=e,n.connection.fidjVersion=n.sdk.version,n.connection.fidjCrypto=!t||!t.hasOwnProperty("crypto")||t.crypto,new n.promise((function(e,t){n.connection.verifyConnectionStates().then((function(){var o=n.connection.getApiEndpoints({filter:"theBestOne"})[0],i=n.connection.getApiEndpoints({filter:"theBestOldOne"})[0],r=n.fidjIsLogin();n.logger.log("fidj.sdk.service.fidjInit > verifyConnectionStates : ",o,i,r),o&&o.url&&(o=o.url),i&&i.url&&(i=i.url),o?(n.connection.setClient(new f(n.connection.fidjId,o,n.storage,n.sdk)),e()):r&&i?(n.connection.setClient(new f(n.connection.fidjId,i,n.storage,n.sdk)),e()):t(new p(404,"Need one connection - or too old SDK version (check update)"))})).catch((function(e){n.logger.error("fidj.sdk.service.fidjInit: ",e),t(new p(500,e.toString()))}))}))):(n.logger.error("fidj.sdk.service.fidjInit : bad init"),n.promise.reject(new p(400,"Need a fidjId")))},e.prototype.fidjLogin=function(e,t){var n=this;return n.logger.log("fidj.sdk.service.fidjLogin"),n.connection.isReady()?new n.promise((function(o,i){n._removeAll().then((function(){return n.connection.verifyConnectionStates()})).then((function(){return n._createSession(n.connection.fidjId)})).then((function(){return n._loginInternal(e,t)})).then((function(e){n.connection.setConnection(e),n.sdk.useDB?n.session.sync(n.connection.getClientId()).then((function(){return o(n.connection.getUser())})).catch((function(e){return o(n.connection.getUser())})):o(n.connection.getUser())})).catch((function(e){n.logger.error("fidj.sdk.service.fidjLogin: ",e.toString()),i(e)}))})):n.promise.reject(new p(404,"Need an intialized FidjService"))},e.prototype.fidjLoginInDemoMode=function(e){var t=this;if(!e||!e.accessToken){var n=new Date;n.setDate(n.getDate()+1);var i=n.getTime(),r=o.encode(JSON.stringify({roles:[],message:"demo",apis:[],endpoints:[],dbs:[],exp:i})),s=o.encode(JSON.stringify({})),c=s+"."+r+"."+s;e={accessToken:c,idToken:c,refreshToken:c}}return new t.promise((function(n,o){t._removeAll().then((function(){return t._createSession(t.connection.fidjId)})).then((function(){t.connection.setConnectionOffline(e),n(t.connection.getUser())})).catch((function(e){t.logger.error("fidj.sdk.service.fidjLoginInDemoMode error: ",e),o(e)}))}))},e.prototype.fidjGetEndpoints=function(e){e||(e={showBlocked:!1});var t=this.connection.getAccessPayload({endpoints:[]}),n=JSON.parse(t).endpoints;return n&&Array.isArray(n)?n=n.filter((function(t){var n=!0;return n&&e.key&&(n=t.key===e.key),n&&!e.showBlocked&&(n=!t.blocked),n})):[]},e.prototype.fidjRoles=function(){return JSON.parse(this.connection.getIdPayload({roles:[]})).roles},e.prototype.fidjMessage=function(){return JSON.parse(this.connection.getIdPayload({message:""})).message},e.prototype.fidjIsLogin=function(){return this.connection.isLogin()},e.prototype.fidjLogout=function(e){var t=this,n=this;return n.connection.getClient()||e?n.connection.logout().then((function(){return n._removeAll()})).catch((function(){return n._removeAll()})).then((function(){return t.session.create(n.connection.fidjId,!0)})):n._removeAll().then((function(){return t.session.create(n.connection.fidjId,!0)}))},e.prototype.fidjSync=function(e,t){var n=this,o=this;if(o.logger.log("fidj.sdk.service.fidjSync"),!o.sdk.useDB)return o.logger.log("fidj.sdk.service.fidjSync: you ar not using DB - no sync available."),Promise.resolve();var i=null===o.session.dbLastSync;return new o.promise((function(r,s){o._createSession(o.connection.fidjId).then((function(){return o.session.sync(o.connection.getClientId())})).then((function(){return o.logger.log("fidj.sdk.service.fidjSync resolved"),o.session.isEmpty()})).catch((function(e){return o.logger.warn("fidj.sdk.service.fidjSync warn: ",e),o.session.isEmpty()})).then((function(n){return o.logger.log("fidj.sdk.service.fidjSync isEmpty : ",n,i),new o.promise((function(r,c){if(n&&i&&e){var a=e(t);a&&a.catch instanceof Function&&a.then(r).catch(s),"string"==typeof a&&o.logger.log(a)}r()}))})).then((function(e){return o.logger.log("fidj.sdk.service.fidjSync fnInitFirstData resolved: ",e),o.session.dbLastSync=(new Date).getTime(),o.session.info()})).then((function(e){return o.session.dbRecordCount=0,e&&e.doc_count&&(o.session.dbRecordCount=e.doc_count),o.logger.log("fidj.sdk.service.fidjSync _dbRecordCount : "+o.session.dbRecordCount),o.connection.refreshConnection()})).then((function(e){o.logger.log("fidj.sdk.service.fidjSync refreshConnection done : ",e),r()})).catch((function(e){if(o.logger.warn("fidj.sdk.service.fidjSync refreshConnection failed : ",e),!e||403!==e.code&&410!==e.code)if(e&&e.code)r();else{var t="Error during synchronisation: "+e.toString();o.logger.error(t),s({code:500,reason:t})}else n.fidjLogout().then((function(){s({code:403,reason:"Synchronization unauthorized : need to login again."})})).catch((function(){s({code:403,reason:"Synchronization unauthorized : need to login again.."})}))}))}))},e.prototype.fidjPutInDb=function(e){var t,n,o=this;return o.logger.log("fidj.sdk.service.fidjPutInDb: ",e),o.sdk.useDB?o.connection.getClientId()?o.session.isReady()?(e&&"object"==typeof e&&Object.keys(e).indexOf("_id")&&(t=e._id),t||(t=o._generateObjectUniqueId(o.connection.fidjId)),o.connection.fidjCrypto&&(n={obj:o.connection,method:"encrypt"}),o.session.put(e,t,o.connection.getClientId(),o.sdk.org,o.connection.fidjVersion,n)):o.promise.reject(new p(400,"Need to be synchronised.")):o.promise.reject(new p(401,"DB put impossible. Need a user logged in.")):(o.logger.log("fidj.sdk.service.fidjPutInDb: you are not using DB - no put available."),Promise.resolve("NA"))},e.prototype.fidjRemoveInDb=function(e){var t=this;return t.logger.log("fidj.sdk.service.fidjRemoveInDb ",e),t.sdk.useDB?t.session.isReady()?e&&"string"==typeof e?t.session.remove(e):t.promise.reject(new p(400,"DB remove impossible. Need the data._id.")):t.promise.reject(new p(400,"Need to be synchronised.")):(t.logger.log("fidj.sdk.service.fidjRemoveInDb: you are not using DB - no remove available."),Promise.resolve())},e.prototype.fidjFindInDb=function(e){var t,n=this;return n.sdk.useDB?n.connection.getClientId()?n.session.isReady()?(n.connection.fidjCrypto&&(t={obj:n.connection,method:"decrypt"}),n.session.get(e,t)):n.promise.reject(new p(400," Need to be synchronised.")):n.promise.reject(new p(401,"Find pb : need a user logged in.")):(n.logger.log("fidj.sdk.service.fidjFindInDb: you are not using DB - no find available."),Promise.resolve())},e.prototype.fidjFindAllInDb=function(){var e,t=this;return t.sdk.useDB?t.connection.getClientId()?t.session.isReady()?(t.connection.fidjCrypto&&(e={obj:t.connection,method:"decrypt"}),t.session.getAll(e).then((function(e){return t.connection.setCryptoSaltAsVerified(),t.promise.resolve(e)}))):t.promise.reject(new p(400,"Need to be synchronised.")):t.promise.reject(new p(401,"Need a user logged in.")):(t.logger.log("fidj.sdk.service.fidjFindAllInDb: you are not using DB - no find available."),Promise.resolve([]))},e.prototype.fidjSendOnEndpoint=function(e,t,n,o){var i={key:e},r=this.fidjGetEndpoints(i);if(!r||1!==r.length)return this.promise.reject(new p(400,"fidj.sdk.service.fidjSendOnEndpoint : endpoint does not exist."));var s=r[0].url;n&&(s=m(s,n));var c,a=this.connection.getIdToken(),d=new l;switch(t){case"POST":c=d.post({url:s,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+a},data:o});break;case"PUT":c=d.put({url:s,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+a},data:o});break;case"DELETE":c=d.delete({url:s,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+a}});break;default:c=d.get({url:s,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+a}})}return c},e.prototype.fidjGetIdToken=function(){return this.connection.getIdToken()},e.prototype._loginInternal=function(e,t,n){var o=this;return o.logger.log("fidj.sdk.service._loginInternal"),o.connection.isReady()?new o.promise((function(i,r){o.connection.logout().then((function(){return o.connection.getClient().login(e,t,n)})).catch((function(i){return o.connection.getClient().login(e,t,n)})).then((function(t){t.email=e,i(t)})).catch((function(e){o.logger.error("fidj.sdk.service._loginInternal error : "+e),r(e)}))})):o.promise.reject(new p(403,"Need an intialized FidjService"))},e.prototype._removeAll=function(){return this.connection.destroy(),this.session.destroy()},e.prototype._createSession=function(e){var t=this.connection.getDBs({filter:"theBestOnes"});return t&&0!==t.length||this.logger.warn("Seems that you are in Demo mode or using Node (no remote DB)."),this.session.setRemote(t),this.session.create(e)},e.prototype._testPromise=function(e){return e?this.promise.resolve("test promise ok "+e):new this.promise((function(e,t){e("test promise ok")}))},e.prototype._generateObjectUniqueId=function(t,n,o){var i=new Date,r=""+i.getFullYear()+i.getMonth()+i.getDate()+i.getHours()+i.getMinutes(),s=++e._srvDataUniqId,c="";return t&&t.charAt(0)&&(c+=t.charAt(0)+""),n&&n.length>3&&(c+=n.substring(0,4)),o&&o.length>3&&(c+=o.substring(0,4)),c+=r+""+s},e}();k._srvDataUniqId=0,e.FidjService=function(){function e(){this.logger=new j(s.ERROR),this.promise=Promise,this.fidjService=null}return e.prototype.init=function(e,t){return this.fidjService||(this.fidjService=new k(this.logger,this.promise)),this.fidjService.fidjInit(e,t)},e.prototype.login=function(e,t){return this.fidjService?this.fidjService.fidjLogin(e,t):this.promise.reject(new p(303,"fidj.sdk.angular2.login : not initialized."))},e.prototype.loginAsDemo=function(e){return this.fidjService?this.fidjService.fidjLoginInDemoMode(e):this.promise.reject(new p(303,"fidj.sdk.angular2.loginAsDemo : not initialized."))},e.prototype.isLoggedIn=function(){return!!this.fidjService&&this.fidjService.fidjIsLogin()},e.prototype.getRoles=function(){return this.fidjService?this.fidjService.fidjRoles():[]},e.prototype.getEndpoints=function(){return this.fidjService?this.fidjService.fidjGetEndpoints():[]},e.prototype.sendOnEndpoint=function(e,t,n,o){return this.fidjService?this.fidjService.fidjSendOnEndpoint(e,t,n,o):this.promise.reject(new p(303,"fidj.sdk.angular2.loginAsDemo : not initialized."))},e.prototype.getIdToken=function(){if(this.fidjService)return this.fidjService.fidjGetIdToken()},e.prototype.getMessage=function(){return this.fidjService?this.fidjService.fidjMessage():""},e.prototype.logout=function(e){return e||!this.fidjService?this.promise.reject(new p(303,"fidj.sdk.angular2.logout : not initialized.")):this.fidjService.fidjLogout(e)},e.prototype.sync=function(e){return this.fidjService?this.fidjService.fidjSync(e,this):this.promise.reject(new p(401,"fidj.sdk.angular2.sync : not initialized."))},e.prototype.put=function(e){return this.fidjService?this.fidjService.fidjPutInDb(e):this.promise.reject(new p(401,"fidj.sdk.angular2.put : not initialized."))},e.prototype.remove=function(e){return this.fidjService?this.fidjService.fidjRemoveInDb(e):this.promise.reject(new p(401,"fidj.sdk.angular2.remove : not initialized."))},e.prototype.find=function(e){return this.fidjService?this.fidjService.fidjFindInDb(e):this.promise.reject(new p(401,"fidj.sdk.angular2.find : not initialized."))},e.prototype.findAll=function(){return this.fidjService?this.fidjService.fidjFindAllInDb():this.promise.reject(new p(401,"fidj.sdk.angular2.findAll : not initialized."))},e}(),e.FidjService=c([t.Injectable()],e.FidjService),e.FidjModule=function(){},e.FidjModule=c([t.NgModule({imports:[n.CommonModule],declarations:[],exports:[],providers:[e.FidjService]})],e.FidjModule),e.Base64=o,e.LocalStorage=i,e.Xor=r,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=fidj.umd.min.js.map