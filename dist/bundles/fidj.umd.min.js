!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common")):"function"==typeof define&&define.amd?define("fidj",["exports","@angular/core","@angular/common"],t):t((e=e||self).fidj={},e.ng.core,e.ng.common)}(this,function(e,t,n){"use strict";function r(e,t,n,r){var o,i=arguments.length,s=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var c=e.length-1;c>=0;c--)(o=e[c])&&(s=(i<3?o(s):i>3?o(t,n,s):o(t,n))||s);return i>3&&s&&Object.defineProperty(t,n,s),s}function o(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function i(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{a(r.next(e))}catch(e){i(e)}}function c(e){try{a(r.throw(e))}catch(e){i(e)}}function a(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,c)}a((r=r.apply(e,t||[])).next())})}function s(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}var c=function(){function e(){}return e.encode=function(e){return e?btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode(parseInt("0x"+t,16))})):null},e.decode=function(e){return e?decodeURIComponent(atob(e).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join("")):null},e}(),a=function(){function e(e,t){if(this.storageKey=t,this.version="0.1",this.storage=e||window.localStorage,!this.storage)throw new Error("fidj.LocalStorageFactory needs a storageService!")}return e.prototype.set=function(e,t){e=this.storageKey+e,this.checkKey(e);var n=typeof t;if("undefined"===n)t="null";else if(null===t)t="null";else if("string"===n)t=JSON.stringify({string:t});else if("number"===n)t=JSON.stringify({number:t});else if("boolean"===n)t=JSON.stringify({bool:t});else{if("object"!==n)throw new TypeError("Value type "+n+" is invalid. It must be null, undefined, xml, string, number, boolean or object");t=JSON.stringify({json:t})}return this.storage.setItem(e,t),t},e.prototype.get=function(e,t){e=this.storageKey+e,this.checkKey(e);var n=this.storage.getItem(e);if(null!==n){if("null"===n)return null;var r=JSON.parse(n);return"string"in r?r.string:"number"in r?r.number.valueOf():"bool"in r?r.bool.valueOf():r.json}return t||null},e.prototype.remove=function(e){e=this.storageKey+e,this.checkKey(e);var t=null!==this.storage.getItem(e);return this.storage.removeItem(e),t},e.prototype.clear=function(){var e=this.storage.length>0;return this.storage.clear(),e},e.prototype.size=function(){return this.storage.length},e.prototype.foreach=function(e,t){for(var n=this.storage.length,r=0;r<n;r++){var o=this.storage.key(r),i=this.get(o);t?e.call(t,i):e(i)}return n},e.prototype.checkKey=function(e){if(!e||"string"!=typeof e)throw new TypeError("Key type must be string");return!0},e}(),d=function(){function e(){}return e.encrypt=function(t,n){var r="";t=e.header+t;for(var o=0;o<t.length;o++)r+=String.fromCharCode(t[o].charCodeAt(0).toString(10)^e.keyCharAt(n,o));return r=c.encode(r)},e.decrypt=function(t,n,r){var o="";t=c.decode(t);for(var i=0;i<t.length;i++)o+=String.fromCharCode(t[i].charCodeAt(0).toString(10)^e.keyCharAt(n,i));return r||e.header===o.substring(0,e.header.length)?(r||(o=o.substring(e.header.length)),o):null},e.keyCharAt=function(e,t){return e[Math.floor(t%e.length)].charCodeAt(0).toString(10)},e.header="artemis-lotsum",e}(),u="2.1.26",l=function(){function e(){this.DEFAULT_CONTENT_TYPE="application/x-www-form-urlencoded; charset=UTF-8"}return e.prototype.send=function(e){var t,n;return null==e&&(e={}),t={method:"GET",data:null,headers:{},async:!0,username:null,password:null,withCredentials:!1},e=Object.assign({},t,e),new Promise((n=this,function(t,r){var o,i,s,c,a;if(XMLHttpRequest)if("string"==typeof e.url&&0!==e.url.length){for(i in n._xhr=a=new XMLHttpRequest,a.onload=function(){var e;n._detachWindowUnload();try{e=n._getResponseText()}catch(e){return void n._handleError("parse",r,null,"invalid JSON response")}return t({url:n._getResponseUrl(),status:a.status,statusText:a.statusText,responseText:e,headers:n._getHeaders(),xhr:a})},a.onerror=function(){return n._handleError("error",r)},a.ontimeout=function(){return n._handleError("timeout",r)},a.onabort=function(){return n._handleError("abort",r)},n._attachWindowUnload(),a.open(e.method,e.url,e.async,e.username,e.password),e.withCredentials&&(a.withCredentials=!0),null==e.data||e.headers["Content-Type"]||(e.headers["Content-Type"]=n.DEFAULT_CONTENT_TYPE),s=e.headers)s.hasOwnProperty(i)&&(c=s[i],a.setRequestHeader(i,c));try{return a.send(e.data)}catch(e){return o=e,n._handleError("send",r,null,o.toString())}}else n._handleError("url",r,null,"URL is a required parameter");else n._handleError("browser",r,null,"browser doesn't support XMLHttpRequest")}))},e.prototype.getXHR=function(){return this._xhr},e.prototype._attachWindowUnload=function(){if(this._unloadHandler=this._handleWindowUnload.bind(this),window.attachEvent)return window.attachEvent("onunload",this._unloadHandler)},e.prototype._detachWindowUnload=function(){if(window.detachEvent)return window.detachEvent("onunload",this._unloadHandler)},e.prototype._getHeaders=function(){return this._parseHeaders(this._xhr.getAllResponseHeaders())},e.prototype._getResponseText=function(){var e;switch(e="string"==typeof this._xhr.responseText?this._xhr.responseText:"",(this._xhr.getResponseHeader("Content-Type")||"").split(";")[0]){case"application/json":case"text/javascript":e=JSON.parse(e+"")}return e},e.prototype._getResponseUrl=function(){return null!=this._xhr.responseURL?this._xhr.responseURL:/^X-Request-URL:/m.test(this._xhr.getAllResponseHeaders())?this._xhr.getResponseHeader("X-Request-URL"):""},e.prototype._handleError=function(e,t,n,r){this._detachWindowUnload();var o=404;return"timeout"===e?o=408:"abort"===e&&(o=408),t({reason:e,status:n||this._xhr.status||o,code:n||this._xhr.status||o,statusText:r||this._xhr.statusText,xhr:this._xhr})},e.prototype._handleWindowUnload=function(){return this._xhr.abort()},e.prototype.trim=function(e){return e.replace(/^\s*|\s*$/g,"")},e.prototype.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},e.prototype.forEach=function(e,t){"[object Array]"===toString.call(e)?this.forEachArray(e,t,this):"string"==typeof e?this.forEachString(e,t,this):this.forEachObject(e,t,this)},e.prototype.forEachArray=function(e,t,n){for(var r=0,o=e.length;r<o;r++)e.hasOwnProperty(r)&&t.call(n,e[r],r,e)},e.prototype.forEachString=function(e,t,n){for(var r=0,o=e.length;r<o;r++)t.call(n,e.charAt(r),r,e)},e.prototype.forEachObject=function(e,t,n){for(var r in e)e.hasOwnProperty(r)&&t.call(n,e[r],r,e)},e.prototype._parseHeaders=function(e){var t=this;if(!e)return{};var n={};return this.forEach(this.trim(e).split("\n"),function(e){var r=e.indexOf(":"),o=t.trim(e.slice(0,r)).toLowerCase(),i=t.trim(e.slice(r+1));void 0===n[o]?n[o]=i:t.isArray(n[o])?n[o].push(i):n[o]=[n[o],i]}),n},e}(),h=function(){function e(){this.xhr=new l}return e.prototype.post=function(e){var t={method:"POST",url:e.url,data:JSON.stringify(e.data)};return e.headers&&(t.headers=e.headers),this.xhr.send(t).then(function(e){return e.status&&(parseInt(e.status,10)<200||parseInt(e.status,10)>=300)?(e.reason="status",e.code=parseInt(e.status,10),Promise.reject(e)):Promise.resolve(e.responseText)}).catch(function(e){return Promise.reject(e)})},e.prototype.put=function(e){var t={method:"PUT",url:e.url,data:JSON.stringify(e.data)};return e.headers&&(t.headers=e.headers),this.xhr.send(t).then(function(e){return e.status&&(parseInt(e.status,10)<200||parseInt(e.status,10)>=300)?(e.reason="status",e.code=parseInt(e.status,10),Promise.reject(e)):Promise.resolve(e.responseText)}).catch(function(e){return Promise.reject(e)})},e.prototype.delete=function(e){var t={method:"DELETE",url:e.url,data:JSON.stringify(e.data)};return e.headers&&(t.headers=e.headers),this.xhr.send(t).then(function(e){return e.status&&(parseInt(e.status,10)<200||parseInt(e.status,10)>=300)?(e.reason="status",e.code=parseInt(e.status,10),Promise.reject(e)):Promise.resolve(e.responseText)}).catch(function(e){return Promise.reject(e)})},e.prototype.get=function(e){var t={method:"GET",url:e.url};return e.data&&(t.data=e.data),e.headers&&(t.headers=e.headers),this.xhr.send(t).then(function(e){return e.status&&(parseInt(e.status,10)<200||parseInt(e.status,10)>=300)?(e.reason="status",e.code=parseInt(e.status,10),Promise.reject(e)):Promise.resolve(e.responseText)}).catch(function(e){return Promise.reject(e)})},e}(),f=function(){function e(t,n,r,o){this.appId=t,this.URI=n,this.storage=r,this.sdk=o;var i=this.storage.get(e._clientUuid)||"uuid-"+Math.random(),s="_clientInfo";window&&window.navigator&&(s=window.navigator.appName+"@"+window.navigator.appVersion+"-"+window.navigator.userAgent),window&&window.device&&window.device.uuid&&(i=window.device.uuid),this.setClientUuid(i),this.setClientInfo(s),this.clientId=this.storage.get(e._clientId),e.refreshCount=this.storage.get(e._refreshCount)||e.refreshCountInitial}return e.prototype.setClientId=function(t){this.clientId=""+t,this.storage.set(e._clientId,this.clientId)},e.prototype.setClientUuid=function(t){this.clientUuid=""+t,this.storage.set(e._clientUuid,this.clientUuid)},e.prototype.setClientInfo=function(e){this.clientInfo=""+e},e.prototype.login=function(e,t,n){var r=this;if(!this.URI)return console.error("no api uri"),Promise.reject({code:408,reason:"no-api-uri"});var o=this.URI+"/users",i={name:e,username:e,email:e,password:t};return(new h).post({url:o,data:i,headers:{"Content-Type":"application/json",Accept:"application/json"}}).then(function(e){r.setClientId(e._id);var n=r.URI+"/oauth/token",o={grant_type:"client_credentials",client_id:r.clientId,client_secret:t,client_udid:r.clientUuid,client_info:r.clientInfo,audience:r.appId,scope:JSON.stringify(r.sdk)};return(new h).post({url:n,data:o,headers:{"Content-Type":"application/json",Accept:"application/json"}})})},e.prototype.reAuthenticate=function(t){var n=this;if(!this.URI)return console.error("no api uri"),Promise.reject({code:408,reason:"no-api-uri"});var r=this.URI+"/oauth/token",o={grant_type:"refresh_token",client_id:this.clientId,client_udid:this.clientUuid,client_info:this.clientInfo,audience:this.appId,scope:JSON.stringify(this.sdk),refresh_token:t,refresh_extra:e.refreshCount};return(new h).post({url:r,data:o,headers:{"Content-Type":"application/json",Accept:"application/json"}}).then(function(t){return e.refreshCount++,n.storage.set(e._refreshCount,e.refreshCount),Promise.resolve(t)})},e.prototype.logout=function(t){if(!this.URI)return console.error("no api uri"),Promise.reject({code:408,reason:"no-api-uri"});if(this.storage.remove(e._clientId),this.storage.remove(e._refreshCount),e.refreshCount=e.refreshCountInitial,!t||!this.clientId)return Promise.resolve();var n=this.URI+"/oauth/revoke",r={token:t,client_id:this.clientId,client_udid:this.clientUuid,client_info:this.clientInfo,audience:this.appId,scope:JSON.stringify(this.sdk)};return(new h).post({url:n,data:r,headers:{"Content-Type":"application/json",Accept:"application/json"}})},e.prototype.isReady=function(){return!!this.URI},e.refreshCountInitial=1,e.refreshCount=e.refreshCountInitial,e._clientUuid="v2.clientUuid",e._clientId="v2.clientId",e._refreshCount="v2.refreshCount",e}(),p=function(){function e(e,t){this.code=e,this.reason=t}return e.prototype.equals=function(e){return this.code===e.code&&this.reason===e.reason},e.prototype.toString=function(){var e="string"==typeof this.reason?this.reason:JSON.stringify(this.reason);return this.code+" - "+e},e}(),g=function(){function e(t,n,r){this._sdk=t,this._storage=n,this._logger=r,this.client=null,this.user=null,this.cryptoSalt=this._storage.get(e._cryptoSalt)||null,this.cryptoSaltNext=this._storage.get(e._cryptoSaltNext)||null,this.accessToken=this._storage.get(e._accessToken)||null,this.accessTokenPrevious=this._storage.get("v2.accessTokenPrevious")||null,this.idToken=this._storage.get(e._idToken)||null,this.refreshToken=this._storage.get(e._refreshToken)||null,this.states=this._storage.get(e._states)||{},this.apis=[]}return e.prototype.isReady=function(){return!!this.client&&this.client.isReady()},e.prototype.destroy=function(t){this._storage.remove(e._accessToken),this._storage.remove(e._idToken),this._storage.remove(e._refreshToken),this._storage.remove(e._states),this.accessToken&&(this.accessTokenPrevious=this.accessToken,this._storage.set(e._accessTokenPrevious,this.accessTokenPrevious)),t&&(this._storage.remove(e._cryptoSalt),this._storage.remove(e._cryptoSaltNext),this._storage.remove(e._accessTokenPrevious)),this.user=null,this.client&&this.client.logout(),this.accessToken=null,this.idToken=null,this.refreshToken=null,this.states={}},e.prototype.setClient=function(e){this.client=e,this.user||(this.user={}),this.user._name=JSON.parse(this.getIdPayload({name:""})).name},e.prototype.setUser=function(e){this.user=e,this.client&&this.user._id&&(this.client.setClientId(this.user._id),delete this.user._id)},e.prototype.getUser=function(){return this.user},e.prototype.getClient=function(){return this.client},e.prototype.setCryptoSalt=function(t){this.cryptoSalt!==t&&this.cryptoSaltNext!==t&&(this.cryptoSaltNext=t,this._storage.set(e._cryptoSaltNext,this.cryptoSaltNext)),this.cryptoSalt||this.setCryptoSaltAsVerified()},e.prototype.setCryptoSaltAsVerified=function(){this.cryptoSaltNext&&(this.cryptoSalt=this.cryptoSaltNext,this._storage.set(e._cryptoSalt,this.cryptoSalt)),this.cryptoSaltNext=null,this._storage.remove(e._cryptoSaltNext)},e.prototype.encrypt=function(e){if("string"!=typeof e)e=JSON.stringify(e);else{var t={string:e};e=JSON.stringify(t)}if(this.fidjCrypto&&this.cryptoSalt){var n=this.cryptoSalt;return d.encrypt(e,n)}return e},e.prototype.decrypt=function(e){var t=null;try{if(!t&&this.fidjCrypto&&this.cryptoSaltNext){var n=this.cryptoSaltNext;t=d.decrypt(e,n),t=JSON.parse(t)}}catch(e){t=null}try{if(!t&&this.fidjCrypto&&this.cryptoSalt){n=this.cryptoSalt;t=d.decrypt(e,n),t=JSON.parse(t)}}catch(e){t=null}try{if(!t&&this.fidjCrypto&&this.cryptoSalt){n=this.cryptoSalt;t=d.decrypt(e,n,!0),t=JSON.parse(t)}}catch(e){t=null}try{t||(t=JSON.parse(e)),t&&t.string&&(t=t.string)}catch(e){t=null}return t},e.prototype.isLogin=function(){var e=!0;try{var t=this.refreshToken.split(".")[1],n=JSON.parse(c.decode(t));e=(new Date).getTime()/1e3>=n.exp}catch(e){}return!e},e.prototype.logout=function(){return this.getClient().logout(this.refreshToken)},e.prototype.getClientId=function(){return this.client?this.client.clientId:null},e.prototype.getIdToken=function(){return this.idToken},e.prototype.getIdPayload=function(e){e&&"string"!=typeof e&&(e=JSON.stringify(e));try{var t=this.getIdToken().split(".")[1];if(t)return c.decode(t)}catch(e){}return e||null},e.prototype.getAccessPayload=function(e){e&&"string"!=typeof e&&(e=JSON.stringify(e));try{var t=this.accessToken.split(".")[1];if(t)return c.decode(t)}catch(e){}return e||null},e.prototype.getPreviousAccessPayload=function(e){e&&"string"!=typeof e&&(e=JSON.stringify(e));try{var t=this.accessTokenPrevious.split(".")[1];if(t)return c.decode(t)}catch(e){}return e||null},e.prototype.refreshConnection=function(){var t=this;if(this._storage.set(e._states,this.states),this.accessToken){var n=this.accessToken.split(".")[1],r=c.decode(n),o=(new Date).getTime()/1e3<JSON.parse(r).exp;if(this._logger.log("fidj.connection.connection.refreshConnection : token not expired ? ",o),o)return Promise.resolve(this.getUser())}if(this.refreshToken){n=this.refreshToken.split(".")[1],r=c.decode(n);var i=(new Date).getTime()/1e3>=JSON.parse(r).exp;this._logger.log("fidj.connection.connection.refreshConnection : refreshToken not expired ? ",i),i&&this._storage.remove(e._refreshToken)}return this.accessTokenPrevious=this.accessToken,this._storage.set("v2.accessTokenPrevious",this.accessTokenPrevious),this._storage.remove(e._accessToken),this._storage.remove(e._idToken),this.accessToken=null,this.idToken=null,this._logger.log("fidj.connection.connection.refreshConnection : refresh authentication."),new Promise(function(e,n){if(!t.getClient())return n(new p(400,"Need an initialized client."));t.getClient().reAuthenticate(t.refreshToken).then(function(n){t.setConnection(n),e(t.getUser())}).catch(function(e){n(e)})})},e.prototype.setConnection=function(t){if(t.access_token){this.accessToken=t.access_token,this._storage.set(e._accessToken,this.accessToken),delete t.access_token;var n=JSON.parse(this.getAccessPayload({salt:""})).salt;n&&this.setCryptoSalt(n)}t.id_token&&(this.idToken=t.id_token,this._storage.set(e._idToken,this.idToken),delete t.id_token),t.refresh_token&&(this.refreshToken=t.refresh_token,this._storage.set(e._refreshToken,this.refreshToken),delete t.refresh_token),this._storage.set(e._states,this.states),t.roles=JSON.parse(this.getIdPayload({roles:[]})).roles,t.message=JSON.parse(this.getIdPayload({message:""})).message,this.setUser(t)},e.prototype.setConnectionOffline=function(t){t.accessToken&&(this.accessToken=t.accessToken,this._storage.set(e._accessToken,this.accessToken)),t.idToken&&(this.idToken=t.idToken,this._storage.set(e._idToken,this.idToken)),t.refreshToken&&(this.refreshToken=t.refreshToken,this._storage.set(e._refreshToken,this.refreshToken)),this.setUser({roles:JSON.parse(this.getIdPayload({roles:[]})).roles,message:JSON.parse(this.getIdPayload({message:""})).message,_id:"demo"})},e.prototype.getApiEndpoints=function(e){var t=[{key:"fidj.default",url:"https://fidj.ovh/api",blocked:!1}],n=[];if(this._sdk.prod||(t=[{key:"fidj.default",url:"http://localhost:3201/api",blocked:!1},{key:"fidj.default",url:"https://fidj-sandbox.herokuapp.com/api",blocked:!1}]),this.accessToken){var r,o=this.getAccessPayload({apis:[]});(r=JSON.parse(o).apis)&&r.length&&(t=[],r.forEach(function(e){e.url&&t.push(e)}))}this.accessTokenPrevious&&((r=JSON.parse(this.getPreviousAccessPayload({apis:[]})).apis)&&r.length&&r.forEach(function(e){e.url&&0===t.filter(function(t){return t.url===e.url}).length&&t.push(e)}));var i=!0;if(this.states&&Object.keys(this.states).length)for(var s=0;s<t.length&&i;s++)this.states[t[s].url]||(i=!1);else i=!1;if(e&&e.filter)if(i&&"theBestOne"===e.filter)for(s=0;s<t.length&&0===n.length;s++){var c=t[s];this.states[c.url]&&this.states[c.url].state&&n.push(c)}else if(i&&"theBestOldOne"===e.filter){var a=void 0;for(s=0;s<t.length;s++){c=t[s];this.states[c.url]&&this.states[c.url].lastTimeWasOk&&(!a||this.states[c.url].lastTimeWasOk>this.states[a.url].lastTimeWasOk)&&(a=c)}a&&n.push(a)}else t.length&&n.push(t[0]);else n=t;return n},e.prototype.getDBs=function(e){if(!this.accessToken)return[];var t=Math.random()%2,n=JSON.parse(this.getAccessPayload({dbs:[]})).dbs||[];0===t?n=n.sort():1===t&&(n=n.reverse());var r=[],o=!0;if(this.states&&Object.keys(this.states).length)for(var i=0;i<n.length&&o;i++)this.states[n[i].url]||(o=!1);else o=!1;if(o&&e&&"theBestOne"===e.filter)for(i=0;i<n.length&&0===r.length;i++){var s=n[i];this.states[s.url]&&this.states[s.url].state&&r.push(s)}else if(o&&e&&"theBestOnes"===e.filter)for(i=0;i<n.length;i++){s=n[i];this.states[s.url]&&this.states[s.url].state&&r.push(s)}else e&&"theBestOne"===e.filter&&n.length?r.push(n[0]):r=n;return r},e.prototype.verifyApiState=function(e,t){return i(this,void 0,void 0,function(){var n,r,o;return s(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,(new h).get({url:t+"/status?isok="+this._sdk.version,headers:{"Content-Type":"application/json",Accept:"application/json"}})];case 1:return n=i.sent(),r=!1,n&&n.isok&&(r=!0),this.states[t]={state:r,time:e,lastTimeWasOk:e},[3,3];case 2:return i.sent(),o=0,this.states[t]&&(o=this.states[t].lastTimeWasOk),this.states[t]={state:!1,time:e,lastTimeWasOk:o},[3,3];case 3:return[2]}})})},e.prototype.verifyDbState=function(e,t){return i(this,void 0,void 0,function(){var n;return s(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,(new h).get({url:t,headers:{"Content-Type":"application/json",Accept:"application/json"}})];case 1:return r.sent(),this.states[t]={state:!0,time:e,lastTimeWasOk:e},[3,3];case 2:return r.sent(),n=0,this.states[t]&&(n=this.states[t].lastTimeWasOk),this.states[t]={state:!1,time:e,lastTimeWasOk:n},[3,3];case 3:return[2]}})})},e.prototype.verifyConnectionStates=function(){var e=this,t=(new Date).getTime(),n=[];return this.apis=this.getApiEndpoints(),this.apis.forEach(function(r){var o=r.url;o||(o=r.toString()),n.push(e.verifyApiState(t,o))}),this.getDBs().forEach(function(r){var o=r.url;o||(o=r.toString()),n.push(e.verifyDbState(t,o))}),Promise.all(n)},e._accessToken="v2.accessToken",e._accessTokenPrevious="v2.accessTokenPrevious",e._idToken="v2.idToken",e._refreshToken="v2.refreshToken",e._states="v2.states",e._cryptoSalt="v2.cryptoSalt",e._cryptoSaltNext="v2.cryptoSalt.next",e}(),y=window.PouchDB?window.PouchDB:require("pouchdb").default,v=require("pouchdb-adapter-cordova-sqlite");y.plugin(v);var j,m=function(){function e(){this.db=null,this.dbRecordCount=0,this.dbLastSync=null,this.remoteDb=null,this.dbs=[]}return e.prototype.isReady=function(){return!!this.db},e.prototype.create=function(e,t){var n=this;return!t&&this.db?Promise.resolve():(this.dbRecordCount=0,this.dbLastSync=null,this.db=null,e=e||"default",new Promise(function(t,r){var o={location:"default"};try{window.cordova&&(o={location:"default",adapter:"cordova-sqlite"}),n.db=new y("fidj_db_"+e,o),n.db.info().then(function(e){return t(n.db)}).catch(function(e){r(new p(400,e))})}catch(e){r(new p(500,e))}}))},e.prototype.destroy=function(){var e=this;return this.db?this.db&&!this.db.destroy?Promise.reject(new p(408,"Need a valid db")):new Promise(function(t,n){e.db.destroy(function(r,o){r?n(new p(500,r)):(e.dbRecordCount=0,e.dbLastSync=null,e.db=null,t())})}):(this.dbRecordCount=0,this.dbLastSync=null,Promise.resolve())},e.prototype.setRemote=function(e){this.dbs=e},e.prototype.sync=function(e){var t=this;return this.db?this.dbs&&this.dbs.length?new Promise(function(n,r){try{t.remoteDb&&t.remoteUri===t.dbs[0].url||(t.remoteUri=t.dbs[0].url,t.remoteDb=new y(t.remoteUri)),t.db.replicate.to(t.remoteDb).on("complete",function(o){return t.remoteDb.replicate.to(t.db,{filter:function(t){return!!e&&!!t&&t.fidjUserId===e}}).on("complete",function(){n()}).on("denied",function(e){return r({code:403,reason:{second:e}})}).on("error",function(e){return r({code:401,reason:{second:e}})})}).on("denied",function(e){return r({code:403,reason:{first:e}})}).on("error",function(e){return r({code:401,reason:{first:e}})})}catch(e){r(new p(500,e))}}):Promise.reject(new p(408,"need a remote db")):Promise.reject(new p(408,"need db"))},e.prototype.put=function(t,n,r,o,i,s){var c=this;if(!this.db)return Promise.reject(new p(408,"need db"));if(!(t&&n&&r&&o&&i))return Promise.reject(new p(400,"need formated data"));var a=JSON.parse(JSON.stringify(t)),d={_id:n,fidjUserId:r,fidjOrgId:o,fidjAppVersion:i};a._rev&&(d._rev=""+a._rev),delete a._id,delete a._rev,delete a.fidjUserId,delete a.fidjOrgId,delete a.fidjAppVersion,delete a.fidjData;var u=e.write(e.value(a));return s?(u=s.obj[s.method](u),d.fidjDacr=u):d.fidjData=u,new Promise(function(e,n){c.db.put(d,function(r,o){o&&o.ok&&o.id&&o.rev?(c.dbRecordCount++,"object"==typeof t?(t._rev=o.rev,t._id=o.id,e(t)):e(o.id)):n(new p(500,r))})})},e.prototype.remove=function(e){var t=this;return this.db?new Promise(function(n,r){t.db.get(e).then(function(e){return e._deleted=!0,t.db.put(e)}).then(function(e){n()}).catch(function(e){r(e)})}):Promise.reject(new p(408,"need db"))},e.prototype.get=function(t,n){var r=this;return this.db?new Promise(function(o,i){r.db.get(t).then(function(t){if(t&&(t.fidjDacr||t.fidjData)){var s=t.fidjDacr;n&&s?s=n.obj[n.method](s):t.fidjData&&(s=JSON.parse(t.fidjData));var c=e.extractJson(s);c?(c._id=t._id,c._rev=t._rev,o(JSON.parse(JSON.stringify(c)))):(r.remove(t._id),i(new p(400,"Bad encoding")))}else i(new p(400,"No data found"))}).catch(function(e){return i(new p(500,e))})}):Promise.reject(new p(408,"Need db"))},e.prototype.getAll=function(t){var n=this;return this.db&&this.db.allDocs?new Promise(function(r,o){n.db.allDocs({include_docs:!0,descending:!0}).then(function(o){var i=[];o.rows.forEach(function(r){if(r&&r.doc._id&&(r.doc.fidjDacr||r.doc.fidjData)){var o=r.doc.fidjDacr;t&&o?o=t.obj[t.method](o):r.doc.fidjData&&(o=JSON.parse(r.doc.fidjData));var s=e.extractJson(o);s?(s._id=r.doc._id,s._rev=r.doc._rev,i.push(JSON.parse(JSON.stringify(s)))):(console.error("Bad encoding : delete row"),n.remove(r.doc._id))}else console.error("Bad encoding")}),r(i)}).catch(function(e){return o(new p(400,e))})}):Promise.reject(new p(408,"Need a valid db"))},e.prototype.isEmpty=function(){var e=this;return this.db&&this.db.allDocs?new Promise(function(t,n){e.db.allDocs({}).then(function(r){r?(e.dbRecordCount=r.total_rows,r.total_rows&&r.total_rows>0?t(!1):t(!0)):n(new p(400,"No response"))}).catch(function(e){return n(new p(400,e))})}):Promise.reject(new p(408,"No db"))},e.prototype.info=function(){return this.db?this.db.info():Promise.reject(new p(408,"No db"))},e.write=function(e){var t="null",n=typeof e;return"undefined"===n?t="null":null===t?t="null":"string"===n?t=JSON.stringify({string:e}):"number"===n?t=JSON.stringify({number:e}):"boolean"===n?t=JSON.stringify({bool:e}):"object"===n&&(t=JSON.stringify({json:e})),t},e.value=function(e){var t=e;return"object"!=typeof e||("string"in e?t=e.string:"number"in e?t=e.number.valueOf():"bool"in e?t=e.bool.valueOf():"json"in e&&"object"!=typeof(t=e.json)&&(t=JSON.parse(t))),t},e.extractJson=function(e){var t=e;return e?("object"==typeof e&&"json"in e&&(t=e.json),"string"==typeof t&&(t=JSON.parse(t)),"object"==typeof t&&"json"in t&&(t=t.json),"object"!=typeof t&&(t=null),t):null},e}();!function(e){e[e.LOG=1]="LOG",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e[e.NONE=4]="NONE"}(j||(j={}));var _=function(){function e(e){this.level=e,e||(this.level=j.ERROR),window.console||(this.level=j.NONE)}return e.prototype.log=function(e,t){this.level===j.LOG&&console.log(e,t)},e.prototype.warn=function(e,t){this.level!==j.LOG&&this.level!==j.WARN||console.warn(e,t)},e.prototype.error=function(e,t){this.level!==j.LOG&&this.level!==j.WARN&&this.level!==j.ERROR||console.error(e,t)},e.prototype.setLevel=function(e){this.level=e},e}(),k=function(){function e(e,t){this.sdk={org:"fidj",version:u,prod:!1},t&&(this.promise=t),this.logger=e||new _,this.logger.log("fidj.sdk.service : constructor"),this.storage=new a(window.localStorage,"fidj."),this.session=new m,this.connection=new g(this.sdk,this.storage,this.logger)}return e.prototype.fidjInit=function(e,t){var n=this;return t&&t.logLevel&&n.logger.setLevel(t.logLevel),n.logger.log("fidj.sdk.service.fidjInit : ",t),e?(n.sdk.prod=!t||t.prod,n.connection.fidjId=e,n.connection.fidjVersion=n.sdk.version,n.connection.fidjCrypto=!t||!t.hasOwnProperty("crypto")||t.crypto,new n.promise(function(e,t){n.connection.verifyConnectionStates().then(function(){var r=n.connection.getApiEndpoints({filter:"theBestOne"})[0],o=n.connection.getApiEndpoints({filter:"theBestOldOne"})[0],i=n.fidjIsLogin();r&&r.url&&(r=r.url),o&&o.url&&(o=o.url),r?(n.connection.setClient(new f(n.connection.fidjId,r,n.storage,n.sdk)),e()):i&&o?(n.connection.setClient(new f(n.connection.fidjId,o,n.storage,n.sdk)),e()):t(new p(404,"Need one connection - or too old SDK version (check update)"))}).catch(function(e){n.logger.error("fidj.sdk.service.fidjInit: ",e),t(new p(500,e.toString()))})})):(n.logger.error("fidj.sdk.service.fidjInit : bad init"),n.promise.reject(new p(400,"Need a fidjId")))},e.prototype.fidjLogin=function(e,t){var n=this;return n.logger.log("fidj.sdk.service.fidjLogin"),n.connection.isReady()?new n.promise(function(r,o){n._removeAll().then(function(){return n.connection.verifyConnectionStates()}).then(function(){return n._createSession(n.connection.fidjId)}).then(function(){return n._loginInternal(e,t)}).then(function(e){n.connection.setConnection(e),n.session.sync(n.connection.getClientId()).then(function(){return r(n.connection.getUser())}).catch(function(e){return r(n.connection.getUser())})}).catch(function(e){n.logger.error("fidj.sdk.service.fidjLogin: ",e.toString()),o(e)})}):n.promise.reject(new p(404,"Need an intialized FidjService"))},e.prototype.fidjLoginInDemoMode=function(e){var t=this;if(!e||!e.accessToken){var n=new Date;n.setDate(n.getDate()+1);var r=n.getTime(),o=c.encode(JSON.stringify({roles:[],message:"demo",apis:[],endpoints:[],dbs:[],exp:r})),i=c.encode(JSON.stringify({})),s=i+"."+o+"."+i;e={accessToken:s,idToken:s,refreshToken:s}}return new t.promise(function(n,r){t._removeAll().then(function(){return t._createSession(t.connection.fidjId)}).then(function(){t.connection.setConnectionOffline(e),n(t.connection.getUser())}).catch(function(e){t.logger.error("fidj.sdk.service.fidjLoginInDemoMode error: ",e),r(e)})})},e.prototype.fidjGetEndpoints=function(e){e||(e={showBlocked:!1});var t=this.connection.getAccessPayload({endpoints:[]}),n=JSON.parse(t).endpoints;return n&&Array.isArray(n)?n=n.filter(function(t){var n=!0;return n&&e.key&&(n=t.key===e.key),n&&!e.showBlocked&&(n=!t.blocked),n}):[]},e.prototype.fidjRoles=function(){return JSON.parse(this.connection.getIdPayload({roles:[]})).roles},e.prototype.fidjMessage=function(){return JSON.parse(this.connection.getIdPayload({message:""})).message},e.prototype.fidjIsLogin=function(){return this.connection.isLogin()},e.prototype.fidjLogout=function(e){var t=this,n=this;return n.connection.getClient()||e?n.connection.logout().then(function(){return n._removeAll()}).catch(function(){return n._removeAll()}).then(function(){return t.session.create(n.connection.fidjId,!0)}):n._removeAll().then(function(){return t.session.create(n.connection.fidjId,!0)})},e.prototype.fidjSync=function(e,t){var n=this,r=this;r.logger.log("fidj.sdk.service.fidjSync");var o=null===r.session.dbLastSync;return new r.promise(function(i,s){r._createSession(r.connection.fidjId).then(function(){return r.session.sync(r.connection.getClientId())}).then(function(){return r.logger.log("fidj.sdk.service.fidjSync resolved"),r.session.isEmpty()}).catch(function(e){return r.logger.warn("fidj.sdk.service.fidjSync warn: ",e),r.session.isEmpty()}).then(function(n){return r.logger.log("fidj.sdk.service.fidjSync isEmpty : ",n,o),new r.promise(function(i,c){if(n&&o&&e){var a=e(t);a&&a.catch instanceof Function&&a.then(i).catch(s),"string"==typeof a&&r.logger.log(a)}i()})}).then(function(e){return r.logger.log("fidj.sdk.service.fidjSync fnInitFirstData resolved: ",e),r.session.dbLastSync=(new Date).getTime(),r.session.info()}).then(function(e){return r.session.dbRecordCount=0,e&&e.doc_count&&(r.session.dbRecordCount=e.doc_count),r.logger.log("fidj.sdk.service.fidjSync _dbRecordCount : "+r.session.dbRecordCount),r.connection.refreshConnection()}).then(function(e){r.logger.log("fidj.sdk.service.fidjSync refreshConnection done : ",e),i()}).catch(function(e){if(r.logger.warn("fidj.sdk.service.fidjSync refreshConnection failed : ",e),!e||403!==e.code&&410!==e.code)if(e&&e.code)i();else{var t="Error during synchronisation: "+e.toString();r.logger.error(t),s({code:500,reason:t})}else n.fidjLogout().then(function(){s({code:403,reason:"Synchronization unauthorized : need to login again."})}).catch(function(){s({code:403,reason:"Synchronization unauthorized : need to login again.."})})})})},e.prototype.fidjPutInDb=function(e){var t,n;return this.logger.log("fidj.sdk.service.fidjPutInDb: ",e),this.connection.getClientId()?this.session.isReady()?(e&&"object"==typeof e&&Object.keys(e).indexOf("_id")&&(t=e._id),t||(t=this._generateObjectUniqueId(this.connection.fidjId)),this.connection.fidjCrypto&&(n={obj:this.connection,method:"encrypt"}),this.session.put(e,t,this.connection.getClientId(),this.sdk.org,this.connection.fidjVersion,n)):this.promise.reject(new p(400,"Need to be synchronised.")):this.promise.reject(new p(401,"DB put impossible. Need a user logged in."))},e.prototype.fidjRemoveInDb=function(e){return this.logger.log("fidj.sdk.service.fidjRemoveInDb ",e),this.session.isReady()?e&&"string"==typeof e?this.session.remove(e):this.promise.reject(new p(400,"DB remove impossible. Need the data._id.")):this.promise.reject(new p(400,"Need to be synchronised."))},e.prototype.fidjFindInDb=function(e){var t;return this.connection.getClientId()?this.session.isReady()?(this.connection.fidjCrypto&&(t={obj:this.connection,method:"decrypt"}),this.session.get(e,t)):this.promise.reject(new p(400," Need to be synchronised.")):this.promise.reject(new p(401,"Find pb : need a user logged in."))},e.prototype.fidjFindAllInDb=function(){var e,t=this;return t.connection.getClientId()?t.session.isReady()?(t.connection.fidjCrypto&&(e={obj:t.connection,method:"decrypt"}),t.session.getAll(e).then(function(e){return t.connection.setCryptoSaltAsVerified(),t.promise.resolve(e)})):t.promise.reject(new p(400,"Need to be synchronised.")):t.promise.reject(new p(401,"Need a user logged in."))},e.prototype.fidjPostOnEndpoint=function(e,t){var n={key:e},r=this.fidjGetEndpoints(n);if(!r||1!==r.length)return this.promise.reject(new p(400,"fidj.sdk.service.fidjPostOnEndpoint : endpoint does not exist."));var o=r[0].url,i=this.connection.getIdToken();return(new h).post({url:o,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+i},data:t})},e.prototype.fidjGetIdToken=function(){return this.connection.getIdToken()},e.prototype._loginInternal=function(e,t,n){var r=this;return r.logger.log("fidj.sdk.service._loginInternal"),r.connection.isReady()?new r.promise(function(o,i){r.connection.logout().then(function(){return r.connection.getClient().login(e,t,n)}).catch(function(o){return r.connection.getClient().login(e,t,n)}).then(function(t){t.email=e,o(t)}).catch(function(e){r.logger.error("fidj.sdk.service._loginInternal error : "+e),i(e)})}):r.promise.reject(new p(403,"Need an intialized FidjService"))},e.prototype._removeAll=function(){return this.connection.destroy(),this.session.destroy()},e.prototype._createSession=function(e){var t=this.connection.getDBs({filter:"theBestOnes"});return t&&0!==t.length||this.logger.warn("Seems that you are in demo mode, no remote DB."),this.session.setRemote(t),this.session.create(e)},e.prototype._testPromise=function(e){return e?this.promise.resolve("test promise ok "+e):new this.promise(function(e,t){e("test promise ok")})},e.prototype._generateObjectUniqueId=function(t,n,r){var o=new Date,i=""+o.getFullYear()+o.getMonth()+o.getDate()+o.getHours()+o.getMinutes(),s=++e._srvDataUniqId,c="";return t&&t.charAt(0)&&(c+=t.charAt(0)+""),n&&n.length>3&&(c+=n.substring(0,4)),r&&r.length>3&&(c+=r.substring(0,4)),c+=i+""+s},e._srvDataUniqId=0,e}(),w=function(){function e(){this.logger=new _,this.promise=Promise,this.fidjService=null}return e.prototype.init=function(e,t){return this.fidjService||(this.fidjService=new k(this.logger,this.promise)),this.fidjService.fidjInit(e,t)},e.prototype.login=function(e,t){return this.fidjService?this.fidjService.fidjLogin(e,t):this.promise.reject(new p(303,"fidj.sdk.angular2.login : not initialized."))},e.prototype.loginAsDemo=function(e){return this.fidjService?this.fidjService.fidjLoginInDemoMode(e):this.promise.reject(new p(303,"fidj.sdk.angular2.loginAsDemo : not initialized."))},e.prototype.isLoggedIn=function(){return!!this.fidjService&&this.fidjService.fidjIsLogin()},e.prototype.getRoles=function(){return this.fidjService?this.fidjService.fidjRoles():[]},e.prototype.getEndpoints=function(){return this.fidjService?this.fidjService.fidjGetEndpoints():[]},e.prototype.postOnEndpoint=function(e,t){return this.fidjService?this.fidjService.fidjPostOnEndpoint(e,t):this.promise.reject(new p(303,"fidj.sdk.angular2.loginAsDemo : not initialized."))},e.prototype.getIdToken=function(){if(this.fidjService)return this.fidjService.fidjGetIdToken()},e.prototype.getMessage=function(){return this.fidjService?this.fidjService.fidjMessage():""},e.prototype.logout=function(e){return e||!this.fidjService?this.promise.reject(new p(303,"fidj.sdk.angular2.logout : not initialized.")):this.fidjService.fidjLogout(e)},e.prototype.sync=function(e){return this.fidjService?this.fidjService.fidjSync(e,this):this.promise.reject(new p(401,"fidj.sdk.angular2.sync : not initialized."))},e.prototype.put=function(e){return this.fidjService?this.fidjService.fidjPutInDb(e):this.promise.reject(new p(401,"fidj.sdk.angular2.put : not initialized."))},e.prototype.remove=function(e){return this.fidjService?this.fidjService.fidjRemoveInDb(e):this.promise.reject(new p(401,"fidj.sdk.angular2.remove : not initialized."))},e.prototype.find=function(e){return this.fidjService?this.fidjService.fidjFindInDb(e):this.promise.reject(new p(401,"fidj.sdk.angular2.find : not initialized."))},e.prototype.findAll=function(){return this.fidjService?this.fidjService.fidjFindAllInDb():this.promise.reject(new p(401,"fidj.sdk.angular2.findAll : not initialized."))},e=r([t.Injectable(),o("design:paramtypes",[])],e)}(),S=function(){function e(){}return e=r([t.NgModule({imports:[n.CommonModule],declarations:[],exports:[],providers:[w]}),o("design:paramtypes",[])],e)}();e.Base64=c,e.FidjModule=S,e.FidjService=w,e.LocalStorage=a,e.Xor=d,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=fidj.umd.min.js.map