!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/common"),require("@angular/core")):"function"==typeof define&&define.amd?define("fidj",["exports","@angular/common","@angular/core"],t):t(e.fidj={},e.ng.common,e.ng.core)}(this,function(e,t,n){"use strict";var a=function(){function e(){}return e.encode=function(e){return e?btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode(parseInt("0x"+t,16))})):null},e.decode=function(e){return e?decodeURIComponent(atob(e).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join("")):null},e}(),o=function(){function e(e,t){if(this.storageKey=t,this.version="0.1",this.storage=e||window.localStorage,!this.storage)throw new Error("fidj.LocalStorageFactory needs a storageService!")}return e.prototype.set=function(e,t){e=this.storageKey+e,this.checkKey(e);var n=typeof t;if("undefined"===n)t="null";else if(null===t)t="null";else if("string"===n)t=JSON.stringify({string:t});else if("number"===n)t=JSON.stringify({number:t});else if("boolean"===n)t=JSON.stringify({bool:t});else{if("object"!==n)throw new TypeError("Value type "+n+" is invalid. It must be null, undefined, xml, string, number, boolean or object");t=JSON.stringify({json:t})}return this.storage.setItem(e,t),t},e.prototype.get=function(e,t){e=this.storageKey+e,this.checkKey(e);var n=this.storage.getItem(e);if(null===n)return t||null;if("null"===n)return null;var o=JSON.parse(n);return"string"in o?o.string:"number"in o?o.number.valueOf():"bool"in o?o.bool.valueOf():o.json},e.prototype.remove=function(e){e=this.storageKey+e,this.checkKey(e);var t=null!==this.storage.getItem(e);return this.storage.removeItem(e),t},e.prototype.clear=function(){var e=0<this.storage.length;return this.storage.clear(),e},e.prototype.size=function(){return this.storage.length},e.prototype.foreach=function(e,t){for(var n=this.storage.length,o=0;o<n;o++){var r=this.storage.key(o),i=this.get(r);t?e.call(t,i):e(i)}return n},e.prototype.checkKey=function(e){if(!e||"string"!=typeof e)throw new TypeError("Key type must be string");return!0},e}(),r=function(){function i(){}return i.encrypt=function(e,t){var n="";e=i.header+e;for(var o=0;o<e.length;o++)n+=String.fromCharCode(e[o].charCodeAt(0).toString(10)^i.keyCharAt(t,o));return n=a.encode(n)},i.decrypt=function(e,t,n){var o="";e=a.decode(e);for(var r=0;r<e.length;r++)o+=String.fromCharCode(e[r].charCodeAt(0).toString(10)^i.keyCharAt(t,r));return n||i.header===o.substring(0,i.header.length)?(n||(o=o.substring(i.header.length)),o):null},i.keyCharAt=function(e,t){return e[Math.floor(t%e.length)].charCodeAt(0).toString(10)},i.header="artemis-lotsum",i}(),i={LOG:1,WARN:2,ERROR:3,NONE:4};i[i.LOG]="LOG",i[i.WARN]="WARN",i[i.ERROR]="ERROR",i[i.NONE]="NONE";var s=function(){function e(){this.DEFAULT_CONTENT_TYPE="application/x-www-form-urlencoded; charset=UTF-8"}return e.prototype.send=function(a){var e,d;return null==a&&(a={}),e={method:"GET",data:null,headers:{},async:!0,username:null,password:null,withCredentials:!1},a=Object.assign({},e,a),new Promise((d=this,function(n,o){var e,t,r,i,s;if(XMLHttpRequest)if("string"==typeof a.url&&0!==a.url.length){for(t in d._xhr=s=new XMLHttpRequest,s.onload=function(){var e;d._detachWindowUnload();try{e=d._getResponseText()}catch(t){return void d._handleError("parse",o,null,"invalid JSON response")}return n({url:d._getResponseUrl(),status:s.status,statusText:s.statusText,responseText:e,headers:d._getHeaders(),xhr:s})},s.onerror=function(){return d._handleError("error",o)},s.ontimeout=function(){return d._handleError("timeout",o)},s.onabort=function(){return d._handleError("abort",o)},d._attachWindowUnload(),s.open(a.method,a.url,a.async,a.username,a.password),a.withCredentials&&(s.withCredentials=!0),null==a.data||a.headers["Content-Type"]||(a.headers["Content-Type"]=d.DEFAULT_CONTENT_TYPE),r=a.headers)r.hasOwnProperty(t)&&(i=r[t],s.setRequestHeader(t,i));try{return s.send(a.data)}catch(c){return e=c,d._handleError("send",o,null,e.toString())}}else d._handleError("url",o,null,"URL is a required parameter");else d._handleError("browser",o,null,"browser doesn't support XMLHttpRequest")}))},e.prototype.getXHR=function(){return this._xhr},e.prototype._attachWindowUnload=function(){if(this._unloadHandler=this._handleWindowUnload.bind(this),window.attachEvent)return window.attachEvent("onunload",this._unloadHandler)},e.prototype._detachWindowUnload=function(){if(window.detachEvent)return window.detachEvent("onunload",this._unloadHandler)},e.prototype._getHeaders=function(){return this._parseHeaders(this._xhr.getAllResponseHeaders())},e.prototype._getResponseText=function(){var e;switch(e="string"==typeof this._xhr.responseText?this._xhr.responseText:"",(this._xhr.getResponseHeader("Content-Type")||"").split(";")[0]){case"application/json":case"text/javascript":e=JSON.parse(e+"")}return e},e.prototype._getResponseUrl=function(){return null!=this._xhr.responseURL?this._xhr.responseURL:/^X-Request-URL:/m.test(this._xhr.getAllResponseHeaders())?this._xhr.getResponseHeader("X-Request-URL"):""},e.prototype._handleError=function(e,t,n,o){this._detachWindowUnload();var r=404;return"timeout"===e?r=408:"abort"===e&&(r=408),t({reason:e,status:n||this._xhr.status||r,code:n||this._xhr.status||r,statusText:o||this._xhr.statusText,xhr:this._xhr})},e.prototype._handleWindowUnload=function(){return this._xhr.abort()},e.prototype.trim=function(e){return e.replace(/^\s*|\s*$/g,"")},e.prototype.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},e.prototype.forEach=function(e,t){"[object Array]"===toString.call(e)?this.forEachArray(e,t,this):"string"==typeof e?this.forEachString(e,t,this):this.forEachObject(e,t,this)},e.prototype.forEachArray=function(e,t,n){for(var o=0,r=e.length;o<r;o++)e.hasOwnProperty(o)&&t.call(n,e[o],o,e)},e.prototype.forEachString=function(e,t,n){for(var o=0,r=e.length;o<r;o++)t.call(n,e.charAt(o),o,e)},e.prototype.forEachObject=function(e,t,n){for(var o in e)e.hasOwnProperty(o)&&t.call(n,e[o],o,e)},e.prototype._parseHeaders=function(e){var r=this;if(!e)return{};var i={};return this.forEach(this.trim(e).split("\n"),function(e){var t=e.indexOf(":"),n=r.trim(e.slice(0,t)).toLowerCase(),o=r.trim(e.slice(t+1));"undefined"==typeof i[n]?i[n]=o:r.isArray(i[n])?i[n].push(o):i[n]=[i[n],o]}),i},e}(),d=function(){function e(){this.xhr=new s}return e.prototype.post=function(e){var t={method:"POST",url:e.url,data:JSON.stringify(e.data)};return e.headers&&(t.headers=e.headers),this.xhr.send(t).then(function(e){return e.status&&(parseInt(e.status,10)<200||300<=parseInt(e.status,10))?(e.reason="status",e.code=parseInt(e.status,10),Promise.reject(e)):Promise.resolve(e.responseText)})["catch"](function(e){return Promise.reject(e)})},e.prototype.put=function(e){var t={method:"PUT",url:e.url,data:JSON.stringify(e.data)};return e.headers&&(t.headers=e.headers),this.xhr.send(t).then(function(e){return e.status&&(parseInt(e.status,10)<200||300<=parseInt(e.status,10))?(e.reason="status",e.code=parseInt(e.status,10),Promise.reject(e)):Promise.resolve(e.responseText)})["catch"](function(e){return Promise.reject(e)})},e.prototype["delete"]=function(e){var t={method:"DELETE",url:e.url,data:JSON.stringify(e.data)};return e.headers&&(t.headers=e.headers),this.xhr.send(t).then(function(e){return e.status&&(parseInt(e.status,10)<200||300<=parseInt(e.status,10))?(e.reason="status",e.code=parseInt(e.status,10),Promise.reject(e)):Promise.resolve(e.responseText)})["catch"](function(e){return Promise.reject(e)})},e.prototype.get=function(e){var t={method:"GET",url:e.url};return e.data&&(t.data=e.data),e.headers&&(t.headers=e.headers),this.xhr.send(t).then(function(e){return e.status&&(parseInt(e.status,10)<200||300<=parseInt(e.status,10))?(e.reason="status",e.code=parseInt(e.status,10),Promise.reject(e)):Promise.resolve(e.responseText)})["catch"](function(e){return Promise.reject(e)})},e}(),u=function(){function s(e,t,n,o){this.appId=e,this.URI=t,this.storage=n,this.sdk=o;var r=this.storage.get(s._clientUuid)||"uuid-"+Math.random(),i="_clientInfo";window&&window.navigator&&(i=window.navigator.appName+"@"+window.navigator.appVersion+"-"+window.navigator.userAgent),window&&window.device&&window.device.uuid&&(r=window.device.uuid),this.setClientUuid(r),this.setClientInfo(i),this.clientId=this.storage.get(s._clientId),s.refreshCount=this.storage.get(s._refreshCount)||0}return s.prototype.setClientId=function(e){this.clientId=""+e,this.storage.set(s._clientId,this.clientId)},s.prototype.setClientUuid=function(e){this.clientUuid=""+e,this.storage.set(s._clientUuid,this.clientUuid)},s.prototype.setClientInfo=function(e){this.clientInfo=""+e},s.prototype.login=function(e,o,t){var r=this;if(!this.URI)return console.error("no api uri"),Promise.reject({code:408,reason:"no-api-uri"});var n=this.URI+"/users",i={name:e,username:e,email:e,password:o};return(new d).post({url:n,data:i,headers:{"Content-Type":"application/json",Accept:"application/json"}}).then(function(e){r.setClientId(e._id);var t=r.URI+"/oauth/token",n={grant_type:"client_credentials",client_id:r.clientId,client_secret:o,client_udid:r.clientUuid,client_info:r.clientInfo,audience:r.appId,scope:JSON.stringify(r.sdk)};return(new d).post({url:t,data:n,headers:{"Content-Type":"application/json",Accept:"application/json"}})})},s.prototype.reAuthenticate=function(e){var t=this;if(!this.URI)return console.error("no api uri"),Promise.reject({code:408,reason:"no-api-uri"});var n=this.URI+"/oauth/token",o={grant_type:"refresh_token",client_id:this.clientId,client_udid:this.clientUuid,client_info:this.clientInfo,audience:this.appId,scope:JSON.stringify(this.sdk),refresh_token:e,refresh_extra:s.refreshCount};return(new d).post({url:n,data:o,headers:{"Content-Type":"application/json",Accept:"application/json"}}).then(function(e){return s.refreshCount++,t.storage.set(s._refreshCount,s.refreshCount),Promise.resolve(e)})},s.prototype.logout=function(e){if(!this.URI)return console.error("no api uri"),Promise.reject({code:408,reason:"no-api-uri"});if(this.storage.remove(s._clientId),this.storage.remove(s._refreshCount),s.refreshCount=0,!e||!this.clientId)return Promise.resolve();var t=this.URI+"/oauth/revoke",n={token:e,client_id:this.clientId,client_udid:this.clientUuid,client_info:this.clientInfo,audience:this.appId,scope:JSON.stringify(this.sdk)};return(new d).post({url:t,data:n,headers:{"Content-Type":"application/json",Accept:"application/json"}})},s.prototype.isReady=function(){return!!this.URI},s.refreshCount=0,s._clientUuid="v2.clientUuid",s._clientId="v2.clientId",s._refreshCount="v2.refreshCount",s}(),l=function(){function e(e,t){this.code=e,this.reason=t}return e.prototype.equals=function(e){return this.code===e.code&&this.reason===e.reason},e.prototype.toString=function(){var e="string"==typeof this.reason?this.reason:JSON.stringify(this.reason);return this.code+" - "+e},e}(),h=function(){function i(e,t,n){this._sdk=e,this._storage=t,this._logger=n,this.client=null,this.user=null,this.cryptoSalt=this._storage.get(i._cryptoSalt)||null,this.cryptoSaltNext=this._storage.get(i._cryptoSaltNext)||null,this.accessToken=this._storage.get(i._accessToken)||null,this.accessTokenPrevious=this._storage.get("v2.accessTokenPrevious")||null,this.idToken=this._storage.get(i._idToken)||null,this.refreshToken=this._storage.get(i._refreshToken)||null,this.states=this._storage.get(i._states)||{},this.apis=[]}return i.prototype.isReady=function(){return!!this.client&&this.client.isReady()},i.prototype.destroy=function(e){this._storage.remove(i._accessToken),this._storage.remove(i._idToken),this._storage.remove(i._refreshToken),this._storage.remove(i._states),this.accessToken&&(this.accessTokenPrevious=this.accessToken,this._storage.set(i._accessTokenPrevious,this.accessTokenPrevious)),e&&(this._storage.remove(i._cryptoSalt),this._storage.remove(i._cryptoSaltNext),this._storage.remove(i._accessTokenPrevious)),this.user=null,this.client&&this.client.logout(),this.accessToken=null,this.idToken=null,this.refreshToken=null,this.states={}},i.prototype.setClient=function(e){this.client=e,this.user||(this.user={}),this.user._name=JSON.parse(this.getIdPayload({name:""})).name},i.prototype.setUser=function(e){this.user=e,this.user._id&&(this.client.setClientId(this.user._id),delete this.user._id)},i.prototype.getUser=function(){return this.user},i.prototype.getClient=function(){return this.client},i.prototype.setCryptoSalt=function(e){this.cryptoSalt!==e&&this.cryptoSaltNext!==e&&(this.cryptoSaltNext=e,this._storage.set(i._cryptoSaltNext,this.cryptoSaltNext)),this.cryptoSalt||this.setCryptoSaltAsVerified()},i.prototype.setCryptoSaltAsVerified=function(){this.cryptoSaltNext&&(this.cryptoSalt=this.cryptoSaltNext,this._storage.set(i._cryptoSalt,this.cryptoSalt)),this.cryptoSaltNext=null,this._storage.remove(i._cryptoSaltNext)},i.prototype.encrypt=function(e){if("string"!=typeof e)e=JSON.stringify(e);else{var t={string:e};e=JSON.stringify(t)}if(this.fidjCrypto&&this.cryptoSalt){var n=this.cryptoSalt;return r.encrypt(e,n)}return e},i.prototype.decrypt=function(e){var t=null;try{if(!t&&this.fidjCrypto&&this.cryptoSaltNext){var n=this.cryptoSaltNext;t=r.decrypt(e,n),t=JSON.parse(t)}}catch(o){t=null}try{if(!t&&this.fidjCrypto&&this.cryptoSalt){n=this.cryptoSalt;t=r.decrypt(e,n),t=JSON.parse(t)}}catch(o){t=null}try{if(!t&&this.fidjCrypto&&this.cryptoSalt){n=this.cryptoSalt;t=r.decrypt(e,n,!0),t=JSON.parse(t)}}catch(o){t=null}try{t||(t=JSON.parse(e)),t&&t.string&&(t=t.string)}catch(o){t=null}return t},i.prototype.isLogin=function(){var e=!0;try{var t=this.refreshToken.split(".")[1],n=JSON.parse(a.decode(t));e=(new Date).getTime()/1e3>=n.exp}catch(o){}return!e},i.prototype.logout=function(){return this.getClient().logout(this.refreshToken)},i.prototype.getClientId=function(){return this.client?this.client.clientId:null},i.prototype.getIdToken=function(){return this.idToken},i.prototype.getIdPayload=function(e){e&&"string"!=typeof e&&(e=JSON.stringify(e));try{var t=this.getIdToken().split(".")[1];if(t)return a.decode(t)}catch(n){}return e||null},i.prototype.getAccessPayload=function(e){e&&"string"!=typeof e&&(e=JSON.stringify(e));try{var t=this.accessToken.split(".")[1];if(t)return a.decode(t)}catch(n){}return e||null},i.prototype.getPreviousAccessPayload=function(e){e&&"string"!=typeof e&&(e=JSON.stringify(e));try{var t=this.accessTokenPrevious.split(".")[1];if(t)return a.decode(t)}catch(n){}return e||null},i.prototype.refreshConnection=function(){var o=this;if(this._storage.set(i._states,this.states),this.accessToken){var e=this.accessToken.split(".")[1],t=a.decode(e),n=(new Date).getTime()/1e3<JSON.parse(t).exp;if(this._logger.log("fidj.connection.connection.refreshConnection : token not expired ? ",n),n)return Promise.resolve(this.getUser())}if(this.refreshToken){e=this.refreshToken.split(".")[1],t=a.decode(e);var r=(new Date).getTime()/1e3>=JSON.parse(t).exp;this._logger.log("fidj.connection.connection.refreshConnection : refreshToken not expired ? ",r),r&&this._storage.remove(i._refreshToken)}return this.accessTokenPrevious=this.accessToken,this._storage.set("v2.accessTokenPrevious",this.accessTokenPrevious),this._storage.remove(i._accessToken),this._storage.remove(i._idToken),this.accessToken=null,this.idToken=null,this._logger.log("fidj.connection.connection.refreshConnection : refresh authentication."),new Promise(function(t,n){if(!o.getClient())return n(new l(400,"Need an initialized client."));o.getClient().reAuthenticate(o.refreshToken).then(function(e){o.setConnection(e),t(o.getUser())})["catch"](function(e){n(e)})})},i.prototype.setConnection=function(e){if(e.access_token){this.accessToken=e.access_token,this._storage.set(i._accessToken,this.accessToken),delete e.access_token;var t=JSON.parse(this.getAccessPayload({salt:""})).salt;t&&this.setCryptoSalt(t)}e.id_token&&(this.idToken=e.id_token,this._storage.set(i._idToken,this.idToken),delete e.id_token),e.refresh_token&&(this.refreshToken=e.refresh_token,this._storage.set(i._refreshToken,this.refreshToken),delete e.refresh_token),this._storage.set(i._states,this.states),e.roles=JSON.parse(this.getIdPayload({roles:[]})).roles,e.message=JSON.parse(this.getIdPayload({message:""})).message,this.setUser(e)},i.prototype.setConnectionOffline=function(e){e.accessToken&&(this.accessToken=e.accessToken,this._storage.set(i._accessToken,this.accessToken)),e.idToken&&(this.idToken=e.idToken,this._storage.set(i._idToken,this.idToken)),e.refreshToken&&(this.refreshToken=e.refreshToken,this._storage.set(i._refreshToken,this.refreshToken)),this.setUser({roles:JSON.parse(this.getIdPayload({roles:[]})).roles,message:JSON.parse(this.getIdPayload({message:""})).message,_id:"demo"})},i.prototype.getApiEndpoints=function(e){var n=[{key:"fidj.default",url:"https://fidj.ovh/api",blocked:!1}],t=[];if(this._sdk.prod||(n=[{key:"fidj.default",url:"http://localhost:3201/api",blocked:!1},{key:"fidj.default",url:"https://fidj-sandbox.herokuapp.com/api",blocked:!1}]),this.accessToken){var o,r=this.getAccessPayload({apis:[]});(o=JSON.parse(r).apis)&&o.length&&(n=[],o.forEach(function(e){e.url&&n.push(e)}))}this.accessTokenPrevious&&((o=JSON.parse(this.getPreviousAccessPayload({apis:[]})).apis)&&o.length&&o.forEach(function(t){t.url&&0===n.filter(function(e){return e.url===t.url}).length&&n.push(t)}));var i=!0;if(this.states&&Object.keys(this.states).length)for(var s=0;s<n.length&&i;s++)this.states[n[s].url]||(i=!1);else i=!1;if(e&&e.filter)if(i&&"theBestOne"===e.filter)for(s=0;s<n.length&&0===t.length;s++){var c=n[s];this.states[c.url]&&this.states[c.url].state&&t.push(c)}else if(i&&"theBestOldOne"===e.filter){var a=void 0;for(s=0;s<n.length;s++){c=n[s];this.states[c.url]&&this.states[c.url].lastTimeWasOk&&(!a||this.states[c.url].lastTimeWasOk>this.states[a.url].lastTimeWasOk)&&(a=c)}a&&t.push(a)}else n.length&&t.push(n[0]);else t=n;return t},i.prototype.getDBs=function(e){if(!this.accessToken)return[];var t=Math.random()%2,n=JSON.parse(this.getAccessPayload({dbs:[]})).dbs||[];0===t?n=n.sort():1===t&&(n=n.reverse());var o=[],r=!0;if(this.states&&Object.keys(this.states).length)for(var i=0;i<n.length&&r;i++)this.states[n[i].url]||(r=!1);else r=!1;if(r&&e&&"theBestOne"===e.filter)for(i=0;i<n.length&&0===o.length;i++){var s=n[i];this.states[s.url]&&this.states[s.url].state&&o.push(s)}else if(r&&e&&"theBestOnes"===e.filter)for(i=0;i<n.length;i++){s=n[i];this.states[s.url]&&this.states[s.url].state&&o.push(s)}else e&&"theBestOne"===e.filter&&n.length?o.push(n[0]):o=n;return o},i.prototype.verifyConnectionStates=function(){var r=this,i=(new Date).getTime(),t=[];return this.apis=this.getApiEndpoints(),this.apis.forEach(function(e){var o=e.url;o||(o=e.toString()),t.push(new Promise(function(n,e){(new d).get({url:o+"/status?isok="+r._sdk.version,headers:{"Content-Type":"application/json",Accept:"application/json"}}).then(function(e){var t=!1;e&&e.isok&&(t=!0),r.states[o]={state:t,time:i,lastTimeWasOk:i},n()})["catch"](function(e){var t=0;r.states[o]&&(t=r.states[o].lastTimeWasOk),r.states[o]={state:!1,time:i,lastTimeWasOk:t},n()})}))}),this.getDBs().forEach(function(e){var o=e.url;o||(o=e.toString()),t.push(new Promise(function(n,e){(new d).get({url:o,headers:{"Content-Type":"application/json",Accept:"application/json"}}).then(function(e){r.states[o]={state:!0,time:i,lastTimeWasOk:i},n()})["catch"](function(e){var t=0;r.states[o]&&(t=r.states[o].lastTimeWasOk),r.states[o]={state:!1,time:i,lastTimeWasOk:t},n()})}))}),Promise.all(t)},i._accessToken="v2.accessToken",i._accessTokenPrevious="v2.accessTokenPrevious",i._idToken="v2.idToken",i._refreshToken="v2.refreshToken",i._states="v2.states",i._cryptoSalt="v2.cryptoSalt",i._cryptoSaltNext="v2.cryptoSalt.next",i}(),c=window.PouchDB?window.PouchDB:require("pouchdb")["default"],f=require("pouchdb-adapter-cordova-sqlite");c.plugin(f);var p=function(){function u(){this.db=null,this.dbRecordCount=0,this.dbLastSync=null,this.remoteDb=null,this.dbs=[]}return u.prototype.isReady=function(){return!!this.db},u.prototype.create=function(r,e){var i=this;return!e&&this.db?Promise.resolve():(this.dbRecordCount=0,this.dbLastSync=null,this.db=null,r=r||"default",new Promise(function(t,n){var e={location:"default"};try{window.cordova&&(e={location:"default",adapter:"cordova-sqlite"}),i.db=new c("fidj_db_"+r,e),i.db.info().then(function(e){return t(i.db)})["catch"](function(e){n(new l(400,e))})}catch(o){n(new l(500,o))}}))},u.prototype.destroy=function(){var r=this;return this.db?this.db&&!this.db.destroy?Promise.reject(new l(408,"Need a valid db")):new Promise(function(n,o){r.db.destroy(function(e,t){e?o(new l(500,e)):(r.dbRecordCount=0,r.dbLastSync=null,r.db=null,n())})}):(this.dbRecordCount=0,this.dbLastSync=null,Promise.resolve())},u.prototype.setRemote=function(e){this.dbs=e},u.prototype.sync=function(o){var r=this;return this.db?this.dbs&&this.dbs.length?new Promise(function(t,n){try{r.remoteDb&&r.remoteUri===r.dbs[0].url||(r.remoteUri=r.dbs[0].url,r.remoteDb=new c(r.remoteUri)),r.db.replicate.to(r.remoteDb).on("complete",function(e){return r.remoteDb.replicate.to(r.db,{filter:function(e){return!!o&&!!e&&e.fidjUserId===o}}).on("complete",function(){t()}).on("denied",function(e){return n({code:403,reason:{second:e}})}).on("error",function(e){return n({code:401,reason:{second:e}})})}).on("denied",function(e){return n({code:403,reason:{first:e}})}).on("error",function(e){return n({code:401,reason:{first:e}})})}catch(e){n(new l(500,e))}}):Promise.reject(new l(408,"need a remote db")):Promise.reject(new l(408,"need db"))},u.prototype.put=function(r,e,t,n,o,i){var s=this;if(!this.db)return Promise.reject(new l(408,"need db"));if(!(r&&e&&t&&n&&o))return Promise.reject(new l(400,"need formated data"));var c=JSON.parse(JSON.stringify(r)),a={_id:e,fidjUserId:t,fidjOrgId:n,fidjAppVersion:o};c._rev&&(a._rev=""+c._rev),delete c._id,delete c._rev,delete c.fidjUserId,delete c.fidjOrgId,delete c.fidjAppVersion,delete c.fidjData;var d=u.write(u.value(c));return i?(d=i.obj[i.method](d),a.fidjDacr=d):a.fidjData=d,new Promise(function(n,o){s.db.put(a,function(e,t){t&&t.ok&&t.id&&t.rev?(s.dbRecordCount++,"object"==typeof r?(r._rev=t.rev,r._id=t.id,n(r)):n(t.id)):o(new l(500,e))})})},u.prototype.remove=function(e){var o=this;return this.db?new Promise(function(t,n){o.db.get(e).then(function(e){return e._deleted=!0,o.db.put(e)}).then(function(e){t()})["catch"](function(e){n(e)})}):Promise.reject(new l(408,"need db"))},u.prototype.get=function(e,i){var s=this;return this.db?new Promise(function(o,r){s.db.get(e).then(function(e){if(e&&(e.fidjDacr||e.fidjData)){var t=e.fidjDacr;i&&t?t=i.obj[i.method](t):e.fidjData&&(t=JSON.parse(e.fidjData));var n=u.extractJson(t);n?(n._id=e._id,n._rev=e._rev,o(JSON.parse(JSON.stringify(n)))):(s.remove(e._id),r(new l(400,"Bad encoding")))}else r(new l(400,"No data found"))})["catch"](function(e){return r(new l(500,e))})}):Promise.reject(new l(408,"Need db"))},u.prototype.getAll=function(r){var i=this;return this.db&&this.db.allDocs?new Promise(function(t,n){i.db.allDocs({include_docs:!0,descending:!0}).then(function(e){var o=[];e.rows.forEach(function(e){if(e&&e.doc._id&&(e.doc.fidjDacr||e.doc.fidjData)){var t=e.doc.fidjDacr;r&&t?t=r.obj[r.method](t):e.doc.fidjData&&(t=JSON.parse(e.doc.fidjData));var n=u.extractJson(t);n?(n._id=e.doc._id,n._rev=e.doc._rev,o.push(JSON.parse(JSON.stringify(n)))):(console.error("Bad encoding : delete row"),i.remove(e.doc._id))}else console.error("Bad encoding")}),t(o)})["catch"](function(e){return n(new l(400,e))})}):Promise.reject(new l(408,"Need a valid db"))},u.prototype.isEmpty=function(){var o=this;return this.db&&this.db.allDocs?new Promise(function(t,n){o.db.allDocs({}).then(function(e){e?(o.dbRecordCount=e.total_rows,e.total_rows&&0<e.total_rows?t(!1):t(!0)):n(new l(400,"No response"))})["catch"](function(e){return n(new l(400,e))})}):Promise.reject(new l(408,"No db"))},u.prototype.info=function(){return this.db?this.db.info():Promise.reject(new l(408,"No db"))},u.write=function(e){var t="null",n=typeof e;return"undefined"===n?t="null":null===t?t="null":"string"===n?t=JSON.stringify({string:e}):"number"===n?t=JSON.stringify({number:e}):"boolean"===n?t=JSON.stringify({bool:e}):"object"===n&&(t=JSON.stringify({json:e})),t},u.value=function(e){var t=e;return"object"!=typeof e||("string"in e?t=e.string:"number"in e?t=e.number.valueOf():"bool"in e?t=e.bool.valueOf():"json"in e&&"object"!=typeof(t=e.json)&&(t=JSON.parse(t))),t},u.extractJson=function(e){var t=e;return e?("object"==typeof e&&"json"in e&&(t=e.json),"string"==typeof t&&(t=JSON.parse(t)),"object"==typeof t&&"json"in t&&(t=t.json),"object"!=typeof t&&(t=null),t):null},u}(),g=function(){function c(e,t){this.sdk={org:"fidj",version:"2.1.22",prod:!1},t&&(this.promise=t),this.logger=e||new v,this.logger.log("fidj.sdk.service : constructor"),this.storage=new o(window.localStorage,"fidj."),this.session=new p,this.connection=new h(this.sdk,this.storage,this.logger)}return c.prototype.fidjInit=function(e,t){var i=this;return t&&t.logLevel&&i.logger.setLevel(t.logLevel),i.logger.log("fidj.sdk.service.fidjInit : ",t),e?(i.sdk.prod=!t||t.prod,i.connection.fidjId=e,i.connection.fidjVersion=i.sdk.version,i.connection.fidjCrypto=!t||!t.hasOwnProperty("crypto")||t.crypto,new i.promise(function(o,r){i.connection.verifyConnectionStates().then(function(){var e=i.connection.getApiEndpoints({filter:"theBestOne"})[0],t=i.connection.getApiEndpoints({filter:"theBestOldOne"})[0],n=i.fidjIsLogin();e&&e.url&&(e=e.url),t&&t.url&&(t=t.url),e?(i.connection.setClient(new u(i.connection.fidjId,e,i.storage,i.sdk)),o()):n&&t?(i.connection.setClient(new u(i.connection.fidjId,t,i.storage,i.sdk)),o()):r(new l(404,"Need one connection - or too old SDK version (check update)"))})["catch"](function(e){i.logger.error("fidj.sdk.service.fidjInit: ",e),r(new l(500,e.toString()))})})):(i.logger.error("fidj.sdk.service.fidjInit : bad init"),i.promise.reject(new l(400,"Need a fidjId")))},c.prototype.fidjLogin=function(e,o){var r=this;return r.logger.log("fidj.sdk.service.fidjLogin"),r.connection.isReady()?new r.promise(function(t,n){r._removeAll().then(function(){return r.connection.verifyConnectionStates()}).then(function(){return r._createSession(r.connection.fidjId)}).then(function(){return r._loginInternal(e,o)}).then(function(e){r.connection.setConnection(e),r.session.sync(r.connection.getClientId()).then(function(){return t(r.connection.getUser())})["catch"](function(e){return t(r.connection.getUser())})})["catch"](function(e){r.logger.error("fidj.sdk.service.fidjLogin: ",e.toString()),n(e)})}):r.promise.reject(new l(404,"Need an intialized FidjService"))},c.prototype.fidjLoginInDemoMode=function(n){var o=this;if(!n||!n.accessToken){var e=new Date;e.setDate(e.getDate()+1);var t=e.getTime(),r=a.encode(JSON.stringify({roles:[],message:"demo",apis:[],endpoints:{},dbs:[],exp:t})),i=a.encode(JSON.stringify({})),s=i+"."+r+"."+i;n={accessToken:s,idToken:s,refreshToken:s}}return new o.promise(function(e,t){o._removeAll().then(function(){return o._createSession(o.connection.fidjId)}).then(function(){o.connection.setConnectionOffline(n),e(o.connection.getUser())})["catch"](function(e){o.logger.error("fidj.sdk.service.fidjLoginInDemoMode error: ",e),t(e)})})},c.prototype.fidjGetEndpoints=function(n){n||(n={showBlocked:!1});var e=JSON.parse(this.connection.getAccessPayload({endpoints:[]})).endpoints;return e?e=e.filter(function(e){var t=!0;return t&&n.key&&(t=e.key===n.key),t&&!n.showBlocked&&(t=!e.blocked),t}):[]},c.prototype.fidjRoles=function(){return JSON.parse(this.connection.getIdPayload({roles:[]})).roles},c.prototype.fidjMessage=function(){return JSON.parse(this.connection.getIdPayload({message:""})).message},c.prototype.fidjIsLogin=function(){return this.connection.isLogin()},c.prototype.fidjLogout=function(e){var t=this,n=this;return n.connection.getClient()||e?n.connection.logout().then(function(){return n._removeAll()})["catch"](function(){return n._removeAll()}).then(function(){return t.session.create(n.connection.fidjId,!0)}):n._removeAll().then(function(){return t.session.create(n.connection.fidjId,!0)})},c.prototype.fidjSync=function(i,s){var o=this,c=this;c.logger.log("fidj.sdk.service.fidjSync");var a=null===c.session.dbLastSync;return new c.promise(function(n,r){c._createSession(c.connection.fidjId).then(function(){return c.session.sync(c.connection.getClientId())}).then(function(){return c.logger.log("fidj.sdk.service.fidjSync resolved"),c.session.isEmpty()})["catch"](function(e){return c.logger.warn("fidj.sdk.service.fidjSync warn: ",e),c.session.isEmpty()}).then(function(o){return c.logger.log("fidj.sdk.service.fidjSync isEmpty : ",o,a),new c.promise(function(e,t){if(o&&a&&i){var n=i(s);n&&n["catch"]instanceof Function&&n.then(e)["catch"](r),"string"==typeof n&&c.logger.log(n)}e()})}).then(function(e){return c.logger.log("fidj.sdk.service.fidjSync fnInitFirstData resolved: ",e),c.session.dbLastSync=(new Date).getTime(),c.session.info()}).then(function(e){return c.session.dbRecordCount=0,e&&e.doc_count&&(c.session.dbRecordCount=e.doc_count),c.logger.log("fidj.sdk.service.fidjSync _dbRecordCount : "+c.session.dbRecordCount),c.connection.refreshConnection()}).then(function(e){c.logger.log("fidj.sdk.service.fidjSync refreshConnection done : ",e),n()})["catch"](function(e){if(c.logger.warn("fidj.sdk.service.fidjSync refreshConnection failed : ",e),!e||403!==e.code&&410!==e.code)if(e&&e.code)n();else{var t="Error during synchronisation: "+e.toString();c.logger.error(t),r({code:500,reason:t})}else o.fidjLogout().then(function(){r({code:403,reason:"Synchronization unauthorized : need to login again."})})["catch"](function(){r({code:403,reason:"Synchronization unauthorized : need to login again.."})})})})},c.prototype.fidjPutInDb=function(e){var t,n,o=this;return o.logger.log("fidj.sdk.service.fidjPutInDb: ",e),o.connection.getClientId()?o.session.isReady()?(e&&"object"==typeof e&&Object.keys(e).indexOf("_id")&&(t=e._id),t||(t=o._generateObjectUniqueId(o.connection.fidjId)),o.connection.fidjCrypto&&(n={obj:o.connection,method:"encrypt"}),o.session.put(e,t,o.connection.getClientId(),o.sdk.org,o.connection.fidjVersion,n)):o.promise.reject(new l(400,"Need to be synchronised.")):o.promise.reject(new l(401,"DB put impossible. Need a user logged in."))},c.prototype.fidjRemoveInDb=function(e){var t=this;return t.logger.log("fidj.sdk.service.fidjRemoveInDb ",e),t.session.isReady()?e&&"string"==typeof e?t.session.remove(e):t.promise.reject(new l(400,"DB remove impossible. Need the data._id.")):t.promise.reject(new l(400,"Need to be synchronised."))},c.prototype.fidjFindInDb=function(e){var t,n=this;return n.connection.getClientId()?n.session.isReady()?(n.connection.fidjCrypto&&(t={obj:n.connection,method:"decrypt"}),n.session.get(e,t)):n.promise.reject(new l(400," Need to be synchronised.")):n.promise.reject(new l(401,"Find pb : need a user logged in."))},c.prototype.fidjFindAllInDb=function(){var e,t=this;return t.connection.getClientId()?t.session.isReady()?(t.connection.fidjCrypto&&(e={obj:t.connection,method:"decrypt"}),t.session.getAll(e).then(function(e){return t.connection.setCryptoSaltAsVerified(),t.promise.resolve(e)})):t.promise.reject(new l(400,"Need to be synchronised.")):t.promise.reject(new l(401,"Need a user logged in."))},c.prototype.fidjPostOnEndpoint=function(e,t){var n={key:e},o=this.fidjGetEndpoints(n);if(!o||1!==o.length)return this.promise.reject(new l(400,"fidj.sdk.service.fidjPostOnEndpoint : endpoint does not exist."));var r=o[0].url,i=this.connection.getIdToken();return(new d).post({url:r,headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:"Bearer "+i},data:t})},c.prototype.fidjGetIdToken=function(){return this.connection.getIdToken()},c.prototype._loginInternal=function(o,r,i){var s=this;return s.logger.log("fidj.sdk.service._loginInternal"),s.connection.isReady()?new s.promise(function(t,n){s.connection.logout().then(function(){return s.connection.getClient().login(o,r,i)})["catch"](function(e){return s.connection.getClient().login(o,r,i)}).then(function(e){e.email=o,t(e)})["catch"](function(e){s.logger.error("fidj.sdk.service._loginInternal error : "+e),n(e)})}):s.promise.reject(new l(403,"Need an intialized FidjService"))},c.prototype._removeAll=function(){return this.connection.destroy(),this.session.destroy()},c.prototype._createSession=function(e){var t=this.connection.getDBs({filter:"theBestOnes"});return t&&0!==t.length||this.logger.warn("Seems that you are in demo mode, no remote DB."),this.session.setRemote(t),this.session.create(e)},c.prototype._testPromise=function(e){return e?this.promise.resolve("test promise ok "+e):new this.promise(function(e,t){e("test promise ok")})},c.prototype._generateObjectUniqueId=function(e,t,n){var o=new Date,r=""+o.getFullYear()+o.getMonth()+o.getDate()+o.getHours()+o.getMinutes(),i=++c._srvDataUniqId,s="";return e&&e.charAt(0)&&(s+=e.charAt(0)+""),t&&3<t.length&&(s+=t.substring(0,4)),n&&3<n.length&&(s+=n.substring(0,4)),s+=r+""+i},c._srvDataUniqId=0,c}(),y=function(){function e(){this.logger=new v,this.promise=Promise,this.fidjService=null}return e.prototype.init=function(e,t){return this.fidjService||(this.fidjService=new g(this.logger,this.promise)),this.fidjService.fidjInit(e,t)},e.prototype.login=function(e,t){return this.fidjService?this.fidjService.fidjLogin(e,t):this.promise.reject(new l(303,"fidj.sdk.angular2.login : not initialized."))},e.prototype.loginAsDemo=function(e){return this.fidjService?this.fidjService.fidjLoginInDemoMode(e):this.promise.reject(new l(303,"fidj.sdk.angular2.loginAsDemo : not initialized."))},e.prototype.isLoggedIn=function(){return!!this.fidjService&&this.fidjService.fidjIsLogin()},e.prototype.getRoles=function(){return this.fidjService?this.fidjService.fidjRoles():[]},e.prototype.getEndpoints=function(){return this.fidjService?this.fidjService.fidjGetEndpoints():[]},e.prototype.postOnEndpoint=function(e,t){return this.fidjService?this.fidjService.fidjPostOnEndpoint(e,t):this.promise.reject(new l(303,"fidj.sdk.angular2.loginAsDemo : not initialized."))},e.prototype.getIdToken=function(){if(this.fidjService)return this.fidjService.fidjGetIdToken()},e.prototype.getMessage=function(){return this.fidjService?this.fidjService.fidjMessage():""},e.prototype.logout=function(e){return e||!this.fidjService?this.promise.reject(new l(303,"fidj.sdk.angular2.logout : not initialized.")):this.fidjService.fidjLogout(e)},e.prototype.sync=function(e){return this.fidjService?this.fidjService.fidjSync(e,this):this.promise.reject(new l(401,"fidj.sdk.angular2.sync : not initialized."))},e.prototype.put=function(e){return this.fidjService?this.fidjService.fidjPutInDb(e):this.promise.reject(new l(401,"fidj.sdk.angular2.put : not initialized."))},e.prototype.remove=function(e){return this.fidjService?this.fidjService.fidjRemoveInDb(e):this.promise.reject(new l(401,"fidj.sdk.angular2.remove : not initialized."))},e.prototype.find=function(e){return this.fidjService?this.fidjService.fidjFindInDb(e):this.promise.reject(new l(401,"fidj.sdk.angular2.find : not initialized."))},e.prototype.findAll=function(){return this.fidjService?this.fidjService.fidjFindAllInDb():this.promise.reject(new l(401,"fidj.sdk.angular2.findAll : not initialized."))},e.decorators=[{type:n.Injectable}],e.ctorParameters=function(){return[]},e}(),v=function(){function e(e){(this.level=e)||(this.level=i.ERROR),window.console||(this.level=i.NONE)}return e.prototype.log=function(e,t){this.level===i.LOG&&console.log(e,t)},e.prototype.warn=function(e,t){this.level!==i.LOG&&this.level!==i.WARN||console.warn(e,t)},e.prototype.error=function(e,t){this.level!==i.LOG&&this.level!==i.WARN&&this.level!==i.ERROR||console.error(e,t)},e.prototype.setLevel=function(e){this.level=e},e}(),j=function(){function e(){}return e.decorators=[{type:n.NgModule,args:[{imports:[t.CommonModule],declarations:[],exports:[],providers:[y]}]}],e.ctorParameters=function(){return[]},e}();e.Base64=a,e.LocalStorage=o,e.Xor=r,e.FidjModule=j,e.FidjService=y,e.LoggerService=v,e.ɵa=i,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=fidj.umd.min.js.map