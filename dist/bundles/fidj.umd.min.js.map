{"version":3,"sources":["../../src/sdk/interfaces.ts","../../src/tools/base64.ts","../../src/tools/storage.ts","../../src/tools/xor.ts","../../src/sdk/error.ts","../../src/sdk/fidj.module.ts","../../node_modules/tslib/tslib.es6.js","../../src/version/index.ts","../../src/connection/ajax.ts","../../src/connection/interfaces.ts","../../src/connection/client.ts","../../src/connection/connection.ts","../../src/session/session.ts","../../src/sdk/logger.service.ts","../../src/sdk/internal.service.ts","../../src/sdk/angular.service.ts"],"names":["LoggerLevelEnum","Base64","encode","input","window","btoa","require","encodeURIComponent","replace","match","p1","String","fromCharCode","parseInt","decode","_atob","atob","decodeURIComponent","split","map","c","charCodeAt","toString","slice","join","LocalStorage","storageService","storageKey","this","version","storage","localStorage","Error","prototype","set","key","value","checkKey","t","JSON","stringify","string","number","bool","TypeError","json","setItem","get","def","item","getItem","parse","valueOf","remove","existed","removeItem","clear","length","size","foreach","f","context","n","i","call","Xor","encrypt","result","header","keyCharAt","decrypt","oldStyle","substring","Math","floor","code","reason","equals","err","msg","NgModule","args","imports","CommonModule","declarations","exports","__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","step","next","e","rejected","done","then","apply","__generator","body","y","g","_","label","sent","trys","ops","verb","throw","return","Symbol","iterator","v","op","pop","push","Object","create","XhrErrorReason","ClientToken","id","type","data","ClientTokens","username","accessToken","idToken","refreshToken","ClientUser","roles","message","Ajax","xhr","formatResponseData","response","dataParsed","formatError","error","errorFormatted","UNKNOWN","status","STATUS","TIMEOUT","request","post","opt","method","url","headers","res","catch","put","timeout","delete","Client","appId","URI","sdk","uuid","_clientUuid","random","info","navigator","appName","appVersion","userAgent","setClientUuid","setClientInfo","clientId","_clientId","refreshCount","_refreshCount","refreshCountInitial","setClientId","clientUuid","clientInfo","login","password","updateProperties","urlLogin","dataLogin","name","email","Content-Type","Accept","console","_a","user","urlToken","dataToken","grant_type","client_udid","client_info","scope","Authorization","tools.Base64","createdAccessToken","token","createdIdToken","createdRefreshToken","reAuthenticate","refresh_token","clientToken","logout","isReady","FidjPouch","Connection","_sdk","_storage","_logger","client","cryptoSalt","_cryptoSalt","cryptoSaltNext","_cryptoSaltNext","_accessToken","accessTokenPrevious","_idToken","_refreshToken","states","_states","apis","destroy","force","_accessTokenPrevious","setClient","setUser","getUser","getClient","setCryptoSalt","setCryptoSaltAsVerified","dataAsObj","fidjCrypto","decrypted","isLogin","exp","payload","decoded","Date","getTime","getClientId","getIdToken","getIdPayload","log","getAccessPayload","getPreviousAccessPayload","refreshConnection","notExpired","expired","previousIdToken","previousAccessToken","clientTokens","setConnection","_b","salt","_j","bind","_f","_e","_h","_g","clientUser","_c","_d","concat","setConnectionOffline","options","getApiEndpoints","ea","blocked","filteredEa","prod","val","apiEndpoints","forEach","endpoint","filter","r","couldCheckStates","keys","state","bestOldOne","lastTimeWasOk","getDBs","dbs","sort","reverse","filteredDBs","verifyApiState","currentTime","endpointUrl","isOk","time","err_1","verifyDbState","dbEndpoint","verifyConnectionStates","promises","endpointObj","_this","dbEndpointObj","all","default","PouchAdapterCordovaSqlite","plugin","Session","db","dbRecordCount","dbLastSync","remoteDb","uid","opts","location","adapter","setRemote","sync","userId","remoteUri","replicate","to","on","doc","fidjUserId","second","first","_id","oid","ave","crypto","dataWithoutIds","toStore","fidjOrgId","fidjAppVersion","_rev","fidjData","resultAsString","write","obj","fidjDacr","ok","rev","data_id","_deleted","row","resultAsJson","extractJson","getAll","allDocs","include_docs","descending","rows","isEmpty","total_rows","LoggerService","level","ERROR","NONE","INFO","warn","WARN","setLevel","urljoin","InternalService","logger","promise","ls","org","useDB","logLevel","global","tools.LocalStorage","session","session.Session","connection","connection.Connection","fidjInit","fidjId","fidjVersion","hasOwnProperty","bestUrls","bestOldUrls","theBestFirstUrl","theBestFirstOldUrl","fidjIsLogin","connection.Client","fidjLogin","_removeAll","_createSession","_loginInternal","err_2","e_1","fidjLoginInDemoMode","self","now","setDate","getDate","tomorrow","endpoints","jwtSign","fidjGetEndpoints","showBlocked","ap","Array","isArray","fidjRoles","fidjMessage","fidjLogout","fidjSync","fnInitFirstData","fnInitFirstData_Arg","firstSync","resolveEmpty","rejectEmptyNotUsed","ret","Function","doc_count","errMessage","fidjPutInDb","indexOf","_generateObjectUniqueId","fidjRemoveInDb","fidjFindInDb","fidjFindAllInDb","results","fidjSendOnEndpoint","firstEndpointUrl","relativePath","jwt","query","answer","fidjForgotPasswordRequest","fidjGetIdToken","_testPromise","a","simpleDate","getFullYear","getMonth","getHours","getMinutes","sequId","_srvDataUniqId","UId","charAt","FidjService","fidjService","init","FidjError","loginAsDemo","isLoggedIn","getRoles","getEndpoints","sendOnEndpoint","forgotPasswordRequest","getMessage","find","findAll","Injectable","providedIn"],"mappings":"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","sourcesContent":["export interface ErrorInterface {\n    code: number;\n    reason: string;\n}\n\nexport interface EndpointInterface {\n    key: string;\n    url: string;\n    blocked: boolean;\n}\n\nexport interface EndpointFilterInterface {\n    key?: string;\n    showBlocked?: boolean;\n}\n\nexport interface EndpointCallInterface {\n    verb: string;\n    key?: string;\n    relativePath?: string;\n    data?: any;\n}\n\n/**\n * Interface used by all InternalService wrappers (angular.js, angular.io)\n *\n * @see FidjModule\n * @see FidjModule, FidjAngularService\n */\nexport interface ModuleServiceInterface {\n\n    init(fidjId: string, options?: ModuleServiceInitOptionsInterface): Promise<void | ErrorInterface>;\n\n    login(login: string, password: string): Promise<any | ErrorInterface>;\n\n    loginAsDemo(options?: ModuleServiceLoginOptionsInterface): Promise<any | ErrorInterface>;\n\n    isLoggedIn(): boolean;\n\n    getRoles(): Promise<Array<string>>;\n\n    getEndpoints(): Promise<Array<EndpointInterface>>;\n\n    sendOnEndpoint(input: EndpointCallInterface): Promise<any>;\n\n    forgotPasswordRequest(email: String): Promise<void>;\n\n    getIdToken(): Promise<string | ErrorInterface>;\n\n    getMessage(): Promise<string>;\n\n    logout(force?: boolean): Promise<void | ErrorInterface>;\n\n    sync(fnInitFirstData?: any): Promise<any | ErrorInterface>;\n\n    put(data: any): Promise<any | ErrorInterface>;\n\n    remove(dataId: any): Promise<any | ErrorInterface>;\n\n    find(id: string): Promise<any | ErrorInterface>;\n\n    findAll(): Promise<any | ErrorInterface>;\n}\n\n/**\n * prod : true by default\n * useDB : false by default\n * crypto : false by default\n * logLevel : NONE by default\n */\nexport interface ModuleServiceInitOptionsInterface {\n    prod: boolean,\n    useDB?: boolean,\n    // forcedEndpoint?: string,\n    // forcedDBEndpoint?: string,\n    crypto?: boolean,\n    logLevel?: LoggerLevelEnum\n}\n\nexport interface ModuleServiceLoginOptionsInterface {\n    accessToken?: string,\n    idToken?: string,\n    refreshToken?: string,\n}\n\nexport interface SdkInterface {\n    org: string,\n    version: string,\n    prod: boolean,\n    useDB: boolean\n}\n\nexport enum LoggerLevelEnum {\n    INFO = 1,\n    WARN = 2,\n    ERROR = 3,\n    NONE = 4\n}\n\nexport interface LoggerInterface {\n    setLevel: (LoggerLevelEnum) => void;\n\n    log: (a?, b?, c?, d?, e?, f?) => any;\n    warn: (a?, b?, c?, d?, e?, f?) => any;\n    error: (a?, b?, c?, d?, e?, f?) => any;\n}\n","export class Base64 {\n\n    constructor() {\n    };\n\n    /**\n     * Decodes string from Base64 string\n     */\n    public static encode(input: string): string {\n\n        if (!input) {\n            return null;\n        }\n\n        const _btoa = typeof window !== 'undefined' ? window.btoa : require('btoa');\n\n        return _btoa(encodeURIComponent(input).replace(/%([0-9A-F]{2})/g,\n            function toSolidBytes(match, p1) {\n                return String.fromCharCode(parseInt('0x' + p1, 16));\n            }));\n\n    }\n\n    public static decode(input: string): string {\n\n        if (!input) {\n            return null;\n        }\n\n        const _atob = typeof window !== 'undefined' ? window.atob : require('atob');\n\n        return decodeURIComponent(_atob(input).split('').map((c) => {\n            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);\n        }).join(''));\n\n    }\n}\n","/**\n * localStorage class factory\n * Usage : var LocalStorage = fidj.LocalStorageFactory(window.localStorage); // to create a new class\n * Usage : var localStorageService = new LocalStorage(); // to create a new instance\n */\nexport class LocalStorage {\n\n    public version = '0.1';\n    private storage;\n\n    // Constructor\n    constructor(storageService, private storageKey) {\n        this.storage = storageService || window.localStorage;\n        if (!this.storage) {\n            throw new Error('fidj.LocalStorageFactory needs a storageService!');\n        }\n        // todo LocalStorage refacto\n        //            if (!fidj.Xml) {\n        //                throw new Error('fidj.Xml needs to be loaded before fidj.LocalStorage!');\n        //            }\n        //            if (!fidj.Json) {\n        //                throw new Error('fidj.Json needs to be loaded before fidj.LocalStorage!');\n        //            }\n        //            if (!fidj.Xml.isXml || !fidj.Xml.xml2String || !fidj.Xml.string2Xml) {\n        //                throw new Error('fidj.Xml with isXml(), xml2String()\n        // and string2Xml() needs to be loaded before fidj.LocalStorage!');\n        //            }\n        //            if (!fidj.Json.object2String || !fidj.Json.string2Object) {\n        //                throw new Error('fidj.Json with object2String()\n        // and string2Object() needs to be loaded before fidj.LocalStorage!');\n        //            }\n        //\n    }\n\n    // Public API\n\n    /**\n     * Sets a key's value.\n     *\n     * @param key - Key to set. If this value is not set or not\n     *              a string an exception is raised.\n     * @param value - Value to set. This can be any value that is JSON\n     *              compatible (Numbers, Strings, Objects etc.).\n     * @returns the stored value which is a container of user value.\n     */\n    set(key: string, value) {\n\n        key = this.storageKey + key;\n        this.checkKey(key);\n        // clone the object before saving to storage\n        const t = typeof(value);\n        if (t === 'undefined') {\n            value = 'null';\n        } else if (value === null) {\n            value = 'null';\n        } else if (t === 'string') {\n            value = JSON.stringify({string: value})\n        } else if (t === 'number') {\n            value = JSON.stringify({number: value});\n        } else if (t === 'boolean') {\n            value = JSON.stringify({bool: value});\n        } else if (t === 'object') {\n            value = JSON.stringify({json: value});\n        } else {\n            // reject and do not insert\n            // if (typeof value == \"function\") for example\n            throw new TypeError('Value type ' + t + ' is invalid. It must be null, undefined, xml, string, number, boolean or object');\n        }\n        this.storage.setItem(key, value);\n        return value;\n    };\n\n    /**\n     * Looks up a key in cache\n     *\n     * @param key - Key to look up.\n     * @param def - Default value to return, if key didn't exist.\n     * @returns the key value, default value or <null>\n     */\n    get(key: string, def?) {\n        key = this.storageKey + key;\n        this.checkKey(key);\n        const item = this.storage.getItem(key);\n        if (item !== null) {\n            if (item === 'null') {\n                return null;\n            }\n            const value = JSON.parse(item);\n\n            // var value = fidj.Json.string2Object(item);\n            // if ('xml' in value) {\n            //     return fidj.Xml.string2Xml(value.xml);\n            // } else\n            if ('string' in value) {\n                return value.string;\n            } else if ('number' in value) {\n                return value.number.valueOf();\n            } else if ('bool' in value) {\n                return value.bool.valueOf();\n            } else {\n                return value.json;\n            }\n        }\n        return !def ? null : def;\n    };\n\n    /**\n     * Deletes a key from cache.\n     *\n     * @param  key - Key to delete.\n     * @returns true if key existed or false if it didn't\n     */\n    remove(key: string) {\n        key = this.storageKey + key;\n        this.checkKey(key);\n        const existed = (this.storage.getItem(key) !== null);\n        this.storage.removeItem(key);\n        return existed;\n    };\n\n    /**\n     * Deletes everything in cache.\n     *\n     * @return true\n     */\n    clear() {\n        const existed = (this.storage.length > 0);\n        this.storage.clear();\n        return existed;\n    };\n\n    /**\n     * How much space in bytes does the storage take?\n     *\n     * @returns Number\n     */\n    size() {\n        return this.storage.length;\n    };\n\n    /**\n     * Call function f on the specified context for each element of the storage\n     * from index 0 to index length-1.\n     * WARNING : You should not modify the storage during the loop !!!\n     *\n     * @param f - Function to call on every item.\n     * @param  context - Context (this for example).\n     * @returns Number of items in storage\n     */\n    foreach(f, context) {\n        const n = this.storage.length;\n        for (let i = 0; i < n; i++) {\n            const key = this.storage.key(i);\n            const value = this.get(key);\n            if (context) {\n                // f is an instance method on instance context\n                f.call(context, value);\n            } else {\n                // f is a function or class method\n                f(value);\n            }\n        }\n        return n;\n    };\n\n    // Private API\n    // helper functions and variables hidden within this function scope\n\n    private checkKey(key) {\n        if (!key || (typeof key !== 'string')) {\n            throw new TypeError('Key type must be string');\n        }\n        return true;\n    }\n}\n","import {Base64} from './base64';\n\nexport class Xor {\n\n    static header = 'artemis-lotsum';\n\n    constructor() {\n    };\n\n\n    public static encrypt(value: string, key: string): string {\n\n        let result = '';\n\n        value = Xor.header + value;\n\n        for (let i = 0; i < value.length; i++) {\n            result += String.fromCharCode((value[i].charCodeAt(0).toString(10) as any) ^ Xor.keyCharAt(key, i));\n        }\n        result = Base64.encode(result);\n        return result;\n    };\n\n    public static decrypt(value: string, key: string, oldStyle?: boolean): string {\n        let result = '';\n        value = Base64.decode(value);\n        for (let i = 0; i < value.length; i++) {\n            result += String.fromCharCode((value[i].charCodeAt(0).toString(10) as any) ^ Xor.keyCharAt(key, i));\n        }\n\n        if (!oldStyle && Xor.header !== result.substring(0, Xor.header.length)) {\n            return null;\n        }\n\n        if (!oldStyle) {\n            result = result.substring(Xor.header.length);\n        }\n        return result;\n    }\n\n    public static keyCharAt(key, i) {\n        return key[Math.floor(i % key.length)].charCodeAt(0).toString(10);\n    }\n\n\n}\n","import {ErrorInterface} from './interfaces';\n\nexport class Error implements ErrorInterface {\n\n    constructor(public code: number, public reason: string) {\n    };\n\n    equals(err: Error) {\n        return this.code === err.code && this.reason === err.reason;\n    }\n\n    toString(): string {\n        const msg: string = (typeof this.reason === 'string') ? this.reason : JSON.stringify(this.reason);\n        return '' + this.code + ' - ' + msg;\n    }\n\n}\n","import {NgModule} from '@angular/core';\nimport {CommonModule} from '@angular/common';\n\n\n/**\n * `NgModule` which provides associated services.\n *\n * ...\n *\n * @stable\n */\n@NgModule({\n    imports: [\n        CommonModule\n    ],\n    declarations: [],\n\n    exports: [],\n})\nexport class FidjModule {\n    constructor() {\n    }\n}\n\n\n/**\n * module FidjModule\n *\n * exemple\n *      // ... after install :\n *      // $ npm install fidj\n *      // then init your app.js & use it in your services\n * TODO refresh gist :\n * <script src=\"https://gist.github.com/mlefree/ad64f7f6a345856f6bf45fd59ca8db46.js\"></script>\n *\n * <script src=\"https://gist.github.com/mlefree/ad64f7f6a345856f6bf45fd59ca8db46.js\"></script>\n */\n","/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation.\r\n\r\nPermission to use, copy, modify, and/or distribute this software for any\r\npurpose with or without fee is hereby granted.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\r\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\r\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\r\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\r\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\r\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\r\nPERFORMANCE OF THIS SOFTWARE.\r\n***************************************************************************** */\r\n/* global Reflect, Promise */\r\n\r\nvar extendStatics = function(d, b) {\r\n    extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\r\n    return extendStatics(d, b);\r\n};\r\n\r\nexport function __extends(d, b) {\r\n    if (typeof b !== \"function\" && b !== null)\r\n        throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\r\n    extendStatics(d, b);\r\n    function __() { this.constructor = d; }\r\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n}\r\n\r\nexport var __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    }\r\n    return __assign.apply(this, arguments);\r\n}\r\n\r\nexport function __rest(s, e) {\r\n    var t = {};\r\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\r\n        t[p] = s[p];\r\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\r\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\r\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\r\n                t[p[i]] = s[p[i]];\r\n        }\r\n    return t;\r\n}\r\n\r\nexport function __decorate(decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n}\r\n\r\nexport function __param(paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n}\r\n\r\nexport function __metadata(metadataKey, metadataValue) {\r\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\r\n}\r\n\r\nexport function __awaiter(thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n}\r\n\r\nexport function __generator(thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n}\r\n\r\nexport var __createBinding = Object.create ? (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\r\n}) : (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    o[k2] = m[k];\r\n});\r\n\r\nexport function __exportStar(m, o) {\r\n    for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(o, p)) __createBinding(o, m, p);\r\n}\r\n\r\nexport function __values(o) {\r\n    var s = typeof Symbol === \"function\" && Symbol.iterator, m = s && o[s], i = 0;\r\n    if (m) return m.call(o);\r\n    if (o && typeof o.length === \"number\") return {\r\n        next: function () {\r\n            if (o && i >= o.length) o = void 0;\r\n            return { value: o && o[i++], done: !o };\r\n        }\r\n    };\r\n    throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\r\n}\r\n\r\nexport function __read(o, n) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\r\n    if (!m) return o;\r\n    var i = m.call(o), r, ar = [], e;\r\n    try {\r\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\r\n    }\r\n    catch (error) { e = { error: error }; }\r\n    finally {\r\n        try {\r\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\r\n        }\r\n        finally { if (e) throw e.error; }\r\n    }\r\n    return ar;\r\n}\r\n\r\n/** @deprecated */\r\nexport function __spread() {\r\n    for (var ar = [], i = 0; i < arguments.length; i++)\r\n        ar = ar.concat(__read(arguments[i]));\r\n    return ar;\r\n}\r\n\r\n/** @deprecated */\r\nexport function __spreadArrays() {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n}\r\n\r\nexport function __spreadArray(to, from) {\r\n    for (var i = 0, il = from.length, j = to.length; i < il; i++, j++)\r\n        to[j] = from[i];\r\n    return to;\r\n}\r\n\r\nexport function __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nexport function __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\nexport function __asyncDelegator(o) {\r\n    var i, p;\r\n    return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\r\n    function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: n === \"return\" } : f ? f(v) : v; } : f; }\r\n}\r\n\r\nexport function __asyncValues(o) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var m = o[Symbol.asyncIterator], i;\r\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\r\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\r\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\r\n}\r\n\r\nexport function __makeTemplateObject(cooked, raw) {\r\n    if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\r\n    return cooked;\r\n};\r\n\r\nvar __setModuleDefault = Object.create ? (function(o, v) {\r\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\r\n}) : function(o, v) {\r\n    o[\"default\"] = v;\r\n};\r\n\r\nexport function __importStar(mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\r\n    __setModuleDefault(result, mod);\r\n    return result;\r\n}\r\n\r\nexport function __importDefault(mod) {\r\n    return (mod && mod.__esModule) ? mod : { default: mod };\r\n}\r\n\r\nexport function __classPrivateFieldGet(receiver, state, kind, f) {\r\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\r\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\r\n    return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\r\n}\r\n\r\nexport function __classPrivateFieldSet(receiver, state, value, kind, f) {\r\n    if (kind === \"m\") throw new TypeError(\"Private method is not writable\");\r\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a setter\");\r\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot write private member to an object whose class did not declare it\");\r\n    return (kind === \"a\" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value)), value;\r\n}\r\n","// bumped version via gulp\nexport const version = '3.3.6';\n","// import {XHRPromise} from './xhrpromise';\n// const superagent = require('superagent');\n// import from 'superagent';\n\nexport interface XhrOptionsInterface {\n    url: string,\n    data?: any,\n    headers?: any,\n    async?: boolean,\n    username?: string,\n    password?: string,\n    withCredentials?: boolean\n}\n\nexport enum XhrErrorReason {\n    UNKNOWN,\n    TIMEOUT,\n    STATUS\n}\n\n\nexport interface XhrErrorInterface {\n    reason: XhrErrorReason,\n    status: number,\n    code: number,\n    message: string,\n}\n\nexport class Ajax {\n\n    // private static xhr: XHRPromise = new XHRPromise();\n    private xhr; // : XHRPromise;\n\n    constructor() {\n\n        // https://www.twilio.com/blog/2017/08/http-requests-in-node-js.html\n        // axios ?\n        //  https://github.com/axios/axios\n        // const axios = require('axios');\n\n        // axios.get('https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY')\n        //     .then(response => {\n        //         console.log(response.data.url);\n        //         console.log(response.data.explanation);\n        //     })\n\n        // superagent.get('https://api.nasa.gov/planetary/apod')\n        //     .query({ api_key: 'DEMO_KEY', date: '2017-08-02' })\n\n        this.xhr = require('axios'); // require('superagent'); // new XHRPromise();\n    };\n\n    private static formatResponseData(response: any): any {\n        // TODO switch depending on json headers\n        let dataParsed = response;\n\n        while (dataParsed && dataParsed.data) {\n            dataParsed = dataParsed.data;\n        }\n\n        try {\n            dataParsed = JSON.parse(dataParsed + '');\n        } catch (e) {\n        }\n        return dataParsed;\n    };\n\n    private static formatError(error: any): XhrErrorInterface {\n\n        const errorFormatted: XhrErrorInterface = {\n            reason: XhrErrorReason.UNKNOWN,\n            status: -1,\n            code: -1,\n            message: '',\n        };\n\n        if (error.status) {\n            errorFormatted.reason = XhrErrorReason.STATUS;\n            errorFormatted.status = parseInt(error.status, 10);\n            errorFormatted.code = parseInt(error.status, 10);\n        }\n\n        if (error.response) {\n            errorFormatted.message = error.response;\n\n            if (error.response.status) {\n                errorFormatted.reason = XhrErrorReason.STATUS;\n                errorFormatted.status = parseInt(error.response.status, 10);\n                errorFormatted.code = parseInt(error.response.status, 10);\n            } else if (error.response.status === null) { // timeout\n                errorFormatted.reason = XhrErrorReason.TIMEOUT;\n                errorFormatted.status = 408;\n                errorFormatted.code = 408;\n            }\n\n        } else if (error.request) {\n            errorFormatted.message = error.request;\n        } else if (error.message) {\n            errorFormatted.message = error.message;\n        }\n\n        // _this._handleError('browser', reject, null, 'browser doesn\\'t support XMLHttpRequest');\n        // _this._handleError('url', reject, null, 'URL is a required parameter');\n        // _this._handleError('parse', reject, null, 'invalid JSON response');\n        // return _this._handleError('error', reject);\n        // return _this._handleError('timeout', reject);\n        // return _this._handleError('abort', reject);\n        // return _this._handleError('send', reject, null, e.toString());\n\n        // if (err.reason === 'timeout') {\n        //     err.code = 408;\n        // } else {\n        //     err.code = 404;\n        // }\n\n        return errorFormatted;\n    };\n\n    public post(args: XhrOptionsInterface): Promise<any | XhrErrorInterface> {\n\n        const opt: any = {\n            method: 'POST',\n            url: args.url,\n            data: JSON.stringify(args.data)\n        };\n        if (args.headers) {\n            opt.headers = args.headers;\n        }\n\n        return this.xhr.post(opt.url, opt.data, {\n                headers: opt.headers,\n                // timeout: 10000\n            })\n            .then(res => {\n                if (res.status &&\n                    (parseInt(res.status, 10) < 200 || parseInt(res.status, 10) >= 300)) {\n                    return Promise.reject(Ajax.formatError(res));\n                }\n\n                return Promise.resolve(Ajax.formatResponseData(res));\n            })\n            .catch(err => {\n                return Promise.reject(Ajax.formatError(err));\n            });\n    }\n\n    public put(args: XhrOptionsInterface): Promise<any | XhrErrorInterface> {\n        const opt: any = {\n            method: 'PUT',\n            url: args.url,\n            data: JSON.stringify(args.data)\n        };\n        if (args.headers) {\n            opt.headers = args.headers;\n        }\n        return this.xhr\n            .put(opt.url, opt.data, {\n                headers: opt.headers,\n                timeout: 10000\n            })\n            .then(res => {\n                if (res.status &&\n                    (parseInt(res.status, 10) < 200 || parseInt(res.status, 10) >= 300)) {\n                    return Promise.reject(Ajax.formatError(res));\n                }\n\n                return Promise.resolve(Ajax.formatResponseData(res));\n            })\n            .catch(err => {\n                return Promise.reject(Ajax.formatError(err));\n            });\n    }\n\n    public delete(args: XhrOptionsInterface): Promise<any | XhrErrorInterface> {\n        const opt: any = {\n            method: 'DELETE',\n            url: args.url,\n            data: JSON.stringify(args.data)\n        };\n        if (args.headers) {\n            opt.headers = args.headers;\n        }\n        return this.xhr\n            .delete(opt.url, // no data\n                {\n                    headers: opt.headers,\n                    timeout: 10000\n                })\n            // .delete(opt.url) // .send(opt)\n            .then(res => {\n                if (res.status &&\n                    (parseInt(res.status, 10) < 200 || parseInt(res.status, 10) >= 300)) {\n                    return Promise.reject(Ajax.formatError(res));\n                }\n\n                return Promise.resolve(Ajax.formatResponseData(res));\n            })\n            .catch(err => {\n                return Promise.reject(Ajax.formatError(err));\n            });\n    }\n\n    public get(args: XhrOptionsInterface): Promise<any | XhrErrorInterface> {\n        const opt: any = {\n            method: 'GET',\n            url: args.url\n        };\n        if (args.data) {\n            opt.data = args.data;\n        }\n        if (args.headers) {\n            opt.headers = args.headers;\n        }\n        return this.xhr\n            .get(opt.url, {\n                // opt.data,\n                headers: opt.headers,\n                timeout: 10000\n            })\n            // .get(opt.url) // .send(opt)\n            .then(res => {\n                if (res.status &&\n                    (parseInt(res.status, 10) < 200 || parseInt(res.status, 10) >= 300)) {\n                    return Promise.reject(Ajax.formatError(res));\n                }\n\n                return Promise.resolve(Ajax.formatResponseData(res));\n            })\n            .catch(err => {\n                return Promise.reject(Ajax.formatError(err));\n            });\n    }\n}\n","export interface ConnectionFindOptionsInterface {\n    filter: string,\n}\n\nexport class ClientToken {\n    constructor(\n        public id: string,\n        public type: string,\n        public data: string) {\n    }\n}\n\nexport class ClientTokens {\n    constructor(\n        public username: string,\n        public accessToken: ClientToken,\n        public idToken: ClientToken,\n        public refreshToken: ClientToken) {\n    }\n}\n\nexport class ClientUser {\n    constructor(public id: string,\n                public username: string,\n                public roles: string[],\n                message: string) {\n    }\n}\n\n","import {Ajax} from './ajax';\nimport {LocalStorage} from '../tools';\nimport {SdkInterface, ErrorInterface} from '../sdk/interfaces';\nimport * as tools from '../tools';\nimport {ClientToken, ClientTokens, ClientUser} from './interfaces';\n\nexport class Client {\n\n    public clientId: string;\n    private clientUuid: string;\n    private clientInfo: string;\n    // private refreshToken: string;\n    private static refreshCountInitial = 1;\n    private static refreshCount = Client.refreshCountInitial;\n    private static _clientUuid = 'v2.clientUuid';\n    private static _clientId = 'v2.clientId';\n    private static _refreshCount = 'v2.refreshCount';\n\n    constructor(private appId: string,\n                private URI: string,\n                private storage: LocalStorage,\n                private sdk: SdkInterface) {\n\n        let uuid: string = this.storage.get(Client._clientUuid) || 'uuid-' + Math.random();\n        let info = '_clientInfo'; // this.storage.get(Client._clientInfo);\n        if (typeof window !== 'undefined' && window.navigator) {\n            info = window.navigator.appName + '@' + window.navigator.appVersion + '-' + window.navigator.userAgent;\n        }\n        if (typeof window !== 'undefined' && window['device'] && window['device'].uuid) {\n            uuid = window['device'].uuid;\n        }\n        this.setClientUuid(uuid);\n        this.setClientInfo(info);\n        this.clientId = this.storage.get(Client._clientId);\n        Client.refreshCount = this.storage.get(Client._refreshCount) || Client.refreshCountInitial;\n    };\n\n    public setClientId(value: string) {\n        this.clientId = '' + value;\n        this.storage.set(Client._clientId, this.clientId);\n    }\n\n    public setClientUuid(value: string) {\n        this.clientUuid = '' + value;\n        this.storage.set(Client._clientUuid, this.clientUuid);\n    }\n\n    public setClientInfo(value: string) {\n        this.clientInfo = '' + value;\n        // this.storage.set('clientInfo', this.clientInfo);\n    }\n\n    /**\n     *\n     * @param login\n     * @param password\n     * @param updateProperties\n     * @throws {ErrorInterface}\n     */\n    public async login(login: string, password: string, updateProperties?: any): Promise<ClientTokens> {\n\n        if (!this.URI) {\n            console.error('no api uri');\n            return Promise.reject({code: 408, reason: 'no-api-uri'});\n        }\n\n        const urlLogin = this.URI + '/users';\n\n        const dataLogin = {\n            name: login,\n            username: login,\n            email: login,\n            password: password\n        };\n\n        const createdUser: ClientUser = (await new Ajax().post({\n            url: urlLogin,\n            data: dataLogin,\n            headers: {'Content-Type': 'application/json', 'Accept': 'application/json'}\n        }) as any).user;\n\n        this.setClientId(login); // login or createdUser.id or createdUser._id\n        const urlToken = this.URI + '/apps/' + this.appId + '/tokens';\n        const dataToken = {\n            grant_type: 'access_token',\n            // grant_type: 'client_credentials',\n            // client_id: this.clientId,\n            // client_secret: password,\n            client_udid: this.clientUuid,\n            client_info: this.clientInfo,\n            // audience: this.appId,\n            scope: JSON.stringify(this.sdk)\n        };\n        const createdAccessToken: ClientToken = (await new Ajax().post({\n            url: urlToken,\n            data: dataToken,\n            headers: {\n                'Content-Type': 'application/json', 'Accept': 'application/json',\n                'Authorization': 'Basic ' + tools.Base64.encode('' + login + ':' + password)\n            }\n        }) as any).token;\n\n        dataToken.grant_type = 'id_token';\n        const createdIdToken: ClientToken = (await new Ajax().post({\n            url: urlToken,\n            data: dataToken,\n            headers: {\n                'Content-Type': 'application/json', 'Accept': 'application/json',\n                'Authorization': 'Bearer ' + createdAccessToken.data\n            }\n        }) as any).token;\n\n        dataToken.grant_type = 'refresh_token';\n        const createdRefreshToken: ClientToken = (await new Ajax().post({\n            url: urlToken,\n            data: dataToken,\n            headers: {\n                'Content-Type': 'application/json', 'Accept': 'application/json',\n                'Authorization': 'Bearer ' + createdAccessToken.data\n            }\n        }) as any).token;\n\n        return new ClientTokens(login, createdAccessToken, createdIdToken, createdRefreshToken);\n    }\n\n    /**\n     *\n     * @param refreshToken\n     * @throws ErrorInterface\n     */\n    public async reAuthenticate(refreshToken: string): Promise<ClientToken> {\n\n        if (!this.URI) {\n            console.error('no api uri');\n            return Promise.reject({code: 408, reason: 'no-api-uri'});\n        }\n\n        const url = this.URI + '/apps/' + this.appId + '/tokens';\n        const data = {\n            grant_type: 'refresh_token',\n            // client_id: this.clientId,\n            client_udid: this.clientUuid,\n            client_info: this.clientInfo,\n            // audience: this.appId,\n            scope: JSON.stringify(this.sdk),\n            refresh_token: refreshToken,\n            refreshCount: Client.refreshCount,\n        };\n\n        const clientToken: ClientToken = await new Ajax().post({\n            url: url,\n            data: data,\n            headers: {\n                'Content-Type': 'application/json', 'Accept': 'application/json',\n                'Authorization': 'Bearer ' + refreshToken\n            }\n        })\n\n        Client.refreshCount++;\n        this.storage.set(Client._refreshCount, Client.refreshCount);\n\n        return clientToken;\n    }\n\n    public logout(refreshToken?: string): Promise<void | ErrorInterface> {\n\n        if (!this.URI) {\n            console.error('no api uri');\n            return Promise.reject({code: 408, reason: 'no-api-uri'});\n        }\n\n        // delete this.clientUuid;\n        // delete this.clientId;\n        // this.storage.remove(Client._clientUuid);\n        this.storage.remove(Client._clientId);\n        this.storage.remove(Client._refreshCount);\n        Client.refreshCount = Client.refreshCountInitial;\n\n        if (!refreshToken || !this.clientId) {\n            return Promise.resolve();\n        }\n\n        const url = this.URI + '/apps/' + this.appId + '/tokens';\n\n        return new Ajax()\n            .delete({\n                url: url,\n                headers: {\n                    'Content-Type': 'application/json', 'Accept': 'application/json',\n                    'Authorization': 'Bearer ' + refreshToken\n                }\n            });\n    }\n\n    public isReady(): boolean {\n        return !!this.URI;\n    }\n}\n","import {Client} from './client';\nimport {ModuleServiceLoginOptionsInterface, SdkInterface, ErrorInterface, EndpointInterface, LoggerInterface} from '../sdk/interfaces';\nimport {Base64, LocalStorage, Xor} from '../tools';\nimport {Ajax} from './ajax';\nimport {ClientToken, ClientTokens, ClientUser, ConnectionFindOptionsInterface} from './interfaces';\nimport {Error} from '../sdk/error';\n\nexport class Connection {\n\n    public fidjId: string;\n    public fidjVersion: string;\n    public fidjCrypto: boolean;\n    public accessToken: string;\n    public accessTokenPrevious: string;\n    public idToken: string;\n    public refreshToken: string;\n    public states: { [s: string]: { state: boolean, time: number, lastTimeWasOk: number }; }; // Map<string, boolean>;\n    public apis: Array<EndpointInterface>;\n\n    private cryptoSalt: string;\n    private cryptoSaltNext: string;\n    private client: Client;\n    private user: ClientUser;\n\n    private static _accessToken = 'v2.accessToken';\n    private static _accessTokenPrevious = 'v2.accessTokenPrevious';\n    private static _idToken = 'v2.idToken';\n    private static _refreshToken = 'v2.refreshToken';\n    private static _states = 'v2.states';\n    private static _cryptoSalt = 'v2.cryptoSalt';\n    private static _cryptoSaltNext = 'v2.cryptoSalt.next';\n\n    constructor(private _sdk: SdkInterface,\n                private _storage: LocalStorage,\n                private _logger: LoggerInterface) {\n        this.client = null;\n        this.user = null;\n        this.cryptoSalt = this._storage.get(Connection._cryptoSalt) || null;\n        this.cryptoSaltNext = this._storage.get(Connection._cryptoSaltNext) || null;\n        this.accessToken = this._storage.get(Connection._accessToken) || null;\n        this.accessTokenPrevious = this._storage.get('v2.accessTokenPrevious') || null;\n        this.idToken = this._storage.get(Connection._idToken) || null;\n        this.refreshToken = this._storage.get(Connection._refreshToken) || null;\n        this.states = this._storage.get(Connection._states) || {};\n        this.apis = [];\n    };\n\n    isReady(): boolean {\n        return !!this.client && this.client.isReady();\n    }\n\n    async destroy(force?: boolean) {\n\n        this._storage.remove(Connection._accessToken);\n        this._storage.remove(Connection._idToken);\n        this._storage.remove(Connection._refreshToken);\n        this._storage.remove(Connection._states);\n\n        if (this.accessToken) {\n            this.accessTokenPrevious = this.accessToken;\n            this._storage.set(Connection._accessTokenPrevious, this.accessTokenPrevious);\n        }\n\n        if (force) {\n            this._storage.remove(Connection._cryptoSalt);\n            this._storage.remove(Connection._cryptoSaltNext);\n            this._storage.remove(Connection._accessTokenPrevious);\n        }\n\n        this.user = null;\n        if (this.client) {\n            // this.client.setClientId(null);\n            await this.client.logout();\n        }\n        this.accessToken = null;\n        this.idToken = null;\n        this.refreshToken = null;\n        this.states = {}; // new Map<string, boolean>();\n    }\n\n    setClient(client: Client): void {\n\n        this.client = client;\n        //if (!this.user) {\n        //    this.user = new ClientUser();\n        //}\n\n        // this._user._id = this._client.clientId;\n        //this.user._name = JSON.parse(this.getIdPayload({name: ''})).name;\n    }\n\n    setUser(user: ClientUser): void {\n        this.user = user;\n        if (this.client && this.user.id) {\n            this.client.setClientId(this.user.id);\n\n            // store only clientId\n            // delete this.user._id;\n        }\n    }\n\n    getUser(): ClientUser {\n        return this.user;\n    }\n\n    getClient(): Client {\n        return this.client;\n    }\n\n    setCryptoSalt(value: string) {\n        if (this.cryptoSalt !== value && this.cryptoSaltNext !== value) {\n            this.cryptoSaltNext = value;\n            this._storage.set(Connection._cryptoSaltNext, this.cryptoSaltNext);\n        }\n\n        if (!this.cryptoSalt) {\n            this.setCryptoSaltAsVerified();\n        }\n    }\n\n    setCryptoSaltAsVerified() {\n        if (this.cryptoSaltNext) {\n            this.cryptoSalt = this.cryptoSaltNext;\n            this._storage.set(Connection._cryptoSalt, this.cryptoSalt);\n        }\n        this.cryptoSaltNext = null;\n        this._storage.remove(Connection._cryptoSaltNext);\n    }\n\n    encrypt(data: any): string {\n\n        if (typeof data !== 'string') {\n            data = JSON.stringify(data);\n        } else {\n            const dataAsObj = {string: data};\n            data = JSON.stringify(dataAsObj);\n        }\n\n        if (this.fidjCrypto && this.cryptoSalt) {\n            const key = this.cryptoSalt;\n            return Xor.encrypt(data, key);\n        } else {\n            return data;\n        }\n    }\n\n    decrypt(data: string): any {\n        let decrypted = null;\n\n        try {\n            if (this.fidjCrypto && this.cryptoSaltNext) {\n                const key = this.cryptoSaltNext;\n                decrypted = Xor.decrypt(data, key);\n                decrypted = JSON.parse(decrypted);\n                // if (decrypted) {\n                //    this.setCryptoSaltAsVerified();\n                // }\n            }\n        } catch (err) {\n            decrypted = null;\n        }\n\n        try {\n            if (!decrypted && this.fidjCrypto && this.cryptoSalt) {\n                const key = this.cryptoSalt;\n                decrypted = Xor.decrypt(data, key);\n                decrypted = JSON.parse(decrypted);\n            }\n        } catch (err) {\n            decrypted = null;\n        }\n\n        try {\n            if (!decrypted && this.fidjCrypto && this.cryptoSalt) {\n                const key = this.cryptoSalt;\n                decrypted = Xor.decrypt(data, key, true);\n                decrypted = JSON.parse(decrypted);\n            }\n        } catch (err) {\n            decrypted = null;\n        }\n\n\n        try {\n\n            if (!decrypted) {\n                decrypted = JSON.parse(data);\n            }\n\n            if (decrypted && decrypted.string) {\n                decrypted = decrypted.string;\n            }\n\n        } catch (err) {\n            decrypted = null;\n        }\n\n        return decrypted;\n    }\n\n    isLogin(): boolean {\n        let exp = true;\n        try {\n            const payload = this.refreshToken.split('.')[1];\n            const decoded = JSON.parse(Base64.decode(payload));\n            exp = ((new Date().getTime() / 1000) >= decoded.exp);\n\n        } catch (e) {\n        }\n        return !exp;\n    }\n\n    // todo reintegrate client.login()\n\n    async logout(): Promise<void | ErrorInterface> {\n        return this.getClient().logout(this.refreshToken);\n    }\n\n    getClientId(): string {\n        if (!this.client) {\n            return null;\n        }\n        return this.client.clientId;\n    }\n\n    async getIdToken() {\n        return this.idToken;\n    }\n\n    async getIdPayload(def?: any) {\n\n        const idToken = await this.getIdToken();\n\n        try {\n            let payload;\n            if (idToken) {\n                payload = idToken.split('.')[1];\n            }\n            if (payload) {\n                return Base64.decode(payload);\n            }\n        } catch (e) {\n            this._logger.log('fidj.connection.getIdPayload pb: ', def, e);\n        }\n\n        if (def) {\n            if (typeof def !== 'string') {\n                def = JSON.stringify(def);\n            }\n            return def;\n        }\n\n        return null;\n    }\n\n    async getAccessPayload(def?: any): Promise<string> {\n        if (def && typeof def !== 'string') {\n            def = JSON.stringify(def);\n        }\n\n        try {\n            const payload = this.accessToken.split('.')[1];\n            if (payload) {\n                return Base64.decode(payload);\n            }\n        } catch (e) {\n        }\n        return def ? def : null;\n    }\n\n    getPreviousAccessPayload(def?: any): string {\n        if (def && typeof def !== 'string') {\n            def = JSON.stringify(def);\n        }\n\n        try {\n            const payload = this.accessTokenPrevious.split('.')[1];\n            if (payload) {\n                return Base64.decode(payload);\n            }\n        } catch (e) {\n        }\n        return def ? def : null;\n    }\n\n    /**\n     * @throws ErrorInterface\n     */\n    async refreshConnection(): Promise<ClientUser> {\n\n        // store states\n        this._storage.set(Connection._states, this.states);\n\n        // token not expired : ok\n        if (this.accessToken) {\n            const payload = this.accessToken.split('.')[1];\n            const decoded = Base64.decode(payload);\n            const notExpired = (new Date().getTime() / 1000) < JSON.parse(decoded).exp;\n            // console.log('new Date().getTime() < JSON.parse(decoded).exp :', (new Date().getTime() / 1000), JSON.parse(decoded).exp);\n            this._logger.log('fidj.connection.connection.refreshConnection : token not expired ? ', notExpired);\n            if (notExpired) {\n                return Promise.resolve(this.getUser());\n            }\n        }\n\n        // remove expired refreshToken\n        if (this.refreshToken) {\n            const payload = this.refreshToken.split('.')[1];\n            const decoded = Base64.decode(payload);\n            const expired = (new Date().getTime() / 1000) >= JSON.parse(decoded).exp;\n            this._logger.log('fidj.connection.connection.refreshConnection : refreshToken not expired ? ', expired);\n            if (expired) {\n                this._storage.remove(Connection._refreshToken);\n            }\n        }\n\n        // remove expired accessToken & idToken & store it as Previous one\n        this.accessTokenPrevious = this.accessToken;\n        this._storage.set('v2.accessTokenPrevious', this.accessTokenPrevious);\n        this._storage.remove(Connection._accessToken);\n        this._storage.remove(Connection._idToken);\n        this.accessToken = null;\n        this.idToken = null;\n\n        // refresh authentication\n        this._logger.log('fidj.connection.connection.refreshConnection : refresh authentication.');\n        const client = this.getClient();\n        if (!client) {\n            throw new Error(400, 'Need an initialized client.');\n        }\n\n        const refreshToken: ClientToken = await this.getClient().reAuthenticate(this.refreshToken);\n\n        const previousIdToken = new ClientToken(this.getClientId(), 'idToken', this.idToken);\n        const previousAccessToken = new ClientToken(this.getClientId(), 'accessToken', this.accessToken);\n        const clientTokens = new ClientTokens(this.getClientId(), previousIdToken, previousAccessToken, refreshToken);\n        await this.setConnection(clientTokens);\n        return this.getUser();\n    };\n\n    async setConnection(clientTokens: ClientTokens) {\n\n        // only in private storage\n        if (clientTokens.accessToken) {\n            this.accessToken = clientTokens.accessToken.data;\n            this._storage.set(Connection._accessToken, this.accessToken);\n\n            const salt: string = JSON.parse(await this.getAccessPayload({salt: ''})).salt;\n            if (salt) {\n                this.setCryptoSalt(salt);\n            }\n        }\n        if (clientTokens.idToken) {\n            this.idToken = clientTokens.idToken.data;\n            this._storage.set(Connection._idToken, this.idToken);\n        }\n        if (clientTokens.refreshToken) {\n            this.refreshToken = clientTokens.refreshToken.data;\n            this._storage.set(Connection._refreshToken, this.refreshToken);\n        }\n\n        // store changed states\n        this._storage.set(Connection._states, this.states);\n\n        // expose roles, message\n        const clientUser = new ClientUser(\n            clientTokens.username, clientTokens.username,\n            JSON.parse(await this.getIdPayload({roles: []})).roles,\n            JSON.parse(await this.getIdPayload({message: ''})).message);\n        this.setUser(clientUser);\n    };\n\n    async setConnectionOffline(options: ModuleServiceLoginOptionsInterface) {\n\n        if (options.accessToken) {\n            this.accessToken = options.accessToken;\n            this._storage.set(Connection._accessToken, this.accessToken);\n        }\n        if (options.idToken) {\n            this.idToken = options.idToken;\n            this._storage.set(Connection._idToken, this.idToken);\n        }\n        if (options.refreshToken) {\n            this.refreshToken = options.refreshToken;\n            this._storage.set(Connection._refreshToken, this.refreshToken);\n        }\n\n        this.setUser(new ClientUser('demo', 'demo',\n            JSON.parse(await this.getIdPayload({roles: []})).roles,\n            JSON.parse(await this.getIdPayload({message: ''})).message));\n    }\n\n    async getApiEndpoints(options?: ConnectionFindOptionsInterface): Promise<Array<EndpointInterface>> {\n\n        // todo : let ea = ['https://fidj/v3', 'https://fidj-proxy.herokuapp.com/v3'];\n        let ea: EndpointInterface[] = [\n            {key: 'fidj.default', url: 'https://api.fidj.ovh/v3', blocked: false}];\n        let filteredEa = [];\n\n        if (!this._sdk.prod) {\n            ea = [\n                {key: 'fidj.default', url: 'http://localhost:3201/v3', blocked: false},\n                {key: 'fidj.default', url: 'https://fidj-sandbox.herokuapp.com/v3', blocked: false}\n            ];\n        }\n\n        if (this.accessToken) {\n            const val = await this.getAccessPayload({apis: []});\n            const apiEndpoints: EndpointInterface[] = JSON.parse(val).apis;\n            if (apiEndpoints && apiEndpoints.length) {\n                ea = [];\n                apiEndpoints.forEach((endpoint) => {\n                    if (endpoint.url) {\n                        ea.push(endpoint);\n                    }\n                });\n            }\n        }\n\n        if (this.accessTokenPrevious) {\n            const apiEndpoints: EndpointInterface[] = JSON.parse(this.getPreviousAccessPayload({apis: []})).apis;\n            if (apiEndpoints && apiEndpoints.length) {\n                apiEndpoints.forEach((endpoint) => {\n                    if (endpoint.url && ea.filter((r) => r.url === endpoint.url).length === 0) {\n                        ea.push(endpoint);\n                    }\n                });\n            }\n        }\n\n        this._logger.log('fidj.sdk.connection.getApiEndpoints : ', ea);\n\n        let couldCheckStates = true;\n        if (this.states && Object.keys(this.states).length) {\n            for (let i = 0; (i < ea.length) && couldCheckStates; i++) {\n                if (!this.states[ea[i].url]) {\n                    couldCheckStates = false;\n                }\n            }\n        } else {\n            couldCheckStates = false;\n        }\n\n        if (options && options.filter) {\n            if (couldCheckStates && options.filter === 'theBestOne') {\n                for (let i = 0; (i < ea.length) && (filteredEa.length === 0); i++) {\n                    const endpoint = ea[i];\n                    if (this.states[endpoint.url] &&\n                        this.states[endpoint.url].state) {\n                        filteredEa.push(endpoint);\n                    }\n                }\n            } else if (couldCheckStates && options.filter === 'theBestOldOne') {\n                let bestOldOne: EndpointInterface;\n                for (let i = 0; (i < ea.length); i++) {\n                    const endpoint = ea[i];\n                    if (this.states[endpoint.url] &&\n                        this.states[endpoint.url].lastTimeWasOk &&\n                        (!bestOldOne || this.states[endpoint.url].lastTimeWasOk > this.states[bestOldOne.url].lastTimeWasOk)) {\n\n                        bestOldOne = endpoint;\n                    }\n                }\n                if (bestOldOne) {\n                    filteredEa.push(bestOldOne);\n                }\n            } else if (ea.length) {\n                filteredEa.push(ea[0]);\n            }\n        } else {\n            filteredEa = ea;\n        }\n\n        return filteredEa;\n    };\n\n    async getDBs(options?: ConnectionFindOptionsInterface): Promise<EndpointInterface[]> {\n\n        if (!this.accessToken) {\n            return [];\n        }\n\n        // todo test random DB connection\n        const random = Math.random() % 2;\n        let dbs = JSON.parse(await this.getAccessPayload({dbs: []})).dbs || [];\n\n        // need to synchronize db\n        if (random === 0) {\n            dbs = dbs.sort();\n        } else if (random === 1) {\n            dbs = dbs.reverse();\n        }\n\n        let filteredDBs = [];\n        let couldCheckStates = true;\n        if (this.states && Object.keys(this.states).length) {\n            for (let i = 0; (i < dbs.length) && couldCheckStates; i++) {\n                if (!this.states[dbs[i].url]) {\n                    couldCheckStates = false;\n                }\n            }\n        } else {\n            couldCheckStates = false;\n        }\n\n        if (couldCheckStates && options && options.filter === 'theBestOne') {\n            for (let i = 0; (i < dbs.length) && (filteredDBs.length === 0); i++) {\n                const endpoint = dbs[i];\n                if (this.states[endpoint.url] &&\n                    this.states[endpoint.url].state) {\n                    filteredDBs.push(endpoint);\n                }\n            }\n        } else if (couldCheckStates && options && options.filter === 'theBestOnes') {\n            for (let i = 0; (i < dbs.length); i++) {\n                const endpoint = dbs[i];\n                if (this.states[endpoint.url] &&\n                    this.states[endpoint.url].state) {\n                    filteredDBs.push(endpoint);\n                }\n            }\n        } else if (options && options.filter === 'theBestOne' && dbs.length) {\n            filteredDBs.push(dbs[0]);\n        } else {\n            filteredDBs = dbs;\n        }\n\n        return filteredDBs;\n    };\n\n    private async verifyApiState(currentTime: number, endpointUrl: string) {\n\n        try {\n\n            this._logger.log('fidj.sdk.connection.verifyApiState : ', currentTime, endpointUrl);\n\n            const data = await new Ajax()\n                .get({\n                    url: endpointUrl + '/status?isOk=' + this._sdk.version,\n                    headers: {'Content-Type': 'application/json', 'Accept': 'application/json'}\n                });\n\n            let state = false;\n            if (data && data.isOk) {\n                state = true;\n            }\n            this.states[endpointUrl] = {state: state, time: currentTime, lastTimeWasOk: currentTime};\n\n            this._logger.log('fidj.sdk.connection.verifyApiState > states : ', this.states);\n\n        } catch (err) {\n            let lastTimeWasOk = 0;\n            if (this.states[endpointUrl]) {\n                lastTimeWasOk = this.states[endpointUrl].lastTimeWasOk;\n            }\n            this.states[endpointUrl] = {state: false, time: currentTime, lastTimeWasOk: lastTimeWasOk};\n\n            this._logger.log('fidj.sdk.connection.verifyApiState > catch pb  - states : ', err, this.states);\n        }\n    }\n\n    private async verifyDbState(currentTime: number, dbEndpoint: string) {\n\n        try {\n            // console.log('verifyDbState: ', dbEndpoint);\n            await new Ajax()\n                .get({\n                    url: dbEndpoint,\n                    headers: {'Content-Type': 'application/json', 'Accept': 'application/json'}\n                });\n\n            this.states[dbEndpoint] = {state: true, time: currentTime, lastTimeWasOk: currentTime};\n            // resolve();\n            // console.log('verifyDbState: state', dbEndpoint, true);\n\n        } catch (err) {\n            let lastTimeWasOk = 0;\n            if (this.states[dbEndpoint]) {\n                lastTimeWasOk = this.states[dbEndpoint].lastTimeWasOk;\n            }\n            this.states[dbEndpoint] = {state: false, time: currentTime, lastTimeWasOk: lastTimeWasOk};\n            // resolve();\n        }\n    }\n\n    async verifyConnectionStates(): Promise<any | ErrorInterface> {\n\n        const currentTime = new Date().getTime();\n\n        // todo need verification ? not yet (cache)\n        // if (Object.keys(this.states).length > 0) {\n        //     const time = this.states[Object.keys(this.states)[0]].time;\n        //     if (currentTime < time) {\n        //         return Promise.resolve();\n        //     }\n        // }\n\n        // verify via GET status on Endpoints & DBs\n        const promises = [];\n        // this.states = {};\n        this.apis = await this.getApiEndpoints();\n        this.apis.forEach((endpointObj) => {\n            let endpointUrl: string = endpointObj.url;\n            if (!endpointUrl) {\n                endpointUrl = endpointObj.toString();\n            }\n            promises.push(this.verifyApiState(currentTime, endpointUrl));\n        });\n\n        const dbs = await this.getDBs();\n        dbs.forEach((dbEndpointObj) => {\n            let dbEndpoint: string = dbEndpointObj.url;\n            if (!dbEndpoint) {\n                dbEndpoint = dbEndpointObj.toString();\n            }\n            promises.push(this.verifyDbState(currentTime, dbEndpoint));\n        });\n        return Promise.all(promises);\n    };\n\n}\n","// import PouchDB from 'pouchdb';\n// let PouchDB: any;\n\nimport PouchDB from 'pouchdb/dist/pouchdb.js';\nimport {Error} from '../sdk/error';\nimport {EndpointInterface, ErrorInterface} from '../sdk/interfaces';\n\nlet FidjPouch;\n\nif (typeof window !== 'undefined') {\n    FidjPouch = (window['PouchDB']) ? window['PouchDB'] : require('pouchdb').default; // .default;\n    // load cordova adapter : https://github.com/pouchdb-community/pouchdb-adapter-cordova-sqlite/issues/22\n    const PouchAdapterCordovaSqlite = require('pouchdb-adapter-cordova-sqlite');\n    FidjPouch.plugin(PouchAdapterCordovaSqlite);\n}\n\nexport interface SessionCryptoInterface {\n    obj: Object,\n    method: string\n}\n\nexport class Session {\n\n    public dbRecordCount: number;\n    public dbLastSync: number; // Date().getTime();\n\n    private db: PouchDB; // PouchDB\n    private remoteDb: PouchDB; // PouchDB;\n    private remoteUri: string;\n    private dbs: Array<EndpointInterface>;\n\n    constructor() {\n        this.db = null;\n        this.dbRecordCount = 0;\n        this.dbLastSync = null;\n        this.remoteDb = null;\n        this.dbs = [];\n    };\n\n    public isReady(): boolean {\n        return !!this.db;\n    }\n\n    public create(uid: string, force?: boolean): Promise<any | ErrorInterface> {\n\n        if (!force && this.db) {\n            return Promise.resolve(this.db);\n        }\n\n        this.dbRecordCount = 0;\n        this.dbLastSync = null; // new Date().getTime();\n        this.db = null;\n        uid = uid || 'default';\n\n        if (typeof window === 'undefined') {\n            return Promise.resolve(this.db);\n        }\n\n        return new Promise((resolve, reject) => {\n\n            let opts: any = {location: 'default'};\n            try {\n                if (window['cordova']) {\n                    opts = {location: 'default', adapter: 'cordova-sqlite'};\n                    //    const plugin = require('pouchdb-adapter-cordova-sqlite');\n                    //    if (plugin) { Pouch.plugin(plugin); }\n                    //    this.db = new Pouch('fidj_db', {adapter: 'cordova-sqlite'});\n                }\n                // } else {\n                this.db = new FidjPouch('fidj_db_' + uid, opts); // , {adapter: 'websql'} ???\n                // }\n\n                this.db.info()\n                    .then((info) => {\n\n                        // todo if (info.adapter !== 'websql') {\n                        return resolve(this.db);\n                        // }\n\n                        // const newopts: any = opts || {};\n                        // newopts.adapter = 'idb';\n                        //\n                        // const newdb = new Pouch('fidj_db', opts);\n                        // this.db.replicate.to(newdb)\n                        //     .then(() => {\n                        //         this.db = newdb;\n                        //         resolve();\n                        //     })\n                        //     .catch((err) => {\n                        //         reject(new Error(400, err.toString()))\n                        //     });\n\n                    }).catch((err) => {\n                    reject(new Error(400, err));\n                });\n            } catch (err) {\n                reject(new Error(500, err));\n            }\n        });\n    }\n\n    public async destroy(): Promise<void> {\n\n        if (!this.db) {\n            this.dbRecordCount = 0;\n            this.dbLastSync = null;\n            return;\n        }\n\n        if (this.db && !this.db.destroy) {\n            return Promise.reject(new Error(408, 'Need a valid db'));\n        }\n\n        return new Promise((resolve, reject) => {\n            this.db.destroy((err, info) => {\n                if (err) {\n                    reject(new Error(500, err));\n                } else {\n                    this.dbRecordCount = 0;\n                    this.dbLastSync = null;\n                    this.db = null;\n                    resolve();\n                }\n            });\n        });\n    };\n\n    public setRemote(dbs: Array<EndpointInterface>): void {\n        this.dbs = dbs;\n    }\n\n    public sync(userId: string): Promise<void | ErrorInterface> {\n\n        if (!this.db) {\n            return Promise.reject(new Error(408, 'need db'));\n        }\n        if (!this.dbs || !this.dbs.length) {\n            return Promise.reject(new Error(408, 'need a remote db'));\n        }\n\n        return new Promise((resolve, reject) => {\n            try {\n\n                if (!this.remoteDb || this.remoteUri !== this.dbs[0].url) {\n                    this.remoteUri = this.dbs[0].url;\n                    this.remoteDb = new FidjPouch(this.remoteUri);\n                    // todo , {headers: {'Authorization': 'Bearer ' + id_token}});\n                }\n\n                this.db.replicate.to(this.remoteDb)\n                    .on('complete', (info) => {\n                        return this.remoteDb.replicate.to(this.db,\n                            {\n                                filter: (doc) => {\n                                    return (!!userId && !!doc && doc.fidjUserId === userId);\n                                }\n                            })\n                            .on('complete', () => {\n                                // this.logger\n                                resolve();\n                            })\n                            .on('denied', (err) => reject({code: 403, reason: {second: err}}))\n                            .on('error', (err) => reject({code: 401, reason: {second: err}}));\n\n                    })\n                    .on('denied', (err) => reject({code: 403, reason: {first: err}}))\n                    .on('error', (err) => reject({code: 401, reason: {first: err}}));\n\n            } catch (err) {\n                reject(new Error(500, err));\n            }\n        });\n    }\n\n    public put(data: any,\n               _id: string,\n               uid: string,\n               oid: string,\n               ave: string,\n               crypto?: SessionCryptoInterface): Promise<any | ErrorInterface> {\n\n        if (!this.db) {\n            return Promise.reject(new Error(408, 'need db'));\n        }\n\n        if (!data || !_id || !uid || !oid || !ave) {\n            return Promise.reject(new Error(400, 'need formated data'));\n        }\n\n        const dataWithoutIds = JSON.parse(JSON.stringify(data));\n        const toStore: any = {\n            _id: _id,\n            fidjUserId: uid,\n            fidjOrgId: oid,\n            fidjAppVersion: ave\n        };\n        if (dataWithoutIds._rev) {\n            toStore._rev = '' + dataWithoutIds._rev;\n        }\n        delete dataWithoutIds._id;\n        delete dataWithoutIds._rev;\n        delete dataWithoutIds.fidjUserId;\n        delete dataWithoutIds.fidjOrgId;\n        delete dataWithoutIds.fidjAppVersion;\n        delete dataWithoutIds.fidjData;\n\n        let resultAsString = Session.write(Session.value(dataWithoutIds));\n        if (crypto) {\n            resultAsString = crypto.obj[crypto.method](resultAsString);\n            toStore.fidjDacr = resultAsString;\n        } else {\n            toStore.fidjData = resultAsString;\n        }\n\n        return new Promise((resolve, reject) => {\n            this.db.put(toStore, (err, response) => {\n                if (response && response.ok && response.id && response.rev) {\n                    this.dbRecordCount++;\n\n                    // propagate _rev & _id\n                    if (typeof data === 'object') {\n                        (data as any)._rev = response.rev;\n                        (data as any)._id = response.id;\n                        resolve(data);\n                    } else {\n                        resolve(response.id);\n                    }\n\n                } else {\n                    reject(new Error(500, err));\n                }\n            });\n        });\n    }\n\n    public remove(data_id: string): Promise<void | ErrorInterface> {\n\n        if (!this.db) {\n            return Promise.reject(new Error(408, 'need db'));\n        }\n\n        return new Promise((resolve, reject) => {\n            this.db.get(data_id)\n                .then((doc) => {\n                    doc._deleted = true;\n                    return this.db.put(doc);\n                })\n                .then((result) => {\n                    resolve();\n                })\n                .catch((err) => {\n                    reject(err);\n                });\n        });\n    }\n\n    public get(data_id: string, crypto?: SessionCryptoInterface): Promise<any | ErrorInterface> {\n\n        if (!this.db) {\n            return Promise.reject(new Error(408, 'Need db'));\n        }\n\n        return new Promise((resolve, reject) => {\n            this.db.get(data_id)\n                .then(row => {\n                    if (!!row && (!!row.fidjDacr || !!row.fidjData)) {\n                        let data = row.fidjDacr;\n                        if (crypto && data) {\n                            data = crypto.obj[crypto.method](data);\n                        } else if (row.fidjData) {\n                            data = JSON.parse(row.fidjData);\n                        }\n                        const resultAsJson = Session.extractJson(data);\n                        if (resultAsJson) {\n                            resultAsJson._id = row._id;\n                            resultAsJson._rev = row._rev;\n                            resolve(JSON.parse(JSON.stringify(resultAsJson)));\n                        } else {\n                            // row._deleted = true;\n                            this.remove(row._id);\n                            reject(new Error(400, 'Bad encoding'));\n                        }\n                    } else {\n                        reject(new Error(400, 'No data found'));\n                    }\n                })\n                .catch(err => reject(new Error(500, err)));\n        });\n    }\n\n    public getAll(crypto?: SessionCryptoInterface): Promise<Array<any> | ErrorInterface> {\n\n        if (!this.db || !(this.db as any).allDocs) {\n            return Promise.reject(new Error(408, 'Need a valid db'));\n        }\n\n        return new Promise((resolve, reject) => {\n            (this.db as any).allDocs({include_docs: true, descending: true})\n                .then(rows => {\n                    const all = [];\n                    rows.rows.forEach(row => {\n                        if (!!row && !!row.doc._id && (!!row.doc.fidjDacr || !!row.doc.fidjData)) {\n                            let data = row.doc.fidjDacr;\n                            if (crypto && data) {\n                                data = crypto.obj[crypto.method](data);\n                            } else if (row.doc.fidjData) {\n                                data = JSON.parse(row.doc.fidjData);\n                            }\n                            const resultAsJson = Session.extractJson(data);\n                            if (resultAsJson) {\n                                resultAsJson._id = row.doc._id;\n                                resultAsJson._rev = row.doc._rev;\n                                all.push(JSON.parse(JSON.stringify(resultAsJson)));\n                            } else {\n                                console.error('Bad encoding : delete row');\n                                // resultAsJson = {};\n                                // resultAsJson._id = row.doc._id;\n                                // resultAsJson._rev = row.doc._rev;\n                                // resultAsJson._deleted = true;\n                                // all.push(resultAsJson);\n                                this.remove(row.doc._id);\n                            }\n                        } else {\n                            console.error('Bad encoding');\n                        }\n                    });\n                    resolve(all);\n                })\n                .catch(err => reject(new Error(400, err)));\n        });\n    }\n\n    public isEmpty(): Promise<boolean | ErrorInterface> {\n\n        if (!this.db || !(this.db as any).allDocs) {\n            return Promise.reject(new Error(408, 'No db'));\n        }\n\n        return new Promise((resolve, reject) => {\n            (this.db as any).allDocs({\n                // filter:  (doc) => {\n                //    if (!self.connection.user || !self.connection.user._id) return doc;\n                //    if (doc.fidjUserId === self.connection.user._id) return doc;\n                // }\n            })\n                .then((response) => {\n                    if (!response) {\n                        reject(new Error(400, 'No response'));\n                    } else {\n                        this.dbRecordCount = response.total_rows;\n                        if (response.total_rows && response.total_rows > 0) {\n                            resolve(false);\n                        } else {\n                            resolve(true);\n                        }\n                    }\n                })\n                .catch((err) => reject(new Error(400, err)));\n        });\n    }\n\n    public info(): Promise<any> {\n        if (!this.db) {\n            return Promise.reject(new Error(408, 'No db'));\n        }\n        return this.db.info();\n    }\n\n    static write(item: any): string {\n        let value = 'null';\n        const t = typeof (item);\n        if (t === 'undefined') {\n            value = 'null';\n        } else if (value === null) {\n            value = 'null';\n        } else if (t === 'string') {\n            value = JSON.stringify({string: item})\n        } else if (t === 'number') {\n            value = JSON.stringify({number: item});\n        } else if (t === 'boolean') {\n            value = JSON.stringify({bool: item});\n        } else if (t === 'object') {\n            value = JSON.stringify({json: item});\n        }\n        return value;\n    }\n\n    static value(item: any): any {\n        let result = item;\n        if (typeof (item) !== 'object') {\n            // return item;\n        } else if ('string' in item) {\n            result = item.string;\n        } else if ('number' in item) {\n            result = item.number.valueOf();\n        } else if ('bool' in item) {\n            result = item.bool.valueOf();\n        } else if ('json' in item) {\n            result = item.json;\n            if (typeof (result) !== 'object') {\n                result = JSON.parse(result);\n            }\n        }\n        return result;\n    }\n\n    static extractJson(item: any): any {\n        let result = item;\n        if (!item) {\n            return null;\n        }\n        if (typeof (item) === 'object' && 'json' in item) {\n            result = item.json;\n        }\n        if (typeof (result) === 'string') {\n            result = JSON.parse(result);\n        }\n        if (typeof (result) === 'object' && 'json' in result) {\n            result = (result as any).json;\n        }\n        if (typeof result !== 'object') {\n            result = null;\n        }\n        return result;\n    }\n\n}\n","import {\n    LoggerInterface, LoggerLevelEnum\n} from './interfaces';\n\nexport class LoggerService implements LoggerInterface {\n\n    constructor(private level?: LoggerLevelEnum) {\n        if (!level) {\n            this.level = LoggerLevelEnum.ERROR;\n        }\n\n        if (typeof console === 'undefined') {\n            this.level = LoggerLevelEnum.NONE;\n        }\n    }\n\n    log(message: string, args: [any]) {\n        if (this.level === LoggerLevelEnum.INFO) {\n            console.log(message, args);\n        }\n    }\n\n    warn(message: string, args: [any]) {\n        if (this.level === LoggerLevelEnum.INFO || this.level === LoggerLevelEnum.WARN) {\n            console.warn(message, args);\n        }\n    }\n\n    error(message: string, args: [any]) {\n        if (this.level === LoggerLevelEnum.INFO || this.level === LoggerLevelEnum.WARN || this.level === LoggerLevelEnum.ERROR) {\n            console.error(message, args);\n        }\n    }\n\n    setLevel(level: LoggerLevelEnum) {\n        this.level = level;\n    }\n}\n\n","// import PouchDB from 'pouchdb';\n// import * as PouchDB from 'pouchdb/dist/pouchdb.js';\n// import PouchDB from 'pouchdb/dist/pouchdb.js';\nimport * as version from '../version';\nimport * as tools from '../tools';\nimport * as connection from '../connection';\nimport * as session from '../session';\nimport {\n    LoggerInterface,\n    ModuleServiceInitOptionsInterface,\n    ModuleServiceLoginOptionsInterface,\n    SdkInterface,\n    ErrorInterface, EndpointInterface, EndpointFilterInterface, LoggerLevelEnum, EndpointCallInterface\n} from './interfaces';\nimport {SessionCryptoInterface} from '../session/session';\nimport {Error} from './error';\nimport {Ajax} from '../connection/ajax';\nimport {LoggerService} from './logger.service';\nimport {ClientTokens, ClientUser} from '../connection';\n\nconst urljoin = require('url-join');\n// import {LocalStorage} from 'node-localstorage';\n// import 'localstorage-polyfill/localStorage';\n\n// const PouchDB = window['PouchDB'] || require('pouchdb').default;\n\n/**\n * please use its angular.js or angular.io wrapper\n * usefull only for fidj dev team\n */\nexport class InternalService {\n\n    private sdk: SdkInterface;\n    private logger: LoggerInterface;\n    private promise: PromiseConstructor;\n    private storage: tools.LocalStorage;\n    private session: session.Session;\n    private connection: connection.Connection;\n\n    constructor(logger: LoggerInterface, promise: PromiseConstructor, options?: ModuleServiceInitOptionsInterface) {\n\n        this.sdk = {\n            org: 'fidj',\n            version: version.version,\n            prod: false,\n            useDB: true\n        };\n        if (promise) {\n            this.promise = promise;\n        }\n        if (logger) {\n            this.logger = logger;\n        } else {\n            this.logger = new LoggerService();\n        }\n        if (options && options.logLevel) {\n            this.logger.setLevel(options.logLevel);\n        }\n\n        this.logger.log('fidj.sdk.service : constructor');\n        let ls;\n        if (typeof window !== 'undefined') {\n            ls = window.localStorage;\n        } else if (typeof global !== 'undefined') {\n            require('localstorage-polyfill');\n            ls = global['localStorage'];\n        }\n        this.storage = new tools.LocalStorage(ls, 'fidj.');\n        this.session = new session.Session();\n        this.connection = new connection.Connection(this.sdk, this.storage, this.logger);\n    }\n\n    /**\n     * Init connection & session\n     * Check uri\n     * Done each app start\n     *\n     * @param fidjId\n     * @param options Optional settings\n     * @param options.fidjId  required use your customized endpoints\n     * @param options.fidjSalt required use your customized endpoints\n     * @param options.fidjVersion required use your customized endpoints\n     * @param options.devMode optional default false, use your customized endpoints\n     * @returns\n     * @throws {ErrorInterface}\n     */\n    public async fidjInit(fidjId: string, options?: ModuleServiceInitOptionsInterface): Promise<void> {\n\n        /*if (options && options.forcedEndpoint) {\n            this.fidjService.setAuthEndpoint(options.forcedEndpoint);\n        }\n        if (options && options.forcedDBEndpoint) {\n            this.fidjService.setDBEndpoint(options.forcedDBEndpoint);\n        }*/\n        if (options && options.logLevel) {\n            this.logger.setLevel(options.logLevel);\n        } else {\n            this.logger.setLevel(LoggerLevelEnum.NONE);\n        }\n\n        this.logger.log('fidj.sdk.service.fidjInit : ', options);\n        if (!fidjId) {\n            this.logger.error('fidj.sdk.service.fidjInit : bad init');\n            return this.promise.reject(new Error(400, 'Need a fidjId'));\n        }\n\n        this.sdk.prod = !options ? true : options.prod;\n        this.sdk.useDB = !options ? false : options.useDB;\n        this.connection.fidjId = fidjId;\n        this.connection.fidjVersion = this.sdk.version;\n        this.connection.fidjCrypto = (!options || !options.hasOwnProperty('crypto')) ? false : options.crypto;\n\n        let bestUrls, bestOldUrls;\n        try {\n            await this.connection.verifyConnectionStates();\n            bestUrls = await this.connection.getApiEndpoints({filter: 'theBestOne'});\n            bestOldUrls = await this.connection.getApiEndpoints({filter: 'theBestOldOne'});\n        } catch (err) {\n            this.logger.error('fidj.sdk.service.fidjInit: ', err);\n            throw new Error(500, err.toString());\n        }\n\n        if (!bestUrls || !bestOldUrls || (bestUrls.length === 0 && bestOldUrls.length === 0)) {\n            throw new Error(404, 'Need one connection - or too old SDK version (check update)');\n        }\n\n        let theBestFirstUrl = bestUrls[0];\n        let theBestFirstOldUrl = bestOldUrls[0];\n        const isLogin = this.fidjIsLogin();\n        this.logger.log('fidj.sdk.service.fidjInit > verifyConnectionStates : ', theBestFirstUrl, theBestFirstOldUrl, isLogin);\n\n        if (theBestFirstUrl) {\n            this.connection.setClient(new connection.Client(this.connection.fidjId, theBestFirstUrl.url, this.storage, this.sdk));\n        } else {\n            this.connection.setClient(new connection.Client(this.connection.fidjId, theBestFirstOldUrl.url, this.storage, this.sdk));\n        }\n    };\n\n    /**\n     * Call it if fidjIsLogin() === false\n     * Erase all (db & storage)\n     *\n     * @param login\n     * @param password\n     * @throws {ErrorInterface}\n     */\n    public async fidjLogin(login: string, password: string): Promise<ClientUser> {\n        this.logger.log('fidj.sdk.service.fidjLogin');\n        if (!this.connection.isReady()) {\n            throw new Error(404, 'Need an initialized FidjService');\n        }\n\n        try {\n            await this._removeAll();\n            await this.connection.verifyConnectionStates();\n            await this._createSession(this.connection.fidjId);\n            const clientTokens = await this._loginInternal(login, password);\n            await this.connection.setConnection(clientTokens);\n        } catch (err) {\n            throw new Error(500, err.toString());\n        }\n\n        if (!this.sdk.useDB) {\n            return this.connection.getUser();\n        }\n\n        try {\n            await this.session.sync(this.connection.getClientId());\n        } catch (e) {\n            this.logger.warn('fidj.sdk.service.fidjLogin: sync -not blocking- issue  ', e.toString());\n        }\n        return this.connection.getUser();\n    }\n\n    /**\n     *\n     * @param options\n     * @param options.accessToken optional\n     * @param options.idToken  optional\n     * @returns\n     */\n    public async fidjLoginInDemoMode(options?: ModuleServiceLoginOptionsInterface): Promise<any | ErrorInterface> {\n        const self = this;\n\n        // generate one day tokens if not set\n        if (!options || !options.accessToken) {\n            const now = new Date();\n            now.setDate(now.getDate() + 1);\n            const tomorrow = now.getTime();\n            const payload = tools.Base64.encode(JSON.stringify({\n                roles: [],\n                message: 'demo',\n                apis: [],\n                endpoints: [],\n                dbs: [],\n                exp: tomorrow\n            }));\n            const jwtSign = tools.Base64.encode(JSON.stringify({}));\n            const token = jwtSign + '.' + payload + '.' + jwtSign;\n            options = {\n                accessToken: token,\n                idToken: token,\n                refreshToken: token\n            };\n        }\n\n        return new self.promise((resolve, reject) => {\n            self._removeAll()\n                .then(() => {\n                    return self._createSession(self.connection.fidjId);\n                })\n                .then(async () => {\n                    await self.connection.setConnectionOffline(options);\n                    resolve(self.connection.getUser());\n                })\n                .catch((err) => {\n                    self.logger.error('fidj.sdk.service.fidjLoginInDemoMode error: ', err);\n                    reject(err);\n                });\n        });\n    };\n\n    public fidjIsLogin(): boolean {\n        return this.connection.isLogin();\n    };\n\n    public async fidjGetEndpoints(filter?: EndpointFilterInterface): Promise<Array<EndpointInterface>> {\n\n        if (!filter) {\n            filter = {showBlocked: false};\n        }\n        const ap = await this.connection.getAccessPayload({endpoints: []});\n        let endpoints = JSON.parse(ap).endpoints;\n        if (!endpoints || !Array.isArray(endpoints)) {\n            return [];\n        }\n\n        endpoints = endpoints.filter((endpoint: EndpointInterface) => {\n            let ok = true;\n            if (ok && filter.key) {\n                ok = (endpoint.key === filter.key);\n            }\n            if (ok && !filter.showBlocked) {\n                ok = !endpoint.blocked;\n            }\n            return ok;\n        });\n        return endpoints;\n    };\n\n    public async fidjRoles(): Promise<Array<string>> {\n        return JSON.parse(await this.connection.getIdPayload({roles: []})).roles;\n    };\n\n    public async fidjMessage(): Promise<string> {\n        return JSON.parse(await this.connection.getIdPayload({message: ''})).message;\n    };\n\n    public async fidjLogout(force?: boolean): Promise<void | ErrorInterface> {\n        const self = this;\n        if (!self.connection.getClient() && !force) {\n            return self._removeAll()\n                .then(() => {\n                    return this.session.create(self.connection.fidjId, true);\n                });\n        }\n\n        return self.connection.logout()\n            .then(() => {\n                return self._removeAll();\n            })\n            .catch(() => {\n                return self._removeAll();\n            })\n            .then(() => {\n                return this.session.create(self.connection.fidjId, true);\n            });\n    };\n\n    /**\n     * Synchronize DB\n     *\n     *\n     * @param fnInitFirstData a function with db as input and that return promise: call if DB is empty\n     * @param fnInitFirstData_Arg arg to set to fnInitFirstData()\n     * @returns  promise\n     */\n    public async fidjSync(fnInitFirstData?, fnInitFirstData_Arg?): Promise<void | ErrorInterface> {\n        const self = this;\n        self.logger.log('fidj.sdk.service.fidjSync');\n        // if (!self.session.isReady()) {\n        //    return self.promise.reject('fidj.sdk.service.fidjSync : DB sync impossible. Did you login ?');\n        // }\n\n        if (!self.sdk.useDB) {\n            self.logger.log('fidj.sdk.service.fidjSync: you ar not using DB - no sync available.');\n            return Promise.resolve();\n        }\n\n        const firstSync = (self.session.dbLastSync === null);\n\n        return new self.promise((resolve, reject) => {\n\n            self._createSession(self.connection.fidjId)\n                .then(() => {\n                    return self.session.sync(self.connection.getClientId());\n                })\n                .then(() => {\n                    self.logger.log('fidj.sdk.service.fidjSync resolved');\n                    return self.session.isEmpty();\n                })\n                .catch((err) => {\n                    self.logger.warn('fidj.sdk.service.fidjSync warn: ', err);\n                    return self.session.isEmpty();\n                })\n                .then((isEmpty) => {\n                    self.logger.log('fidj.sdk.service.fidjSync isEmpty : ', isEmpty, firstSync);\n\n                    return new self.promise((resolveEmpty, rejectEmptyNotUsed) => {\n                        if (isEmpty && firstSync && fnInitFirstData) {\n                            const ret = fnInitFirstData(fnInitFirstData_Arg);\n                            if (ret && ret['catch'] instanceof Function) {\n                                ret.then(resolveEmpty).catch(reject);\n                            }\n                            if (typeof ret === 'string') {\n                                self.logger.log(ret);\n                            }\n                        }\n                        resolveEmpty(); // self.connection.getUser());\n                    });\n                })\n                .then((info) => {\n                    self.logger.log('fidj.sdk.service.fidjSync fnInitFirstData resolved: ', info);\n                    self.session.dbLastSync = new Date().getTime();\n                    return self.session.info();\n                })\n                .then((result: any) => {\n                    self.session.dbRecordCount = 0;\n                    if (result && result.doc_count) {\n                        self.session.dbRecordCount = result.doc_count;\n                    }\n                    self.logger.log('fidj.sdk.service.fidjSync _dbRecordCount : ' + self.session.dbRecordCount);\n\n                    return self.connection.refreshConnection();\n                })\n                .then((user) => {\n                    self.logger.log('fidj.sdk.service.fidjSync refreshConnection done : ', user);\n                    resolve(); // self.connection.getUser()\n                })\n                .catch((err: ErrorInterface) => {\n                    // console.error(err);\n                    self.logger.warn('fidj.sdk.service.fidjSync refreshConnection failed : ', err);\n\n                    if (err && (err.code === 403 || err.code === 410)) {\n                        this.fidjLogout()\n                            .then(() => {\n                                reject({code: 403, reason: 'Synchronization unauthorized : need to login again.'});\n                            })\n                            .catch(() => {\n                                reject({code: 403, reason: 'Synchronization unauthorized : need to login again..'});\n                            });\n                    } else if (err && err.code) {\n                        // todo what to do with this err ?\n                        resolve();\n                    } else {\n                        const errMessage = 'Error during synchronisation: ' + err.toString();\n                        self.logger.error(errMessage);\n                        reject({code: 500, reason: errMessage});\n                    }\n                })\n            ;\n        });\n    };\n\n    public async fidjPutInDb(data: any): Promise<string | ErrorInterface> {\n        const self = this;\n        self.logger.log('fidj.sdk.service.fidjPutInDb: ', data);\n        if (!self.sdk.useDB) {\n            self.logger.log('fidj.sdk.service.fidjPutInDb: you are not using DB - no put available.');\n            return Promise.resolve('NA');\n        }\n\n        if (!self.connection.getClientId()) {\n            return self.promise.reject(new Error(401, 'DB put impossible. Need a user logged in.'));\n        }\n        if (!self.session.isReady()) {\n            return self.promise.reject(new Error(400, 'Need to be synchronised.'));\n        }\n\n        let _id: string;\n        if (data && typeof data === 'object' && Object.keys(data).indexOf('_id')) {\n            _id = data._id;\n        }\n        if (!_id) {\n            _id = self._generateObjectUniqueId(self.connection.fidjId);\n        }\n        let crypto: SessionCryptoInterface;\n        if (self.connection.fidjCrypto) {\n            crypto = {\n                obj: self.connection,\n                method: 'encrypt'\n            }\n        }\n\n        return self.session.put(\n            data,\n            _id,\n            self.connection.getClientId(),\n            self.sdk.org,\n            self.connection.fidjVersion,\n            crypto);\n    };\n\n    public async fidjRemoveInDb(data_id: string): Promise<void | ErrorInterface> {\n        const self = this;\n        self.logger.log('fidj.sdk.service.fidjRemoveInDb ', data_id);\n        if (!self.sdk.useDB) {\n            self.logger.log('fidj.sdk.service.fidjRemoveInDb: you are not using DB - no remove available.');\n            return Promise.resolve();\n        }\n\n        if (!self.session.isReady()) {\n            return self.promise.reject(new Error(400, 'Need to be synchronised.'));\n        }\n\n        if (!data_id || typeof data_id !== 'string') {\n            return self.promise.reject(new Error(400, 'DB remove impossible. ' +\n                'Need the data._id.'));\n        }\n\n        return self.session.remove(data_id);\n    };\n\n    public async fidjFindInDb(data_id: string): Promise<any | ErrorInterface> {\n        const self = this;\n\n        if (!self.sdk.useDB) {\n            self.logger.log('fidj.sdk.service.fidjFindInDb: you are not using DB - no find available.');\n            return Promise.resolve();\n        }\n\n        if (!self.connection.getClientId()) {\n            return self.promise.reject(new Error(401, 'Find pb : need a user logged in.'));\n        }\n        if (!self.session.isReady()) {\n            return self.promise.reject(new Error(400, ' Need to be synchronised.'));\n        }\n\n        let crypto: SessionCryptoInterface;\n        if (self.connection.fidjCrypto) {\n            crypto = {\n                obj: self.connection,\n                method: 'decrypt'\n            };\n        }\n\n        return self.session.get(data_id, crypto);\n    };\n\n    public async fidjFindAllInDb(): Promise<Array<any> | ErrorInterface> {\n        const self = this;\n\n        if (!self.sdk.useDB) {\n            self.logger.log('fidj.sdk.service.fidjFindAllInDb: you are not using DB - no find available.');\n            return Promise.resolve([]);\n        }\n\n        if (!self.connection.getClientId()) {\n            return self.promise.reject(new Error(401, 'Need a user logged in.'));\n        }\n        if (!self.session.isReady()) {\n            return self.promise.reject(new Error(400, 'Need to be synchronised.'));\n        }\n\n        let crypto: SessionCryptoInterface;\n        if (self.connection.fidjCrypto) {\n            crypto = {\n                obj: self.connection,\n                method: 'decrypt'\n            };\n        }\n\n        return self.session.getAll(crypto)\n            .then(results => {\n                self.connection.setCryptoSaltAsVerified();\n                return self.promise.resolve((results as Array<any>));\n            });\n    };\n\n    public async fidjSendOnEndpoint(input: EndpointCallInterface): Promise<any> {\n        const filter: EndpointFilterInterface = input.key ? {key: input.key} : null;\n        const endpoints = await this.fidjGetEndpoints(filter);\n        if (!endpoints || endpoints.length !== 1) {\n            throw new Error(400, 'fidj.sdk.service.fidjSendOnEndpoint : endpoint does not exist.');\n        }\n\n        let firstEndpointUrl = endpoints[0].url;\n        if (input.relativePath) {\n            firstEndpointUrl = urljoin(firstEndpointUrl, input.relativePath);\n        }\n        const jwt = await this.connection.getIdToken();\n        let answer;\n        const query = new Ajax();\n        switch (input.verb) {\n            case 'POST' :\n                answer = query.post({\n                    url: firstEndpointUrl,\n                    // not used : withCredentials: true,\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Accept': 'application/json',\n                        'Authorization': 'Bearer ' + jwt\n                    },\n                    data: input.data ? input.data : {}\n                });\n                break;\n            case 'PUT' :\n                answer = query.put({\n                    url: firstEndpointUrl,\n                    // not used : withCredentials: true,\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Accept': 'application/json',\n                        'Authorization': 'Bearer ' + jwt\n                    },\n                    data: input.data ? input.data : {}\n                });\n                break;\n            case 'DELETE' :\n                answer = query.delete({\n                    url: firstEndpointUrl,\n                    // not used : withCredentials: true,\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Accept': 'application/json',\n                        'Authorization': 'Bearer ' + jwt\n                    },\n                    // not used: data: data\n                });\n                break;\n            default:\n                answer = query.get({\n                    url: firstEndpointUrl,\n                    // not used : withCredentials: true,\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Accept': 'application/json',\n                        'Authorization': 'Bearer ' + jwt\n                    },\n                    // not used: data: data\n                });\n        }\n        return answer;\n    };\n\n    public async fidjForgotPasswordRequest(email: String) {\n\n        const bestUrls = await this.connection.getApiEndpoints({filter: 'theBestOne'});\n        if (!bestUrls ||bestUrls.length !== 1) {\n            throw new Error(400, 'fidj.sdk.service.fidjForgotPasswordRequest : api endpoint does not exist.');\n        }\n\n        const query = new Ajax();\n        await query.post({\n            url: bestUrls[0].url + '/me/forgot',\n            // not used : withCredentials: true,\n            headers: {\n                'Content-Type': 'application/json',\n                'Accept': 'application/json',\n            },\n            data: {email}\n        });\n    }\n\n    public async fidjGetIdToken() {\n        return this.connection.getIdToken();\n    };\n\n    // Internal functions\n\n    /**\n     * Logout then Login\n     *\n     * @param login\n     * @param password\n     * @param updateProperties\n     * @throws {ErrorInterface}\n     */\n    private async _loginInternal(login: string, password: string, updateProperties?: any): Promise<ClientTokens> {\n        this.logger.log('fidj.sdk.service._loginInternal');\n        if (!this.connection.isReady()) {\n            throw new Error(403, 'Need an initialized FidjService');\n        }\n\n        await this.connection.logout();\n\n        let clientTokens;\n        try {\n            clientTokens = this.connection.getClient().login(login, password, updateProperties);\n        } catch (e) {\n            clientTokens = await this.connection.getClient().login(login, password, updateProperties);\n        }\n        return clientTokens;\n    };\n\n    protected async _removeAll(): Promise<void | ErrorInterface> {\n        await this.connection.destroy();\n        await this.session.destroy();\n    };\n\n    private async _createSession(uid: string): Promise<void | ErrorInterface> {\n        const dbs: EndpointInterface[] = await this.connection.getDBs({filter: 'theBestOnes'});\n        if (!dbs || dbs.length === 0) {\n            this.logger.warn('Seems that you are in Demo mode or using Node (no remote DB).');\n        }\n        this.session.setRemote(dbs);\n        return this.session.create(uid);\n    };\n\n    private async _testPromise(a?): Promise<any> {\n        if (a) {\n            return this.promise.resolve('test promise ok ' + a);\n        }\n        return new this.promise((resolve, reject) => {\n            resolve('test promise ok');\n        });\n    };\n\n    private static _srvDataUniqId = 0;\n\n    private _generateObjectUniqueId(appName, type?, name?) {\n\n        // return null;\n        const now = new Date();\n        const simpleDate = '' + now.getFullYear() + '' + now.getMonth() + '' + now.getDate()\n            + '' + now.getHours() + '' + now.getMinutes(); // new Date().toISOString();\n        const sequId = ++InternalService._srvDataUniqId;\n        let UId = '';\n        if (appName && appName.charAt(0)) {\n            UId += appName.charAt(0) + '';\n        }\n        if (type && type.length > 3) {\n            UId += type.substring(0, 4);\n        }\n        if (name && name.length > 3) {\n            UId += name.substring(0, 4);\n        }\n        UId += simpleDate + '' + sequId;\n        return UId;\n    }\n\n}\n","import {Injectable} from '@angular/core';\nimport {\n    EndpointCallInterface,\n    EndpointInterface,\n    ErrorInterface,\n    LoggerInterface,\n    LoggerLevelEnum,\n    ModuleServiceInitOptionsInterface,\n    ModuleServiceInterface,\n    ModuleServiceLoginOptionsInterface\n} from './interfaces';\nimport {InternalService} from './internal.service';\nimport {Error as FidjError} from '../connection';\nimport {LoggerService} from './logger.service';\n\n/**\n * Angular FidjService\n * @see ModuleServiceInterface\n *\n */\n@Injectable({\n    providedIn: 'root',\n})\nexport class FidjService implements ModuleServiceInterface {\n\n    private logger: LoggerInterface;\n    private fidjService: InternalService;\n    private promise: any;\n\n    constructor() {\n        this.logger = new LoggerService(LoggerLevelEnum.ERROR);\n        this.promise = Promise;\n        this.fidjService = null;\n        // let pouchdbRequired = PouchDB;\n        // pouchdbRequired.error();\n    };\n\n    public async init(fidjId: string, options?: ModuleServiceInitOptionsInterface): Promise<void | ErrorInterface> {\n        if (!this.fidjService) {\n            this.fidjService = new InternalService(this.logger, this.promise);\n        }\n        return this.fidjService.fidjInit(fidjId, options);\n    };\n\n    public async login(login: string, password: string): Promise<any | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(303, 'fidj.sdk.angular.login : not initialized.'));\n        }\n        return this.fidjService.fidjLogin(login, password);\n    };\n\n    public async loginAsDemo(options?: ModuleServiceLoginOptionsInterface): Promise<any | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(303, 'fidj.sdk.angular.loginAsDemo : not initialized.'));\n        }\n        return this.fidjService.fidjLoginInDemoMode(options);\n    };\n\n    public isLoggedIn(): boolean {\n        if (!this.fidjService) {\n            return false; // this.promise.reject('fidj.sdk.angular.isLoggedIn : not initialized.');\n        }\n        return this.fidjService.fidjIsLogin();\n    };\n\n    public async getRoles(): Promise<Array<string>> {\n        if (!this.fidjService) {\n            return [];\n        }\n        return await this.fidjService.fidjRoles();\n    };\n\n    public async getEndpoints(): Promise<Array<EndpointInterface>> {\n        if (!this.fidjService) {\n            return [];\n        }\n        return this.fidjService.fidjGetEndpoints();\n    };\n\n    /**\n     * @throws {ErrorInterface}\n     * @param {EndpointCallInterface} input\n     */\n    public async sendOnEndpoint(input: EndpointCallInterface): Promise<any> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(303, 'fidj.sdk.angular.loginAsDemo : not initialized.'));\n        }\n        return this.fidjService.fidjSendOnEndpoint(input);\n    };\n\n    public async forgotPasswordRequest(email: String): Promise<void> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(303, 'fidj.sdk.angular.loginAsDemo : not initialized.'));\n        }\n        return this.fidjService.fidjForgotPasswordRequest(email);\n    };\n\n    public async getIdToken() {\n        if (!this.fidjService) {\n            return;\n        }\n        return this.fidjService.fidjGetIdToken();\n    };\n\n    public async getMessage(): Promise<string> {\n        if (!this.fidjService) {\n            return '';\n        }\n        return this.fidjService.fidjMessage();\n    };\n\n    public async logout(force?: boolean): Promise<void | ErrorInterface> {\n        if (force || !this.fidjService) {\n            return this.promise.reject(new FidjError(303, 'fidj.sdk.angular.logout : not initialized.'));\n        }\n        return this.fidjService.fidjLogout(force);\n    };\n\n    /**\n     *\n     * Synchronize DB\n     * @param fnInitFirstData  a function with db as input and that return promise: call if DB is empty\n     * @returns promise with this.session.db\n     * @memberof fidj.angularService\n     *\n     * @example\n     *  let initDb = function() {\n     *     this.fidjService.put('my first row');\n     *  };\n     *  this.fidjService.sync(initDb)\n     *  .then(user => ...)\n     *  .catch(err => ...)\n     *\n     */\n    public async sync(fnInitFirstData?): Promise<void | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(401, 'fidj.sdk.angular.sync : not initialized.'));\n        }\n        return this.fidjService.fidjSync(fnInitFirstData, this);\n    };\n\n    /**\n     * Store data in your session\n     *\n     * @param data to store\n     * @returns\n     */\n    public async put(data: any): Promise<string | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(401, 'fidj.sdk.angular.put : not initialized.'));\n        }\n        return this.fidjService.fidjPutInDb(data);\n    };\n\n    /**\n     * Find object Id and remove it from your session\n     *\n     * @param id of object to find and remove\n     * @returns\n     */\n    public async remove(id: string): Promise<void | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(401, 'fidj.sdk.angular.remove : not initialized.'));\n        }\n        return this.fidjService.fidjRemoveInDb(id);\n    };\n\n    /**\n     * Find\n     */\n    public async find(id: string): Promise<any | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(401, 'fidj.sdk.angular.find : not initialized.'));\n        }\n        return this.fidjService.fidjFindInDb(id);\n    };\n\n    public async findAll(): Promise<any[] | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(401, 'fidj.sdk.angular.findAll : not initialized.'));\n        }\n        return this.fidjService.fidjFindAllInDb();\n    };\n\n}\n"]}