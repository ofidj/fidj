{"version":3,"sources":["../../node_modules/tslib/tslib.es6.js","ng://fidj/sdk/interfaces.ts","ng://fidj/tools/base64.ts","ng://fidj/tools/storage.ts","ng://fidj/tools/xor.ts","ng://fidj/version/index.ts","ng://fidj/connection/ajax.ts","ng://fidj/session/session.ts","ng://fidj/connection/client.ts","ng://fidj/sdk/error.ts","ng://fidj/connection/connection.ts","ng://fidj/sdk/logger.service.ts","ng://fidj/sdk/internal.service.ts","ng://fidj/sdk/angular.service.ts","ng://fidj/sdk/fidj.module.ts"],"names":["__decorate","decorators","target","key","desc","d","c","arguments","length","r","Object","getOwnPropertyDescriptor","Reflect","decorate","i","defineProperty","__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","__generator","body","f","y","t","g","_","label","sent","trys","ops","verb","throw","return","Symbol","iterator","this","n","v","op","TypeError","call","pop","push","LoggerLevelEnum","Base64","encode","input","window","btoa","require","encodeURIComponent","replace","match","p1","String","fromCharCode","parseInt","decode","_atob","atob","decodeURIComponent","split","map","charCodeAt","toString","slice","join","LocalStorage","storageService","storageKey","version","storage","localStorage","Error","prototype","set","checkKey","JSON","stringify","string","number","bool","json","setItem","get","def","item","getItem","parse","valueOf","remove","existed","removeItem","clear","size","foreach","context","Xor","encrypt","header","keyCharAt","decrypt","oldStyle","substring","Math","floor","XhrErrorReason","FidjPouch","Ajax","xhr","formatResponseData","response","dataParsed","data","formatError","error","errorFormatted","reason","UNKNOWN","status","code","message","STATUS","TIMEOUT","request","post","args","opt","method","url","headers","timeout","res","catch","err","put","delete","Client","appId","URI","sdk","uuid","_clientUuid","random","info","navigator","appName","appVersion","userAgent","setClientUuid","setClientInfo","clientId","_clientId","refreshCount","_refreshCount","refreshCountInitial","setClientId","clientUuid","clientInfo","login","password","updateProperties","_this","console","urlLogin","dataLogin","name","username","email","Content-Type","Accept","createdUser","_id","urlToken","dataToken","grant_type","client_id","client_secret","client_udid","client_info","audience","scope","reAuthenticate","refreshToken","refresh_token","refresh_extra","obj","logout","token","isReady","Error$1","equals","msg","Connection","_sdk","_storage","_logger","client","user","cryptoSalt","_cryptoSalt","cryptoSaltNext","_cryptoSaltNext","accessToken","_accessToken","accessTokenPrevious","idToken","_idToken","_refreshToken","states","_states","apis","destroy","force","_accessTokenPrevious","setClient","_name","getIdPayload","setUser","getUser","getClient","setCryptoSalt","setCryptoSaltAsVerified","dataAsObj","fidjCrypto","decrypted","isLogin","exp","payload","decoded","Date","getTime","getClientId","getIdToken","log","getAccessPayload","getPreviousAccessPayload","refreshConnection","notExpired","expired","setConnection","clientUser","access_token","salt","id_token","roles","setConnectionOffline","options","getApiEndpoints","ea","blocked","filteredEa","prod","apiEndpoints","val","forEach","endpoint","filter","couldCheckStates","keys","state","bestOldOne","lastTimeWasOk","getDBs","dbs","sort","reverse","filteredDBs","verifyApiState","currentTime","endpointUrl","_a","isok","time","err_1","verifyDbState","dbEndpoint","verifyConnectionStates","promises","endpointObj","dbEndpointObj","all","default","PouchAdapterCordovaSqlite","plugin","Session","db","dbRecordCount","dbLastSync","remoteDb","create","uid","opts","location","adapter","setRemote","sync","userId","remoteUri","replicate","to","on","doc","fidjUserId","second","first","oid","ave","crypto","dataWithoutIds","toStore","fidjOrgId","fidjAppVersion","_rev","fidjData","resultAsString","write","fidjDacr","ok","id","rev","data_id","_deleted","row","resultAsJson","extractJson","getAll","allDocs","include_docs","descending","rows","isEmpty","total_rows","LoggerService","level","ERROR","NONE","LOG","warn","WARN","setLevel","urljoin","InternalService","logger","promise","ls","org","version.version","useDB","logLevel","global","tools.LocalStorage","session","session.Session","connection","connection.Connection","fidjInit","fidjId","self","fidjVersion","hasOwnProperty","theBestUrl","theBestOldUrl","fidjIsLogin","connection.Client","fidjLogin","_removeAll","_createSession","_loginInternal","fidjLoginInDemoMode","now","setDate","getDate","tomorrow","tools.Base64","endpoints","jwtSign","fidjGetEndpoints","showBlocked","ap","Array","isArray","fidjRoles","fidjMessage","fidjLogout","fidjSync","fnInitFirstData","fnInitFirstData_Arg","firstSync","resolveEmpty","rejectEmptyNotUsed","ret","Function","doc_count","errMessage","fidjPutInDb","indexOf","_generateObjectUniqueId","fidjRemoveInDb","fidjFindInDb","fidjFindAllInDb","results","fidjSendOnEndpoint","relativePath","answer","jwt","query","Authorization","fidjGetIdToken","loginUser","_testPromise","a","type","simpleDate","getFullYear","getMonth","getHours","getMinutes","sequId","_srvDataUniqId","UId","charAt","FidjService","fidjService","init","FidjError","loginAsDemo","isLoggedIn","getRoles","getEndpoints","sendOnEndpoint","getMessage","find","findAll","Injectable","FidjModule","NgModule","imports","CommonModule","declarations","exports","providers"],"mappings":"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","sourcesContent":["/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\nLicensed under the Apache License, Version 2.0 (the \"License\"); you may not use\r\nthis file except in compliance with the License. You may obtain a copy of the\r\nLicense at http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nTHIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED\r\nWARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,\r\nMERCHANTABLITY OR NON-INFRINGEMENT.\r\n\r\nSee the Apache Version 2.0 License for specific language governing permissions\r\nand limitations under the License.\r\n***************************************************************************** */\r\n/* global Reflect, Promise */\r\n\r\nvar extendStatics = function(d, b) {\r\n    extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n    return extendStatics(d, b);\r\n};\r\n\r\nexport function __extends(d, b) {\r\n    extendStatics(d, b);\r\n    function __() { this.constructor = d; }\r\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n}\r\n\r\nexport var __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    }\r\n    return __assign.apply(this, arguments);\r\n}\r\n\r\nexport function __rest(s, e) {\r\n    var t = {};\r\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\r\n        t[p] = s[p];\r\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\r\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\r\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\r\n                t[p[i]] = s[p[i]];\r\n        }\r\n    return t;\r\n}\r\n\r\nexport function __decorate(decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n}\r\n\r\nexport function __param(paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n}\r\n\r\nexport function __metadata(metadataKey, metadataValue) {\r\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\r\n}\r\n\r\nexport function __awaiter(thisArg, _arguments, P, generator) {\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n}\r\n\r\nexport function __generator(thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n}\r\n\r\nexport function __exportStar(m, exports) {\r\n    for (var p in m) if (!exports.hasOwnProperty(p)) exports[p] = m[p];\r\n}\r\n\r\nexport function __values(o) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator], i = 0;\r\n    if (m) return m.call(o);\r\n    return {\r\n        next: function () {\r\n            if (o && i >= o.length) o = void 0;\r\n            return { value: o && o[i++], done: !o };\r\n        }\r\n    };\r\n}\r\n\r\nexport function __read(o, n) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\r\n    if (!m) return o;\r\n    var i = m.call(o), r, ar = [], e;\r\n    try {\r\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\r\n    }\r\n    catch (error) { e = { error: error }; }\r\n    finally {\r\n        try {\r\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\r\n        }\r\n        finally { if (e) throw e.error; }\r\n    }\r\n    return ar;\r\n}\r\n\r\nexport function __spread() {\r\n    for (var ar = [], i = 0; i < arguments.length; i++)\r\n        ar = ar.concat(__read(arguments[i]));\r\n    return ar;\r\n}\r\n\r\nexport function __spreadArrays() {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n};\r\n\r\nexport function __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nexport function __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\nexport function __asyncDelegator(o) {\r\n    var i, p;\r\n    return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\r\n    function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: n === \"return\" } : f ? f(v) : v; } : f; }\r\n}\r\n\r\nexport function __asyncValues(o) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var m = o[Symbol.asyncIterator], i;\r\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\r\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\r\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\r\n}\r\n\r\nexport function __makeTemplateObject(cooked, raw) {\r\n    if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\r\n    return cooked;\r\n};\r\n\r\nexport function __importStar(mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];\r\n    result.default = mod;\r\n    return result;\r\n}\r\n\r\nexport function __importDefault(mod) {\r\n    return (mod && mod.__esModule) ? mod : { default: mod };\r\n}\r\n","// export namespace fidj {\n// }\nexport interface ErrorInterface {\n    code: number;\n    reason: string;\n}\n\nexport interface EndpointInterface {\n    key: string;\n    url: string;\n    blocked: boolean;\n}\n\nexport interface EndpointFilterInterface {\n    key?: string;\n    showBlocked?: boolean;\n}\n\n/**\n * Interface used by all InternalService wrappers (angular.js, angular.io)\n *\n * @see FidjModule\n * @see FidjModule, FidjAngularService\n */\nexport interface ModuleServiceInterface {\n\n    init(fidjId: string, options?: ModuleServiceInitOptionsInterface): Promise<void | ErrorInterface>;\n\n    login(login: string, password: string): Promise<any | ErrorInterface>;\n\n    loginAsDemo(options?: ModuleServiceLoginOptionsInterface): Promise<any | ErrorInterface>;\n\n    isLoggedIn(): boolean;\n\n    getRoles(): Array<string>;\n\n    getEndpoints(): Array<EndpointInterface>;\n\n    sendOnEndpoint(key: string, verb: string, relativePath?: string, data?: any): Promise<any | ErrorInterface>;\n\n    getIdToken(): string;\n\n    getMessage(): string;\n\n    logout(force?: boolean): Promise<void | ErrorInterface>;\n\n    sync(fnInitFirstData?: any): Promise<any | ErrorInterface>;\n\n    put(data: any): Promise<any | ErrorInterface>;\n\n    remove(dataId: any): Promise<any | ErrorInterface>;\n\n    find(id: string): Promise<any | ErrorInterface>;\n\n    findAll(): Promise<any | ErrorInterface>;\n}\n\n\nexport interface ModuleServiceInitOptionsInterface {\n    prod: boolean,\n    useDB?: boolean,\n    // forcedEndpoint?: string,\n    // forcedDBEndpoint?: string,\n    crypto?: boolean,\n    logLevel?: LoggerLevelEnum\n}\n\nexport interface ModuleServiceLoginOptionsInterface {\n    accessToken?: string,\n    idToken?: string,\n    refreshToken?: string,\n}\n\nexport interface SdkInterface {\n    org: string,\n    version: string,\n    prod: boolean,\n    useDB: boolean\n}\n\nexport enum LoggerLevelEnum {\n    LOG = 1,\n    WARN = 2,\n    ERROR = 3,\n    NONE = 4\n}\n\nexport interface LoggerInterface {\n    setLevel: (LoggerLevelEnum) => void;\n\n    log: (a?, b?, c?, d?, e?, f?) => any;\n    warn: (a?, b?, c?, d?, e?, f?) => any;\n    error: (a?, b?, c?, d?, e?, f?) => any;\n}\n","export class Base64 {\n\n    constructor() {\n    };\n\n    /**\n     * Decodes string from Base64 string\n     */\n    public static encode(input: string): string {\n\n        if (!input) {\n            return null;\n        }\n\n        const _btoa = typeof window !== 'undefined' ? window.btoa : require('btoa');\n\n        return _btoa(encodeURIComponent(input).replace(/%([0-9A-F]{2})/g,\n            function toSolidBytes(match, p1) {\n                return String.fromCharCode(parseInt('0x' + p1, 16));\n            }));\n\n    }\n\n    public static decode(input: string): string {\n\n        if (!input) {\n            return null;\n        }\n\n        const _atob = typeof window !== 'undefined' ? window.atob : require('atob');\n\n        return decodeURIComponent(_atob(input).split('').map((c) => {\n            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);\n        }).join(''));\n\n    }\n}\n","/**\n * localStorage class factory\n * Usage : var LocalStorage = fidj.LocalStorageFactory(window.localStorage); // to create a new class\n * Usage : var localStorageService = new LocalStorage(); // to create a new instance\n */\nexport class LocalStorage {\n\n    public version = '0.1';\n    private storage;\n\n    // Constructor\n    constructor(storageService, private storageKey) {\n        this.storage = storageService || window.localStorage;\n        if (!this.storage) {\n            throw new Error('fidj.LocalStorageFactory needs a storageService!');\n        }\n        // todo LocalStorage refacto\n        //            if (!fidj.Xml) {\n        //                throw new Error('fidj.Xml needs to be loaded before fidj.LocalStorage!');\n        //            }\n        //            if (!fidj.Json) {\n        //                throw new Error('fidj.Json needs to be loaded before fidj.LocalStorage!');\n        //            }\n        //            if (!fidj.Xml.isXml || !fidj.Xml.xml2String || !fidj.Xml.string2Xml) {\n        //                throw new Error('fidj.Xml with isXml(), xml2String()\n        // and string2Xml() needs to be loaded before fidj.LocalStorage!');\n        //            }\n        //            if (!fidj.Json.object2String || !fidj.Json.string2Object) {\n        //                throw new Error('fidj.Json with object2String()\n        // and string2Object() needs to be loaded before fidj.LocalStorage!');\n        //            }\n        //\n    }\n\n    // Public API\n\n    /**\n     * Sets a key's value.\n     *\n     * @param key - Key to set. If this value is not set or not\n     *              a string an exception is raised.\n     * @param value - Value to set. This can be any value that is JSON\n     *              compatible (Numbers, Strings, Objects etc.).\n     * @returns the stored value which is a container of user value.\n     */\n    set(key: string, value) {\n\n        key = this.storageKey + key;\n        this.checkKey(key);\n        // clone the object before saving to storage\n        const t = typeof(value);\n        if (t === 'undefined') {\n            value = 'null';\n        } else if (value === null) {\n            value = 'null';\n        } else if (t === 'string') {\n            value = JSON.stringify({string: value})\n        } else if (t === 'number') {\n            value = JSON.stringify({number: value});\n        } else if (t === 'boolean') {\n            value = JSON.stringify({bool: value});\n        } else if (t === 'object') {\n            value = JSON.stringify({json: value});\n        } else {\n            // reject and do not insert\n            // if (typeof value == \"function\") for example\n            throw new TypeError('Value type ' + t + ' is invalid. It must be null, undefined, xml, string, number, boolean or object');\n        }\n        this.storage.setItem(key, value);\n        return value;\n    };\n\n    /**\n     * Looks up a key in cache\n     *\n     * @param key - Key to look up.\n     * @param def - Default value to return, if key didn't exist.\n     * @returns the key value, default value or <null>\n     */\n    get(key: string, def?) {\n        key = this.storageKey + key;\n        this.checkKey(key);\n        const item = this.storage.getItem(key);\n        if (item !== null) {\n            if (item === 'null') {\n                return null;\n            }\n            const value = JSON.parse(item);\n\n            // var value = fidj.Json.string2Object(item);\n            // if ('xml' in value) {\n            //     return fidj.Xml.string2Xml(value.xml);\n            // } else\n            if ('string' in value) {\n                return value.string;\n            } else if ('number' in value) {\n                return value.number.valueOf();\n            } else if ('bool' in value) {\n                return value.bool.valueOf();\n            } else {\n                return value.json;\n            }\n        }\n        return !def ? null : def;\n    };\n\n    /**\n     * Deletes a key from cache.\n     *\n     * @param  key - Key to delete.\n     * @returns true if key existed or false if it didn't\n     */\n    remove(key: string) {\n        key = this.storageKey + key;\n        this.checkKey(key);\n        const existed = (this.storage.getItem(key) !== null);\n        this.storage.removeItem(key);\n        return existed;\n    };\n\n    /**\n     * Deletes everything in cache.\n     *\n     * @return true\n     */\n    clear() {\n        const existed = (this.storage.length > 0);\n        this.storage.clear();\n        return existed;\n    };\n\n    /**\n     * How much space in bytes does the storage take?\n     *\n     * @returns Number\n     */\n    size() {\n        return this.storage.length;\n    };\n\n    /**\n     * Call function f on the specified context for each element of the storage\n     * from index 0 to index length-1.\n     * WARNING : You should not modify the storage during the loop !!!\n     *\n     * @param f - Function to call on every item.\n     * @param  context - Context (this for example).\n     * @returns Number of items in storage\n     */\n    foreach(f, context) {\n        const n = this.storage.length;\n        for (let i = 0; i < n; i++) {\n            const key = this.storage.key(i);\n            const value = this.get(key);\n            if (context) {\n                // f is an instance method on instance context\n                f.call(context, value);\n            } else {\n                // f is a function or class method\n                f(value);\n            }\n        }\n        return n;\n    };\n\n    // Private API\n    // helper functions and variables hidden within this function scope\n\n    private checkKey(key) {\n        if (!key || (typeof key !== 'string')) {\n            throw new TypeError('Key type must be string');\n        }\n        return true;\n    }\n}\n","import {Base64} from './base64';\n\nexport class Xor {\n\n    static header = 'artemis-lotsum';\n\n    constructor() {\n    };\n\n\n    public static encrypt(value: string, key: string): string {\n\n        let result = '';\n\n        value = Xor.header + value;\n\n        for (let i = 0; i < value.length; i++) {\n            result += String.fromCharCode((value[i].charCodeAt(0).toString(10) as any) ^ Xor.keyCharAt(key, i));\n        }\n        result = Base64.encode(result);\n        return result;\n    };\n\n    public static decrypt(value: string, key: string, oldStyle?: boolean): string {\n        let result = '';\n        value = Base64.decode(value);\n        for (let i = 0; i < value.length; i++) {\n            result += String.fromCharCode((value[i].charCodeAt(0).toString(10) as any) ^ Xor.keyCharAt(key, i));\n        }\n\n        if (!oldStyle && Xor.header !== result.substring(0, Xor.header.length)) {\n            return null;\n        }\n\n        if (!oldStyle) {\n            result = result.substring(Xor.header.length);\n        }\n        return result;\n    }\n\n    public static keyCharAt(key, i) {\n        return key[Math.floor(i % key.length)].charCodeAt(0).toString(10);\n    }\n\n\n}\n","// bumped version via gulp\nexport const version = '2.1.38';\n","// import {XHRPromise} from './xhrpromise';\n// const superagent = require('superagent');\n// import from 'superagent';\n\nexport interface XhrOptionsInterface {\n    url: string,\n    data?: any,\n    headers?: any,\n    async?: boolean,\n    username?: string,\n    password?: string,\n    withCredentials?: boolean\n}\n\nexport enum XhrErrorReason {\n    UNKNOWN,\n    TIMEOUT,\n    STATUS\n}\n\n\nexport interface XhrErrorInterface {\n    reason: XhrErrorReason,\n    status: number,\n    code: number,\n    message: string,\n}\n\nexport class Ajax {\n\n    // private static xhr: XHRPromise = new XHRPromise();\n    private xhr; // : XHRPromise;\n\n    constructor() {\n\n        // https://www.twilio.com/blog/2017/08/http-requests-in-node-js.html\n        // axios ?\n        //  https://github.com/axios/axios\n        // const axios = require('axios');\n\n        // axios.get('https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY')\n        //     .then(response => {\n        //         console.log(response.data.url);\n        //         console.log(response.data.explanation);\n        //     })\n\n        // superagent.get('https://api.nasa.gov/planetary/apod')\n        //     .query({ api_key: 'DEMO_KEY', date: '2017-08-02' })\n\n        this.xhr = require('axios'); // require('superagent'); // new XHRPromise();\n    };\n\n    private static formatResponseData(response: any): any {\n        // TODO switch depending on json headers\n        let dataParsed = response;\n\n        while (dataParsed && dataParsed.data) {\n            dataParsed = dataParsed.data;\n        }\n\n        try {\n            dataParsed = JSON.parse(dataParsed + '');\n        } catch (e) {\n        }\n        return dataParsed;\n    };\n\n    private static formatError(error: any): XhrErrorInterface {\n\n        const errorFormatted: XhrErrorInterface = {\n            reason: XhrErrorReason.UNKNOWN,\n            status: -1,\n            code: -1,\n            message: '',\n        };\n\n        if (error.status) {\n            errorFormatted.reason = XhrErrorReason.STATUS;\n            errorFormatted.status = parseInt(error.status, 10);\n            errorFormatted.code = parseInt(error.status, 10);\n        }\n\n        if (error.response) {\n            errorFormatted.message = error.response;\n\n            if (error.response.status) {\n                errorFormatted.reason = XhrErrorReason.STATUS;\n                errorFormatted.status = parseInt(error.response.status, 10);\n                errorFormatted.code = parseInt(error.response.status, 10);\n            } else if (error.response.status === null) { // timeout\n                errorFormatted.reason = XhrErrorReason.TIMEOUT;\n                errorFormatted.status = 408;\n                errorFormatted.code = 408;\n            }\n\n        } else if (error.request) {\n            errorFormatted.message = error.request;\n        } else if (error.message) {\n            errorFormatted.message = error.message;\n        }\n\n        // _this._handleError('browser', reject, null, 'browser doesn\\'t support XMLHttpRequest');\n        // _this._handleError('url', reject, null, 'URL is a required parameter');\n        // _this._handleError('parse', reject, null, 'invalid JSON response');\n        // return _this._handleError('error', reject);\n        // return _this._handleError('timeout', reject);\n        // return _this._handleError('abort', reject);\n        // return _this._handleError('send', reject, null, e.toString());\n\n        // if (err.reason === 'timeout') {\n        //     err.code = 408;\n        // } else {\n        //     err.code = 404;\n        // }\n\n        return errorFormatted;\n    };\n\n    public post(args: XhrOptionsInterface): Promise<any | XhrErrorInterface> {\n\n        const opt: any = {\n            method: 'POST',\n            url: args.url,\n            data: JSON.stringify(args.data)\n        };\n        if (args.headers) {\n            opt.headers = args.headers;\n        }\n\n        return this.xhr\n            .post(opt.url, {\n                data: opt.data,\n                headers: opt.headers,\n                timeout: 10000\n            })\n            .then(res => {\n                if (res.status &&\n                    (parseInt(res.status, 10) < 200 || parseInt(res.status, 10) >= 300)) {\n                    return Promise.reject(Ajax.formatError(res));\n                }\n\n                return Promise.resolve(Ajax.formatResponseData(res));\n            })\n            .catch(err => {\n                return Promise.reject(Ajax.formatError(err));\n            });\n    }\n\n    public put(args: XhrOptionsInterface): Promise<any | XhrErrorInterface> {\n        const opt: any = {\n            method: 'PUT',\n            url: args.url,\n            data: JSON.stringify(args.data)\n        };\n        if (args.headers) {\n            opt.headers = args.headers;\n        }\n        return this.xhr\n            .put(opt.url, {\n                data: opt.data,\n                headers: opt.headers,\n                timeout: 10000\n            })\n            .then(res => {\n                if (res.status &&\n                    (parseInt(res.status, 10) < 200 || parseInt(res.status, 10) >= 300)) {\n                    return Promise.reject(Ajax.formatError(res));\n                }\n\n                return Promise.resolve(Ajax.formatResponseData(res));\n            })\n            .catch(err => {\n                return Promise.reject(Ajax.formatError(err));\n            });\n    }\n\n    public delete(args: XhrOptionsInterface): Promise<any | XhrErrorInterface> {\n        const opt: any = {\n            method: 'DELETE',\n            url: args.url,\n            data: JSON.stringify(args.data)\n        };\n        if (args.headers) {\n            opt.headers = args.headers;\n        }\n        return this.xhr\n            .delete(opt.url, {\n                data: opt.data,\n                headers: opt.headers,\n                timeout: 10000\n            })\n            // .delete(opt.url) // .send(opt)\n            .then(res => {\n                if (res.status &&\n                    (parseInt(res.status, 10) < 200 || parseInt(res.status, 10) >= 300)) {\n                    return Promise.reject(Ajax.formatError(res));\n                }\n\n                return Promise.resolve(Ajax.formatResponseData(res));\n            })\n            .catch(err => {\n                return Promise.reject(Ajax.formatError(err));\n            });\n    }\n\n    public get(args: XhrOptionsInterface): Promise<any | XhrErrorInterface> {\n        const opt: any = {\n            method: 'GET',\n            url: args.url\n        };\n        if (args.data) {\n            opt.data = args.data;\n        }\n        if (args.headers) {\n            opt.headers = args.headers;\n        }\n        return this.xhr\n            .get(opt.url, {\n                data: opt.data,\n                headers: opt.headers,\n                timeout: 10000\n            })\n            // .get(opt.url) // .send(opt)\n            .then(res => {\n                if (res.status &&\n                    (parseInt(res.status, 10) < 200 || parseInt(res.status, 10) >= 300)) {\n                    return Promise.reject(Ajax.formatError(res));\n                }\n\n                return Promise.resolve(Ajax.formatResponseData(res));\n            })\n            .catch(err => {\n                return Promise.reject(Ajax.formatError(err));\n            });\n    }\n}\n","// import PouchDB from 'pouchdb';\n// let PouchDB: any;\n\nimport PouchDB from 'pouchdb/dist/pouchdb.js';\nimport {Error} from '../sdk/error';\nimport {EndpointInterface, ErrorInterface} from '../sdk/interfaces';\n\nlet FidjPouch;\n\nif (typeof window !== 'undefined') {\n    FidjPouch = (window['PouchDB']) ? window['PouchDB'] : require('pouchdb').default; // .default;\n    // load cordova adapter : https://github.com/pouchdb-community/pouchdb-adapter-cordova-sqlite/issues/22\n    const PouchAdapterCordovaSqlite = require('pouchdb-adapter-cordova-sqlite');\n    FidjPouch.plugin(PouchAdapterCordovaSqlite);\n}\n\nexport interface SessionCryptoInterface {\n    obj: Object,\n    method: string\n}\n\nexport class Session {\n\n    public dbRecordCount: number;\n    public dbLastSync: number; // Date().getTime();\n\n    private db: PouchDB; // PouchDB\n    private remoteDb: PouchDB; // PouchDB;\n    private remoteUri: string;\n    private dbs: Array<EndpointInterface>;\n\n    constructor() {\n        this.db = null;\n        this.dbRecordCount = 0;\n        this.dbLastSync = null;\n        this.remoteDb = null;\n        this.dbs = [];\n    };\n\n    public isReady(): boolean {\n        return !!this.db;\n    }\n\n    public create(uid: string, force?: boolean): Promise<any | ErrorInterface> {\n\n        if (!force && this.db) {\n            return Promise.resolve(this.db);\n        }\n\n        this.dbRecordCount = 0;\n        this.dbLastSync = null; // new Date().getTime();\n        this.db = null;\n        uid = uid || 'default';\n\n        if (typeof window === 'undefined') {\n            return Promise.resolve(this.db);\n        }\n\n        return new Promise((resolve, reject) => {\n\n            let opts: any = {location: 'default'};\n            try {\n                if (window['cordova']) {\n                    opts = {location: 'default', adapter: 'cordova-sqlite'};\n                    //    const plugin = require('pouchdb-adapter-cordova-sqlite');\n                    //    if (plugin) { Pouch.plugin(plugin); }\n                    //    this.db = new Pouch('fidj_db', {adapter: 'cordova-sqlite'});\n                }\n                // } else {\n                this.db = new FidjPouch('fidj_db_' + uid, opts); // , {adapter: 'websql'} ???\n                // }\n\n                this.db.info()\n                    .then((info) => {\n\n                        // todo if (info.adapter !== 'websql') {\n                        return resolve(this.db);\n                        // }\n\n                        // const newopts: any = opts || {};\n                        // newopts.adapter = 'idb';\n                        //\n                        // const newdb = new Pouch('fidj_db', opts);\n                        // this.db.replicate.to(newdb)\n                        //     .then(() => {\n                        //         this.db = newdb;\n                        //         resolve();\n                        //     })\n                        //     .catch((err) => {\n                        //         reject(new Error(400, err.toString()))\n                        //     });\n\n                    }).catch((err) => {\n                    reject(new Error(400, err));\n                });\n            } catch (err) {\n                reject(new Error(500, err));\n            }\n        });\n    }\n\n    public destroy(): Promise<void | ErrorInterface> {\n\n        if (!this.db) {\n            this.dbRecordCount = 0;\n            this.dbLastSync = null;\n            return Promise.resolve();\n        }\n\n        if (this.db && !this.db.destroy) {\n            return Promise.reject(new Error(408, 'Need a valid db'));\n        }\n\n        return new Promise((resolve, reject) => {\n            this.db.destroy((err, info) => {\n                if (err) {\n                    reject(new Error(500, err));\n                } else {\n                    this.dbRecordCount = 0;\n                    this.dbLastSync = null;\n                    this.db = null;\n                    resolve();\n                }\n            });\n        });\n    };\n\n    public setRemote(dbs: Array<EndpointInterface>): void {\n        this.dbs = dbs;\n    }\n\n    public sync(userId: string): Promise<void | ErrorInterface> {\n\n        if (!this.db) {\n            return Promise.reject(new Error(408, 'need db'));\n        }\n        if (!this.dbs || !this.dbs.length) {\n            return Promise.reject(new Error(408, 'need a remote db'));\n        }\n\n        return new Promise((resolve, reject) => {\n            try {\n\n                if (!this.remoteDb || this.remoteUri !== this.dbs[0].url) {\n                    this.remoteUri = this.dbs[0].url;\n                    this.remoteDb = new FidjPouch(this.remoteUri);\n                    // todo , {headers: {'Authorization': 'Bearer ' + id_token}});\n                }\n\n                this.db.replicate.to(this.remoteDb)\n                    .on('complete', (info) => {\n                        return this.remoteDb.replicate.to(this.db,\n                            {\n                                filter: (doc) => {\n                                    return (!!userId && !!doc && doc.fidjUserId === userId);\n                                }\n                            })\n                            .on('complete', () => {\n                                // this.logger\n                                resolve();\n                            })\n                            .on('denied', (err) => reject({code: 403, reason: {second: err}}))\n                            .on('error', (err) => reject({code: 401, reason: {second: err}}));\n\n                    })\n                    .on('denied', (err) => reject({code: 403, reason: {first: err}}))\n                    .on('error', (err) => reject({code: 401, reason: {first: err}}));\n\n            } catch (err) {\n                reject(new Error(500, err));\n            }\n        });\n    }\n\n    public put(data: any,\n               _id: string,\n               uid: string,\n               oid: string,\n               ave: string,\n               crypto?: SessionCryptoInterface): Promise<any | ErrorInterface> {\n\n        if (!this.db) {\n            return Promise.reject(new Error(408, 'need db'));\n        }\n\n        if (!data || !_id || !uid || !oid || !ave) {\n            return Promise.reject(new Error(400, 'need formated data'));\n        }\n\n        const dataWithoutIds = JSON.parse(JSON.stringify(data));\n        const toStore: any = {\n            _id: _id,\n            fidjUserId: uid,\n            fidjOrgId: oid,\n            fidjAppVersion: ave\n        };\n        if (dataWithoutIds._rev) {\n            toStore._rev = '' + dataWithoutIds._rev;\n        }\n        delete dataWithoutIds._id;\n        delete dataWithoutIds._rev;\n        delete dataWithoutIds.fidjUserId;\n        delete dataWithoutIds.fidjOrgId;\n        delete dataWithoutIds.fidjAppVersion;\n        delete dataWithoutIds.fidjData;\n\n        let resultAsString = Session.write(Session.value(dataWithoutIds));\n        if (crypto) {\n            resultAsString = crypto.obj[crypto.method](resultAsString);\n            toStore.fidjDacr = resultAsString;\n        } else {\n            toStore.fidjData = resultAsString;\n        }\n\n        return new Promise((resolve, reject) => {\n            this.db.put(toStore, (err, response) => {\n                if (response && response.ok && response.id && response.rev) {\n                    this.dbRecordCount++;\n\n                    // propagate _rev & _id\n                    if (typeof data === 'object') {\n                        (data as any)._rev = response.rev;\n                        (data as any)._id = response.id;\n                        resolve(data);\n                    } else {\n                        resolve(response.id);\n                    }\n\n                } else {\n                    reject(new Error(500, err));\n                }\n            });\n        });\n    }\n\n    public remove(data_id: string): Promise<void | ErrorInterface> {\n\n        if (!this.db) {\n            return Promise.reject(new Error(408, 'need db'));\n        }\n\n        return new Promise((resolve, reject) => {\n            this.db.get(data_id)\n                .then((doc) => {\n                    doc._deleted = true;\n                    return this.db.put(doc);\n                })\n                .then((result) => {\n                    resolve();\n                })\n                .catch((err) => {\n                    reject(err);\n                });\n        });\n    }\n\n    public get(data_id: string, crypto?: SessionCryptoInterface): Promise<any | ErrorInterface> {\n\n        if (!this.db) {\n            return Promise.reject(new Error(408, 'Need db'));\n        }\n\n        return new Promise((resolve, reject) => {\n            this.db.get(data_id)\n                .then(row => {\n                    if (!!row && (!!row.fidjDacr || !!row.fidjData)) {\n                        let data = row.fidjDacr;\n                        if (crypto && data) {\n                            data = crypto.obj[crypto.method](data);\n                        } else if (row.fidjData) {\n                            data = JSON.parse(row.fidjData);\n                        }\n                        const resultAsJson = Session.extractJson(data);\n                        if (resultAsJson) {\n                            resultAsJson._id = row._id;\n                            resultAsJson._rev = row._rev;\n                            resolve(JSON.parse(JSON.stringify(resultAsJson)));\n                        } else {\n                            // row._deleted = true;\n                            this.remove(row._id);\n                            reject(new Error(400, 'Bad encoding'));\n                        }\n                    } else {\n                        reject(new Error(400, 'No data found'));\n                    }\n                })\n                .catch(err => reject(new Error(500, err)));\n        });\n    }\n\n    public getAll(crypto?: SessionCryptoInterface): Promise<Array<any> | ErrorInterface> {\n\n        if (!this.db || !(this.db as any).allDocs) {\n            return Promise.reject(new Error(408, 'Need a valid db'));\n        }\n\n        return new Promise((resolve, reject) => {\n            (this.db as any).allDocs({include_docs: true, descending: true})\n                .then(rows => {\n                    const all = [];\n                    rows.rows.forEach(row => {\n                        if (!!row && !!row.doc._id && (!!row.doc.fidjDacr || !!row.doc.fidjData)) {\n                            let data = row.doc.fidjDacr;\n                            if (crypto && data) {\n                                data = crypto.obj[crypto.method](data);\n                            } else if (row.doc.fidjData) {\n                                data = JSON.parse(row.doc.fidjData);\n                            }\n                            const resultAsJson = Session.extractJson(data);\n                            if (resultAsJson) {\n                                resultAsJson._id = row.doc._id;\n                                resultAsJson._rev = row.doc._rev;\n                                all.push(JSON.parse(JSON.stringify(resultAsJson)));\n                            } else {\n                                console.error('Bad encoding : delete row');\n                                // resultAsJson = {};\n                                // resultAsJson._id = row.doc._id;\n                                // resultAsJson._rev = row.doc._rev;\n                                // resultAsJson._deleted = true;\n                                // all.push(resultAsJson);\n                                this.remove(row.doc._id);\n                            }\n                        } else {\n                            console.error('Bad encoding');\n                        }\n                    });\n                    resolve(all);\n                })\n                .catch(err => reject(new Error(400, err)));\n        });\n    }\n\n    public isEmpty(): Promise<boolean | ErrorInterface> {\n\n        if (!this.db || !(this.db as any).allDocs) {\n            return Promise.reject(new Error(408, 'No db'));\n        }\n\n        return new Promise((resolve, reject) => {\n            (this.db as any).allDocs({\n                // filter:  (doc) => {\n                //    if (!self.connection.user || !self.connection.user._id) return doc;\n                //    if (doc.fidjUserId === self.connection.user._id) return doc;\n                // }\n            })\n                .then((response) => {\n                    if (!response) {\n                        reject(new Error(400, 'No response'));\n                    } else {\n                        this.dbRecordCount = response.total_rows;\n                        if (response.total_rows && response.total_rows > 0) {\n                            resolve(false);\n                        } else {\n                            resolve(true);\n                        }\n                    }\n                })\n                .catch((err) => reject(new Error(400, err)));\n        });\n    }\n\n    public info(): Promise<any> {\n        if (!this.db) {\n            return Promise.reject(new Error(408, 'No db'));\n        }\n        return this.db.info();\n    }\n\n    static write(item: any): string {\n        let value = 'null';\n        const t = typeof (item);\n        if (t === 'undefined') {\n            value = 'null';\n        } else if (value === null) {\n            value = 'null';\n        } else if (t === 'string') {\n            value = JSON.stringify({string: item})\n        } else if (t === 'number') {\n            value = JSON.stringify({number: item});\n        } else if (t === 'boolean') {\n            value = JSON.stringify({bool: item});\n        } else if (t === 'object') {\n            value = JSON.stringify({json: item});\n        }\n        return value;\n    }\n\n    static value(item: any): any {\n        let result = item;\n        if (typeof (item) !== 'object') {\n            // return item;\n        } else if ('string' in item) {\n            result = item.string;\n        } else if ('number' in item) {\n            result = item.number.valueOf();\n        } else if ('bool' in item) {\n            result = item.bool.valueOf();\n        } else if ('json' in item) {\n            result = item.json;\n            if (typeof (result) !== 'object') {\n                result = JSON.parse(result);\n            }\n        }\n        return result;\n    }\n\n    static extractJson(item: any): any {\n        let result = item;\n        if (!item) {\n            return null;\n        }\n        if (typeof (item) === 'object' && 'json' in item) {\n            result = item.json;\n        }\n        if (typeof (result) === 'string') {\n            result = JSON.parse(result);\n        }\n        if (typeof (result) === 'object' && 'json' in result) {\n            result = (result as any).json;\n        }\n        if (typeof result !== 'object') {\n            result = null;\n        }\n        return result;\n    }\n\n}\n","import {Ajax} from './ajax';\nimport {LocalStorage} from '../tools';\nimport {SdkInterface, ErrorInterface} from '../sdk/interfaces';\n\nexport class Client {\n\n    public clientId: string;\n    private clientUuid: string;\n    private clientInfo: string;\n    // private refreshToken: string;\n    private static refreshCountInitial = 1;\n    private static refreshCount = Client.refreshCountInitial;\n    private static _clientUuid = 'v2.clientUuid';\n    private static _clientId = 'v2.clientId';\n    private static _refreshCount = 'v2.refreshCount';\n\n    constructor(private appId: string,\n                private URI: string,\n                private storage: LocalStorage,\n                private sdk: SdkInterface) {\n\n        let uuid: string = this.storage.get(Client._clientUuid) || 'uuid-' + Math.random();\n        let info = '_clientInfo'; // this.storage.get(Client._clientInfo);\n        if (typeof window !== 'undefined' && window.navigator) {\n            info = window.navigator.appName + '@' + window.navigator.appVersion + '-' + window.navigator.userAgent;\n        }\n        if (typeof window !== 'undefined' && window['device'] && window['device'].uuid) {\n            uuid = window['device'].uuid;\n        }\n        this.setClientUuid(uuid);\n        this.setClientInfo(info);\n        this.clientId = this.storage.get(Client._clientId);\n        Client.refreshCount = this.storage.get(Client._refreshCount) || Client.refreshCountInitial;\n    };\n\n    public setClientId(value: string) {\n        this.clientId = '' + value;\n        this.storage.set(Client._clientId, this.clientId);\n    }\n\n    public setClientUuid(value: string) {\n        this.clientUuid = '' + value;\n        this.storage.set(Client._clientUuid, this.clientUuid);\n    }\n\n    public setClientInfo(value: string) {\n        this.clientInfo = '' + value;\n        // this.storage.set('clientInfo', this.clientInfo);\n    }\n\n    public login(login: string, password: string, updateProperties?: any): Promise<any | ErrorInterface> {\n\n        if (!this.URI) {\n            console.error('no api uri');\n            return Promise.reject({code: 408, reason: 'no-api-uri'});\n        }\n\n        const urlLogin = this.URI + '/users';\n        const dataLogin = {\n            name: login,\n            username: login,\n            email: login,\n            password: password\n        };\n\n        return new Ajax()\n            .post({\n                url: urlLogin,\n                data: dataLogin,\n                headers: {'Content-Type': 'application/json', 'Accept': 'application/json'}\n            })\n            .then(createdUser => {\n\n                this.setClientId(createdUser._id);\n                const urlToken = this.URI + '/oauth/token';\n                const dataToken = {\n                    grant_type: 'client_credentials',\n                    client_id: this.clientId,\n                    client_secret: password,\n                    client_udid: this.clientUuid,\n                    client_info: this.clientInfo,\n                    audience: this.appId,\n                    scope: JSON.stringify(this.sdk)\n                };\n                return new Ajax()\n                    .post({\n                        url: urlToken,\n                        data: dataToken,\n                        headers: {'Content-Type': 'application/json', 'Accept': 'application/json'}\n                    });\n            });\n    }\n\n    public reAuthenticate(refreshToken: string): Promise<any | ErrorInterface> {\n\n        if (!this.URI) {\n            console.error('no api uri');\n            return Promise.reject({code: 408, reason: 'no-api-uri'});\n        }\n\n        const url = this.URI + '/oauth/token';\n        const data = {\n            grant_type: 'refresh_token',\n            client_id: this.clientId,\n            client_udid: this.clientUuid,\n            client_info: this.clientInfo,\n            audience: this.appId,\n            scope: JSON.stringify(this.sdk),\n            refresh_token: refreshToken,\n            refresh_extra: Client.refreshCount,\n        };\n\n        return new Ajax()\n            .post({\n                url: url,\n                data: data,\n                headers: {'Content-Type': 'application/json', 'Accept': 'application/json'}\n            })\n            .then((obj: any) => {\n                Client.refreshCount++;\n                this.storage.set(Client._refreshCount, Client.refreshCount);\n                return Promise.resolve(obj);\n            });\n    }\n\n    public logout(refreshToken?: string): Promise<void | ErrorInterface> {\n\n        if (!this.URI) {\n            console.error('no api uri');\n            return Promise.reject({code: 408, reason: 'no-api-uri'});\n        }\n\n        // delete this.clientUuid;\n        // delete this.clientId;\n        // this.storage.remove(Client._clientUuid);\n        this.storage.remove(Client._clientId);\n        this.storage.remove(Client._refreshCount);\n        Client.refreshCount = Client.refreshCountInitial;\n\n        if (!refreshToken || !this.clientId) {\n            return Promise.resolve();\n        }\n\n        const url = this.URI + '/oauth/revoke';\n        const data = {\n            token: refreshToken,\n            client_id: this.clientId,\n            client_udid: this.clientUuid,\n            client_info: this.clientInfo,\n            audience: this.appId,\n            scope: JSON.stringify(this.sdk)\n        };\n\n        return new Ajax()\n            .post({\n                url: url,\n                data: data,\n                headers: {'Content-Type': 'application/json', 'Accept': 'application/json'}\n            });\n    }\n\n    public isReady(): boolean {\n        return !!this.URI;\n    }\n}\n","import {ErrorInterface} from './interfaces';\n\nexport class Error implements ErrorInterface {\n\n    constructor(public code: number, public reason: string) {\n    };\n\n    equals(err: Error) {\n        return this.code === err.code && this.reason === err.reason;\n    }\n\n    toString(): string {\n        const msg: string = (typeof this.reason === 'string') ? this.reason : JSON.stringify(this.reason);\n        return '' + this.code + ' - ' + msg;\n    }\n\n}\n","import {Client} from './client';\nimport {ModuleServiceLoginOptionsInterface, SdkInterface, ErrorInterface, EndpointInterface, LoggerInterface} from '../sdk/interfaces';\nimport {Base64, LocalStorage, Xor} from '../tools';\nimport {Ajax} from './ajax';\nimport {ConnectionFindOptionsInterface} from './interfaces';\nimport {Error} from '../sdk/error';\n\nexport class Connection {\n\n    public fidjId: string;\n    public fidjVersion: string;\n    public fidjCrypto: boolean;\n    public accessToken: string;\n    public accessTokenPrevious: string;\n    public idToken: string;\n    public refreshToken: string;\n    public states: { [s: string]: { state: boolean, time: number, lastTimeWasOk: number }; }; // Map<string, boolean>;\n    public apis: Array<EndpointInterface>;\n\n    private cryptoSalt: string;\n    private cryptoSaltNext: string;\n    private client: Client;\n    private user: any;\n\n    private static _accessToken = 'v2.accessToken';\n    private static _accessTokenPrevious = 'v2.accessTokenPrevious';\n    private static _idToken = 'v2.idToken';\n    private static _refreshToken = 'v2.refreshToken';\n    private static _states = 'v2.states';\n    private static _cryptoSalt = 'v2.cryptoSalt';\n    private static _cryptoSaltNext = 'v2.cryptoSalt.next';\n\n    constructor(private _sdk: SdkInterface,\n                private _storage: LocalStorage,\n                private _logger: LoggerInterface) {\n        this.client = null;\n        this.user = null;\n        this.cryptoSalt = this._storage.get(Connection._cryptoSalt) || null;\n        this.cryptoSaltNext = this._storage.get(Connection._cryptoSaltNext) || null;\n        this.accessToken = this._storage.get(Connection._accessToken) || null;\n        this.accessTokenPrevious = this._storage.get('v2.accessTokenPrevious') || null;\n        this.idToken = this._storage.get(Connection._idToken) || null;\n        this.refreshToken = this._storage.get(Connection._refreshToken) || null;\n        this.states = this._storage.get(Connection._states) || {};\n        this.apis = [];\n    };\n\n    isReady(): boolean {\n        return !!this.client && this.client.isReady();\n    }\n\n    destroy(force?: boolean): void {\n\n        this._storage.remove(Connection._accessToken);\n        this._storage.remove(Connection._idToken);\n        this._storage.remove(Connection._refreshToken);\n        this._storage.remove(Connection._states);\n\n        if (this.accessToken) {\n            this.accessTokenPrevious = this.accessToken;\n            this._storage.set(Connection._accessTokenPrevious, this.accessTokenPrevious);\n        }\n\n        if (force) {\n            this._storage.remove(Connection._cryptoSalt);\n            this._storage.remove(Connection._cryptoSaltNext);\n            this._storage.remove(Connection._accessTokenPrevious);\n        }\n\n        this.user = null;\n        if (this.client) {\n            // this.client.setClientId(null);\n            this.client.logout();\n        }\n        this.accessToken = null;\n        this.idToken = null;\n        this.refreshToken = null;\n        this.states = {}; // new Map<string, boolean>();\n    }\n\n    setClient(client: Client): void {\n\n        this.client = client;\n        if (!this.user) {\n            this.user = {};\n        }\n\n        // this._user._id = this._client.clientId;\n        this.user._name = JSON.parse(this.getIdPayload({name: ''})).name;\n    }\n\n    setUser(user: any): void {\n        this.user = user;\n        if (this.client && this.user._id) {\n            this.client.setClientId(this.user._id);\n\n            // store only clientId\n            delete this.user._id;\n        }\n    }\n\n    getUser(): any {\n        return this.user;\n    }\n\n    getClient(): Client {\n        return this.client;\n    }\n\n    setCryptoSalt(value: string) {\n        if (this.cryptoSalt !== value && this.cryptoSaltNext !== value) {\n            this.cryptoSaltNext = value;\n            this._storage.set(Connection._cryptoSaltNext, this.cryptoSaltNext);\n        }\n\n        if (!this.cryptoSalt) {\n            this.setCryptoSaltAsVerified();\n        }\n    }\n\n    setCryptoSaltAsVerified() {\n        if (this.cryptoSaltNext) {\n            this.cryptoSalt = this.cryptoSaltNext;\n            this._storage.set(Connection._cryptoSalt, this.cryptoSalt);\n        }\n        this.cryptoSaltNext = null;\n        this._storage.remove(Connection._cryptoSaltNext);\n    }\n\n    encrypt(data: any): string {\n\n        if (typeof data !== 'string') {\n            data = JSON.stringify(data);\n        } else {\n            const dataAsObj = {string: data};\n            data = JSON.stringify(dataAsObj);\n        }\n\n        if (this.fidjCrypto && this.cryptoSalt) {\n            const key = this.cryptoSalt;\n            return Xor.encrypt(data, key);\n        } else {\n            return data;\n        }\n    }\n\n    decrypt(data: string): any {\n        let decrypted = null;\n\n        try {\n            if (!decrypted && this.fidjCrypto && this.cryptoSaltNext) {\n                const key = this.cryptoSaltNext;\n                decrypted = Xor.decrypt(data, key);\n                decrypted = JSON.parse(decrypted);\n                // if (decrypted) {\n                //    this.setCryptoSaltAsVerified();\n                // }\n            }\n        } catch (err) {\n            decrypted = null;\n        }\n\n        try {\n            if (!decrypted && this.fidjCrypto && this.cryptoSalt) {\n                const key = this.cryptoSalt;\n                decrypted = Xor.decrypt(data, key);\n                decrypted = JSON.parse(decrypted);\n            }\n        } catch (err) {\n            decrypted = null;\n        }\n\n        try {\n            if (!decrypted && this.fidjCrypto && this.cryptoSalt) {\n                const key = this.cryptoSalt;\n                decrypted = Xor.decrypt(data, key, true);\n                decrypted = JSON.parse(decrypted);\n            }\n        } catch (err) {\n            decrypted = null;\n        }\n\n\n        try {\n\n            if (!decrypted) {\n                decrypted = JSON.parse(data);\n            }\n\n            if (decrypted && decrypted.string) {\n                decrypted = decrypted.string;\n            }\n\n        } catch (err) {\n            decrypted = null;\n        }\n\n        return decrypted;\n    }\n\n    isLogin(): boolean {\n        let exp = true;\n        try {\n            const payload = this.refreshToken.split('.')[1];\n            const decoded = JSON.parse(Base64.decode(payload));\n            exp = ((new Date().getTime() / 1000) >= decoded.exp);\n\n        } catch (e) {\n        }\n        return !exp;\n    }\n\n    // todo reintegrate client.login()\n\n    logout(): Promise<void | ErrorInterface> {\n        return this.getClient().logout(this.refreshToken);\n    }\n\n    getClientId(): string {\n        if (!this.client) {\n            return null;\n        }\n        return this.client.clientId;\n    }\n\n    getIdToken(): string {\n        return this.idToken;\n    }\n\n    getIdPayload(def?: any): string {\n        if (def && typeof def !== 'string') {\n            def = JSON.stringify(def);\n        }\n\n        try {\n            const payload = this.getIdToken().split('.')[1];\n            if (payload) {\n                return Base64.decode(payload);\n            }\n        } catch (e) {\n            this._logger.log('fidj.connection.getIdPayload pb: ', def, e);\n        }\n        return def ? def : null;\n    }\n\n    getAccessPayload(def?: any): string {\n        if (def && typeof def !== 'string') {\n            def = JSON.stringify(def);\n        }\n\n        try {\n            const payload = this.accessToken.split('.')[1];\n            if (payload) {\n                return Base64.decode(payload);\n            }\n        } catch (e) {\n        }\n        return def ? def : null;\n    }\n\n    getPreviousAccessPayload(def?: any): string {\n        if (def && typeof def !== 'string') {\n            def = JSON.stringify(def);\n        }\n\n        try {\n            const payload = this.accessTokenPrevious.split('.')[1];\n            if (payload) {\n                return Base64.decode(payload);\n            }\n        } catch (e) {\n        }\n        return def ? def : null;\n    }\n\n    refreshConnection(): Promise<any | ErrorInterface> {\n\n        // store states\n        this._storage.set(Connection._states, this.states);\n\n        // token not expired : ok\n        if (this.accessToken) {\n            const payload = this.accessToken.split('.')[1];\n            const decoded = Base64.decode(payload);\n            const notExpired = (new Date().getTime() / 1000) < JSON.parse(decoded).exp;\n            // console.log('new Date().getTime() < JSON.parse(decoded).exp :', (new Date().getTime() / 1000), JSON.parse(decoded).exp);\n            this._logger.log('fidj.connection.connection.refreshConnection : token not expired ? ', notExpired);\n            if (notExpired) {\n                return Promise.resolve(this.getUser());\n            }\n        }\n\n        // remove expired refreshToken\n        if (this.refreshToken) {\n            const payload = this.refreshToken.split('.')[1];\n            const decoded = Base64.decode(payload);\n            const expired = (new Date().getTime() / 1000) >= JSON.parse(decoded).exp;\n            this._logger.log('fidj.connection.connection.refreshConnection : refreshToken not expired ? ', expired);\n            if (expired) {\n                this._storage.remove(Connection._refreshToken);\n            }\n        }\n\n        // remove expired accessToken & idToken & store it as Previous one\n        this.accessTokenPrevious = this.accessToken;\n        this._storage.set('v2.accessTokenPrevious', this.accessTokenPrevious);\n        this._storage.remove(Connection._accessToken);\n        this._storage.remove(Connection._idToken);\n        this.accessToken = null;\n        this.idToken = null;\n\n        // refresh authentication\n        this._logger.log('fidj.connection.connection.refreshConnection : refresh authentication.');\n        return new Promise((resolve, reject) => {\n            const client = this.getClient();\n\n            if (!client) {\n                return reject(new Error(400, 'Need an initialized client.'))\n            }\n\n            this.getClient().reAuthenticate(this.refreshToken)\n                .then(user => {\n                    this.setConnection(user);\n                    resolve(this.getUser());\n                })\n                .catch(err => {\n\n                    // if (err && err.code === 408) {\n                    //     code = 408; // no api uri or basic timeout : offline\n                    // } else if (err && err.code === 404) {\n                    //     code = 404; // page not found : offline\n                    // } else if (err && err.code === 410) {\n                    //     code = 403; // token expired or device not sure : need relogin\n                    // } else if (err) {\n                    //     code = 403; // forbidden : need relogin\n                    // }\n\n                    // resolve(code);\n                    reject(err);\n                });\n        });\n    };\n\n    setConnection(clientUser: any): void {\n\n        // only in private storage\n        if (clientUser.access_token) {\n            this.accessToken = clientUser.access_token;\n            this._storage.set(Connection._accessToken, this.accessToken);\n            delete clientUser.access_token;\n\n            const salt: string = JSON.parse(this.getAccessPayload({salt: ''})).salt;\n            if (salt) {\n                this.setCryptoSalt(salt);\n            }\n        }\n        if (clientUser.id_token) {\n            this.idToken = clientUser.id_token;\n            this._storage.set(Connection._idToken, this.idToken);\n            delete clientUser.id_token;\n        }\n        if (clientUser.refresh_token) {\n            this.refreshToken = clientUser.refresh_token;\n            this._storage.set(Connection._refreshToken, this.refreshToken);\n            delete clientUser.refresh_token;\n        }\n\n        // store changed states\n        this._storage.set(Connection._states, this.states);\n\n        // expose roles, message\n        // clientUser.roles = self.fidjRoles();\n        // clientUser.message = self.fidjMessage();\n        clientUser.roles = JSON.parse(this.getIdPayload({roles: []})).roles;\n        clientUser.message = JSON.parse(this.getIdPayload({message: ''})).message;\n        this.setUser(clientUser);\n    };\n\n    setConnectionOffline(options: ModuleServiceLoginOptionsInterface): void {\n\n        if (options.accessToken) {\n            this.accessToken = options.accessToken;\n            this._storage.set(Connection._accessToken, this.accessToken);\n        }\n        if (options.idToken) {\n            this.idToken = options.idToken;\n            this._storage.set(Connection._idToken, this.idToken);\n        }\n        if (options.refreshToken) {\n            this.refreshToken = options.refreshToken;\n            this._storage.set(Connection._refreshToken, this.refreshToken);\n        }\n\n        this.setUser({\n            roles: JSON.parse(this.getIdPayload({roles: []})).roles,\n            message: JSON.parse(this.getIdPayload({message: ''})).message,\n            _id: 'demo'\n        });\n    }\n\n    getApiEndpoints(options?: ConnectionFindOptionsInterface): Array<EndpointInterface> {\n\n        // todo : let ea = ['https://fidj/api', 'https://fidj-proxy.herokuapp.com/api'];\n        let ea: EndpointInterface[] = [\n            {key: 'fidj.default', url: 'https://fidj.ovh/api', blocked: false}];\n        let filteredEa = [];\n\n        if (!this._sdk.prod) {\n            ea = [\n                {key: 'fidj.default', url: 'http://localhost:3201/api', blocked: false},\n                {key: 'fidj.default', url: 'https://fidj-sandbox.herokuapp.com/api', blocked: false}\n            ];\n        }\n\n        if (this.accessToken) {\n            const val = this.getAccessPayload({apis: []});\n            const apiEndpoints: EndpointInterface[] = JSON.parse(val).apis;\n            if (apiEndpoints && apiEndpoints.length) {\n                ea = [];\n                apiEndpoints.forEach((endpoint) => {\n                    if (endpoint.url) {\n                        ea.push(endpoint);\n                    }\n                });\n            }\n        }\n\n        if (this.accessTokenPrevious) {\n            const apiEndpoints: EndpointInterface[] = JSON.parse(this.getPreviousAccessPayload({apis: []})).apis;\n            if (apiEndpoints && apiEndpoints.length) {\n                apiEndpoints.forEach((endpoint) => {\n                    if (endpoint.url && ea.filter((r) => r.url === endpoint.url).length === 0) {\n                        ea.push(endpoint);\n                    }\n                });\n            }\n        }\n\n        this._logger.log('fidj.sdk.connection.getApiEndpoints : ', ea);\n\n        let couldCheckStates = true;\n        if (this.states && Object.keys(this.states).length) {\n            for (let i = 0; (i < ea.length) && couldCheckStates; i++) {\n                if (!this.states[ea[i].url]) {\n                    couldCheckStates = false;\n                }\n            }\n        } else {\n            couldCheckStates = false;\n        }\n\n        if (options && options.filter) {\n\n            if (couldCheckStates && options.filter === 'theBestOne') {\n                for (let i = 0; (i < ea.length) && (filteredEa.length === 0); i++) {\n                    const endpoint = ea[i];\n                    if (this.states[endpoint.url] &&\n                        this.states[endpoint.url].state) {\n                        filteredEa.push(endpoint);\n                    }\n                }\n            } else if (couldCheckStates && options.filter === 'theBestOldOne') {\n                let bestOldOne: EndpointInterface;\n                for (let i = 0; (i < ea.length); i++) {\n                    const endpoint = ea[i];\n                    if (this.states[endpoint.url] &&\n                        this.states[endpoint.url].lastTimeWasOk &&\n                        (!bestOldOne || this.states[endpoint.url].lastTimeWasOk > this.states[bestOldOne.url].lastTimeWasOk)) {\n\n                        bestOldOne = endpoint;\n                    }\n                }\n                if (bestOldOne) {\n                    filteredEa.push(bestOldOne);\n                }\n            } else if (ea.length) {\n                filteredEa.push(ea[0]);\n            }\n        } else {\n            filteredEa = ea;\n        }\n\n        return filteredEa;\n    };\n\n    getDBs(options?: ConnectionFindOptionsInterface): EndpointInterface[] {\n\n        if (!this.accessToken) {\n            return [];\n        }\n\n        // todo test random DB connection\n        const random = Math.random() % 2;\n        let dbs = JSON.parse(this.getAccessPayload({dbs: []})).dbs || [];\n\n        // need to synchronize db\n        if (random === 0) {\n            dbs = dbs.sort();\n        } else if (random === 1) {\n            dbs = dbs.reverse();\n        }\n\n        let filteredDBs = [];\n        let couldCheckStates = true;\n        if (this.states && Object.keys(this.states).length) {\n            for (let i = 0; (i < dbs.length) && couldCheckStates; i++) {\n                if (!this.states[dbs[i].url]) {\n                    couldCheckStates = false;\n                }\n            }\n        } else {\n            couldCheckStates = false;\n        }\n\n        if (couldCheckStates && options && options.filter === 'theBestOne') {\n            for (let i = 0; (i < dbs.length) && (filteredDBs.length === 0); i++) {\n                const endpoint = dbs[i];\n                if (this.states[endpoint.url] &&\n                    this.states[endpoint.url].state) {\n                    filteredDBs.push(endpoint);\n                }\n            }\n        } else if (couldCheckStates && options && options.filter === 'theBestOnes') {\n            for (let i = 0; (i < dbs.length); i++) {\n                const endpoint = dbs[i];\n                if (this.states[endpoint.url] &&\n                    this.states[endpoint.url].state) {\n                    filteredDBs.push(endpoint);\n                }\n            }\n        } else if (options && options.filter === 'theBestOne' && dbs.length) {\n            filteredDBs.push(dbs[0]);\n        } else {\n            filteredDBs = dbs;\n        }\n\n        return filteredDBs;\n    };\n\n    private async verifyApiState(currentTime: number, endpointUrl: string) {\n\n        try {\n\n            this._logger.log('fidj.sdk.connection.verifyApiState : ', currentTime, endpointUrl);\n\n            const data = await new Ajax()\n                .get({\n                    url: endpointUrl + '/status?isok=' + this._sdk.version,\n                    headers: {'Content-Type': 'application/json', 'Accept': 'application/json'}\n                });\n\n            let state = false;\n            if (data && data.isok) {\n                state = true;\n            }\n            this.states[endpointUrl] = {state: state, time: currentTime, lastTimeWasOk: currentTime};\n\n            this._logger.log('fidj.sdk.connection.verifyApiState > states : ', this.states);\n\n        } catch (err) {\n            let lastTimeWasOk = 0;\n            if (this.states[endpointUrl]) {\n                lastTimeWasOk = this.states[endpointUrl].lastTimeWasOk;\n            }\n            this.states[endpointUrl] = {state: false, time: currentTime, lastTimeWasOk: lastTimeWasOk};\n\n            this._logger.log('fidj.sdk.connection.verifyApiState > catch pb  - states : ', err, this.states);\n        }\n    }\n\n    private async verifyDbState(currentTime: number, dbEndpoint: string) {\n\n        try {\n            // console.log('verifyDbState: ', dbEndpoint);\n            const data = await new Ajax()\n                .get({\n                    url: dbEndpoint,\n                    headers: {'Content-Type': 'application/json', 'Accept': 'application/json'}\n                });\n\n            this.states[dbEndpoint] = {state: true, time: currentTime, lastTimeWasOk: currentTime};\n            // resolve();\n            // console.log('verifyDbState: state', dbEndpoint, true);\n\n        } catch (err) {\n            let lastTimeWasOk = 0;\n            if (this.states[dbEndpoint]) {\n                lastTimeWasOk = this.states[dbEndpoint].lastTimeWasOk;\n            }\n            this.states[dbEndpoint] = {state: false, time: currentTime, lastTimeWasOk: lastTimeWasOk};\n            // resolve();\n        }\n    }\n\n    verifyConnectionStates(): Promise<any | ErrorInterface> {\n\n        const currentTime = new Date().getTime();\n\n        // todo need verification ? not yet (cache)\n        // if (Object.keys(this.states).length > 0) {\n        //     const time = this.states[Object.keys(this.states)[0]].time;\n        //     if (currentTime < time) {\n        //         return Promise.resolve();\n        //     }\n        // }\n\n        // verify via GET status on Endpoints & DBs\n        const promises = [];\n        // this.states = {};\n        this.apis = this.getApiEndpoints();\n        this.apis.forEach((endpointObj) => {\n            let endpointUrl: string = endpointObj.url;\n            if (!endpointUrl) {\n                endpointUrl = endpointObj.toString();\n            }\n            promises.push(this.verifyApiState(currentTime, endpointUrl));\n        });\n\n        const dbs = this.getDBs();\n        dbs.forEach((dbEndpointObj) => {\n            let dbEndpoint: string = dbEndpointObj.url;\n            if (!dbEndpoint) {\n                dbEndpoint = dbEndpointObj.toString();\n            }\n            promises.push(this.verifyDbState(currentTime, dbEndpoint));\n        });\n        return Promise.all(promises);\n    };\n\n}\n","import {\n    LoggerInterface, LoggerLevelEnum\n} from './interfaces';\n\nexport class LoggerService implements LoggerInterface {\n\n    constructor(private level?: LoggerLevelEnum) {\n        if (!level) {\n            this.level = LoggerLevelEnum.ERROR;\n        }\n\n        if (typeof console === 'undefined') {\n            this.level = LoggerLevelEnum.NONE;\n        }\n    }\n\n    log(message: string, args: [any]) {\n        if (this.level === LoggerLevelEnum.LOG) {\n            console.log(message, args);\n        }\n    }\n\n    warn(message: string, args: [any]) {\n        if (this.level === LoggerLevelEnum.LOG || this.level === LoggerLevelEnum.WARN) {\n            console.warn(message, args);\n        }\n    }\n\n    error(message: string, args: [any]) {\n        if (this.level === LoggerLevelEnum.LOG || this.level === LoggerLevelEnum.WARN || this.level === LoggerLevelEnum.ERROR) {\n            console.error(message, args);\n        }\n    }\n\n    setLevel(level: LoggerLevelEnum) {\n        this.level = level;\n    }\n}\n\n","// import PouchDB from 'pouchdb';\n// import * as PouchDB from 'pouchdb/dist/pouchdb.js';\n// import PouchDB from 'pouchdb/dist/pouchdb.js';\nimport * as version from '../version';\nimport * as tools from '../tools';\nimport * as connection from '../connection';\nimport * as session from '../session';\nimport {\n    LoggerInterface,\n    ModuleServiceInitOptionsInterface,\n    ModuleServiceLoginOptionsInterface,\n    SdkInterface,\n    ErrorInterface, EndpointInterface, EndpointFilterInterface\n} from './interfaces';\nimport {SessionCryptoInterface} from '../session/session';\nimport {Error} from './error';\nimport {Ajax} from '../connection/ajax';\nimport {LoggerService} from './logger.service';\n\nconst urljoin = require('url-join');\n// import {LocalStorage} from 'node-localstorage';\n// import 'localstorage-polyfill/localStorage';\n\n// const PouchDB = window['PouchDB'] || require('pouchdb').default;\n\n/**\n * please use its angular.js or angular.io wrapper\n * usefull only for fidj dev team\n */\nexport class InternalService {\n\n    private sdk: SdkInterface;\n    private logger: LoggerInterface;\n    private promise: PromiseConstructor;\n    private storage: tools.LocalStorage;\n    private session: session.Session;\n    private connection: connection.Connection;\n\n    constructor(logger: LoggerInterface, promise: PromiseConstructor, options?: ModuleServiceInitOptionsInterface) {\n\n        this.sdk = {\n            org: 'fidj',\n            version: version.version,\n            prod: false,\n            useDB: true\n        };\n        if (promise) {\n            this.promise = promise;\n        }\n        if (logger) {\n            this.logger = logger;\n        } else {\n            this.logger = new LoggerService();\n        }\n        if (options && options.logLevel) {\n            this.logger.setLevel(options.logLevel);\n        }\n\n        this.logger.log('fidj.sdk.service : constructor');\n        let ls;\n        if (typeof window !== 'undefined') {\n            ls = window.localStorage;\n        } else if (typeof global !== 'undefined') {\n            require('localstorage-polyfill');\n            ls = global['localStorage'];\n        }\n        this.storage = new tools.LocalStorage(ls, 'fidj.');\n        this.session = new session.Session();\n        this.connection = new connection.Connection(this.sdk, this.storage, this.logger);\n    }\n\n    /**\n     * Init connection & session\n     * Check uri\n     * Done each app start\n     *\n     * @param options Optional settings\n     * @param options.fidjId  required use your customized endpoints\n     * @param options.fidjSalt required use your customized endpoints\n     * @param options.fidjVersion required use your customized endpoints\n     * @param options.devMode optional default false, use your customized endpoints\n     * @returns\n     */\n    public fidjInit(fidjId: string, options?: ModuleServiceInitOptionsInterface): Promise<void | ErrorInterface> {\n\n        const self = this;\n        /*\n        if (options && options.forcedEndpoint) {\n            this.fidjService.setAuthEndpoint(options.forcedEndpoint);\n        }\n        if (options && options.forcedDBEndpoint) {\n            this.fidjService.setDBEndpoint(options.forcedDBEndpoint);\n        }*/\n        if (options && options.logLevel) {\n            self.logger.setLevel(options.logLevel);\n        }\n\n        self.logger.log('fidj.sdk.service.fidjInit : ', options);\n        if (!fidjId) {\n            self.logger.error('fidj.sdk.service.fidjInit : bad init');\n            return self.promise.reject(new Error(400, 'Need a fidjId'));\n        }\n\n        self.sdk.prod = !options ? true : options.prod;\n        self.sdk.useDB = !options ? true : options.useDB;\n        self.connection.fidjId = fidjId;\n        self.connection.fidjVersion = self.sdk.version;\n        self.connection.fidjCrypto = (!options || !options.hasOwnProperty('crypto')) ? true : options.crypto;\n\n        return new self.promise((resolve, reject) => {\n            self.connection.verifyConnectionStates()\n                .then(() => {\n\n                    let theBestUrl: any = self.connection.getApiEndpoints({filter: 'theBestOne'})[0];\n                    let theBestOldUrl: any = self.connection.getApiEndpoints({filter: 'theBestOldOne'})[0];\n                    const isLogin = self.fidjIsLogin();\n                    self.logger.log('fidj.sdk.service.fidjInit > verifyConnectionStates : ', theBestUrl, theBestOldUrl, isLogin);\n\n                    if (theBestUrl && theBestUrl.url) {\n                        theBestUrl = theBestUrl.url;\n                    }\n                    if (theBestOldUrl && theBestOldUrl.url) {\n                        theBestOldUrl = theBestOldUrl.url;\n                    }\n\n                    if (theBestUrl) {\n                        self.connection.setClient(new connection.Client(self.connection.fidjId, theBestUrl, self.storage, self.sdk));\n                        resolve();\n                    } else if (isLogin && theBestOldUrl) {\n                        self.connection.setClient(new connection.Client(self.connection.fidjId, theBestOldUrl, self.storage, self.sdk));\n                        resolve();\n                    } else {\n                        reject(new Error(404, 'Need one connection - or too old SDK version (check update)'));\n                    }\n\n                })\n                .catch((err) => {\n                    self.logger.error('fidj.sdk.service.fidjInit: ', err);\n                    reject(new Error(500, err.toString()));\n                });\n        });\n    };\n\n    /**\n     * Call it if fidjIsLogin() === false\n     * Erase all (db & storage)\n     *\n     * @param login\n     * @param password\n     * @returns\n     */\n    public fidjLogin(login: string, password: string): Promise<any | ErrorInterface> {\n        const self = this;\n        self.logger.log('fidj.sdk.service.fidjLogin');\n        if (!self.connection.isReady()) {\n            return self.promise.reject(new Error(404, 'Need an intialized FidjService'));\n        }\n\n        return new self.promise((resolve, reject) => {\n            self._removeAll()\n                .then(() => {\n                    return self.connection.verifyConnectionStates();\n                })\n                .then(() => {\n                    return self._createSession(self.connection.fidjId);\n                })\n                .then(() => {\n                    return self._loginInternal(login, password);\n                })\n                .then((user) => {\n                    self.connection.setConnection(user);\n\n                    if (!self.sdk.useDB) {\n                        resolve(self.connection.getUser());\n                    } else {\n                        self.session.sync(self.connection.getClientId())\n                            .then(() => resolve(self.connection.getUser()))\n                            .catch((err) => resolve(self.connection.getUser()));\n                    }\n                })\n                .catch((err) => {\n                    self.logger.error('fidj.sdk.service.fidjLogin: ', err.toString());\n                    reject(err);\n                });\n        });\n    };\n\n    /**\n     *\n     * @param options\n     * @param options.accessToken optional\n     * @param options.idToken  optional\n     * @returns\n     */\n    public fidjLoginInDemoMode(options?: ModuleServiceLoginOptionsInterface): Promise<any | ErrorInterface> {\n        const self = this;\n\n        // generate one day tokens if not set\n        if (!options || !options.accessToken) {\n            const now = new Date();\n            now.setDate(now.getDate() + 1);\n            const tomorrow = now.getTime();\n            const payload = tools.Base64.encode(JSON.stringify({\n                roles: [],\n                message: 'demo',\n                apis: [],\n                endpoints: [],\n                dbs: [],\n                exp: tomorrow\n            }));\n            const jwtSign = tools.Base64.encode(JSON.stringify({}));\n            const token = jwtSign + '.' + payload + '.' + jwtSign;\n            options = {\n                accessToken: token,\n                idToken: token,\n                refreshToken: token\n            };\n        }\n\n        return new self.promise((resolve, reject) => {\n            self._removeAll()\n                .then(() => {\n                    return self._createSession(self.connection.fidjId);\n                })\n                .then(() => {\n                    self.connection.setConnectionOffline(options);\n                    resolve(self.connection.getUser());\n                })\n                .catch((err) => {\n                    self.logger.error('fidj.sdk.service.fidjLoginInDemoMode error: ', err);\n                    reject(err);\n                });\n        });\n    };\n\n    public fidjGetEndpoints(filter?: EndpointFilterInterface): Array<EndpointInterface> {\n\n        if (!filter) {\n            filter = {showBlocked: false};\n        }\n        const ap = this.connection.getAccessPayload({endpoints: []});\n        let endpoints = JSON.parse(ap).endpoints;\n        if (!endpoints || !Array.isArray(endpoints)) {\n            return [];\n        }\n\n        endpoints = endpoints.filter((endpoint: EndpointInterface) => {\n            let ok = true;\n            if (ok && filter.key) {\n                ok = (endpoint.key === filter.key);\n            }\n            if (ok && !filter.showBlocked) {\n                ok = !endpoint.blocked;\n            }\n            return ok;\n        });\n        return endpoints;\n    };\n\n    public fidjRoles(): Array<string> {\n        return JSON.parse(this.connection.getIdPayload({roles: []})).roles;\n    };\n\n    public fidjMessage(): string {\n        return JSON.parse(this.connection.getIdPayload({message: ''})).message;\n    };\n\n    public fidjIsLogin(): boolean {\n        return this.connection.isLogin();\n    };\n\n    public fidjLogout(force?: boolean): Promise<void | ErrorInterface> {\n        const self = this;\n        if (!self.connection.getClient() && !force) {\n            return self._removeAll()\n                .then(() => {\n                    return this.session.create(self.connection.fidjId, true);\n                });\n        }\n\n        return self.connection.logout()\n            .then(() => {\n                return self._removeAll();\n            })\n            .catch(() => {\n                return self._removeAll();\n            })\n            .then(() => {\n                return this.session.create(self.connection.fidjId, true);\n            });\n    };\n\n    /**\n     * Synchronize DB\n     *\n     *\n     * @param fnInitFirstData a function with db as input and that return promise: call if DB is empty\n     * @param fnInitFirstData_Arg arg to set to fnInitFirstData()\n     * @returns  promise\n     */\n    public fidjSync(fnInitFirstData?, fnInitFirstData_Arg?): Promise<void | ErrorInterface> {\n        const self = this;\n        self.logger.log('fidj.sdk.service.fidjSync');\n        // if (!self.session.isReady()) {\n        //    return self.promise.reject('fidj.sdk.service.fidjSync : DB sync impossible. Did you login ?');\n        // }\n\n        if (!self.sdk.useDB) {\n            self.logger.log('fidj.sdk.service.fidjSync: you ar not using DB - no sync available.');\n            return Promise.resolve();\n        }\n\n        const firstSync = (self.session.dbLastSync === null);\n\n        return new self.promise((resolve, reject) => {\n\n            self._createSession(self.connection.fidjId)\n                .then(() => {\n                    return self.session.sync(self.connection.getClientId());\n                })\n                .then(() => {\n                    self.logger.log('fidj.sdk.service.fidjSync resolved');\n                    return self.session.isEmpty();\n                })\n                .catch((err) => {\n                    self.logger.warn('fidj.sdk.service.fidjSync warn: ', err);\n                    return self.session.isEmpty();\n                })\n                .then((isEmpty) => {\n                    self.logger.log('fidj.sdk.service.fidjSync isEmpty : ', isEmpty, firstSync);\n\n                    return new self.promise((resolveEmpty, rejectEmptyNotUsed) => {\n                        if (isEmpty && firstSync && fnInitFirstData) {\n                            const ret = fnInitFirstData(fnInitFirstData_Arg);\n                            if (ret && ret['catch'] instanceof Function) {\n                                ret.then(resolveEmpty).catch(reject);\n                            }\n                            if (typeof ret === 'string') {\n                                self.logger.log(ret);\n                            }\n                        }\n                        resolveEmpty(); // self.connection.getUser());\n                    });\n                })\n                .then((info) => {\n                    self.logger.log('fidj.sdk.service.fidjSync fnInitFirstData resolved: ', info);\n                    self.session.dbLastSync = new Date().getTime();\n                    return self.session.info();\n                })\n                .then((result: any) => {\n                    self.session.dbRecordCount = 0;\n                    if (result && result.doc_count) {\n                        self.session.dbRecordCount = result.doc_count;\n                    }\n                    self.logger.log('fidj.sdk.service.fidjSync _dbRecordCount : ' + self.session.dbRecordCount);\n\n                    return self.connection.refreshConnection();\n                })\n                .then((user) => {\n                    self.logger.log('fidj.sdk.service.fidjSync refreshConnection done : ', user);\n                    resolve(); // self.connection.getUser()\n                })\n                .catch((err: ErrorInterface) => {\n                    // console.error(err);\n                    self.logger.warn('fidj.sdk.service.fidjSync refreshConnection failed : ', err);\n\n                    if (err && (err.code === 403 || err.code === 410)) {\n                        this.fidjLogout()\n                            .then(() => {\n                                reject({code: 403, reason: 'Synchronization unauthorized : need to login again.'});\n                            })\n                            .catch(() => {\n                                reject({code: 403, reason: 'Synchronization unauthorized : need to login again..'});\n                            });\n                    } else if (err && err.code) {\n                        // todo what to do with this err ?\n                        resolve();\n                    } else {\n                        const errMessage = 'Error during synchronisation: ' + err.toString();\n                        self.logger.error(errMessage);\n                        reject({code: 500, reason: errMessage});\n                    }\n                })\n            ;\n        });\n    };\n\n    public fidjPutInDb(data: any): Promise<string | ErrorInterface> {\n        const self = this;\n        self.logger.log('fidj.sdk.service.fidjPutInDb: ', data);\n        if (!self.sdk.useDB) {\n            self.logger.log('fidj.sdk.service.fidjPutInDb: you are not using DB - no put available.');\n            return Promise.resolve('NA');\n        }\n\n        if (!self.connection.getClientId()) {\n            return self.promise.reject(new Error(401, 'DB put impossible. Need a user logged in.'));\n        }\n        if (!self.session.isReady()) {\n            return self.promise.reject(new Error(400, 'Need to be synchronised.'));\n        }\n\n        let _id: string;\n        if (data && typeof data === 'object' && Object.keys(data).indexOf('_id')) {\n            _id = data._id;\n        }\n        if (!_id) {\n            _id = self._generateObjectUniqueId(self.connection.fidjId);\n        }\n        let crypto: SessionCryptoInterface;\n        if (self.connection.fidjCrypto) {\n            crypto = {\n                obj: self.connection,\n                method: 'encrypt'\n            }\n        }\n\n        return self.session.put(\n            data,\n            _id,\n            self.connection.getClientId(),\n            self.sdk.org,\n            self.connection.fidjVersion,\n            crypto);\n    };\n\n    public fidjRemoveInDb(data_id: string): Promise<void | ErrorInterface> {\n        const self = this;\n        self.logger.log('fidj.sdk.service.fidjRemoveInDb ', data_id);\n        if (!self.sdk.useDB) {\n            self.logger.log('fidj.sdk.service.fidjRemoveInDb: you are not using DB - no remove available.');\n            return Promise.resolve();\n        }\n\n        if (!self.session.isReady()) {\n            return self.promise.reject(new Error(400, 'Need to be synchronised.'));\n        }\n\n        if (!data_id || typeof data_id !== 'string') {\n            return self.promise.reject(new Error(400, 'DB remove impossible. ' +\n                'Need the data._id.'));\n        }\n\n        return self.session.remove(data_id);\n    };\n\n    public fidjFindInDb(data_id: string): Promise<any | ErrorInterface> {\n        const self = this;\n\n        if (!self.sdk.useDB) {\n            self.logger.log('fidj.sdk.service.fidjFindInDb: you are not using DB - no find available.');\n            return Promise.resolve();\n        }\n\n        if (!self.connection.getClientId()) {\n            return self.promise.reject(new Error(401, 'Find pb : need a user logged in.'));\n        }\n        if (!self.session.isReady()) {\n            return self.promise.reject(new Error(400, ' Need to be synchronised.'));\n        }\n\n        let crypto: SessionCryptoInterface;\n        if (self.connection.fidjCrypto) {\n            crypto = {\n                obj: self.connection,\n                method: 'decrypt'\n            };\n        }\n\n        return self.session.get(data_id, crypto);\n    };\n\n    public fidjFindAllInDb(): Promise<Array<any> | ErrorInterface> {\n        const self = this;\n\n        if (!self.sdk.useDB) {\n            self.logger.log('fidj.sdk.service.fidjFindAllInDb: you are not using DB - no find available.');\n            return Promise.resolve([]);\n        }\n\n        if (!self.connection.getClientId()) {\n            return self.promise.reject(new Error(401, 'Need a user logged in.'));\n        }\n        if (!self.session.isReady()) {\n            return self.promise.reject(new Error(400, 'Need to be synchronised.'));\n        }\n\n        let crypto: SessionCryptoInterface;\n        if (self.connection.fidjCrypto) {\n            crypto = {\n                obj: self.connection,\n                method: 'decrypt'\n            };\n        }\n\n        return self.session.getAll(crypto)\n            .then(results => {\n                self.connection.setCryptoSaltAsVerified();\n                return self.promise.resolve((results as Array<any>));\n            });\n    };\n\n    public fidjSendOnEndpoint(key: string, verb: string, relativePath: string, data: any): Promise<any | ErrorInterface> {\n        const filter: EndpointFilterInterface = {\n            key: key\n        };\n        const endpoints = this.fidjGetEndpoints(filter);\n        if (!endpoints || endpoints.length !== 1) {\n            return this.promise.reject(\n                new Error(400,\n                    'fidj.sdk.service.fidjSendOnEndpoint : endpoint does not exist.'));\n        }\n\n        let endpointUrl = endpoints[0].url;\n        if (relativePath) {\n            endpointUrl = urljoin(endpointUrl, relativePath);\n        }\n        const jwt = this.connection.getIdToken();\n        let answer;\n        const query = new Ajax();\n        switch (verb) {\n            case 'POST' :\n                answer = query.post({\n                    url: endpointUrl,\n                    // not used : withCredentials: true,\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Accept': 'application/json',\n                        'Authorization': 'Bearer ' + jwt\n                    },\n                    data: data\n                });\n                break;\n            case 'PUT' :\n                answer = query.put({\n                    url: endpointUrl,\n                    // not used : withCredentials: true,\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Accept': 'application/json',\n                        'Authorization': 'Bearer ' + jwt\n                    },\n                    data: data\n                });\n                break;\n            case 'DELETE' :\n                answer = query.delete({\n                    url: endpointUrl,\n                    // not used : withCredentials: true,\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Accept': 'application/json',\n                        'Authorization': 'Bearer ' + jwt\n                    },\n                    // not used: data: data\n                });\n                break;\n            default:\n                answer = query.get({\n                    url: endpointUrl,\n                    // not used : withCredentials: true,\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Accept': 'application/json',\n                        'Authorization': 'Bearer ' + jwt\n                    },\n                    // not used: data: data\n                });\n        }\n        return answer;\n    };\n\n    public fidjGetIdToken(): string {\n        return this.connection.getIdToken();\n    };\n\n    // Internal functions\n\n    /**\n     * Logout then Login\n     *\n     * @param login\n     * @param password\n     * @param updateProperties\n     */\n    private _loginInternal(login: string, password: string, updateProperties?: any): Promise<any | ErrorInterface> {\n        const self = this;\n        self.logger.log('fidj.sdk.service._loginInternal');\n        if (!self.connection.isReady()) {\n            return self.promise.reject(new Error(403, 'Need an intialized FidjService'));\n        }\n\n        return new self.promise((resolve, reject) => {\n\n                self.connection.logout()\n                    .then(() => {\n                        return self.connection.getClient().login(login, password, updateProperties);\n                    })\n                    .catch((err) => {\n                        return self.connection.getClient().login(login, password, updateProperties);\n                    })\n                    .then(loginUser => {\n                        loginUser.email = login;\n                        resolve(loginUser);\n                    })\n                    .catch(err => {\n                        self.logger.error('fidj.sdk.service._loginInternal error : ' + err);\n                        reject(err);\n                    });\n            }\n        );\n    };\n\n    protected _removeAll(): Promise<void | ErrorInterface> {\n        this.connection.destroy();\n        return this.session.destroy();\n    };\n\n    private _createSession(uid: string): Promise<void | ErrorInterface> {\n        const dbs: EndpointInterface[] = this.connection.getDBs({filter: 'theBestOnes'});\n        if (!dbs || dbs.length === 0) {\n            this.logger.warn('Seems that you are in Demo mode or using Node (no remote DB).');\n        }\n        this.session.setRemote(dbs);\n        return this.session.create(uid);\n    };\n\n    private _testPromise(a?): Promise<any> {\n        if (a) {\n            return this.promise.resolve('test promise ok ' + a);\n        }\n        return new this.promise((resolve, reject) => {\n            resolve('test promise ok');\n        });\n    };\n\n    private static _srvDataUniqId = 0;\n\n    private _generateObjectUniqueId(appName, type?, name?) {\n\n        // return null;\n        const now = new Date();\n        const simpleDate = '' + now.getFullYear() + '' + now.getMonth() + '' + now.getDate()\n            + '' + now.getHours() + '' + now.getMinutes(); // new Date().toISOString();\n        const sequId = ++InternalService._srvDataUniqId;\n        let UId = '';\n        if (appName && appName.charAt(0)) {\n            UId += appName.charAt(0) + '';\n        }\n        if (type && type.length > 3) {\n            UId += type.substring(0, 4);\n        }\n        if (name && name.length > 3) {\n            UId += name.substring(0, 4);\n        }\n        UId += simpleDate + '' + sequId;\n        return UId;\n    }\n\n}\n","/* tslint:disable:max-line-length */\nimport {Injectable} from '@angular/core';\nimport {\n    EndpointInterface,\n    ErrorInterface,\n    LoggerInterface,\n    LoggerLevelEnum,\n    ModuleServiceInitOptionsInterface,\n    ModuleServiceInterface,\n    ModuleServiceLoginOptionsInterface\n} from './interfaces';\nimport {InternalService} from './internal.service';\nimport {Error as FidjError} from '../connection';\nimport {LoggerService} from './logger.service';\n\n/**\n * Angular2+ FidjService\n * @see ModuleServiceInterface\n *\n * @exemple\n *      // ... after install :\n *      // $ npm install --save-dev fidj\n *      // then init your app.js & use it in your services\n * TODO refresh gist :\n * <script src=\"https://gist.githubusercontent.com/mlefree/ad64f7f6a345856f6bf45fd59ca8db46/raw/5fff69dd9c15f692a856db62cf334b724ef3f4ac/angular.fidj.inject.js\"></script>\n *\n * <script src=\"https://gist.githubusercontent.com/mlefree/ad64f7f6a345856f6bf45fd59ca8db46/raw/5fff69dd9c15f692a856db62cf334b724ef3f4ac/angular.fidj.sync.js\"></script>\n *\n *\n */\n@Injectable()\nexport class FidjService implements ModuleServiceInterface {\n\n    private logger: LoggerInterface;\n    private fidjService: InternalService;\n    private promise: any;\n\n    constructor() {\n        this.logger = new LoggerService(LoggerLevelEnum.ERROR);\n        this.promise = Promise;\n        this.fidjService = null;\n        // let pouchdbRequired = PouchDB;\n        // pouchdbRequired.error();\n    };\n\n    public init(fidjId: string, options?: ModuleServiceInitOptionsInterface): Promise<void | ErrorInterface> {\n        if (!this.fidjService) {\n            this.fidjService = new InternalService(this.logger, this.promise);\n        }\n        return this.fidjService.fidjInit(fidjId, options);\n    };\n\n    public login(login: string, password: string): Promise<any | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(303, 'fidj.sdk.angular2.login : not initialized.'));\n        }\n        return this.fidjService.fidjLogin(login, password);\n    };\n\n    public loginAsDemo(options?: ModuleServiceLoginOptionsInterface): Promise<any | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(303, 'fidj.sdk.angular2.loginAsDemo : not initialized.'));\n        }\n        return this.fidjService.fidjLoginInDemoMode(options);\n    };\n\n    public isLoggedIn(): boolean {\n        if (!this.fidjService) {\n            return false; // this.promise.reject('fidj.sdk.angular2.isLoggedIn : not initialized.');\n        }\n        return this.fidjService.fidjIsLogin();\n    };\n\n    public getRoles(): Array<string> {\n        if (!this.fidjService) {\n            return [];\n        }\n        return this.fidjService.fidjRoles();\n    };\n\n    public getEndpoints(): Array<EndpointInterface> {\n        if (!this.fidjService) {\n            return [];\n        }\n        return this.fidjService.fidjGetEndpoints();\n    };\n\n    public sendOnEndpoint(key: string, verb: string, relativePath?: string, data?: any): Promise<any | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(303, 'fidj.sdk.angular2.loginAsDemo : not initialized.'));\n        }\n        return this.fidjService.fidjSendOnEndpoint(key, verb, relativePath, data);\n    };\n\n    public getIdToken(): string {\n        if (!this.fidjService) {\n            return;\n        }\n        return this.fidjService.fidjGetIdToken();\n    };\n\n    public getMessage(): string {\n        if (!this.fidjService) {\n            return '';\n        }\n        return this.fidjService.fidjMessage();\n    };\n\n    public logout(force?: boolean): Promise<void | ErrorInterface> {\n        if (force || !this.fidjService) {\n            return this.promise.reject(new FidjError(303, 'fidj.sdk.angular2.logout : not initialized.'));\n        }\n        return this.fidjService.fidjLogout(force);\n    };\n\n    /**\n     *\n     * Synchronize DB\n     * @param fnInitFirstData  a function with db as input and that return promise: call if DB is empty\n     * @returns promise with this.session.db\n     * @memberof fidj.angularService\n     *\n     * @example\n     *  let initDb = function() {\n     *     this.fidjService.put('my first row');\n     *  };\n     *  this.fidjService.sync(initDb)\n     *  .then(user => ...)\n     *  .catch(err => ...)\n     *\n     */\n    public sync(fnInitFirstData?): Promise<void | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(401, 'fidj.sdk.angular2.sync : not initialized.'));\n        }\n        return this.fidjService.fidjSync(fnInitFirstData, this);\n    };\n\n    /**\n     * Store data in your session\n     *\n     * @param data to store\n     * @returns\n     */\n    public put(data: any): Promise<string | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(401, 'fidj.sdk.angular2.put : not initialized.'));\n        }\n        return this.fidjService.fidjPutInDb(data);\n    };\n\n    /**\n     * Find object Id and remove it from your session\n     *\n     * @param id of object to find and remove\n     * @returns\n     */\n    public remove(id: string): Promise<void | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(401, 'fidj.sdk.angular2.remove : not initialized.'));\n        }\n        return this.fidjService.fidjRemoveInDb(id);\n    };\n\n    /**\n     * Find\n     */\n    public find(id: string): Promise<any | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(401, 'fidj.sdk.angular2.find : not initialized.'));\n        }\n        return this.fidjService.fidjFindInDb(id);\n    };\n\n    public findAll(): Promise<any[] | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(401, 'fidj.sdk.angular2.findAll : not initialized.'));\n        }\n        return this.fidjService.fidjFindAllInDb();\n    };\n\n}\n","import {ModuleWithProviders, NgModule} from '@angular/core';\nimport {CommonModule} from '@angular/common';\nimport {FidjService} from './angular.service';\n\n\n/**\n * `NgModule` which provides associated services.\n *\n * ...\n *\n * @stable\n */\n@NgModule({\n    imports: [\n        CommonModule\n    ],\n    declarations: [],\n\n    exports: [],\n\n    providers: [FidjService]\n})\nexport class FidjModule {\n    constructor() {\n    }\n}\n\n\n/**\n * module FidjModule\n *\n * exemple\n *      // ... after install :\n *      // $ npm install fidj\n *      // then init your app.js & use it in your services\n * TODO refresh gist :\n * <script src=\"https://gist.github.com/mlefree/ad64f7f6a345856f6bf45fd59ca8db46.js\"></script>\n *\n * <script src=\"https://gist.github.com/mlefree/ad64f7f6a345856f6bf45fd59ca8db46.js\"></script>\n */\n"]}