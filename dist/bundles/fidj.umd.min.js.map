{"version":3,"sources":["../../src/sdk/interfaces.ts","../../src/tools/base64.ts","../../src/tools/storage.ts","../../src/tools/xor.ts","../../src/sdk/error.ts","../../src/sdk/fidj.module.ts","../../src/version/index.ts","../../src/connection/ajax.ts","../../src/connection/client.ts","../../node_modules/tslib/tslib.es6.js","../../src/connection/connection.ts","../../src/session/session.ts","../../src/sdk/logger.service.ts","../../src/sdk/internal.service.ts","../../src/sdk/angular.service.ts"],"names":["LoggerLevelEnum","Base64","encode","input","window","btoa","require","encodeURIComponent","replace","match","p1","String","fromCharCode","parseInt","decode","_atob","atob","decodeURIComponent","split","map","c","charCodeAt","toString","slice","join","LocalStorage","storageService","storageKey","this","version","storage","localStorage","Error","prototype","set","key","value","checkKey","t","JSON","stringify","string","number","bool","TypeError","json","setItem","get","def","item","getItem","parse","valueOf","remove","existed","removeItem","clear","length","size","foreach","f","context","n","i","call","Xor","encrypt","result","header","keyCharAt","decrypt","oldStyle","substring","Math","floor","code","reason","equals","err","msg","NgModule","args","imports","CommonModule","declarations","exports","XhrErrorReason","Ajax","xhr","formatResponseData","response","dataParsed","data","e","formatError","error","errorFormatted","UNKNOWN","status","message","STATUS","TIMEOUT","request","post","opt","method","url","headers","timeout","then","res","Promise","reject","resolve","catch","put","delete","Client","appId","URI","sdk","uuid","_clientUuid","random","info","navigator","appName","appVersion","userAgent","setClientUuid","setClientInfo","clientId","_clientId","refreshCount","_refreshCount","refreshCountInitial","setClientId","clientUuid","clientInfo","login","password","updateProperties","_this","console","urlLogin","dataLogin","name","username","email","Content-Type","Accept","createdUser","_id","urlToken","dataToken","grant_type","client_id","client_secret","client_udid","client_info","audience","scope","Authorization","tools.Base64","reAuthenticate","refreshToken","refresh_token","refresh_extra","obj","logout","token","isReady","__awaiter","thisArg","_arguments","P","generator","fulfilled","step","next","rejected","done","apply","__generator","body","y","g","_","label","sent","trys","ops","verb","throw","return","Symbol","iterator","v","op","pop","push","Object","create","FidjPouch","Connection","_sdk","_storage","_logger","client","user","cryptoSalt","_cryptoSalt","cryptoSaltNext","_cryptoSaltNext","accessToken","_accessToken","accessTokenPrevious","idToken","_idToken","_refreshToken","states","_states","apis","destroy","force","_accessTokenPrevious","setClient","_name","getIdPayload","setUser","getUser","getClient","setCryptoSalt","setCryptoSaltAsVerified","dataAsObj","fidjCrypto","decrypted","isLogin","exp","payload","decoded","Date","getTime","getClientId","getIdToken","log","getAccessPayload","getPreviousAccessPayload","refreshConnection","notExpired","expired","setConnection","clientUser","access_token","salt","id_token","roles","setConnectionOffline","options","getApiEndpoints","ea","blocked","filteredEa","prod","apiEndpoints","val","forEach","endpoint","filter","r","couldCheckStates","keys","state","bestOldOne","lastTimeWasOk","getDBs","dbs","sort","reverse","filteredDBs","verifyApiState","currentTime","endpointUrl","_a","isOk","time","err_1","verifyDbState","dbEndpoint","verifyConnectionStates","promises","endpointObj","dbEndpointObj","all","default","PouchAdapterCordovaSqlite","plugin","Session","db","dbRecordCount","dbLastSync","remoteDb","uid","opts","location","adapter","setRemote","sync","userId","remoteUri","replicate","to","on","doc","fidjUserId","second","first","oid","ave","crypto","dataWithoutIds","toStore","fidjOrgId","fidjAppVersion","_rev","fidjData","resultAsString","write","fidjDacr","ok","id","rev","data_id","_deleted","row","resultAsJson","extractJson","getAll","allDocs","include_docs","descending","rows","isEmpty","total_rows","LoggerService","level","ERROR","NONE","INFO","warn","WARN","setLevel","urljoin","InternalService","logger","promise","ls","org","useDB","logLevel","global","tools.LocalStorage","session","session.Session","connection","connection.Connection","fidjInit","fidjId","self","fidjVersion","hasOwnProperty","theBestUrl","theBestOldUrl","fidjIsLogin","connection.Client","fidjLogin","_removeAll","_createSession","_loginInternal","fidjLoginInDemoMode","now","setDate","getDate","tomorrow","endpoints","jwtSign","fidjGetEndpoints","showBlocked","ap","Array","isArray","fidjRoles","fidjMessage","fidjLogout","fidjSync","fnInitFirstData","fnInitFirstData_Arg","firstSync","resolveEmpty","rejectEmptyNotUsed","ret","Function","doc_count","errMessage","fidjPutInDb","indexOf","_generateObjectUniqueId","fidjRemoveInDb","fidjFindInDb","fidjFindAllInDb","results","fidjSendOnEndpoint","relativePath","answer","jwt","query","fidjGetIdToken","loginUser","_testPromise","a","type","simpleDate","getFullYear","getMonth","getHours","getMinutes","sequId","_srvDataUniqId","UId","charAt","FidjService","fidjService","init","FidjError","loginAsDemo","isLoggedIn","getRoles","getEndpoints","sendOnEndpoint","getMessage","find","findAll","Injectable","providedIn"],"mappings":"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","sourcesContent":["// export namespace fidj {\n// }\nexport interface ErrorInterface {\n    code: number;\n    reason: string;\n}\n\nexport interface EndpointInterface {\n    key: string;\n    url: string;\n    blocked: boolean;\n}\n\nexport interface EndpointFilterInterface {\n    key?: string;\n    showBlocked?: boolean;\n}\n\n/**\n * Interface used by all InternalService wrappers (angular.js, angular.io)\n *\n * @see FidjModule\n * @see FidjModule, FidjAngularService\n */\nexport interface ModuleServiceInterface {\n\n    init(fidjId: string, options?: ModuleServiceInitOptionsInterface): Promise<void | ErrorInterface>;\n\n    login(login: string, password: string): Promise<any | ErrorInterface>;\n\n    loginAsDemo(options?: ModuleServiceLoginOptionsInterface): Promise<any | ErrorInterface>;\n\n    isLoggedIn(): boolean;\n\n    getRoles(): Array<string>;\n\n    getEndpoints(): Array<EndpointInterface>;\n\n    sendOnEndpoint(key: string, verb: string, relativePath?: string, data?: any): Promise<any | ErrorInterface>;\n\n    getIdToken(): string;\n\n    getMessage(): string;\n\n    logout(force?: boolean): Promise<void | ErrorInterface>;\n\n    sync(fnInitFirstData?: any): Promise<any | ErrorInterface>;\n\n    put(data: any): Promise<any | ErrorInterface>;\n\n    remove(dataId: any): Promise<any | ErrorInterface>;\n\n    find(id: string): Promise<any | ErrorInterface>;\n\n    findAll(): Promise<any | ErrorInterface>;\n}\n\n/**\n * prod : true by default\n * useDB : false by default\n * crypto : false by default\n * logLevel : NONE by default\n */\nexport interface ModuleServiceInitOptionsInterface {\n    prod: boolean,\n    useDB?: boolean,\n    // forcedEndpoint?: string,\n    // forcedDBEndpoint?: string,\n    crypto?: boolean,\n    logLevel?: LoggerLevelEnum\n}\n\nexport interface ModuleServiceLoginOptionsInterface {\n    accessToken?: string,\n    idToken?: string,\n    refreshToken?: string,\n}\n\nexport interface SdkInterface {\n    org: string,\n    version: string,\n    prod: boolean,\n    useDB: boolean\n}\n\nexport enum LoggerLevelEnum {\n    INFO = 1,\n    WARN = 2,\n    ERROR = 3,\n    NONE = 4\n}\n\nexport interface LoggerInterface {\n    setLevel: (LoggerLevelEnum) => void;\n\n    log: (a?, b?, c?, d?, e?, f?) => any;\n    warn: (a?, b?, c?, d?, e?, f?) => any;\n    error: (a?, b?, c?, d?, e?, f?) => any;\n}\n","export class Base64 {\n\n    constructor() {\n    };\n\n    /**\n     * Decodes string from Base64 string\n     */\n    public static encode(input: string): string {\n\n        if (!input) {\n            return null;\n        }\n\n        const _btoa = typeof window !== 'undefined' ? window.btoa : require('btoa');\n\n        return _btoa(encodeURIComponent(input).replace(/%([0-9A-F]{2})/g,\n            function toSolidBytes(match, p1) {\n                return String.fromCharCode(parseInt('0x' + p1, 16));\n            }));\n\n    }\n\n    public static decode(input: string): string {\n\n        if (!input) {\n            return null;\n        }\n\n        const _atob = typeof window !== 'undefined' ? window.atob : require('atob');\n\n        return decodeURIComponent(_atob(input).split('').map((c) => {\n            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);\n        }).join(''));\n\n    }\n}\n","/**\n * localStorage class factory\n * Usage : var LocalStorage = fidj.LocalStorageFactory(window.localStorage); // to create a new class\n * Usage : var localStorageService = new LocalStorage(); // to create a new instance\n */\nexport class LocalStorage {\n\n    public version = '0.1';\n    private storage;\n\n    // Constructor\n    constructor(storageService, private storageKey) {\n        this.storage = storageService || window.localStorage;\n        if (!this.storage) {\n            throw new Error('fidj.LocalStorageFactory needs a storageService!');\n        }\n        // todo LocalStorage refacto\n        //            if (!fidj.Xml) {\n        //                throw new Error('fidj.Xml needs to be loaded before fidj.LocalStorage!');\n        //            }\n        //            if (!fidj.Json) {\n        //                throw new Error('fidj.Json needs to be loaded before fidj.LocalStorage!');\n        //            }\n        //            if (!fidj.Xml.isXml || !fidj.Xml.xml2String || !fidj.Xml.string2Xml) {\n        //                throw new Error('fidj.Xml with isXml(), xml2String()\n        // and string2Xml() needs to be loaded before fidj.LocalStorage!');\n        //            }\n        //            if (!fidj.Json.object2String || !fidj.Json.string2Object) {\n        //                throw new Error('fidj.Json with object2String()\n        // and string2Object() needs to be loaded before fidj.LocalStorage!');\n        //            }\n        //\n    }\n\n    // Public API\n\n    /**\n     * Sets a key's value.\n     *\n     * @param key - Key to set. If this value is not set or not\n     *              a string an exception is raised.\n     * @param value - Value to set. This can be any value that is JSON\n     *              compatible (Numbers, Strings, Objects etc.).\n     * @returns the stored value which is a container of user value.\n     */\n    set(key: string, value) {\n\n        key = this.storageKey + key;\n        this.checkKey(key);\n        // clone the object before saving to storage\n        const t = typeof(value);\n        if (t === 'undefined') {\n            value = 'null';\n        } else if (value === null) {\n            value = 'null';\n        } else if (t === 'string') {\n            value = JSON.stringify({string: value})\n        } else if (t === 'number') {\n            value = JSON.stringify({number: value});\n        } else if (t === 'boolean') {\n            value = JSON.stringify({bool: value});\n        } else if (t === 'object') {\n            value = JSON.stringify({json: value});\n        } else {\n            // reject and do not insert\n            // if (typeof value == \"function\") for example\n            throw new TypeError('Value type ' + t + ' is invalid. It must be null, undefined, xml, string, number, boolean or object');\n        }\n        this.storage.setItem(key, value);\n        return value;\n    };\n\n    /**\n     * Looks up a key in cache\n     *\n     * @param key - Key to look up.\n     * @param def - Default value to return, if key didn't exist.\n     * @returns the key value, default value or <null>\n     */\n    get(key: string, def?) {\n        key = this.storageKey + key;\n        this.checkKey(key);\n        const item = this.storage.getItem(key);\n        if (item !== null) {\n            if (item === 'null') {\n                return null;\n            }\n            const value = JSON.parse(item);\n\n            // var value = fidj.Json.string2Object(item);\n            // if ('xml' in value) {\n            //     return fidj.Xml.string2Xml(value.xml);\n            // } else\n            if ('string' in value) {\n                return value.string;\n            } else if ('number' in value) {\n                return value.number.valueOf();\n            } else if ('bool' in value) {\n                return value.bool.valueOf();\n            } else {\n                return value.json;\n            }\n        }\n        return !def ? null : def;\n    };\n\n    /**\n     * Deletes a key from cache.\n     *\n     * @param  key - Key to delete.\n     * @returns true if key existed or false if it didn't\n     */\n    remove(key: string) {\n        key = this.storageKey + key;\n        this.checkKey(key);\n        const existed = (this.storage.getItem(key) !== null);\n        this.storage.removeItem(key);\n        return existed;\n    };\n\n    /**\n     * Deletes everything in cache.\n     *\n     * @return true\n     */\n    clear() {\n        const existed = (this.storage.length > 0);\n        this.storage.clear();\n        return existed;\n    };\n\n    /**\n     * How much space in bytes does the storage take?\n     *\n     * @returns Number\n     */\n    size() {\n        return this.storage.length;\n    };\n\n    /**\n     * Call function f on the specified context for each element of the storage\n     * from index 0 to index length-1.\n     * WARNING : You should not modify the storage during the loop !!!\n     *\n     * @param f - Function to call on every item.\n     * @param  context - Context (this for example).\n     * @returns Number of items in storage\n     */\n    foreach(f, context) {\n        const n = this.storage.length;\n        for (let i = 0; i < n; i++) {\n            const key = this.storage.key(i);\n            const value = this.get(key);\n            if (context) {\n                // f is an instance method on instance context\n                f.call(context, value);\n            } else {\n                // f is a function or class method\n                f(value);\n            }\n        }\n        return n;\n    };\n\n    // Private API\n    // helper functions and variables hidden within this function scope\n\n    private checkKey(key) {\n        if (!key || (typeof key !== 'string')) {\n            throw new TypeError('Key type must be string');\n        }\n        return true;\n    }\n}\n","import {Base64} from './base64';\n\nexport class Xor {\n\n    static header = 'artemis-lotsum';\n\n    constructor() {\n    };\n\n\n    public static encrypt(value: string, key: string): string {\n\n        let result = '';\n\n        value = Xor.header + value;\n\n        for (let i = 0; i < value.length; i++) {\n            result += String.fromCharCode((value[i].charCodeAt(0).toString(10) as any) ^ Xor.keyCharAt(key, i));\n        }\n        result = Base64.encode(result);\n        return result;\n    };\n\n    public static decrypt(value: string, key: string, oldStyle?: boolean): string {\n        let result = '';\n        value = Base64.decode(value);\n        for (let i = 0; i < value.length; i++) {\n            result += String.fromCharCode((value[i].charCodeAt(0).toString(10) as any) ^ Xor.keyCharAt(key, i));\n        }\n\n        if (!oldStyle && Xor.header !== result.substring(0, Xor.header.length)) {\n            return null;\n        }\n\n        if (!oldStyle) {\n            result = result.substring(Xor.header.length);\n        }\n        return result;\n    }\n\n    public static keyCharAt(key, i) {\n        return key[Math.floor(i % key.length)].charCodeAt(0).toString(10);\n    }\n\n\n}\n","import {ErrorInterface} from './interfaces';\n\nexport class Error implements ErrorInterface {\n\n    constructor(public code: number, public reason: string) {\n    };\n\n    equals(err: Error) {\n        return this.code === err.code && this.reason === err.reason;\n    }\n\n    toString(): string {\n        const msg: string = (typeof this.reason === 'string') ? this.reason : JSON.stringify(this.reason);\n        return '' + this.code + ' - ' + msg;\n    }\n\n}\n","import {NgModule} from '@angular/core';\nimport {CommonModule} from '@angular/common';\n\n\n/**\n * `NgModule` which provides associated services.\n *\n * ...\n *\n * @stable\n */\n@NgModule({\n    imports: [\n        CommonModule\n    ],\n    declarations: [],\n\n    exports: [],\n})\nexport class FidjModule {\n    constructor() {\n    }\n}\n\n\n/**\n * module FidjModule\n *\n * exemple\n *      // ... after install :\n *      // $ npm install fidj\n *      // then init your app.js & use it in your services\n * TODO refresh gist :\n * <script src=\"https://gist.github.com/mlefree/ad64f7f6a345856f6bf45fd59ca8db46.js\"></script>\n *\n * <script src=\"https://gist.github.com/mlefree/ad64f7f6a345856f6bf45fd59ca8db46.js\"></script>\n */\n","// bumped version via gulp\nexport const version = '3.3.0';\n","// import {XHRPromise} from './xhrpromise';\n// const superagent = require('superagent');\n// import from 'superagent';\n\nexport interface XhrOptionsInterface {\n    url: string,\n    data?: any,\n    headers?: any,\n    async?: boolean,\n    username?: string,\n    password?: string,\n    withCredentials?: boolean\n}\n\nexport enum XhrErrorReason {\n    UNKNOWN,\n    TIMEOUT,\n    STATUS\n}\n\n\nexport interface XhrErrorInterface {\n    reason: XhrErrorReason,\n    status: number,\n    code: number,\n    message: string,\n}\n\nexport class Ajax {\n\n    // private static xhr: XHRPromise = new XHRPromise();\n    private xhr; // : XHRPromise;\n\n    constructor() {\n\n        // https://www.twilio.com/blog/2017/08/http-requests-in-node-js.html\n        // axios ?\n        //  https://github.com/axios/axios\n        // const axios = require('axios');\n\n        // axios.get('https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY')\n        //     .then(response => {\n        //         console.log(response.data.url);\n        //         console.log(response.data.explanation);\n        //     })\n\n        // superagent.get('https://api.nasa.gov/planetary/apod')\n        //     .query({ api_key: 'DEMO_KEY', date: '2017-08-02' })\n\n        this.xhr = require('axios'); // require('superagent'); // new XHRPromise();\n    };\n\n    private static formatResponseData(response: any): any {\n        // TODO switch depending on json headers\n        let dataParsed = response;\n\n        while (dataParsed && dataParsed.data) {\n            dataParsed = dataParsed.data;\n        }\n\n        try {\n            dataParsed = JSON.parse(dataParsed + '');\n        } catch (e) {\n        }\n        return dataParsed;\n    };\n\n    private static formatError(error: any): XhrErrorInterface {\n\n        const errorFormatted: XhrErrorInterface = {\n            reason: XhrErrorReason.UNKNOWN,\n            status: -1,\n            code: -1,\n            message: '',\n        };\n\n        if (error.status) {\n            errorFormatted.reason = XhrErrorReason.STATUS;\n            errorFormatted.status = parseInt(error.status, 10);\n            errorFormatted.code = parseInt(error.status, 10);\n        }\n\n        if (error.response) {\n            errorFormatted.message = error.response;\n\n            if (error.response.status) {\n                errorFormatted.reason = XhrErrorReason.STATUS;\n                errorFormatted.status = parseInt(error.response.status, 10);\n                errorFormatted.code = parseInt(error.response.status, 10);\n            } else if (error.response.status === null) { // timeout\n                errorFormatted.reason = XhrErrorReason.TIMEOUT;\n                errorFormatted.status = 408;\n                errorFormatted.code = 408;\n            }\n\n        } else if (error.request) {\n            errorFormatted.message = error.request;\n        } else if (error.message) {\n            errorFormatted.message = error.message;\n        }\n\n        // _this._handleError('browser', reject, null, 'browser doesn\\'t support XMLHttpRequest');\n        // _this._handleError('url', reject, null, 'URL is a required parameter');\n        // _this._handleError('parse', reject, null, 'invalid JSON response');\n        // return _this._handleError('error', reject);\n        // return _this._handleError('timeout', reject);\n        // return _this._handleError('abort', reject);\n        // return _this._handleError('send', reject, null, e.toString());\n\n        // if (err.reason === 'timeout') {\n        //     err.code = 408;\n        // } else {\n        //     err.code = 404;\n        // }\n\n        return errorFormatted;\n    };\n\n    public post(args: XhrOptionsInterface): Promise<any | XhrErrorInterface> {\n\n        const opt: any = {\n            method: 'POST',\n            url: args.url,\n            data: JSON.stringify(args.data)\n        };\n        if (args.headers) {\n            opt.headers = args.headers;\n        }\n\n        return this.xhr\n            .post(opt.url, {\n                data: opt.data,\n                headers: opt.headers,\n                timeout: 10000\n            })\n            .then(res => {\n                if (res.status &&\n                    (parseInt(res.status, 10) < 200 || parseInt(res.status, 10) >= 300)) {\n                    return Promise.reject(Ajax.formatError(res));\n                }\n\n                return Promise.resolve(Ajax.formatResponseData(res));\n            })\n            .catch(err => {\n                return Promise.reject(Ajax.formatError(err));\n            });\n    }\n\n    public put(args: XhrOptionsInterface): Promise<any | XhrErrorInterface> {\n        const opt: any = {\n            method: 'PUT',\n            url: args.url,\n            data: JSON.stringify(args.data)\n        };\n        if (args.headers) {\n            opt.headers = args.headers;\n        }\n        return this.xhr\n            .put(opt.url, {\n                data: opt.data,\n                headers: opt.headers,\n                timeout: 10000\n            })\n            .then(res => {\n                if (res.status &&\n                    (parseInt(res.status, 10) < 200 || parseInt(res.status, 10) >= 300)) {\n                    return Promise.reject(Ajax.formatError(res));\n                }\n\n                return Promise.resolve(Ajax.formatResponseData(res));\n            })\n            .catch(err => {\n                return Promise.reject(Ajax.formatError(err));\n            });\n    }\n\n    public delete(args: XhrOptionsInterface): Promise<any | XhrErrorInterface> {\n        const opt: any = {\n            method: 'DELETE',\n            url: args.url,\n            data: JSON.stringify(args.data)\n        };\n        if (args.headers) {\n            opt.headers = args.headers;\n        }\n        return this.xhr\n            .delete(opt.url, {\n                data: opt.data,\n                headers: opt.headers,\n                timeout: 10000\n            })\n            // .delete(opt.url) // .send(opt)\n            .then(res => {\n                if (res.status &&\n                    (parseInt(res.status, 10) < 200 || parseInt(res.status, 10) >= 300)) {\n                    return Promise.reject(Ajax.formatError(res));\n                }\n\n                return Promise.resolve(Ajax.formatResponseData(res));\n            })\n            .catch(err => {\n                return Promise.reject(Ajax.formatError(err));\n            });\n    }\n\n    public get(args: XhrOptionsInterface): Promise<any | XhrErrorInterface> {\n        const opt: any = {\n            method: 'GET',\n            url: args.url\n        };\n        if (args.data) {\n            opt.data = args.data;\n        }\n        if (args.headers) {\n            opt.headers = args.headers;\n        }\n        return this.xhr\n            .get(opt.url, {\n                data: opt.data,\n                headers: opt.headers,\n                timeout: 10000\n            })\n            // .get(opt.url) // .send(opt)\n            .then(res => {\n                if (res.status &&\n                    (parseInt(res.status, 10) < 200 || parseInt(res.status, 10) >= 300)) {\n                    return Promise.reject(Ajax.formatError(res));\n                }\n\n                return Promise.resolve(Ajax.formatResponseData(res));\n            })\n            .catch(err => {\n                return Promise.reject(Ajax.formatError(err));\n            });\n    }\n}\n","import {Ajax} from './ajax';\nimport {LocalStorage} from '../tools';\nimport {SdkInterface, ErrorInterface} from '../sdk/interfaces';\nimport * as tools from '../tools';\n\nexport class Client {\n\n    public clientId: string;\n    private clientUuid: string;\n    private clientInfo: string;\n    // private refreshToken: string;\n    private static refreshCountInitial = 1;\n    private static refreshCount = Client.refreshCountInitial;\n    private static _clientUuid = 'v2.clientUuid';\n    private static _clientId = 'v2.clientId';\n    private static _refreshCount = 'v2.refreshCount';\n\n    constructor(private appId: string,\n                private URI: string,\n                private storage: LocalStorage,\n                private sdk: SdkInterface) {\n\n        let uuid: string = this.storage.get(Client._clientUuid) || 'uuid-' + Math.random();\n        let info = '_clientInfo'; // this.storage.get(Client._clientInfo);\n        if (typeof window !== 'undefined' && window.navigator) {\n            info = window.navigator.appName + '@' + window.navigator.appVersion + '-' + window.navigator.userAgent;\n        }\n        if (typeof window !== 'undefined' && window['device'] && window['device'].uuid) {\n            uuid = window['device'].uuid;\n        }\n        this.setClientUuid(uuid);\n        this.setClientInfo(info);\n        this.clientId = this.storage.get(Client._clientId);\n        Client.refreshCount = this.storage.get(Client._refreshCount) || Client.refreshCountInitial;\n    };\n\n    public setClientId(value: string) {\n        this.clientId = '' + value;\n        this.storage.set(Client._clientId, this.clientId);\n    }\n\n    public setClientUuid(value: string) {\n        this.clientUuid = '' + value;\n        this.storage.set(Client._clientUuid, this.clientUuid);\n    }\n\n    public setClientInfo(value: string) {\n        this.clientInfo = '' + value;\n        // this.storage.set('clientInfo', this.clientInfo);\n    }\n\n    public login(login: string, password: string, updateProperties?: any): Promise<any | ErrorInterface> {\n\n        if (!this.URI) {\n            console.error('no api uri');\n            return Promise.reject({code: 408, reason: 'no-api-uri'});\n        }\n\n        const urlLogin = this.URI + '/users';\n        const dataLogin = {\n            name: login,\n            username: login,\n            email: login,\n            password: password\n        };\n\n        return new Ajax()\n            .post({\n                url: urlLogin,\n                data: dataLogin,\n                headers: {'Content-Type': 'application/json', 'Accept': 'application/json'}\n            })\n            .then(createdUser => {\n\n                this.setClientId(createdUser._id);\n                const urlToken = this.URI + '/me/tokens';\n                const dataToken = {\n                    grant_type: 'client_credentials',\n                    client_id: this.clientId,\n                    client_secret: password,\n                    client_udid: this.clientUuid,\n                    client_info: this.clientInfo,\n                    audience: this.appId,\n                    scope: JSON.stringify(this.sdk)\n                };\n                return new Ajax()\n                    .post({\n                        url: urlToken,\n                        data: dataToken,\n                        headers: {\n                            'Content-Type': 'application/json', 'Accept': 'application/json',\n                            'Authorization': 'Basic ' + tools.Base64.encode('' + login + ':'+password)\n                        }\n                    });\n            });\n    }\n\n    public reAuthenticate(refreshToken: string): Promise<any | ErrorInterface> {\n\n        if (!this.URI) {\n            console.error('no api uri');\n            return Promise.reject({code: 408, reason: 'no-api-uri'});\n        }\n\n        const url = this.URI + '/me/tokens';\n        const data = {\n            grant_type: 'refresh_token',\n            client_id: this.clientId,\n            client_udid: this.clientUuid,\n            client_info: this.clientInfo,\n            audience: this.appId,\n            scope: JSON.stringify(this.sdk),\n            refresh_token: refreshToken,\n            refresh_extra: Client.refreshCount,\n        };\n\n        return new Ajax()\n            .post({\n                url: url,\n                data: data,\n                headers: {\n                    'Content-Type': 'application/json', 'Accept': 'application/json',\n                    'Authorization': 'Bearer ' + refreshToken\n                }\n            })\n            .then((obj: any) => {\n                Client.refreshCount++;\n                this.storage.set(Client._refreshCount, Client.refreshCount);\n                return Promise.resolve(obj);\n            });\n    }\n\n    public logout(refreshToken?: string): Promise<void | ErrorInterface> {\n\n        if (!this.URI) {\n            console.error('no api uri');\n            return Promise.reject({code: 408, reason: 'no-api-uri'});\n        }\n\n        // delete this.clientUuid;\n        // delete this.clientId;\n        // this.storage.remove(Client._clientUuid);\n        this.storage.remove(Client._clientId);\n        this.storage.remove(Client._refreshCount);\n        Client.refreshCount = Client.refreshCountInitial;\n\n        if (!refreshToken || !this.clientId) {\n            return Promise.resolve();\n        }\n\n        const url = this.URI + '/me/tokens/' + this.clientId;\n        const data = {\n            token: refreshToken,\n            client_id: this.clientId,\n            client_udid: this.clientUuid,\n            client_info: this.clientInfo,\n            audience: this.appId,\n            scope: JSON.stringify(this.sdk)\n        };\n\n        return new Ajax()\n            .delete({\n                url: url,\n                data: data,\n                headers: {\n                    'Content-Type': 'application/json', 'Accept': 'application/json',\n                    'Authorization': 'Bearer ' + refreshToken\n                }\n            });\n    }\n\n    public isReady(): boolean {\n        return !!this.URI;\n    }\n}\n","/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation.\r\n\r\nPermission to use, copy, modify, and/or distribute this software for any\r\npurpose with or without fee is hereby granted.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\r\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\r\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\r\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\r\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\r\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\r\nPERFORMANCE OF THIS SOFTWARE.\r\n***************************************************************************** */\r\n/* global Reflect, Promise */\r\n\r\nvar extendStatics = function(d, b) {\r\n    extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\r\n    return extendStatics(d, b);\r\n};\r\n\r\nexport function __extends(d, b) {\r\n    if (typeof b !== \"function\" && b !== null)\r\n        throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\r\n    extendStatics(d, b);\r\n    function __() { this.constructor = d; }\r\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n}\r\n\r\nexport var __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    }\r\n    return __assign.apply(this, arguments);\r\n}\r\n\r\nexport function __rest(s, e) {\r\n    var t = {};\r\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\r\n        t[p] = s[p];\r\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\r\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\r\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\r\n                t[p[i]] = s[p[i]];\r\n        }\r\n    return t;\r\n}\r\n\r\nexport function __decorate(decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n}\r\n\r\nexport function __param(paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n}\r\n\r\nexport function __metadata(metadataKey, metadataValue) {\r\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\r\n}\r\n\r\nexport function __awaiter(thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n}\r\n\r\nexport function __generator(thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n}\r\n\r\nexport var __createBinding = Object.create ? (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\r\n}) : (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    o[k2] = m[k];\r\n});\r\n\r\nexport function __exportStar(m, o) {\r\n    for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(o, p)) __createBinding(o, m, p);\r\n}\r\n\r\nexport function __values(o) {\r\n    var s = typeof Symbol === \"function\" && Symbol.iterator, m = s && o[s], i = 0;\r\n    if (m) return m.call(o);\r\n    if (o && typeof o.length === \"number\") return {\r\n        next: function () {\r\n            if (o && i >= o.length) o = void 0;\r\n            return { value: o && o[i++], done: !o };\r\n        }\r\n    };\r\n    throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\r\n}\r\n\r\nexport function __read(o, n) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\r\n    if (!m) return o;\r\n    var i = m.call(o), r, ar = [], e;\r\n    try {\r\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\r\n    }\r\n    catch (error) { e = { error: error }; }\r\n    finally {\r\n        try {\r\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\r\n        }\r\n        finally { if (e) throw e.error; }\r\n    }\r\n    return ar;\r\n}\r\n\r\n/** @deprecated */\r\nexport function __spread() {\r\n    for (var ar = [], i = 0; i < arguments.length; i++)\r\n        ar = ar.concat(__read(arguments[i]));\r\n    return ar;\r\n}\r\n\r\n/** @deprecated */\r\nexport function __spreadArrays() {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n}\r\n\r\nexport function __spreadArray(to, from) {\r\n    for (var i = 0, il = from.length, j = to.length; i < il; i++, j++)\r\n        to[j] = from[i];\r\n    return to;\r\n}\r\n\r\nexport function __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nexport function __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\nexport function __asyncDelegator(o) {\r\n    var i, p;\r\n    return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\r\n    function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: n === \"return\" } : f ? f(v) : v; } : f; }\r\n}\r\n\r\nexport function __asyncValues(o) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var m = o[Symbol.asyncIterator], i;\r\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\r\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\r\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\r\n}\r\n\r\nexport function __makeTemplateObject(cooked, raw) {\r\n    if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\r\n    return cooked;\r\n};\r\n\r\nvar __setModuleDefault = Object.create ? (function(o, v) {\r\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\r\n}) : function(o, v) {\r\n    o[\"default\"] = v;\r\n};\r\n\r\nexport function __importStar(mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\r\n    __setModuleDefault(result, mod);\r\n    return result;\r\n}\r\n\r\nexport function __importDefault(mod) {\r\n    return (mod && mod.__esModule) ? mod : { default: mod };\r\n}\r\n\r\nexport function __classPrivateFieldGet(receiver, state, kind, f) {\r\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\r\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\r\n    return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\r\n}\r\n\r\nexport function __classPrivateFieldSet(receiver, state, value, kind, f) {\r\n    if (kind === \"m\") throw new TypeError(\"Private method is not writable\");\r\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a setter\");\r\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot write private member to an object whose class did not declare it\");\r\n    return (kind === \"a\" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value)), value;\r\n}\r\n","import {Client} from './client';\nimport {ModuleServiceLoginOptionsInterface, SdkInterface, ErrorInterface, EndpointInterface, LoggerInterface} from '../sdk/interfaces';\nimport {Base64, LocalStorage, Xor} from '../tools';\nimport {Ajax} from './ajax';\nimport {ConnectionFindOptionsInterface} from './interfaces';\nimport {Error} from '../sdk/error';\n\nexport class Connection {\n\n    public fidjId: string;\n    public fidjVersion: string;\n    public fidjCrypto: boolean;\n    public accessToken: string;\n    public accessTokenPrevious: string;\n    public idToken: string;\n    public refreshToken: string;\n    public states: { [s: string]: { state: boolean, time: number, lastTimeWasOk: number }; }; // Map<string, boolean>;\n    public apis: Array<EndpointInterface>;\n\n    private cryptoSalt: string;\n    private cryptoSaltNext: string;\n    private client: Client;\n    private user: any;\n\n    private static _accessToken = 'v2.accessToken';\n    private static _accessTokenPrevious = 'v2.accessTokenPrevious';\n    private static _idToken = 'v2.idToken';\n    private static _refreshToken = 'v2.refreshToken';\n    private static _states = 'v2.states';\n    private static _cryptoSalt = 'v2.cryptoSalt';\n    private static _cryptoSaltNext = 'v2.cryptoSalt.next';\n\n    constructor(private _sdk: SdkInterface,\n                private _storage: LocalStorage,\n                private _logger: LoggerInterface) {\n        this.client = null;\n        this.user = null;\n        this.cryptoSalt = this._storage.get(Connection._cryptoSalt) || null;\n        this.cryptoSaltNext = this._storage.get(Connection._cryptoSaltNext) || null;\n        this.accessToken = this._storage.get(Connection._accessToken) || null;\n        this.accessTokenPrevious = this._storage.get('v2.accessTokenPrevious') || null;\n        this.idToken = this._storage.get(Connection._idToken) || null;\n        this.refreshToken = this._storage.get(Connection._refreshToken) || null;\n        this.states = this._storage.get(Connection._states) || {};\n        this.apis = [];\n    };\n\n    isReady(): boolean {\n        return !!this.client && this.client.isReady();\n    }\n\n    destroy(force?: boolean): void {\n\n        this._storage.remove(Connection._accessToken);\n        this._storage.remove(Connection._idToken);\n        this._storage.remove(Connection._refreshToken);\n        this._storage.remove(Connection._states);\n\n        if (this.accessToken) {\n            this.accessTokenPrevious = this.accessToken;\n            this._storage.set(Connection._accessTokenPrevious, this.accessTokenPrevious);\n        }\n\n        if (force) {\n            this._storage.remove(Connection._cryptoSalt);\n            this._storage.remove(Connection._cryptoSaltNext);\n            this._storage.remove(Connection._accessTokenPrevious);\n        }\n\n        this.user = null;\n        if (this.client) {\n            // this.client.setClientId(null);\n            this.client.logout();\n        }\n        this.accessToken = null;\n        this.idToken = null;\n        this.refreshToken = null;\n        this.states = {}; // new Map<string, boolean>();\n    }\n\n    setClient(client: Client): void {\n\n        this.client = client;\n        if (!this.user) {\n            this.user = {};\n        }\n\n        // this._user._id = this._client.clientId;\n        this.user._name = JSON.parse(this.getIdPayload({name: ''})).name;\n    }\n\n    setUser(user: any): void {\n        this.user = user;\n        if (this.client && this.user._id) {\n            this.client.setClientId(this.user._id);\n\n            // store only clientId\n            delete this.user._id;\n        }\n    }\n\n    getUser(): any {\n        return this.user;\n    }\n\n    getClient(): Client {\n        return this.client;\n    }\n\n    setCryptoSalt(value: string) {\n        if (this.cryptoSalt !== value && this.cryptoSaltNext !== value) {\n            this.cryptoSaltNext = value;\n            this._storage.set(Connection._cryptoSaltNext, this.cryptoSaltNext);\n        }\n\n        if (!this.cryptoSalt) {\n            this.setCryptoSaltAsVerified();\n        }\n    }\n\n    setCryptoSaltAsVerified() {\n        if (this.cryptoSaltNext) {\n            this.cryptoSalt = this.cryptoSaltNext;\n            this._storage.set(Connection._cryptoSalt, this.cryptoSalt);\n        }\n        this.cryptoSaltNext = null;\n        this._storage.remove(Connection._cryptoSaltNext);\n    }\n\n    encrypt(data: any): string {\n\n        if (typeof data !== 'string') {\n            data = JSON.stringify(data);\n        } else {\n            const dataAsObj = {string: data};\n            data = JSON.stringify(dataAsObj);\n        }\n\n        if (this.fidjCrypto && this.cryptoSalt) {\n            const key = this.cryptoSalt;\n            return Xor.encrypt(data, key);\n        } else {\n            return data;\n        }\n    }\n\n    decrypt(data: string): any {\n        let decrypted = null;\n\n        try {\n            if (!decrypted && this.fidjCrypto && this.cryptoSaltNext) {\n                const key = this.cryptoSaltNext;\n                decrypted = Xor.decrypt(data, key);\n                decrypted = JSON.parse(decrypted);\n                // if (decrypted) {\n                //    this.setCryptoSaltAsVerified();\n                // }\n            }\n        } catch (err) {\n            decrypted = null;\n        }\n\n        try {\n            if (!decrypted && this.fidjCrypto && this.cryptoSalt) {\n                const key = this.cryptoSalt;\n                decrypted = Xor.decrypt(data, key);\n                decrypted = JSON.parse(decrypted);\n            }\n        } catch (err) {\n            decrypted = null;\n        }\n\n        try {\n            if (!decrypted && this.fidjCrypto && this.cryptoSalt) {\n                const key = this.cryptoSalt;\n                decrypted = Xor.decrypt(data, key, true);\n                decrypted = JSON.parse(decrypted);\n            }\n        } catch (err) {\n            decrypted = null;\n        }\n\n\n        try {\n\n            if (!decrypted) {\n                decrypted = JSON.parse(data);\n            }\n\n            if (decrypted && decrypted.string) {\n                decrypted = decrypted.string;\n            }\n\n        } catch (err) {\n            decrypted = null;\n        }\n\n        return decrypted;\n    }\n\n    isLogin(): boolean {\n        let exp = true;\n        try {\n            const payload = this.refreshToken.split('.')[1];\n            const decoded = JSON.parse(Base64.decode(payload));\n            exp = ((new Date().getTime() / 1000) >= decoded.exp);\n\n        } catch (e) {\n        }\n        return !exp;\n    }\n\n    // todo reintegrate client.login()\n\n    logout(): Promise<void | ErrorInterface> {\n        return this.getClient().logout(this.refreshToken);\n    }\n\n    getClientId(): string {\n        if (!this.client) {\n            return null;\n        }\n        return this.client.clientId;\n    }\n\n    getIdToken(): string {\n        return this.idToken;\n    }\n\n    getIdPayload(def?: any): string {\n\n        const idToken = this.getIdToken();\n\n        try {\n            let payload;\n            if (idToken) {\n                payload = idToken.split('.')[1];\n            }\n            if (payload) {\n                return Base64.decode(payload);\n            }\n        } catch (e) {\n            this._logger.log('fidj.connection.getIdPayload pb: ', def, e);\n        }\n\n        if (def) {\n            if (typeof def !== 'string') {\n                def = JSON.stringify(def);\n            }\n            return def;\n        }\n\n        return null;\n    }\n\n    getAccessPayload(def?: any): string {\n        if (def && typeof def !== 'string') {\n            def = JSON.stringify(def);\n        }\n\n        try {\n            const payload = this.accessToken.split('.')[1];\n            if (payload) {\n                return Base64.decode(payload);\n            }\n        } catch (e) {\n        }\n        return def ? def : null;\n    }\n\n    getPreviousAccessPayload(def?: any): string {\n        if (def && typeof def !== 'string') {\n            def = JSON.stringify(def);\n        }\n\n        try {\n            const payload = this.accessTokenPrevious.split('.')[1];\n            if (payload) {\n                return Base64.decode(payload);\n            }\n        } catch (e) {\n        }\n        return def ? def : null;\n    }\n\n    refreshConnection(): Promise<any | ErrorInterface> {\n\n        // store states\n        this._storage.set(Connection._states, this.states);\n\n        // token not expired : ok\n        if (this.accessToken) {\n            const payload = this.accessToken.split('.')[1];\n            const decoded = Base64.decode(payload);\n            const notExpired = (new Date().getTime() / 1000) < JSON.parse(decoded).exp;\n            // console.log('new Date().getTime() < JSON.parse(decoded).exp :', (new Date().getTime() / 1000), JSON.parse(decoded).exp);\n            this._logger.log('fidj.connection.connection.refreshConnection : token not expired ? ', notExpired);\n            if (notExpired) {\n                return Promise.resolve(this.getUser());\n            }\n        }\n\n        // remove expired refreshToken\n        if (this.refreshToken) {\n            const payload = this.refreshToken.split('.')[1];\n            const decoded = Base64.decode(payload);\n            const expired = (new Date().getTime() / 1000) >= JSON.parse(decoded).exp;\n            this._logger.log('fidj.connection.connection.refreshConnection : refreshToken not expired ? ', expired);\n            if (expired) {\n                this._storage.remove(Connection._refreshToken);\n            }\n        }\n\n        // remove expired accessToken & idToken & store it as Previous one\n        this.accessTokenPrevious = this.accessToken;\n        this._storage.set('v2.accessTokenPrevious', this.accessTokenPrevious);\n        this._storage.remove(Connection._accessToken);\n        this._storage.remove(Connection._idToken);\n        this.accessToken = null;\n        this.idToken = null;\n\n        // refresh authentication\n        this._logger.log('fidj.connection.connection.refreshConnection : refresh authentication.');\n        return new Promise((resolve, reject) => {\n            const client = this.getClient();\n\n            if (!client) {\n                return reject(new Error(400, 'Need an initialized client.'))\n            }\n\n            this.getClient().reAuthenticate(this.refreshToken)\n                .then(user => {\n                    this.setConnection(user);\n                    resolve(this.getUser());\n                })\n                .catch(err => {\n\n                    // if (err && err.code === 408) {\n                    //     code = 408; // no api uri or basic timeout : offline\n                    // } else if (err && err.code === 404) {\n                    //     code = 404; // page not found : offline\n                    // } else if (err && err.code === 410) {\n                    //     code = 403; // token expired or device not sure : need relogin\n                    // } else if (err) {\n                    //     code = 403; // forbidden : need relogin\n                    // }\n\n                    // resolve(code);\n                    reject(err);\n                });\n        });\n    };\n\n    setConnection(clientUser: any): void {\n\n        // only in private storage\n        if (clientUser.access_token) {\n            this.accessToken = clientUser.access_token;\n            this._storage.set(Connection._accessToken, this.accessToken);\n            delete clientUser.access_token;\n\n            const salt: string = JSON.parse(this.getAccessPayload({salt: ''})).salt;\n            if (salt) {\n                this.setCryptoSalt(salt);\n            }\n        }\n        if (clientUser.id_token) {\n            this.idToken = clientUser.id_token;\n            this._storage.set(Connection._idToken, this.idToken);\n            delete clientUser.id_token;\n        }\n        if (clientUser.refresh_token) {\n            this.refreshToken = clientUser.refresh_token;\n            this._storage.set(Connection._refreshToken, this.refreshToken);\n            delete clientUser.refresh_token;\n        }\n\n        // store changed states\n        this._storage.set(Connection._states, this.states);\n\n        // expose roles, message\n        // clientUser.roles = self.fidjRoles();\n        // clientUser.message = self.fidjMessage();\n        clientUser.roles = JSON.parse(this.getIdPayload({roles: []})).roles;\n        clientUser.message = JSON.parse(this.getIdPayload({message: ''})).message;\n        this.setUser(clientUser);\n    };\n\n    setConnectionOffline(options: ModuleServiceLoginOptionsInterface): void {\n\n        if (options.accessToken) {\n            this.accessToken = options.accessToken;\n            this._storage.set(Connection._accessToken, this.accessToken);\n        }\n        if (options.idToken) {\n            this.idToken = options.idToken;\n            this._storage.set(Connection._idToken, this.idToken);\n        }\n        if (options.refreshToken) {\n            this.refreshToken = options.refreshToken;\n            this._storage.set(Connection._refreshToken, this.refreshToken);\n        }\n\n        this.setUser({\n            roles: JSON.parse(this.getIdPayload({roles: []})).roles,\n            message: JSON.parse(this.getIdPayload({message: ''})).message,\n            _id: 'demo'\n        });\n    }\n\n    getApiEndpoints(options?: ConnectionFindOptionsInterface): Array<EndpointInterface> {\n\n        // todo : let ea = ['https://fidj/v3', 'https://fidj-proxy.herokuapp.com/v3'];\n        let ea: EndpointInterface[] = [\n            {key: 'fidj.default', url: 'https://api.fidj.ovh/v3', blocked: false}];\n        let filteredEa = [];\n\n        if (!this._sdk.prod) {\n            ea = [\n                {key: 'fidj.default', url: 'http://localhost:3201/v3', blocked: false},\n                {key: 'fidj.default', url: 'https://fidj-sandbox.herokuapp.com/v3', blocked: false}\n            ];\n        }\n\n        if (this.accessToken) {\n            const val = this.getAccessPayload({apis: []});\n            const apiEndpoints: EndpointInterface[] = JSON.parse(val).apis;\n            if (apiEndpoints && apiEndpoints.length) {\n                ea = [];\n                apiEndpoints.forEach((endpoint) => {\n                    if (endpoint.url) {\n                        ea.push(endpoint);\n                    }\n                });\n            }\n        }\n\n        if (this.accessTokenPrevious) {\n            const apiEndpoints: EndpointInterface[] = JSON.parse(this.getPreviousAccessPayload({apis: []})).apis;\n            if (apiEndpoints && apiEndpoints.length) {\n                apiEndpoints.forEach((endpoint) => {\n                    if (endpoint.url && ea.filter((r) => r.url === endpoint.url).length === 0) {\n                        ea.push(endpoint);\n                    }\n                });\n            }\n        }\n\n        this._logger.log('fidj.sdk.connection.getApiEndpoints : ', ea);\n\n        let couldCheckStates = true;\n        if (this.states && Object.keys(this.states).length) {\n            for (let i = 0; (i < ea.length) && couldCheckStates; i++) {\n                if (!this.states[ea[i].url]) {\n                    couldCheckStates = false;\n                }\n            }\n        } else {\n            couldCheckStates = false;\n        }\n\n        if (options && options.filter) {\n\n            if (couldCheckStates && options.filter === 'theBestOne') {\n                for (let i = 0; (i < ea.length) && (filteredEa.length === 0); i++) {\n                    const endpoint = ea[i];\n                    if (this.states[endpoint.url] &&\n                        this.states[endpoint.url].state) {\n                        filteredEa.push(endpoint);\n                    }\n                }\n            } else if (couldCheckStates && options.filter === 'theBestOldOne') {\n                let bestOldOne: EndpointInterface;\n                for (let i = 0; (i < ea.length); i++) {\n                    const endpoint = ea[i];\n                    if (this.states[endpoint.url] &&\n                        this.states[endpoint.url].lastTimeWasOk &&\n                        (!bestOldOne || this.states[endpoint.url].lastTimeWasOk > this.states[bestOldOne.url].lastTimeWasOk)) {\n\n                        bestOldOne = endpoint;\n                    }\n                }\n                if (bestOldOne) {\n                    filteredEa.push(bestOldOne);\n                }\n            } else if (ea.length) {\n                filteredEa.push(ea[0]);\n            }\n        } else {\n            filteredEa = ea;\n        }\n\n        return filteredEa;\n    };\n\n    getDBs(options?: ConnectionFindOptionsInterface): EndpointInterface[] {\n\n        if (!this.accessToken) {\n            return [];\n        }\n\n        // todo test random DB connection\n        const random = Math.random() % 2;\n        let dbs = JSON.parse(this.getAccessPayload({dbs: []})).dbs || [];\n\n        // need to synchronize db\n        if (random === 0) {\n            dbs = dbs.sort();\n        } else if (random === 1) {\n            dbs = dbs.reverse();\n        }\n\n        let filteredDBs = [];\n        let couldCheckStates = true;\n        if (this.states && Object.keys(this.states).length) {\n            for (let i = 0; (i < dbs.length) && couldCheckStates; i++) {\n                if (!this.states[dbs[i].url]) {\n                    couldCheckStates = false;\n                }\n            }\n        } else {\n            couldCheckStates = false;\n        }\n\n        if (couldCheckStates && options && options.filter === 'theBestOne') {\n            for (let i = 0; (i < dbs.length) && (filteredDBs.length === 0); i++) {\n                const endpoint = dbs[i];\n                if (this.states[endpoint.url] &&\n                    this.states[endpoint.url].state) {\n                    filteredDBs.push(endpoint);\n                }\n            }\n        } else if (couldCheckStates && options && options.filter === 'theBestOnes') {\n            for (let i = 0; (i < dbs.length); i++) {\n                const endpoint = dbs[i];\n                if (this.states[endpoint.url] &&\n                    this.states[endpoint.url].state) {\n                    filteredDBs.push(endpoint);\n                }\n            }\n        } else if (options && options.filter === 'theBestOne' && dbs.length) {\n            filteredDBs.push(dbs[0]);\n        } else {\n            filteredDBs = dbs;\n        }\n\n        return filteredDBs;\n    };\n\n    private async verifyApiState(currentTime: number, endpointUrl: string) {\n\n        try {\n\n            this._logger.log('fidj.sdk.connection.verifyApiState : ', currentTime, endpointUrl);\n\n            const data = await new Ajax()\n                .get({\n                    url: endpointUrl + '/status?isOk=' + this._sdk.version,\n                    headers: {'Content-Type': 'application/json', 'Accept': 'application/json'}\n                });\n\n            let state = false;\n            if (data && data.isOk) {\n                state = true;\n            }\n            this.states[endpointUrl] = {state: state, time: currentTime, lastTimeWasOk: currentTime};\n\n            this._logger.log('fidj.sdk.connection.verifyApiState > states : ', this.states);\n\n        } catch (err) {\n            let lastTimeWasOk = 0;\n            if (this.states[endpointUrl]) {\n                lastTimeWasOk = this.states[endpointUrl].lastTimeWasOk;\n            }\n            this.states[endpointUrl] = {state: false, time: currentTime, lastTimeWasOk: lastTimeWasOk};\n\n            this._logger.log('fidj.sdk.connection.verifyApiState > catch pb  - states : ', err, this.states);\n        }\n    }\n\n    private async verifyDbState(currentTime: number, dbEndpoint: string) {\n\n        try {\n            // console.log('verifyDbState: ', dbEndpoint);\n            const data = await new Ajax()\n                .get({\n                    url: dbEndpoint,\n                    headers: {'Content-Type': 'application/json', 'Accept': 'application/json'}\n                });\n\n            this.states[dbEndpoint] = {state: true, time: currentTime, lastTimeWasOk: currentTime};\n            // resolve();\n            // console.log('verifyDbState: state', dbEndpoint, true);\n\n        } catch (err) {\n            let lastTimeWasOk = 0;\n            if (this.states[dbEndpoint]) {\n                lastTimeWasOk = this.states[dbEndpoint].lastTimeWasOk;\n            }\n            this.states[dbEndpoint] = {state: false, time: currentTime, lastTimeWasOk: lastTimeWasOk};\n            // resolve();\n        }\n    }\n\n    verifyConnectionStates(): Promise<any | ErrorInterface> {\n\n        const currentTime = new Date().getTime();\n\n        // todo need verification ? not yet (cache)\n        // if (Object.keys(this.states).length > 0) {\n        //     const time = this.states[Object.keys(this.states)[0]].time;\n        //     if (currentTime < time) {\n        //         return Promise.resolve();\n        //     }\n        // }\n\n        // verify via GET status on Endpoints & DBs\n        const promises = [];\n        // this.states = {};\n        this.apis = this.getApiEndpoints();\n        this.apis.forEach((endpointObj) => {\n            let endpointUrl: string = endpointObj.url;\n            if (!endpointUrl) {\n                endpointUrl = endpointObj.toString();\n            }\n            promises.push(this.verifyApiState(currentTime, endpointUrl));\n        });\n\n        const dbs = this.getDBs();\n        dbs.forEach((dbEndpointObj) => {\n            let dbEndpoint: string = dbEndpointObj.url;\n            if (!dbEndpoint) {\n                dbEndpoint = dbEndpointObj.toString();\n            }\n            promises.push(this.verifyDbState(currentTime, dbEndpoint));\n        });\n        return Promise.all(promises);\n    };\n\n}\n","// import PouchDB from 'pouchdb';\n// let PouchDB: any;\n\nimport PouchDB from 'pouchdb/dist/pouchdb.js';\nimport {Error} from '../sdk/error';\nimport {EndpointInterface, ErrorInterface} from '../sdk/interfaces';\n\nlet FidjPouch;\n\nif (typeof window !== 'undefined') {\n    FidjPouch = (window['PouchDB']) ? window['PouchDB'] : require('pouchdb').default; // .default;\n    // load cordova adapter : https://github.com/pouchdb-community/pouchdb-adapter-cordova-sqlite/issues/22\n    const PouchAdapterCordovaSqlite = require('pouchdb-adapter-cordova-sqlite');\n    FidjPouch.plugin(PouchAdapterCordovaSqlite);\n}\n\nexport interface SessionCryptoInterface {\n    obj: Object,\n    method: string\n}\n\nexport class Session {\n\n    public dbRecordCount: number;\n    public dbLastSync: number; // Date().getTime();\n\n    private db: PouchDB; // PouchDB\n    private remoteDb: PouchDB; // PouchDB;\n    private remoteUri: string;\n    private dbs: Array<EndpointInterface>;\n\n    constructor() {\n        this.db = null;\n        this.dbRecordCount = 0;\n        this.dbLastSync = null;\n        this.remoteDb = null;\n        this.dbs = [];\n    };\n\n    public isReady(): boolean {\n        return !!this.db;\n    }\n\n    public create(uid: string, force?: boolean): Promise<any | ErrorInterface> {\n\n        if (!force && this.db) {\n            return Promise.resolve(this.db);\n        }\n\n        this.dbRecordCount = 0;\n        this.dbLastSync = null; // new Date().getTime();\n        this.db = null;\n        uid = uid || 'default';\n\n        if (typeof window === 'undefined') {\n            return Promise.resolve(this.db);\n        }\n\n        return new Promise((resolve, reject) => {\n\n            let opts: any = {location: 'default'};\n            try {\n                if (window['cordova']) {\n                    opts = {location: 'default', adapter: 'cordova-sqlite'};\n                    //    const plugin = require('pouchdb-adapter-cordova-sqlite');\n                    //    if (plugin) { Pouch.plugin(plugin); }\n                    //    this.db = new Pouch('fidj_db', {adapter: 'cordova-sqlite'});\n                }\n                // } else {\n                this.db = new FidjPouch('fidj_db_' + uid, opts); // , {adapter: 'websql'} ???\n                // }\n\n                this.db.info()\n                    .then((info) => {\n\n                        // todo if (info.adapter !== 'websql') {\n                        return resolve(this.db);\n                        // }\n\n                        // const newopts: any = opts || {};\n                        // newopts.adapter = 'idb';\n                        //\n                        // const newdb = new Pouch('fidj_db', opts);\n                        // this.db.replicate.to(newdb)\n                        //     .then(() => {\n                        //         this.db = newdb;\n                        //         resolve();\n                        //     })\n                        //     .catch((err) => {\n                        //         reject(new Error(400, err.toString()))\n                        //     });\n\n                    }).catch((err) => {\n                    reject(new Error(400, err));\n                });\n            } catch (err) {\n                reject(new Error(500, err));\n            }\n        });\n    }\n\n    public destroy(): Promise<void | ErrorInterface> {\n\n        if (!this.db) {\n            this.dbRecordCount = 0;\n            this.dbLastSync = null;\n            return Promise.resolve();\n        }\n\n        if (this.db && !this.db.destroy) {\n            return Promise.reject(new Error(408, 'Need a valid db'));\n        }\n\n        return new Promise((resolve, reject) => {\n            this.db.destroy((err, info) => {\n                if (err) {\n                    reject(new Error(500, err));\n                } else {\n                    this.dbRecordCount = 0;\n                    this.dbLastSync = null;\n                    this.db = null;\n                    resolve();\n                }\n            });\n        });\n    };\n\n    public setRemote(dbs: Array<EndpointInterface>): void {\n        this.dbs = dbs;\n    }\n\n    public sync(userId: string): Promise<void | ErrorInterface> {\n\n        if (!this.db) {\n            return Promise.reject(new Error(408, 'need db'));\n        }\n        if (!this.dbs || !this.dbs.length) {\n            return Promise.reject(new Error(408, 'need a remote db'));\n        }\n\n        return new Promise((resolve, reject) => {\n            try {\n\n                if (!this.remoteDb || this.remoteUri !== this.dbs[0].url) {\n                    this.remoteUri = this.dbs[0].url;\n                    this.remoteDb = new FidjPouch(this.remoteUri);\n                    // todo , {headers: {'Authorization': 'Bearer ' + id_token}});\n                }\n\n                this.db.replicate.to(this.remoteDb)\n                    .on('complete', (info) => {\n                        return this.remoteDb.replicate.to(this.db,\n                            {\n                                filter: (doc) => {\n                                    return (!!userId && !!doc && doc.fidjUserId === userId);\n                                }\n                            })\n                            .on('complete', () => {\n                                // this.logger\n                                resolve();\n                            })\n                            .on('denied', (err) => reject({code: 403, reason: {second: err}}))\n                            .on('error', (err) => reject({code: 401, reason: {second: err}}));\n\n                    })\n                    .on('denied', (err) => reject({code: 403, reason: {first: err}}))\n                    .on('error', (err) => reject({code: 401, reason: {first: err}}));\n\n            } catch (err) {\n                reject(new Error(500, err));\n            }\n        });\n    }\n\n    public put(data: any,\n               _id: string,\n               uid: string,\n               oid: string,\n               ave: string,\n               crypto?: SessionCryptoInterface): Promise<any | ErrorInterface> {\n\n        if (!this.db) {\n            return Promise.reject(new Error(408, 'need db'));\n        }\n\n        if (!data || !_id || !uid || !oid || !ave) {\n            return Promise.reject(new Error(400, 'need formated data'));\n        }\n\n        const dataWithoutIds = JSON.parse(JSON.stringify(data));\n        const toStore: any = {\n            _id: _id,\n            fidjUserId: uid,\n            fidjOrgId: oid,\n            fidjAppVersion: ave\n        };\n        if (dataWithoutIds._rev) {\n            toStore._rev = '' + dataWithoutIds._rev;\n        }\n        delete dataWithoutIds._id;\n        delete dataWithoutIds._rev;\n        delete dataWithoutIds.fidjUserId;\n        delete dataWithoutIds.fidjOrgId;\n        delete dataWithoutIds.fidjAppVersion;\n        delete dataWithoutIds.fidjData;\n\n        let resultAsString = Session.write(Session.value(dataWithoutIds));\n        if (crypto) {\n            resultAsString = crypto.obj[crypto.method](resultAsString);\n            toStore.fidjDacr = resultAsString;\n        } else {\n            toStore.fidjData = resultAsString;\n        }\n\n        return new Promise((resolve, reject) => {\n            this.db.put(toStore, (err, response) => {\n                if (response && response.ok && response.id && response.rev) {\n                    this.dbRecordCount++;\n\n                    // propagate _rev & _id\n                    if (typeof data === 'object') {\n                        (data as any)._rev = response.rev;\n                        (data as any)._id = response.id;\n                        resolve(data);\n                    } else {\n                        resolve(response.id);\n                    }\n\n                } else {\n                    reject(new Error(500, err));\n                }\n            });\n        });\n    }\n\n    public remove(data_id: string): Promise<void | ErrorInterface> {\n\n        if (!this.db) {\n            return Promise.reject(new Error(408, 'need db'));\n        }\n\n        return new Promise((resolve, reject) => {\n            this.db.get(data_id)\n                .then((doc) => {\n                    doc._deleted = true;\n                    return this.db.put(doc);\n                })\n                .then((result) => {\n                    resolve();\n                })\n                .catch((err) => {\n                    reject(err);\n                });\n        });\n    }\n\n    public get(data_id: string, crypto?: SessionCryptoInterface): Promise<any | ErrorInterface> {\n\n        if (!this.db) {\n            return Promise.reject(new Error(408, 'Need db'));\n        }\n\n        return new Promise((resolve, reject) => {\n            this.db.get(data_id)\n                .then(row => {\n                    if (!!row && (!!row.fidjDacr || !!row.fidjData)) {\n                        let data = row.fidjDacr;\n                        if (crypto && data) {\n                            data = crypto.obj[crypto.method](data);\n                        } else if (row.fidjData) {\n                            data = JSON.parse(row.fidjData);\n                        }\n                        const resultAsJson = Session.extractJson(data);\n                        if (resultAsJson) {\n                            resultAsJson._id = row._id;\n                            resultAsJson._rev = row._rev;\n                            resolve(JSON.parse(JSON.stringify(resultAsJson)));\n                        } else {\n                            // row._deleted = true;\n                            this.remove(row._id);\n                            reject(new Error(400, 'Bad encoding'));\n                        }\n                    } else {\n                        reject(new Error(400, 'No data found'));\n                    }\n                })\n                .catch(err => reject(new Error(500, err)));\n        });\n    }\n\n    public getAll(crypto?: SessionCryptoInterface): Promise<Array<any> | ErrorInterface> {\n\n        if (!this.db || !(this.db as any).allDocs) {\n            return Promise.reject(new Error(408, 'Need a valid db'));\n        }\n\n        return new Promise((resolve, reject) => {\n            (this.db as any).allDocs({include_docs: true, descending: true})\n                .then(rows => {\n                    const all = [];\n                    rows.rows.forEach(row => {\n                        if (!!row && !!row.doc._id && (!!row.doc.fidjDacr || !!row.doc.fidjData)) {\n                            let data = row.doc.fidjDacr;\n                            if (crypto && data) {\n                                data = crypto.obj[crypto.method](data);\n                            } else if (row.doc.fidjData) {\n                                data = JSON.parse(row.doc.fidjData);\n                            }\n                            const resultAsJson = Session.extractJson(data);\n                            if (resultAsJson) {\n                                resultAsJson._id = row.doc._id;\n                                resultAsJson._rev = row.doc._rev;\n                                all.push(JSON.parse(JSON.stringify(resultAsJson)));\n                            } else {\n                                console.error('Bad encoding : delete row');\n                                // resultAsJson = {};\n                                // resultAsJson._id = row.doc._id;\n                                // resultAsJson._rev = row.doc._rev;\n                                // resultAsJson._deleted = true;\n                                // all.push(resultAsJson);\n                                this.remove(row.doc._id);\n                            }\n                        } else {\n                            console.error('Bad encoding');\n                        }\n                    });\n                    resolve(all);\n                })\n                .catch(err => reject(new Error(400, err)));\n        });\n    }\n\n    public isEmpty(): Promise<boolean | ErrorInterface> {\n\n        if (!this.db || !(this.db as any).allDocs) {\n            return Promise.reject(new Error(408, 'No db'));\n        }\n\n        return new Promise((resolve, reject) => {\n            (this.db as any).allDocs({\n                // filter:  (doc) => {\n                //    if (!self.connection.user || !self.connection.user._id) return doc;\n                //    if (doc.fidjUserId === self.connection.user._id) return doc;\n                // }\n            })\n                .then((response) => {\n                    if (!response) {\n                        reject(new Error(400, 'No response'));\n                    } else {\n                        this.dbRecordCount = response.total_rows;\n                        if (response.total_rows && response.total_rows > 0) {\n                            resolve(false);\n                        } else {\n                            resolve(true);\n                        }\n                    }\n                })\n                .catch((err) => reject(new Error(400, err)));\n        });\n    }\n\n    public info(): Promise<any> {\n        if (!this.db) {\n            return Promise.reject(new Error(408, 'No db'));\n        }\n        return this.db.info();\n    }\n\n    static write(item: any): string {\n        let value = 'null';\n        const t = typeof (item);\n        if (t === 'undefined') {\n            value = 'null';\n        } else if (value === null) {\n            value = 'null';\n        } else if (t === 'string') {\n            value = JSON.stringify({string: item})\n        } else if (t === 'number') {\n            value = JSON.stringify({number: item});\n        } else if (t === 'boolean') {\n            value = JSON.stringify({bool: item});\n        } else if (t === 'object') {\n            value = JSON.stringify({json: item});\n        }\n        return value;\n    }\n\n    static value(item: any): any {\n        let result = item;\n        if (typeof (item) !== 'object') {\n            // return item;\n        } else if ('string' in item) {\n            result = item.string;\n        } else if ('number' in item) {\n            result = item.number.valueOf();\n        } else if ('bool' in item) {\n            result = item.bool.valueOf();\n        } else if ('json' in item) {\n            result = item.json;\n            if (typeof (result) !== 'object') {\n                result = JSON.parse(result);\n            }\n        }\n        return result;\n    }\n\n    static extractJson(item: any): any {\n        let result = item;\n        if (!item) {\n            return null;\n        }\n        if (typeof (item) === 'object' && 'json' in item) {\n            result = item.json;\n        }\n        if (typeof (result) === 'string') {\n            result = JSON.parse(result);\n        }\n        if (typeof (result) === 'object' && 'json' in result) {\n            result = (result as any).json;\n        }\n        if (typeof result !== 'object') {\n            result = null;\n        }\n        return result;\n    }\n\n}\n","import {\n    LoggerInterface, LoggerLevelEnum\n} from './interfaces';\n\nexport class LoggerService implements LoggerInterface {\n\n    constructor(private level?: LoggerLevelEnum) {\n        if (!level) {\n            this.level = LoggerLevelEnum.ERROR;\n        }\n\n        if (typeof console === 'undefined') {\n            this.level = LoggerLevelEnum.NONE;\n        }\n    }\n\n    log(message: string, args: [any]) {\n        if (this.level === LoggerLevelEnum.INFO) {\n            console.log(message, args);\n        }\n    }\n\n    warn(message: string, args: [any]) {\n        if (this.level === LoggerLevelEnum.INFO || this.level === LoggerLevelEnum.WARN) {\n            console.warn(message, args);\n        }\n    }\n\n    error(message: string, args: [any]) {\n        if (this.level === LoggerLevelEnum.INFO || this.level === LoggerLevelEnum.WARN || this.level === LoggerLevelEnum.ERROR) {\n            console.error(message, args);\n        }\n    }\n\n    setLevel(level: LoggerLevelEnum) {\n        this.level = level;\n    }\n}\n\n","// import PouchDB from 'pouchdb';\n// import * as PouchDB from 'pouchdb/dist/pouchdb.js';\n// import PouchDB from 'pouchdb/dist/pouchdb.js';\nimport * as version from '../version';\nimport * as tools from '../tools';\nimport * as connection from '../connection';\nimport * as session from '../session';\nimport {\n    LoggerInterface,\n    ModuleServiceInitOptionsInterface,\n    ModuleServiceLoginOptionsInterface,\n    SdkInterface,\n    ErrorInterface, EndpointInterface, EndpointFilterInterface, LoggerLevelEnum\n} from './interfaces';\nimport {SessionCryptoInterface} from '../session/session';\nimport {Error} from './error';\nimport {Ajax} from '../connection/ajax';\nimport {LoggerService} from './logger.service';\n\nconst urljoin = require('url-join');\n// import {LocalStorage} from 'node-localstorage';\n// import 'localstorage-polyfill/localStorage';\n\n// const PouchDB = window['PouchDB'] || require('pouchdb').default;\n\n/**\n * please use its angular.js or angular.io wrapper\n * usefull only for fidj dev team\n */\nexport class InternalService {\n\n    private sdk: SdkInterface;\n    private logger: LoggerInterface;\n    private promise: PromiseConstructor;\n    private storage: tools.LocalStorage;\n    private session: session.Session;\n    private connection: connection.Connection;\n\n    constructor(logger: LoggerInterface, promise: PromiseConstructor, options?: ModuleServiceInitOptionsInterface) {\n\n        this.sdk = {\n            org: 'fidj',\n            version: version.version,\n            prod: false,\n            useDB: true\n        };\n        if (promise) {\n            this.promise = promise;\n        }\n        if (logger) {\n            this.logger = logger;\n        } else {\n            this.logger = new LoggerService();\n        }\n        if (options && options.logLevel) {\n            this.logger.setLevel(options.logLevel);\n        }\n\n        this.logger.log('fidj.sdk.service : constructor');\n        let ls;\n        if (typeof window !== 'undefined') {\n            ls = window.localStorage;\n        } else if (typeof global !== 'undefined') {\n            require('localstorage-polyfill');\n            ls = global['localStorage'];\n        }\n        this.storage = new tools.LocalStorage(ls, 'fidj.');\n        this.session = new session.Session();\n        this.connection = new connection.Connection(this.sdk, this.storage, this.logger);\n    }\n\n    /**\n     * Init connection & session\n     * Check uri\n     * Done each app start\n     *\n     * @param options Optional settings\n     * @param options.fidjId  required use your customized endpoints\n     * @param options.fidjSalt required use your customized endpoints\n     * @param options.fidjVersion required use your customized endpoints\n     * @param options.devMode optional default false, use your customized endpoints\n     * @returns\n     */\n    public fidjInit(fidjId: string, options?: ModuleServiceInitOptionsInterface): Promise<void | ErrorInterface> {\n\n        const self = this;\n        /*\n        if (options && options.forcedEndpoint) {\n            this.fidjService.setAuthEndpoint(options.forcedEndpoint);\n        }\n        if (options && options.forcedDBEndpoint) {\n            this.fidjService.setDBEndpoint(options.forcedDBEndpoint);\n        }*/\n        if (options && options.logLevel) {\n            self.logger.setLevel(options.logLevel);\n        } else {\n            self.logger.setLevel(LoggerLevelEnum.NONE);\n        }\n\n        self.logger.log('fidj.sdk.service.fidjInit : ', options);\n        if (!fidjId) {\n            self.logger.error('fidj.sdk.service.fidjInit : bad init');\n            return self.promise.reject(new Error(400, 'Need a fidjId'));\n        }\n\n        self.sdk.prod = !options ? true : options.prod;\n        self.sdk.useDB = !options ? false : options.useDB;\n        self.connection.fidjId = fidjId;\n        self.connection.fidjVersion = self.sdk.version;\n        self.connection.fidjCrypto = (!options || !options.hasOwnProperty('crypto')) ? false : options.crypto;\n\n        return new self.promise((resolve, reject) => {\n            self.connection.verifyConnectionStates()\n                .then(() => {\n\n                    let theBestUrl: any = self.connection.getApiEndpoints({filter: 'theBestOne'})[0];\n                    let theBestOldUrl: any = self.connection.getApiEndpoints({filter: 'theBestOldOne'})[0];\n                    const isLogin = self.fidjIsLogin();\n                    self.logger.log('fidj.sdk.service.fidjInit > verifyConnectionStates : ', theBestUrl, theBestOldUrl, isLogin);\n\n                    if (theBestUrl && theBestUrl.url) {\n                        theBestUrl = theBestUrl.url;\n                    }\n                    if (theBestOldUrl && theBestOldUrl.url) {\n                        theBestOldUrl = theBestOldUrl.url;\n                    }\n\n                    if (theBestUrl) {\n                        self.connection.setClient(new connection.Client(self.connection.fidjId, theBestUrl, self.storage, self.sdk));\n                        resolve();\n                    } else if (isLogin && theBestOldUrl) {\n                        self.connection.setClient(new connection.Client(self.connection.fidjId, theBestOldUrl, self.storage, self.sdk));\n                        resolve();\n                    } else {\n                        reject(new Error(404, 'Need one connection - or too old SDK version (check update)'));\n                    }\n\n                })\n                .catch((err) => {\n                    self.logger.error('fidj.sdk.service.fidjInit: ', err);\n                    reject(new Error(500, err.toString()));\n                });\n        });\n    };\n\n    /**\n     * Call it if fidjIsLogin() === false\n     * Erase all (db & storage)\n     *\n     * @param login\n     * @param password\n     * @returns\n     */\n    public fidjLogin(login: string, password: string): Promise<any | ErrorInterface> {\n        const self = this;\n        self.logger.log('fidj.sdk.service.fidjLogin');\n        if (!self.connection.isReady()) {\n            return self.promise.reject(new Error(404, 'Need an intialized FidjService'));\n        }\n\n        return new self.promise((resolve, reject) => {\n            self._removeAll()\n                .then(() => {\n                    return self.connection.verifyConnectionStates();\n                })\n                .then(() => {\n                    return self._createSession(self.connection.fidjId);\n                })\n                .then(() => {\n                    return self._loginInternal(login, password);\n                })\n                .then((user) => {\n                    self.connection.setConnection(user);\n\n                    if (!self.sdk.useDB) {\n                        resolve(self.connection.getUser());\n                    } else {\n                        self.session.sync(self.connection.getClientId())\n                            .then(() => resolve(self.connection.getUser()))\n                            .catch((err) => resolve(self.connection.getUser()));\n                    }\n                })\n                .catch((err) => {\n                    self.logger.error('fidj.sdk.service.fidjLogin: ', err.toString());\n                    reject(err);\n                });\n        });\n    };\n\n    /**\n     *\n     * @param options\n     * @param options.accessToken optional\n     * @param options.idToken  optional\n     * @returns\n     */\n    public fidjLoginInDemoMode(options?: ModuleServiceLoginOptionsInterface): Promise<any | ErrorInterface> {\n        const self = this;\n\n        // generate one day tokens if not set\n        if (!options || !options.accessToken) {\n            const now = new Date();\n            now.setDate(now.getDate() + 1);\n            const tomorrow = now.getTime();\n            const payload = tools.Base64.encode(JSON.stringify({\n                roles: [],\n                message: 'demo',\n                apis: [],\n                endpoints: [],\n                dbs: [],\n                exp: tomorrow\n            }));\n            const jwtSign = tools.Base64.encode(JSON.stringify({}));\n            const token = jwtSign + '.' + payload + '.' + jwtSign;\n            options = {\n                accessToken: token,\n                idToken: token,\n                refreshToken: token\n            };\n        }\n\n        return new self.promise((resolve, reject) => {\n            self._removeAll()\n                .then(() => {\n                    return self._createSession(self.connection.fidjId);\n                })\n                .then(() => {\n                    self.connection.setConnectionOffline(options);\n                    resolve(self.connection.getUser());\n                })\n                .catch((err) => {\n                    self.logger.error('fidj.sdk.service.fidjLoginInDemoMode error: ', err);\n                    reject(err);\n                });\n        });\n    };\n\n    public fidjGetEndpoints(filter?: EndpointFilterInterface): Array<EndpointInterface> {\n\n        if (!filter) {\n            filter = {showBlocked: false};\n        }\n        const ap = this.connection.getAccessPayload({endpoints: []});\n        let endpoints = JSON.parse(ap).endpoints;\n        if (!endpoints || !Array.isArray(endpoints)) {\n            return [];\n        }\n\n        endpoints = endpoints.filter((endpoint: EndpointInterface) => {\n            let ok = true;\n            if (ok && filter.key) {\n                ok = (endpoint.key === filter.key);\n            }\n            if (ok && !filter.showBlocked) {\n                ok = !endpoint.blocked;\n            }\n            return ok;\n        });\n        return endpoints;\n    };\n\n    public fidjRoles(): Array<string> {\n        return JSON.parse(this.connection.getIdPayload({roles: []})).roles;\n    };\n\n    public fidjMessage(): string {\n        return JSON.parse(this.connection.getIdPayload({message: ''})).message;\n    };\n\n    public fidjIsLogin(): boolean {\n        return this.connection.isLogin();\n    };\n\n    public fidjLogout(force?: boolean): Promise<void | ErrorInterface> {\n        const self = this;\n        if (!self.connection.getClient() && !force) {\n            return self._removeAll()\n                .then(() => {\n                    return this.session.create(self.connection.fidjId, true);\n                });\n        }\n\n        return self.connection.logout()\n            .then(() => {\n                return self._removeAll();\n            })\n            .catch(() => {\n                return self._removeAll();\n            })\n            .then(() => {\n                return this.session.create(self.connection.fidjId, true);\n            });\n    };\n\n    /**\n     * Synchronize DB\n     *\n     *\n     * @param fnInitFirstData a function with db as input and that return promise: call if DB is empty\n     * @param fnInitFirstData_Arg arg to set to fnInitFirstData()\n     * @returns  promise\n     */\n    public fidjSync(fnInitFirstData?, fnInitFirstData_Arg?): Promise<void | ErrorInterface> {\n        const self = this;\n        self.logger.log('fidj.sdk.service.fidjSync');\n        // if (!self.session.isReady()) {\n        //    return self.promise.reject('fidj.sdk.service.fidjSync : DB sync impossible. Did you login ?');\n        // }\n\n        if (!self.sdk.useDB) {\n            self.logger.log('fidj.sdk.service.fidjSync: you ar not using DB - no sync available.');\n            return Promise.resolve();\n        }\n\n        const firstSync = (self.session.dbLastSync === null);\n\n        return new self.promise((resolve, reject) => {\n\n            self._createSession(self.connection.fidjId)\n                .then(() => {\n                    return self.session.sync(self.connection.getClientId());\n                })\n                .then(() => {\n                    self.logger.log('fidj.sdk.service.fidjSync resolved');\n                    return self.session.isEmpty();\n                })\n                .catch((err) => {\n                    self.logger.warn('fidj.sdk.service.fidjSync warn: ', err);\n                    return self.session.isEmpty();\n                })\n                .then((isEmpty) => {\n                    self.logger.log('fidj.sdk.service.fidjSync isEmpty : ', isEmpty, firstSync);\n\n                    return new self.promise((resolveEmpty, rejectEmptyNotUsed) => {\n                        if (isEmpty && firstSync && fnInitFirstData) {\n                            const ret = fnInitFirstData(fnInitFirstData_Arg);\n                            if (ret && ret['catch'] instanceof Function) {\n                                ret.then(resolveEmpty).catch(reject);\n                            }\n                            if (typeof ret === 'string') {\n                                self.logger.log(ret);\n                            }\n                        }\n                        resolveEmpty(); // self.connection.getUser());\n                    });\n                })\n                .then((info) => {\n                    self.logger.log('fidj.sdk.service.fidjSync fnInitFirstData resolved: ', info);\n                    self.session.dbLastSync = new Date().getTime();\n                    return self.session.info();\n                })\n                .then((result: any) => {\n                    self.session.dbRecordCount = 0;\n                    if (result && result.doc_count) {\n                        self.session.dbRecordCount = result.doc_count;\n                    }\n                    self.logger.log('fidj.sdk.service.fidjSync _dbRecordCount : ' + self.session.dbRecordCount);\n\n                    return self.connection.refreshConnection();\n                })\n                .then((user) => {\n                    self.logger.log('fidj.sdk.service.fidjSync refreshConnection done : ', user);\n                    resolve(); // self.connection.getUser()\n                })\n                .catch((err: ErrorInterface) => {\n                    // console.error(err);\n                    self.logger.warn('fidj.sdk.service.fidjSync refreshConnection failed : ', err);\n\n                    if (err && (err.code === 403 || err.code === 410)) {\n                        this.fidjLogout()\n                            .then(() => {\n                                reject({code: 403, reason: 'Synchronization unauthorized : need to login again.'});\n                            })\n                            .catch(() => {\n                                reject({code: 403, reason: 'Synchronization unauthorized : need to login again..'});\n                            });\n                    } else if (err && err.code) {\n                        // todo what to do with this err ?\n                        resolve();\n                    } else {\n                        const errMessage = 'Error during synchronisation: ' + err.toString();\n                        self.logger.error(errMessage);\n                        reject({code: 500, reason: errMessage});\n                    }\n                })\n            ;\n        });\n    };\n\n    public fidjPutInDb(data: any): Promise<string | ErrorInterface> {\n        const self = this;\n        self.logger.log('fidj.sdk.service.fidjPutInDb: ', data);\n        if (!self.sdk.useDB) {\n            self.logger.log('fidj.sdk.service.fidjPutInDb: you are not using DB - no put available.');\n            return Promise.resolve('NA');\n        }\n\n        if (!self.connection.getClientId()) {\n            return self.promise.reject(new Error(401, 'DB put impossible. Need a user logged in.'));\n        }\n        if (!self.session.isReady()) {\n            return self.promise.reject(new Error(400, 'Need to be synchronised.'));\n        }\n\n        let _id: string;\n        if (data && typeof data === 'object' && Object.keys(data).indexOf('_id')) {\n            _id = data._id;\n        }\n        if (!_id) {\n            _id = self._generateObjectUniqueId(self.connection.fidjId);\n        }\n        let crypto: SessionCryptoInterface;\n        if (self.connection.fidjCrypto) {\n            crypto = {\n                obj: self.connection,\n                method: 'encrypt'\n            }\n        }\n\n        return self.session.put(\n            data,\n            _id,\n            self.connection.getClientId(),\n            self.sdk.org,\n            self.connection.fidjVersion,\n            crypto);\n    };\n\n    public fidjRemoveInDb(data_id: string): Promise<void | ErrorInterface> {\n        const self = this;\n        self.logger.log('fidj.sdk.service.fidjRemoveInDb ', data_id);\n        if (!self.sdk.useDB) {\n            self.logger.log('fidj.sdk.service.fidjRemoveInDb: you are not using DB - no remove available.');\n            return Promise.resolve();\n        }\n\n        if (!self.session.isReady()) {\n            return self.promise.reject(new Error(400, 'Need to be synchronised.'));\n        }\n\n        if (!data_id || typeof data_id !== 'string') {\n            return self.promise.reject(new Error(400, 'DB remove impossible. ' +\n                'Need the data._id.'));\n        }\n\n        return self.session.remove(data_id);\n    };\n\n    public fidjFindInDb(data_id: string): Promise<any | ErrorInterface> {\n        const self = this;\n\n        if (!self.sdk.useDB) {\n            self.logger.log('fidj.sdk.service.fidjFindInDb: you are not using DB - no find available.');\n            return Promise.resolve();\n        }\n\n        if (!self.connection.getClientId()) {\n            return self.promise.reject(new Error(401, 'Find pb : need a user logged in.'));\n        }\n        if (!self.session.isReady()) {\n            return self.promise.reject(new Error(400, ' Need to be synchronised.'));\n        }\n\n        let crypto: SessionCryptoInterface;\n        if (self.connection.fidjCrypto) {\n            crypto = {\n                obj: self.connection,\n                method: 'decrypt'\n            };\n        }\n\n        return self.session.get(data_id, crypto);\n    };\n\n    public fidjFindAllInDb(): Promise<Array<any> | ErrorInterface> {\n        const self = this;\n\n        if (!self.sdk.useDB) {\n            self.logger.log('fidj.sdk.service.fidjFindAllInDb: you are not using DB - no find available.');\n            return Promise.resolve([]);\n        }\n\n        if (!self.connection.getClientId()) {\n            return self.promise.reject(new Error(401, 'Need a user logged in.'));\n        }\n        if (!self.session.isReady()) {\n            return self.promise.reject(new Error(400, 'Need to be synchronised.'));\n        }\n\n        let crypto: SessionCryptoInterface;\n        if (self.connection.fidjCrypto) {\n            crypto = {\n                obj: self.connection,\n                method: 'decrypt'\n            };\n        }\n\n        return self.session.getAll(crypto)\n            .then(results => {\n                self.connection.setCryptoSaltAsVerified();\n                return self.promise.resolve((results as Array<any>));\n            });\n    };\n\n    public fidjSendOnEndpoint(key: string, verb: string, relativePath: string, data: any): Promise<any | ErrorInterface> {\n        const filter: EndpointFilterInterface = {\n            key: key\n        };\n        const endpoints = this.fidjGetEndpoints(filter);\n        if (!endpoints || endpoints.length !== 1) {\n            return this.promise.reject(\n                new Error(400,\n                    'fidj.sdk.service.fidjSendOnEndpoint : endpoint does not exist.'));\n        }\n\n        let endpointUrl = endpoints[0].url;\n        if (relativePath) {\n            endpointUrl = urljoin(endpointUrl, relativePath);\n        }\n        const jwt = this.connection.getIdToken();\n        let answer;\n        const query = new Ajax();\n        switch (verb) {\n            case 'POST' :\n                answer = query.post({\n                    url: endpointUrl,\n                    // not used : withCredentials: true,\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Accept': 'application/json',\n                        'Authorization': 'Bearer ' + jwt\n                    },\n                    data: data\n                });\n                break;\n            case 'PUT' :\n                answer = query.put({\n                    url: endpointUrl,\n                    // not used : withCredentials: true,\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Accept': 'application/json',\n                        'Authorization': 'Bearer ' + jwt\n                    },\n                    data: data\n                });\n                break;\n            case 'DELETE' :\n                answer = query.delete({\n                    url: endpointUrl,\n                    // not used : withCredentials: true,\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Accept': 'application/json',\n                        'Authorization': 'Bearer ' + jwt\n                    },\n                    // not used: data: data\n                });\n                break;\n            default:\n                answer = query.get({\n                    url: endpointUrl,\n                    // not used : withCredentials: true,\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Accept': 'application/json',\n                        'Authorization': 'Bearer ' + jwt\n                    },\n                    // not used: data: data\n                });\n        }\n        return answer;\n    };\n\n    public fidjGetIdToken(): string {\n        return this.connection.getIdToken();\n    };\n\n    // Internal functions\n\n    /**\n     * Logout then Login\n     *\n     * @param login\n     * @param password\n     * @param updateProperties\n     */\n    private _loginInternal(login: string, password: string, updateProperties?: any): Promise<any | ErrorInterface> {\n        const self = this;\n        self.logger.log('fidj.sdk.service._loginInternal');\n        if (!self.connection.isReady()) {\n            return self.promise.reject(new Error(403, 'Need an intialized FidjService'));\n        }\n\n        return new self.promise((resolve, reject) => {\n\n                self.connection.logout()\n                    .then(() => {\n                        return self.connection.getClient().login(login, password, updateProperties);\n                    })\n                    .catch((err) => {\n                        return self.connection.getClient().login(login, password, updateProperties);\n                    })\n                    .then(loginUser => {\n                        loginUser.email = login;\n                        resolve(loginUser);\n                    })\n                    .catch(err => {\n                        self.logger.error('fidj.sdk.service._loginInternal error : ' + err);\n                        reject(err);\n                    });\n            }\n        );\n    };\n\n    protected _removeAll(): Promise<void | ErrorInterface> {\n        this.connection.destroy();\n        return this.session.destroy();\n    };\n\n    private _createSession(uid: string): Promise<void | ErrorInterface> {\n        const dbs: EndpointInterface[] = this.connection.getDBs({filter: 'theBestOnes'});\n        if (!dbs || dbs.length === 0) {\n            this.logger.warn('Seems that you are in Demo mode or using Node (no remote DB).');\n        }\n        this.session.setRemote(dbs);\n        return this.session.create(uid);\n    };\n\n    private _testPromise(a?): Promise<any> {\n        if (a) {\n            return this.promise.resolve('test promise ok ' + a);\n        }\n        return new this.promise((resolve, reject) => {\n            resolve('test promise ok');\n        });\n    };\n\n    private static _srvDataUniqId = 0;\n\n    private _generateObjectUniqueId(appName, type?, name?) {\n\n        // return null;\n        const now = new Date();\n        const simpleDate = '' + now.getFullYear() + '' + now.getMonth() + '' + now.getDate()\n            + '' + now.getHours() + '' + now.getMinutes(); // new Date().toISOString();\n        const sequId = ++InternalService._srvDataUniqId;\n        let UId = '';\n        if (appName && appName.charAt(0)) {\n            UId += appName.charAt(0) + '';\n        }\n        if (type && type.length > 3) {\n            UId += type.substring(0, 4);\n        }\n        if (name && name.length > 3) {\n            UId += name.substring(0, 4);\n        }\n        UId += simpleDate + '' + sequId;\n        return UId;\n    }\n\n}\n","/* tslint:disable:max-line-length */\nimport {Injectable} from '@angular/core';\nimport {\n    EndpointInterface,\n    ErrorInterface,\n    LoggerInterface,\n    LoggerLevelEnum,\n    ModuleServiceInitOptionsInterface,\n    ModuleServiceInterface,\n    ModuleServiceLoginOptionsInterface\n} from './interfaces';\nimport {InternalService} from './internal.service';\nimport {Error as FidjError} from '../connection';\nimport {LoggerService} from './logger.service';\n\n/**\n * Angular FidjService\n * @see ModuleServiceInterface\n *\n */\n@Injectable({\n    providedIn: 'root',\n})\nexport class FidjService implements ModuleServiceInterface {\n\n    private logger: LoggerInterface;\n    private fidjService: InternalService;\n    private promise: any;\n\n    constructor() {\n        this.logger = new LoggerService(LoggerLevelEnum.ERROR);\n        this.promise = Promise;\n        this.fidjService = null;\n        // let pouchdbRequired = PouchDB;\n        // pouchdbRequired.error();\n    };\n\n    public init(fidjId: string, options?: ModuleServiceInitOptionsInterface): Promise<void | ErrorInterface> {\n        if (!this.fidjService) {\n            this.fidjService = new InternalService(this.logger, this.promise);\n        }\n        return this.fidjService.fidjInit(fidjId, options);\n    };\n\n    public login(login: string, password: string): Promise<any | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(303, 'fidj.sdk.angular.login : not initialized.'));\n        }\n        return this.fidjService.fidjLogin(login, password);\n    };\n\n    public loginAsDemo(options?: ModuleServiceLoginOptionsInterface): Promise<any | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(303, 'fidj.sdk.angular.loginAsDemo : not initialized.'));\n        }\n        return this.fidjService.fidjLoginInDemoMode(options);\n    };\n\n    public isLoggedIn(): boolean {\n        if (!this.fidjService) {\n            return false; // this.promise.reject('fidj.sdk.angular.isLoggedIn : not initialized.');\n        }\n        return this.fidjService.fidjIsLogin();\n    };\n\n    public getRoles(): Array<string> {\n        if (!this.fidjService) {\n            return [];\n        }\n        return this.fidjService.fidjRoles();\n    };\n\n    public getEndpoints(): Array<EndpointInterface> {\n        if (!this.fidjService) {\n            return [];\n        }\n        return this.fidjService.fidjGetEndpoints();\n    };\n\n    public sendOnEndpoint(key: string, verb: string, relativePath?: string, data?: any): Promise<any | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(303, 'fidj.sdk.angular.loginAsDemo : not initialized.'));\n        }\n        return this.fidjService.fidjSendOnEndpoint(key, verb, relativePath, data);\n    };\n\n    public getIdToken(): string {\n        if (!this.fidjService) {\n            return;\n        }\n        return this.fidjService.fidjGetIdToken();\n    };\n\n    public getMessage(): string {\n        if (!this.fidjService) {\n            return '';\n        }\n        return this.fidjService.fidjMessage();\n    };\n\n    public logout(force?: boolean): Promise<void | ErrorInterface> {\n        if (force || !this.fidjService) {\n            return this.promise.reject(new FidjError(303, 'fidj.sdk.angular.logout : not initialized.'));\n        }\n        return this.fidjService.fidjLogout(force);\n    };\n\n    /**\n     *\n     * Synchronize DB\n     * @param fnInitFirstData  a function with db as input and that return promise: call if DB is empty\n     * @returns promise with this.session.db\n     * @memberof fidj.angularService\n     *\n     * @example\n     *  let initDb = function() {\n     *     this.fidjService.put('my first row');\n     *  };\n     *  this.fidjService.sync(initDb)\n     *  .then(user => ...)\n     *  .catch(err => ...)\n     *\n     */\n    public sync(fnInitFirstData?): Promise<void | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(401, 'fidj.sdk.angular.sync : not initialized.'));\n        }\n        return this.fidjService.fidjSync(fnInitFirstData, this);\n    };\n\n    /**\n     * Store data in your session\n     *\n     * @param data to store\n     * @returns\n     */\n    public put(data: any): Promise<string | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(401, 'fidj.sdk.angular.put : not initialized.'));\n        }\n        return this.fidjService.fidjPutInDb(data);\n    };\n\n    /**\n     * Find object Id and remove it from your session\n     *\n     * @param id of object to find and remove\n     * @returns\n     */\n    public remove(id: string): Promise<void | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(401, 'fidj.sdk.angular.remove : not initialized.'));\n        }\n        return this.fidjService.fidjRemoveInDb(id);\n    };\n\n    /**\n     * Find\n     */\n    public find(id: string): Promise<any | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(401, 'fidj.sdk.angular.find : not initialized.'));\n        }\n        return this.fidjService.fidjFindInDb(id);\n    };\n\n    public findAll(): Promise<any[] | ErrorInterface> {\n        if (!this.fidjService) {\n            return this.promise.reject(new FidjError(401, 'fidj.sdk.angular.findAll : not initialized.'));\n        }\n        return this.fidjService.fidjFindAllInDb();\n    };\n\n}\n"]}